// WADE (Web App Development Engine) - version 4.0.1 - Copyright Clockwork Chilli ltd 2012-2018 - all rights reserved 
function Animation(a,b,c,d,e,f,g,i,h){if("object"==typeof a&&a){if(this.name=a.name,this._numCells={x:a.numCells&&a.numCells.x||1,y:a.numCells&&a.numCells.y||1},this._startFrame=a.startFrame||0,this._endFrame="undefined"!=typeof a.endFrame&&!isNaN(a.endFrame)?a.endFrame:this._numCells.x*this._numCells.y-1,this._imageName=a.image,this._speed="undefined"!=typeof a.speed?a.speed:20,this._looping=!!a.looping,this._playMode=a.playMode||"forward",this._autoResize="undefined"!=typeof a.autoResize?a.autoResize:
!0,this._offset={x:a.offset&&a.offset.x||0,y:a.offset&&a.offset.y||0},this._image=wade.getImage(this._imageName),this._stopped=!!a.stopped,this._imageArea=a.imageArea||{minX:0,minY:0,maxX:1,maxY:1},a.properties)for(var k in a.properties)if(a.properties.hasOwnProperty(k))try{this[k]=JSON.parse(JSON.stringify(a.properties[k]))}catch(j){}}else this._image=wade.getImage(a),this._imageName=wade.getFullPathAndFileName(a),this._numCells={x:b?b:1,y:c?c:1},this._startFrame=f?f:0,this._endFrame="undefined"!=
typeof g&&!isNaN(g)?g:b*c-1,this._speed="undefined"!=typeof d?d:20,this._looping=e,this._playMode="forward",this._stopped=!1,this._autoResize="undefined"!=typeof i?i:!0,this._offset=h||{x:0,y:0},this._offset.x=this._offset.x||0,this._offset.y=this._offset.y||0,this._imageArea={minX:0,minY:0,maxX:1,maxY:1};this._currentFrame=this._startFrame;this._playing=!1;this._time=0;this._direction=1;this._frameFraction=0;this._frameSize={x:this._image.width*(this._imageArea.maxX-this._imageArea.minX)/this._numCells.x,
y:this._image.height*(this._imageArea.maxY-this._imageArea.minY)/this._numCells.y};this._frameCorner={};try{this._f32AnimFrameInfo=new Float32Array([0,0,this._frameSize.x/this._image.width,this._frameSize.y/this._image.height])}catch(l){}this._updateFrameCorner()}Animation.prototype.getImageSize=function(){return{x:this._image.width,y:this._image.height}};Animation.prototype.getFrameSize=function(){return{x:this._frameSize.x,y:this._frameSize.y}};
Animation.prototype.getFrameCorner=function(){return{x:this._frameCorner.x,y:this._frameCorner.y}};Animation.prototype.getFrameCorner_ref=function(){return this._frameCorner};Animation.prototype.getFrameSize_ref=function(){return this._frameSize};Animation.prototype.getImageName=function(){return wade.getFullPathAndFileName(this._imageName)};Animation.prototype.getRelativeImageName=function(){return this._imageName};Animation.prototype.getNumCells=function(){return{x:this._numCells.x,y:this._numCells.y}};
Animation.prototype.play=function(a){if(this._autoResize&&this.sprite&&!this.isDefault){var b=this.sprite.getScaleFactor();this.sprite.setSize(this._frameSize.x*b.x,this._frameSize.y*b.y)}this._time=0;this._direction=a&&"reverse"==a?-1:1;this._playMode=a;a=this._currentFrame;this._currentFrame=1==this._direction?this._startFrame:this._endFrame;a!=this._currentFrame&&this._updateFrameCorner();a=this._playing;this._playing=!0;this._stopped=!1;if(this.sprite&&this.name)this.sprite.onAnimationStart(this.name,
a)};Animation.prototype.stop=function(){this._playing=!1;this._stopped=!0};Animation.prototype.resume=function(){this._playing||(this._stopped?(this._playing=!0,this._stopped=!1):this.play())};
Animation.prototype.step=function(){this._time+=wade.c_timeStep*this._speed;var a=this._currentFrame,b=this._time+wade.c_epsilon-0.5,c=Math.round(b);this._frameFraction=b-c+0.5;this._currentFrame=1==this._direction?c+this._startFrame:this._endFrame-c;if(a!=this._currentFrame){if(1==this._direction){if(this._currentFrame>this._endFrame)if("ping-pong"==this._playMode)this._currentFrame=this._endFrame,this._direction=-1,this._time=0;else if(this._looping)this._currentFrame=this._startFrame,this._time-=
this._endFrame-this._startFrame+1;else if(this._currentFrame=this._endFrame,this._playing=!1,this._time=0,this.sprite&&this.name)this.sprite.onAnimationEnd(this.name)}else if(this._currentFrame<this._startFrame)if(this._looping)"ping-pong"==this._playMode?(this._currentFrame=this._startFrame,this._direction=1,this._time=0):(this._currentFrame=this._endFrame,this._time-=(this._endFrame-this._startFrame+1)/this._speed);else if(this._currentFrame=this._startFrame,this._playing=!1,this._time=0,this.sprite&&
this.name)this.sprite.onAnimationEnd(this.name);this._updateFrameCorner();this.sprite&&this.sprite.isVisible()&&this.sprite.getSceneObject()&&this.sprite.getSceneObject().isInScene()&&this.sprite.setDirtyArea()}};Animation.prototype.isPlaying=function(){return this._playing};
Animation.prototype.clone=function(){var a=new Animation;wade.extend(a,this);a.sprite=0;a._numCells={x:this._numCells.x,y:this._numCells.y};a._offset={x:this._offset.x,y:this._offset.y};a._frameSize={x:this._frameSize.x,y:this._frameSize.y};a._frameCorner={x:this._frameCorner.x,y:this._frameCorner.y};try{a._f32AnimFrameInfo=this._f32AnimFrameInfo?new Float32Array([this._f32AnimFrameInfo[0],this._f32AnimFrameInfo[1],this._f32AnimFrameInfo[2],this._f32AnimFrameInfo[3]]):new Float32Array([0,0,1,1]),
a._f32PositionAndSize=this._f32PositionAndSize?new Float32Array([this._f32PositionAndSize[0],this._f32PositionAndSize[1],this._f32PositionAndSize[2],this._f32PositionAndSize[3]]):new Float32Array([0,0,1,1]),a._f32RotationAlpha=this._f32RotationAlpha?new Float32Array([this._f32RotationAlpha[0],this._f32RotationAlpha[1]]):new Float32Array([0,0])}catch(b){}return a};
Animation.prototype.serialize=function(a,b){var c={type:"Animation",name:this.name,startFrame:this._startFrame,endFrame:this._endFrame,numCells:{x:this._numCells.x,y:this._numCells.y},image:this._imageName,imageArea:{minX:this._imageArea.minX||0,minY:this._imageArea.minY,maxX:"undefined"==typeof this._imageArea.maxX?1:this._imageArea.maxX,maxY:"undefined"==typeof this._imageArea.maxY?1:this._imageArea.maxY},speed:this._speed,looping:this._looping,playMode:this._playMode,autoResize:this._autoResize,
offset:{x:this._offset.x,y:this._offset.y},stopped:this._stopped,properties:{}},d=["name","sprite","isDefault"];b&&(d=d.concat(b));for(var e in this)if(this.hasOwnProperty(e)&&"_"!=e[0]&&-1==d.indexOf(e))try{var f=JSON.stringify(this[e]);c.properties[e]=JSON.parse(f)}catch(g){}return a?JSON.stringify(c,null,"\t"):c};Animation.prototype.setFrameNumber=function(a){a!=this._currentFrame&&(this._currentFrame=a,this._updateFrameCorner(),this.sprite&&this.sprite.setDirtyArea())};
Animation.prototype.getFrameNumber=function(){return this._currentFrame};Animation.prototype.getFrameCount=function(){return this._endFrame-this._startFrame+1};Animation.prototype.setOffset=function(a){this._offset.x=a.x;this._offset.y=a.y;this.sprite&&this.sprite.updateBoundingBox()};Animation.prototype.getOffset=function(){return{x:this._offset.x,y:this._offset.y}};
Animation.prototype.setImageArea=function(a,b,c,d){this._imageArea.minX=a;this._imageArea.minY=b;this._imageArea.maxX=c;this._imageArea.maxY=d;this._frameSize={x:this._image.width*(this._imageArea.maxX-this._imageArea.minX)/this._numCells.x,y:this._image.height*(this._imageArea.maxY-this._imageArea.minY)/this._numCells.y};this._updateFrameCorner();this._f32AnimFrameInfo[2]=this._frameSize.x/this._image.width;this._f32AnimFrameInfo[3]=this._frameSize.y/this._image.height};
Animation.prototype.getImageArea=function(){return{minX:this._imageArea.minX,minY:this._imageArea.minY,maxX:this._imageArea.maxX,maxY:this._imageArea.maxY}};Animation.prototype.getSpeed=function(){return this._speed};Animation.prototype.setSpeed=function(a){this._speed=a};Animation.prototype.getOffset_ref=function(){return this._offset};
Animation.prototype.refreshImage=function(){this._image=wade.getImage(this._imageName);this._frameSize={x:this._image.width*(this._imageArea.maxX-this._imageArea.minX)/this._numCells.x,y:this._image.height*(this._imageArea.maxY-this._imageArea.minY)/this._numCells.y};this._f32AnimFrameInfo&&(this._f32AnimFrameInfo[2]=this._frameSize.x/this._image.width,this._f32AnimFrameInfo[3]=this._frameSize.y/this._image.height);this._updateFrameCorner();if(this._autoResize&&this.sprite&&!this.isDefault){var a=
this.sprite.getScaleFactor();this.sprite.setSize(this._frameSize.x*a.x,this._frameSize.y*a.y)}};
Animation.prototype._updateFrameCorner=function(){var a=this._currentFrame%this._numCells.x,b=Math.floor(this._currentFrame/this._numCells.x);this._frameCorner.x=a*this._frameSize.x+this._image.width*this._imageArea.minX;this._frameCorner.y=b*this._frameSize.y+this._image.height*this._imageArea.minY;this._f32AnimFrameInfo&&(this._f32AnimFrameInfo[0]=a/this._numCells.x*(this._imageArea.maxX-this._imageArea.minX)+this._imageArea.minX,this._f32AnimFrameInfo[1]=b/this._numCells.y*(this._imageArea.maxY-
this._imageArea.minY)+this._imageArea.minY)};Animation.prototype.getF32AnimFrameInfo=function(){return this._f32AnimFrameInfo};Animation.prototype.getImage=function(){return this._image};Animation.prototype.mirror=function(){this._f32AnimFrameInfo&&(this._f32AnimFrameInfo[2]*=-1)};Animation.prototype.flip=function(){this._f32AnimFrameInfo&&(this._f32AnimFrameInfo[3]*=-1)};
function AssetLoader(){var a=this;this.loadingStatus={};this.loadedImages={};this.loadedAudio={};this.loadedJson={};this.loadedText={};this.loadedScripts={};this.loadedFonts={};this.attemptsCount={};this.pendingCallbacks={};this.maxAttempts=5;this.loadingRequests={scripts:0,json:0,text:0,images:0,audio:0,fonts:0};this.loadingSuccess={scripts:0,json:0,text:0,images:0,audio:0,fonts:0};this.loadingErrors={scripts:0,json:0,text:0,images:0,audio:0,fonts:0};this.loadingFailed={scripts:0,json:0,text:0,images:0,
audio:0,fonts:0};this.init=function(a){this.audioContext=wade.getWebAudioContext();var c;window.Audio&&(c=new Audio)?this.audioExtension=c.canPlayType("audio/ogg; codecs=vorbis")?"ogg":"aac":a||wade.log("Warning: Unable to initialise audio.")};this.updateAttempts=function(a,c){this.attemptsCount[a]?this.attemptsCount[a]++:(this.attemptsCount[a]=1,this.loadingRequests[c]++)};this.loadScript=function(b,c,d,e,f){if("loading"!=this.loadingStatus[b]||d){if("ok"==this.loadingStatus[b]||"loading"==this.loadingStatus[b]){if(!d){"ok"==
this.loadingStatus[b]&&setTimeout(function(){!f&&eval.call(window,a.loadedScripts[b]);c&&c(a.loadedScripts[b],b)},0);return}this.attemptsCount[b]=0}this.loadingStatus[b]="loading";this.updateAttempts(b,"scripts");d={cache:d?!1:!0,type:"GET",url:b,dataType:"script",timeout:15E3,success:this.scriptLoaded(b,c,!f),error:this.scriptLoadingError(b,c,d,e)};wade.ajax(d)}};this.loadJson=function(b,c,d,e,f){if("ok"==this.loadingStatus[b]||"loading"==this.loadingStatus[b]){if(!e){"ok"==this.loadingStatus[b]?
setTimeout(function(){c&&(c.data=a.loadedJson[b]);d&&d(a.loadedJson[b],b)},0):this.pendingCallbacks[b]?(d&&this.pendingCallbacks[b].success.push(d),f&&this.pendingCallbacks[b].error.push(f)):this.pendingCallbacks[b]={success:[d],error:[f]};return}this.attemptsCount[b]=0}this.loadingStatus[b]="loading";this.updateAttempts(b,"json");wade.ajax({cache:e?!1:!0,type:"GET",url:b,dataType:"json",timeout:15E3,success:this.jsonLoaded(b,c,d),error:this.jsonLoadingError(b,c,d,e,f)})};this.loadText=function(b,
c,d,e,f){if("ok"==this.loadingStatus[b]||"loading"==this.loadingStatus[b]){if(!e){"ok"==this.loadingStatus[b]?setTimeout(function(){c&&(c.data=a.loadedText[b]);d&&d(a.loadedText[b],b)},0):this.pendingCallbacks[b]?(d&&this.pendingCallbacks[b].success.push(d),f&&this.pendingCallbacks[b].error.push(f)):this.pendingCallbacks[b]={success:[d],error:[f]};return}this.attemptsCount[b]=0}this.loadingStatus[b]="loading";this.updateAttempts(b,"text");wade.ajax({cache:e?!1:!0,type:"GET",url:b,dataType:"text",
timeout:15E3,success:this.textLoaded(b,c,d),error:this.textLoadingError(b,c,d,e,f)})};this.loadAppScript=function(a,c){this.updateAttempts(a,"scripts");var d=this;wade.ajax({cache:c?!1:!0,type:"GET",url:a,dataType:"script",timeout:15E3,success:function(c){try{eval.call(window,c)}catch(f){wade.error("Main app script "+a+" is not a valid JavaScript file: "+f);d.appLoadingError(a);return}d.appLoaded(a)()},error:this.appLoadingError(a)})};this.loadImage=function(b,c,d){var e;if("ok"==this.loadingStatus[b])c&&
setTimeout(function(){c(a.loadedImages[b],b)},0);else if("loading"==this.loadingStatus[b]&&this.loadedImages[b])c&&this.loadedImages[b].addEventListener("load",c,!1),d&&this.loadedImages[b].addEventListener("error",d,!1);else{e=this.imageLoaded(b,c);d=this.imageLoadingError(b,c,d);this.loadingStatus[b]="loading";this.updateAttempts(b,"images");var f=new Image;f.crossOrigin="anonymous";this.loadedImages[b]=f;e&&f.addEventListener("load",e,!1);d&&f.addEventListener("error",d,!1);f.callbackIsSet=!!c;
f.src=b}};this.unloadImage=function(a){if("ok"!=this.loadingStatus[a])return!1;var c=this.loadedImages[a];c.removeEventListener("load",c.loadListener);c.removeEventListener("error",c.errorListener);c.src?c.src="data:image/gif;base64,R0lGODlhAQABAIAAAP7//wAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==":c.width=c.height=1;if(c=wade.getImageUsers(a))for(var d=0;d<c.length;d++)c[d].onImageUnloaded&&c[d].onImageUnloaded(a);wade.removeAllImageUsers(a);this.loadedImages[a]=null;this.loadingStatus[a]="";this.attemptsCount[a]=
0;return!0};this.releaseImageReference=function(a){"ok"==this.loadingStatus[a]&&(this.loadedImages[a]=null,this.loadingStatus[a]="",this.attemptsCount[a]=0)};this.unloadAllImages=function(){for(var a in this.loadedImages)this.loadedImages.hasOwnProperty(a)&&this.unloadImage(a)};this.imageLoaded=function(a,c){var d=this;return function(){d.loadingSuccess.images++;d.loadingStatus[a]="ok";window.wade&&wade.setImage(a,d.loadedImages[a]);d.handleLoadingCallback(c,d.loadedImages[a],a)}};this.imageLoadingError=
function(a,c,d){var e=this;return function(){e.loadingErrors.images++;e.loadingStatus[a]="error";e.attemptsCount[a]<e.maxAttempts?(d?d():wade.error("Unable to load image "+a),e.loadingFailed.images++):e.loadImage(a,c,d)}};this.setImage=function(a,c){c.imageName=a;(this.loadedImages[a]=c)&&(this.loadingStatus[a]="ok")};this.setJson=function(a,c){(this.loadedJson[a]=c)&&(this.loadingStatus[a]="ok")};this.setText=function(a,c){(this.loadedText[a]=c)&&(this.loadingStatus[a]="ok")};this.setAudio=function(a,
c,d){this.audioContext||(this.audioContext=wade.getWebAudioContext());if(c&&this.audioContext&&"string"==typeof c){for(var e=atob(c.split(",")[1]),f=new ArrayBuffer(e.length),g=new Uint8Array(f),i=0;i<e.length;i++)g[i]=e.charCodeAt(i);var h=this;this.audioContext.decodeAudioData(f,function(c){h.loadedAudio[a]=c;h.loadingStatus[a]="ok";d&&setTimeout(d,0)},function(){wade.log("Unable to decode audio file "+c)})}else(this.loadedAudio[a]=c)&&(this.loadingStatus[a]="ok"),d&&setTimeout(d,0)};this.setScript=
function(a,c){wade.isDebugMode()&&-1==c.indexOf("//# sourceURL")&&(c+="\n//# sourceURL=wade://wade.app/"+a);(this.loadedScripts[a]=c)&&(this.loadingStatus[a]="ok")};this.setFont=function(a,c){if(this.loadedFonts[a]=c)if(this.loadingStatus[a]="ok",!document.getElementById("__wade_font_"+a)){var d=Math.max(a.lastIndexOf("/"),a.lastIndexOf("\\"))+1,d=a.substr(d,a.lastIndexOf(".")-d),e=document.createElement("style");e.id="__wade_font_"+a;e.appendChild(document.createTextNode("@font-face {font-family: '"+
d+"';src: url('"+c+"') format('woff');}"));document.head.appendChild(e)}};this.jsonLoaded=function(a,c,d){var e=this;return function(f){e.loadingSuccess.json++;e.loadingStatus[a]="ok";e.loadedJson[a]=f;window.wade&&wade.setJson(a,e.loadedJson[a]);c&&(c.data=f);e.handleLoadingCallback(d,e.loadedJson[a],a)}};this.textLoaded=function(a,c,d){var e=this;return function(f){e.loadingSuccess.text++;e.loadingStatus[a]="ok";e.loadedText[a]=f;window.wade&&wade.setText(a,e.loadedText[a]);c&&(c.data=f);e.handleLoadingCallback(d,
e.loadedText[a],a)}};this.scriptLoaded=function(a,c,d){var e=this;return function(f){e.loadingSuccess.scripts++;e.loadingStatus[a]="ok";e.loadedScripts[a]=f;window.wade&&wade.setScript(a,e.loadedScripts[a]);d&&eval.call(window,f);e.handleLoadingCallback(c,e.loadedScripts[a],a)}};this.scriptLoadingError=function(a,c,d,e){var f=this;return function(){f.loadingErrors.scripts++;f.loadingStatus[a]="error";f.attemptsCount[a]<f.maxAttempts?(e?e():wade.error("Unable to load script "+a),f.loadingFailed.scripts++):
f.loadScript(a,c,d,e)}};this.jsonLoadingError=function(a,c,d,e,f){var g=this;return function(){g.loadingErrors.json++;g.loadingStatus[a]="error";g.attemptsCount[a]<g.maxAttempts?(g.handleErrorCallback(a,f,"Unable to load json file"),g.loadingFailed.json++):g.loadJson(a,c,d,e,f)}};this.textLoadingError=function(a,c,d,e,f){var g=this;return function(){g.loadingErrors.text++;g.loadingStatus[a]="error";g.attemptsCount[a]<g.maxAttempts?(g.handleErrorCallback(a,f,"Unable to load text file"),g.loadingFailed.text++):
g.loadText(a,c,d,e,f)}};this.appLoaded=function(a){var c=this;return function(){c.loadingSuccess.scripts++;c.loadingStatus[a]="ok";wade.instanceApp()}};this.appLoadingError=function(a){var c=this;return function(){c.loadingErrors.scripts++;c.loadingStatus[a]="error";c.attemptsCount[a]<c.maxAttempts?(wade.error("Unable to load main app script "+a),c.loadingFailed.scripts++):c.loadAppScript(a)}};this.loadAudio=function(a,c,d,e,f){if("ok"==this.loadingStatus[a]||"loading"==this.loadingStatus[a]){if("ok"==
this.loadingStatus[a]){var g=this;g.loadedAudio[a]&&(g.loadedAudio[a].autoplay=c,g.loadedAudio[a].loop=d);c&&g.audioContext&&wade.playAudio(a,d);e&&e(g.loadedAudio[a],a)}}else{this.loadingStatus[a]="loading";this.updateAttempts(a,"audio");var i=a.substr(a.length-3).toLowerCase(),h=a;if(i!=this.audioExtension&&("aac"==i||"ogg"==i))h=a.substr(0,a.length-3)+this.audioExtension;if(this.audioContext){var g=this,k=new XMLHttpRequest;k.open("GET",h,!0);k.responseType="arraybuffer";k.timeout=6E4;k.onload=
function(){g.audioContext.decodeAudioData(k.response,function(f){g.loadedAudio[a]=f;g.audioLoaded(a,e)();c&&wade.playAudio(a,d)},g.audioLoadingError(a,c,d,e,f))};k.send()}else i=new Audio,i.autoplay=c,i.loop=d,i.name=a,i.addEventListener("canplaythrough",this.audioLoaded(a,e),!1),i.addEventListener("error",this.audioLoadingError(a,c,d,e,f),!1),d&&i.addEventListener("ended",function(){this.currentTime=0;this.play()},!1),i.src=h,i.load(),this.loadedAudio[a]=i}};this.unloadAudio=function(a){if("ok"!=
this.loadingStatus[a])return!1;this.loadedAudio[a]=null;this.loadingStatus[a]="";this.attemptsCount[a]=0;return!0};this.unloadAllAudio=function(){for(var a in this.loadedAudio)this.loadedAudio.hasOwnProperty(a)&&this.unloadAudio(a)};this.audioLoaded=function(a,c){var d=this;return function(){"ok"!=d.loadingStatus[a]&&(d.loadingSuccess.audio++,window.wade&&wade.setAudio(a,d.loadedAudio[a]),d.loadingStatus[a]="ok",d.handleLoadingCallback(c,d.loadedAudio[a],a))}};this.audioLoadingError=function(a,c,
d,e,f){var g=this;return function(){g.loadingErrors.audio++;g.loadingStatus[a]="error";g.attemptsCount[a]<g.maxAttempts?(f?f():wade.error("Unable to load audio "+a),g.loadingFailed.audio++):g.loadAudio(a,c,d,e,f)}};this.isFinishedLoading=function(){return this.loadingRequests.scripts==this.loadingSuccess.scripts+this.loadingFailed.scripts&&this.loadingRequests.json==this.loadingSuccess.json+this.loadingFailed.json&&this.loadingRequests.text==this.loadingSuccess.text+this.loadingFailed.text&&this.loadingRequests.images==
this.loadingSuccess.images+this.loadingFailed.images&&this.loadingRequests.audio==this.loadingSuccess.audio+this.loadingFailed.audio&&this.loadingRequests.fonts==this.loadingSuccess.fonts+this.loadingFailed.fonts};this.getPercentageComplete=function(){return 100*(this.loadingSuccess.scripts+this.loadingSuccess.json+this.loadingSuccess.text+this.loadingSuccess.images+this.loadingSuccess.audio)/(this.loadingRequests.scripts+this.loadingRequests.json+this.loadingRequests.text+this.loadingRequests.images+
this.loadingRequests.audio)};this.getImage=function(a,c){if("ok"==this.loadingStatus[a])return this.loadedImages[a];"undefined"==typeof c&&(c="Warning: Trying to get image "+a+" without loading it first");c&&wade.warn(c);return wade.getImage()};this.getJson=function(a){if("ok"==this.loadingStatus[a])return this.loadedJson[a];wade.warn("Warning: Trying to get JSON data "+a+" without loading it first");return{}};this.getText=function(a){if("ok"==this.loadingStatus[a])return this.loadedText[a];wade.warn("Warning: Trying to get text data "+
a+" without loading it first");return""};this.getAudio=function(a){if("ok"==this.loadingStatus[a])return this.loadedAudio[a];wade.warn("Warning: Trying to get audio "+a+" without loading it first");return new Audio};this.getScript=function(a){if("ok"==this.loadingStatus[a])return this.loadedScripts[a];wade.warn("Warning: Trying to get script "+a+" without loading it first");return""};this.getFont=function(a){if("ok"==this.loadingStatus[a])return this.loadedFonts[a];wade.warn("Warning: Trying to get font "+
a+" without loading it first");return""};this.getLoadingStatus=function(a){return(a=this.loadingStatus[a])?a:"unknown"};this.setGlobalCallback=function(a){a&&this.isFinishedLoading()?(a(),this.globalCallback=0):this.globalCallback=a};this.handleLoadingCallback=function(a,c,d){a&&a(c,d);if(this.pendingCallbacks[d]&&this.pendingCallbacks[d].success){for(a=0;a<this.pendingCallbacks[d].success.length;a++)this.pendingCallbacks[d].success[a]&&this.pendingCallbacks[d].success[a](c,d);delete this.pendingCallbacks[d]}this.globalCallback&&
this.isFinishedLoading()&&(this.globalCallback(),this.setGlobalCallback(null))};this.handleErrorCallback=function(a,c,d){c?c():wade.error(d+" "+a);if(this.pendingCallbacks[a]&&this.pendingCallbacks[a].error){for(c=0;c<this.pendingCallbacks[a].error.length;c++)this.pendingCallbacks[a].error[c]&&this.pendingCallbacks[a].error[c](data,a);delete this.pendingCallbacks[a]}};this.loadFont=function(a,c,d){if("ok"==this.loadingStatus[a])c&&c(this.loadedFonts[a],a);else if("loading"!=this.loadingStatus[a])if(this.loadingStatus[a]=
"loading",this.updateAttempts(a,"fonts"),!window.FileReader||!window.XMLHttpRequest)wade.log("It isn't possible to load fonts dynamically in this environment, because it lacks support for some HTML5 features"),this.fontLoaded(a,c)();else{var e=Math.max(a.lastIndexOf("/"),a.lastIndexOf("\\"))+1,f=a.substr(e,a.lastIndexOf(".")-e),e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="blob";var g=this;e.onload=function(){if(this.status&&200!=this.status||!this.response)g.fontLoadingError(a,c,d);else{var e=
this.response,h=new FileReader;h.onloadend=function(){var e=document.createElement("style");e.id="__wade_font_"+f;e.appendChild(document.createTextNode("@font-face {font-family: '"+f+"';src: url('"+h.result+"') format('woff');}"));document.head.appendChild(e);var j=document.createElement("span");j.innerHTML="giItT1WQy@!-/#";j.style.position="absolute";j.style.left="-10000px";j.style.top="-10000px";j.style.fontSize="300px";j.style.fontFamily="sans-serif";j.style.fontVariant="normal";j.style.fontStyle=
"normal";j.style.fontWeight="normal";j.style.letterSpacing="0";document.body.appendChild(j);var i=j.offsetWidth;j.style.fontFamily=f;var m,q=0;m=setInterval(function(){if(j&&j.offsetWidth!=i)return j.parentNode.removeChild(j),j=null,clearInterval(m),g.loadedFonts[a]=h.result,g.fontLoaded(a,c)(),!0;if(15E3<(q+=50))clearInterval(m),g.fontLoadingError(a,c,d)();return!1},50)};h.readAsDataURL(e)}};e.send()}};this.fontLoaded=function(a,c){var d=this;return function(){"ok"!=d.loadingStatus[a]&&(d.loadingSuccess.fonts++,
d.loadingStatus[a]="ok",window.wade&&wade.setFont(a,d.loadedFonts[a]),d.handleLoadingCallback(c,d.loadedFonts[a],a))}};this.fontLoadingError=function(a,c,d){var e=this;return function(){e.loadingErrors.fonts++;e.loadingStatus[a]="error";e.attemptsCount[a]<e.maxAttempts?(d?d():wade.error("Unable to load font "+a),e.loadingFailed.fonts++):e.loadFont(a,c,d)}}}
function InputManager(){var a=this,b=0,c=0,d,e=[],f=[],g=[],i=[],h=[],k=[],j=5,l={},m=[],q=[],u=[],x="",p=!1,r=!1,n=!0,t=1,w=3,y,v={},z={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps_lock",27:"esc",32:"space",33:"page_up",34:"page_down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"print_screen",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",
74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"num_zero",97:"num_one",98:"num_two",99:"num_three",100:"num_four",101:"num_five",102:"num_six",103:"num_seven",104:"num_eight",105:"num_nine",106:"num_multiply",107:"num_plus",109:"num_minus",110:"num_period",111:"num_division",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",186:"semicolon",187:"plus",189:"minus",
192:"back_tick",222:"single_quote"},F={},A;for(A in z)F[z[A]]=parseInt(A);var G=function(a,b){"string"==typeof b&&(b=document.getElementById(b));if(null==b)return{x:0,y:0};var c;c=(c=a)?c:window.event;c=isNaN(window.scrollX)?{x:document.documentElement.scrollLeft+document.body.scrollLeft+c.clientX,y:document.documentElement.scrollTop+document.body.scrollTop+c.clientY}:{x:window.scrollX+c.clientX,y:window.scrollY+c.clientY};c.x-=b.offsetLeft+b.clientLeft+b.clientWidth/2;c.y-=b.offsetTop+b.clientTop+
b.clientHeight/2;c.x*=b.getAttribute("width")/b.clientWidth;c.y*=b.getAttribute("height")/b.clientHeight;if(wade.isScreenRotated()){var d=c.y;c.y=-c.x;c.x=d}return c},s=function(a){n&&(a=a?a:window.event,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault(),a.returnValue=!1,a.cancel=!0,a.cancelBubble=!0)};this.init=function(){if(!r){y=wade.getContainerName();var a=document.getElementById(y);a.addEventListener("mousedown",this.event_mouseDown);window.addEventListener("mouseup",
this.event_mouseUp);a.addEventListener("mousemove",this.event_mouseMove);a.addEventListener("mousewheel",this.event_mouseWheel);a.addEventListener("click",this.noEvent);a.addEventListener("dblclick",this.noEvent);a.addEventListener("contextmenu",this.noEvent);a.addEventListener("DOMMouseScroll",this.event_mouseWheel);window.addEventListener("touchstart",this.event_touchStart);window.addEventListener("touchend",this.event_touchEnd);window.addEventListener("touchmove",this.event_touchMove);window.addEventListener("keydown",
this.event_keyDown);window.addEventListener("keyup",this.event_keyUp);window.addEventListener("keypress",this.event_keyPress);window.addEventListener("blur",this.event_blur);window.addEventListener("focus",this.event_focus);navigator.msPointerEnabled&&(a.addEventListener("MSPointerDown",this.event_pointerDown),a.addEventListener("MSPointerMove",this.event_pointerMove),a.addEventListener("MSPointerUp",this.event_pointerUp));window.tizen&&(window.addEventListener("tizenhwkey",function(a){"back"==a.keyName&&
tizen.application.getCurrentApplication().exit()}),window.onblur=function(){wade.deleteCanvases()},window.onfocus=function(){wade.recreateCanvases()});window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this.event_deviceOrientation,!1);window.DeviceMotionEvent&&window.addEventListener("devicemotion",this.event_deviceMotion,!1);r=!0}};this.deinit=function(){if(r){var a=document.getElementById(y);a.removeEventListener("mousedown",this.event_mouseDown);window.removeEventListener("mouseup",
this.event_mouseUp);a.removeEventListener("mousemove",this.event_mouseMove);a.removeEventListener("mousewheel",this.event_mouseWheel);a.removeEventListener("click",this.noEvent);a.removeEventListener("dblclick",this.noEvent);a.removeEventListener("contextmenu",this.noEvent);a.removeEventListener("DOMMouseScroll",this.event_mouseWheel);window.removeEventListener("touchstart",this.event_touchStart);window.removeEventListener("touchend",this.event_touchEnd);window.removeEventListener("touchmove",this.event_touchMove);
window.removeEventListener("keydown",this.event_keyDown);window.removeEventListener("keyup",this.event_keyUp);window.removeEventListener("keypress",this.event_keyPress);window.removeEventListener("blur",this.event_blur);window.removeEventListener("focus",this.event_focus);navigator.msPointerEnabled&&(a.removeEventListener("MSPointerDown",this.event_pointerDown),a.removeEventListener("MSPointerMove",this.event_pointerMove),a.removeEventListener("MSPointerUp",this.event_pointerUp));window.tizen&&(window.removeEventListener("tizenhwkey"),
window.onblur=window.onfocus=null);window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this.event_deviceOrientation);window.DeviceMotionEvent&&window.removeEventListener("deviceorientation",this.event_deviceMotion);r=!1}};this.enableGamepads=function(a){"undefined"==typeof a&&(a=!0);if(a)if(wade.areGamepadsSupported()){var b=navigator.getGamepads||navigator.webkitGetGamepads;wade.setMainLoop(function(){for(var a=b.call(navigator),c=0;c<a.length;c++){var d=a[c];q[c]||(q[c]=
[]);if(d)for(var e=0;e<d.buttons.length;e++){if(q[c][e]&&d.buttons[e].pressed!=q[c][e].pressed){var f=d.buttons[e].pressed?"onGamepadButtonDown":"onGamepadButtonUp",p={gamepadIndex:d.index,gamepadId:d.id,button:e};wade.app&&wade.isAppInitialized()&&!wade.processEvent(f,p)&&wade.app[f]&&wade.app[f](p)}q[c][e]={pressed:d.buttons[e].pressed,value:d.buttons[e].value}}}m=a},"__wade_gamepads")}else wade.log("Warning - Gamepads aren't supported in this browser");else wade.setMainLoop(null,"__wade_gamepads")};
this.getGamepadData=function(){return m};this.event_mouseDown=function(c){var j={screenPosition:G(c,y),shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,meta:c.metaKey};if(Math.abs(j.screenPosition.x)>wade.getScreenWidth()/2||Math.abs(j.screenPosition.y)>wade.getScreenHeight()/2)return!1;a._setLastMousePosition(j.screenPosition.x,j.screenPosition.y);var g=(new Date).getTime();if(!p&&f.mouseDown&&e.mouseDown&&g-e.mouseDown<f.mouseDown||!p&&f.mouseUp&&e.mouseUp&&g-e.mouseUp<f.mouseUp)return!1;if(p||!b){b=
p?b+1:!0;h.push({x:j.screenPosition.x,y:j.screenPosition.y});j.button=c.button;j.pointerId=c.pointerId||0;k[j.button]=1;d=c;if(wade.app&&(wade.isAppInitialized()&&!wade.processEvent("onMouseDown",j))&&wade.app.onMouseDown)wade.app.onMouseDown(j);s(c);e.mouseDown=g;u.length=0;x="";u.push({x:j.screenPosition.x,y:j.screenPosition.y})}return!1};this.event_mouseUp=function(c){var g={screenPosition:G(c,y),shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,meta:c.metaKey};if(Math.abs(g.screenPosition.x)>wade.getScreenWidth()/
2||Math.abs(g.screenPosition.y)>wade.getScreenHeight()/2)return!1;a._setLastMousePosition(g.screenPosition.x,g.screenPosition.y);var i=(new Date).getTime();if(!p&&f.mouseUp&&e.mouseUp&&i-e.mouseUp<f.mouseUp)return!1;if(p||b){b=p?b-1:!1;g.button=c.button;g.pointerId=c.pointerId||0;k[g.button]=0;d=c;if(h.length){for(var r=0;r<h.length;r++){var n=g.screenPosition.x-h[r].x,l=g.screenPosition.y-h[r].y;if(n*n+l*l<=j*j){a.event_click(g);break}}h.length--}if(wade.app&&(wade.isAppInitialized()&&!wade.processEvent("onMouseUp",
g))&&wade.app.onMouseUp)wade.app.onMouseUp(g);!e.mouseUp&&(navigator&&navigator.userAgent.match(/(iPod|iPhone|iPad)/)&&navigator.userAgent.match(/AppleWebKit/))&&wade.playSilentSound();s(c);e.mouseUp=i;u.length=0;x=""}return!1};this.event_mouseMove=function(b){var c={screenPosition:G(b,y),shift:b.shiftKey,ctrl:b.ctrlKey,alt:b.altKey,meta:b.metaKey};if(Math.abs(c.screenPosition.x)>wade.getScreenWidth()/2||Math.abs(c.screenPosition.y)>wade.getScreenHeight()/2)return!1;a._setLastMousePosition(c.screenPosition.x,
c.screenPosition.y);var j=(new Date).getTime();if(!p&&f.mouseMove&&e.mouseMove&&j-e.mouseMove<f.mouseMove)return!1;c.pointerId=b.pointerId||0;d=b;if(wade.app&&(wade.isAppInitialized()&&!wade.processEvent("onMouseMove",c))&&wade.app.onMouseMove)wade.app.onMouseMove(c);e.mouseMove=j;s(b);a.isMouseDown()&&(u.push({x:c.screenPosition.x,y:c.screenPosition.y}),a.detectGestures())};this.event_mouseWheel=function(b){var b=b?b:window.event,c={screenPosition:G(b,y),shift:b.shiftKey,ctrl:b.ctrlKey,alt:b.altKey,
meta:b.metaKey};if(Math.abs(c.screenPosition.x)>wade.getScreenWidth()/2||Math.abs(c.screenPosition.y)>wade.getScreenHeight()/2)return!1;a._setLastMousePosition(c.screenPosition.x,c.screenPosition.y);var j=(new Date).getTime();if(p||!f.mouseWheel||!(e.mouseWheel&&j-e.mouseWheel<f.mouseWheel)){c.value=b.detail?-1*b.detail:b.wheelDelta/40;d=c;if(wade.app&&(wade.isAppInitialized()&&!wade.processEvent("onMouseWheel",c))&&wade.app.onMouseWheel)wade.app.onMouseWheel(c);e.mouseWheel=j;s(b)}};this.event_click=
function(a){var b=(new Date).getTime();if(p||!f.onClick||!(e.onClick&&b-e.onClick<f.onClick)){if(wade.app&&(wade.isAppInitialized()&&!wade.processEvent("onClick",a))&&wade.app.onClick)wade.app.onClick(a);e.onClick=b}};this.event_touchStart=function(b){for(var d=b.touches||i,e=0;e<d.length;e++)d[e].pointerId="undefined"==typeof d[e].pointerId?d[e].identifier:d[e].pointerId;if(2==d.length){var e=d[0].pageX-d[1].pageX,f=d[0].pageY-d[1].pageY;c=Math.sqrt(e*e+f*f);p&&a.event_mouseDown(d[1])}else 1==d.length?
a.event_mouseDown(d[0]):p&&a.event_mouseDown(d[d.length-1]);s(b)};this.event_touchEnd=function(b){if(b.changedTouches&&b.changedTouches.length)for(var c=0;c<b.changedTouches.length;c++)b.changedTouches[c].pointerId="undefined"==typeof b.changedTouches[c].pointerId?b.changedTouches[c].identifier:b.changedTouches[c].pointerId,a.event_mouseUp(b.changedTouches[c]);else a.event_mouseUp(d);s(b)};this.event_touchMove=function(b){var d;d=b.touches||i;if(2==d.length){var e=d[0].pageX-d[1].pageX,f=d[0].pageY-
d[1].pageY;if(e=Math.sqrt(e*e+f*f))f=c-e,Math.abs(f)>wade.c_epsilon&&(f=-30*f/Math.max(wade.getScreenWidth(),wade.getScreenHeight()),a.event_mouseWheel({clientX:d[0].pageX,clientY:d[0].pageY,detail:-f}));c=e;if(p&&b.changedTouches)for(d=0;d<b.changedTouches.length;d++)a.event_mouseMove({clientX:b.changedTouches[d].pageX,clientY:b.changedTouches[d].pageY,pointerId:b.changedTouches[d].identifier})}else if(1==d.length)a.event_mouseMove({clientX:d[0].pageX,clientY:d[0].pageY,pointerId:d[0].identifier});
else if(p&&b.changedTouches)for(d=0;d<b.changedTouches.length;d++)a.event_mouseMove({clientX:b.changedTouches[d].pageX,clientY:b.changedTouches[d].pageY,pointerId:b.changedTouches[d].identifier});s(b)};this.event_keyDown=function(a){var b={keyCode:"which"in a?a.which:a.keyCode,shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey,meta:a.metaKey};v[b.keyCode]?s(a):(b.keyName=z[b.keyCode],v[b.keyCode]=!0,wade.app&&wade.isAppInitialized()&&!wade.processEvent("onKeyDown",b)?wade.app.onKeyDown&&wade.app.onKeyDown(b)&&
s(a):s(a))};this.event_keyUp=function(a){var b={keyCode:"which"in a?a.which:a.keyCode,shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey,meta:a.metaKey};b.keyName=z[b.keyCode];v[b.keyCode]=!1;wade.app&&wade.isAppInitialized()&&!wade.processEvent("onKeyUp",b)?wade.app.onKeyUp&&wade.app.onKeyUp(b)&&s(a):s(a)};this.event_keyPress=function(a){var b={charCode:"charCode"in a?a.charCode:a.keyCode};b.charName=String.fromCharCode(b.charCode);wade.app&&wade.isAppInitialized()&&!wade.processEvent("onKeyPress",b)?
wade.app.onKeyPress&&wade.app.onKeyPress(b)&&s(a):s(a)};this.isKeyDown=function(a){return"string"==typeof a?!!v[this.getKeyCode(a)]:!!v[a]};this.event_pointerDown=function(b){g[b.pointerId]||(g[b.pointerId]=1,i.push({pageX:b.pageX,pageY:b.pageY,clientX:b.clientX,clientY:b.clientY,pointerId:b.pointerId}),a.event_touchStart(b))};this.event_pointerUp=function(b){if(g[b.pointerId]){for(var c=0;c<i.length;c++)if(i[c].pointerId==b.pointerId){wade.removeObjectFromArrayByIndex(c,i);break}g[b.pointerId]=0;
a.event_touchEnd({changedTouches:[b]})}};this.event_pointerMove=function(b){if(g[b.pointerId]){for(var c=0;c<i.length;c++)if(i[c].pointerId==b.pointerId){i[c].pageX=b.pageX;i[c].pageY=b.pageY;i[c].clientX=b.clientX;i[c].clientY=b.clientY;i[c].identifier=b.pointerId;b.changedTouches=[i[c]];break}a.event_touchMove(b)}};this.event_deviceMotion=function(a){if(a.acceleration&&null!==a.acceleration.x){var b={acceleration:a.acceleration,accelerationIncludingGravity:a.accelerationIncludingGravity,rotation:a.rotationRate,
refreshInterval:a.interval};wade.app&&wade.isAppInitialized()&&!wade.processEvent("onDeviceMotion",b)?wade.app.onDeviceMotion&&wade.app.onDeviceMotion(b)&&s(a):s(a)}};this.event_deviceOrientation=function(a){if(null!==a.alpha){var b={alpha:a.alpha,beta:a.beta,gamma:a.gamma};wade.app&&wade.isAppInitialized()&&!wade.processEvent("onDeviceOrientation",b)?wade.app.onDeviceOrientation&&wade.app.onDeviceOrientation(b)&&s(a):s(a)}};this.event_gamepadConnected=function(a){wade.app.onGamepadConnected&&wade.app.onGamepadConnected({gamepadId:a.gamepad.id})};
this.event_gamepadDisconnected=function(a){wade.app.onGamepadDisconnected&&wade.app.onGamepadDisconnected({gamepadId:a.gamepad.id})};this.event_blur=function(a){var b={};wade.app&&wade.isAppInitialized()&&!wade.processEvent("onBlur",b)?wade.app.onBlur&&wade.app.onBlur(b)&&s(a):s(a)};this.event_focus=function(a){var b={};wade.app&&wade.isAppInitialized()&&!wade.processEvent("onFocus",b)?wade.app.onFocus&&wade.app.onFocus(b)&&s(a):s(a)};this.noEvent=function(a){s(a)};this.isMouseDown=function(a){return"undefined"==
typeof a?!!b:!!k[a]};this.setMinimumIntervalBetweenEvents=function(a,b){f[a]=b};this.setClickTolerance=function(a){j=a};this.getMousePosition=function(){return{x:l.x,y:l.y}};this.enableMultitouch=function(a){p=a};this.isMultitouchEnabled=function(){return p};this.cancelEvents=function(a){"undefined"==typeof a&&(a=!0);n=a};this._setLastMousePosition=function(a,b){if(a!=l.x||b!=l.y)wade.updateMouseInOut(l,{x:a,y:b}),l.x=a,l.y=b};this.detectGestures=function(){var a=0,b=0,c=0,d=0;if(!x&&u.length<3*w){for(var e=
1;e<u.length&&!x;e++){var f=u[e].x-u[e-1].x||wade.c_epsilon,p=u[e].y-u[e-1].y||wade.c_epsilon,j=f/Math.abs(p),f=p/Math.abs(f);-1>j&&Math.abs(f)<=t&&++a==w&&!b&&!c&&!d?x="onSwipeLeft":1<j&&Math.abs(f)<=t&&++b==w&&!a&&!c&&!d?x="onSwipeRight":-1>f&&Math.abs(j)<=t&&++c==w&&!a&&!b&&!d?x="onSwipeUp":1<f&&(Math.abs(j)<=t&&++d==w&&!a&&!c&&!b)&&(x="onSwipeDown")}if(x&&(a=u[0],a={screenPosition:{x:a.x,y:a.y},screenPositions:u},wade.app&&(wade.isAppInitialized()&&!wade.processEvent(x,a))&&wade.app[x]))wade.app[x](a)}};
this.setSwipeTolerance=function(a,b){t=a;w=b};this.getKeyName=function(a){return z[a]};this.getKeyCode=function(a){return F[a]}}
function Layer(a,b){this.id=a;this._sprites=[];this._spriteUidCounter=0;this._movingSprites=[];this._transform={scale:1,translate:1};this._sorting="none";this._dirtyAreas=[];this._smoothing=this._clearCanvas=this._needsFullRedraw=!0;this._resolutionFactor=wade.getResolutionFactor();this._cameraPosition=wade.getCameraPosition();this._useQuadtree=!0;this._opacity=1;this._maxBatchSize=256;this._minBatchSize=4;this._batchSize=0;this._spriteBatch=Array(this._maxBatchSize);this._invisibleSprites=[];this._batchedBufferBound=
!1;this._batchingEnabled=!0;this._postProcessUniforms={};this._postProcessShaderProgram=null;this._customProperties={};this._blur=0;this._alwaysUpdateBlur=!1;this._renderMode=b||"webgl";"webgl"==this._renderMode&&!wade.isWebGlSupported()&&(this._renderMode="2d",wade.log("WebGL is not supported in this environment, layer "+a+" is falling back to a canvas-based renderer."));this._useOffScreenTarget=!1;this._alwaysDrawSprites=[];this._updateScaleConversionFactor();try{this._f32ViewportSize=new Float32Array([0,
0]),this._f32CameraScaleTranslateTime=new Float32Array([0,0,0,0])}catch(c){}this.initCanvas();var d=wade.getScreenWidth()/2,e=wade.getScreenHeight()/2;this._worldBounds={minX:-d,minY:-e,maxX:d,maxY:e};this._initQuadTree()}Layer.prototype.getScaleFactor=function(){return this._transform.scale};Layer.prototype.getTranslateFactor=function(){return this._transform.translate};
Layer.prototype.setTransform=function(a,b){this._transform.scale=a;this._transform.translate=b;this._updateScaleConversionFactor();this._needsFullRedraw=!0};Layer.prototype.getSorting=function(){return this._sorting};
Layer.prototype.setSorting=function(a){if(a!=this._sorting){this._sorting=a;switch(a){case "bottomToTop":this._sortingFunction=this._spriteSorter_bottomToTop;break;case "topToBottom":this._sortingFunction=this._spriteSorter_topToBottom;break;case "none":this._sortingFunction=0;break;default:this._sortingFunction=a}this._needsFullSorting=!0}};Layer.prototype.clearDirtyAreas=function(){this._dirtyAreas.length=0;this._needsFullRedraw=!1};
Layer.prototype.addDirtyArea=function(a){this._dirtyAreas.push({minX:a.minX,maxX:a.maxX,minY:a.minY,maxY:a.maxY})};Layer.prototype.addAlwaysDrawSprite=function(a){this._alwaysDrawSprites.push(a)};Layer.prototype.removeAlwaysDrawSprite=function(a){wade.removeObjectFromArray(a,this._alwaysDrawSprites)};
Layer.prototype.addSprite=function(a){this._sprites.push(a);a.id=++this._spriteUidCounter;wade.expandBox(this._worldBounds,a.boundingBox);this._useQuadtree&&(this.addDirtyArea(a.boundingBox),this._addSpriteToQuadTree(a));a.isAlwaysDrawing()&&this.addAlwaysDrawSprite(a);this._needsFullSorting=!0};Layer.prototype.getSpriteCount=function(){return this._sprites.length+this._alwaysDrawSprites.length};
Layer.prototype.removeSprite=function(a){wade.removeObjectFromArray(a,this._sprites);this._useQuadtree&&a.quadTreeNode&&(this.addDirtyArea(a.boundingBox),a.quadTreeNode.removeObject(a),a.quadTreeNode=0);a.isAlwaysDrawing()&&this.removeAlwaysDrawSprite(a)};Layer.prototype.hasAnythingChanged=function(){return!(0==this._dirtyAreas.length&&!this._needsFullRedraw&&this._useQuadtree&&!this._alwaysDrawSprites.length)};
Layer.prototype.draw=function(a){var b,c;if(this._canvas){if(!a&&!this.hasAnythingChanged()){if(!wade.isSharedCanvas(this._canvas))return;if(this._useOffScreenTarget){this.clearDirtyAreas();"webgl"==this._renderMode&&this.drawRenderTargetToScreen();return}}!this._useOffScreenTarget&&"webgl"==this._renderMode&&(this._needsFullRedraw=!0);"webgl"==this._renderMode&&!wade.isWebGlSupported()&&(this._renderMode="2d");var d=this._context,e=wade.getScreenWidth()*this._resolutionFactor,f=wade.getScreenHeight()*
this._resolutionFactor,g=e/2,i=f/2;if("none"!=this._sorting)if(this._needsFullSorting=this._needsFullSorting||this._movingSprites.length*this._movingSprites.length>this._sprites.length)this._sprites.sort(this._sortingFunction);else for(b=0;b<this._movingSprites.length;b++){var h=0,k=this._movingSprites[b];for(c=0;c<this._sprites.length&&k!=this._sprites[c];c++);if(c<this._sprites.length){for(a=c+1;a<this._sprites.length;a++)if(0<this._sortingFunction(k,this._sprites[a]))this._sprites[a].setDirtyArea(),
this._sprites[a-1]=this._sprites[a],this._sprites[a]=k,h++;else break;if(!h)for(a=c-1;0<=a;a--)if(0>this._sortingFunction(k,this._sprites[a]))this._sprites[a].setDirtyArea(),this._sprites[a+1]=this._sprites[a],this._sprites[a]=k,h++;else break}}this._needsFullSorting=!1;this._movingSprites.length=0;"webgl"==this._renderMode&&(d.bindFramebuffer(d.FRAMEBUFFER,this._useOffScreenTarget?this._mainRenderTarget:null),d.uniform2fv(d.currentShader.uniforms.uViewportSize,this._f32ViewportSize),d.uniform4fv(d.currentShader.uniforms.uCameraScaleTranslateTime,
this._f32CameraScaleTranslateTime));if(this._useQuadtree){b=this.canvasBoxToWorld({minX:-g,minY:-i,maxX:g,maxY:i});this._needsFullRedraw?(a=this._scaleConversionFactor,c=g-this._cameraPosition.x*this._transform.translate*a,h=i-this._cameraPosition.y*this._transform.translate*a,"2d"==this._renderMode?(d.restore(),d.save(),d.setTransform(a,0,0,a,Math.round(c),Math.round(h))):"webgl"==this._renderMode&&(this._f32CameraScaleTranslateTime[0]=a,this._f32CameraScaleTranslateTime[1]=this._cameraPosition.x*
this._transform.translate*a,this._f32CameraScaleTranslateTime[2]=this._cameraPosition.y*this._transform.translate*a,this._f32CameraScaleTranslateTime[3]=wade.getAppTime(),d.uniform4fv(d.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime)),h=wade.cloneObject(b)):h=this._joinDirtyAreas();if(!h){this.clearDirtyAreas();"webgl"==this._renderMode&&this._useOffScreenTarget&&this.drawRenderTargetToScreen();return}for(a=0;a<this._sprites.length;a++)this._sprites[a].needsDrawing=
0;for(a=0;a.minX!=h.minX||a.minY!=h.minY||a.maxX!=h.maxX||a.maxY!=h.maxY;){if(isNaN(h.minX)||isNaN(h.minY)||isNaN(h.maxX)||isNaN(h.maxY)){wade.warn("Warning: it isn't possible to render this frame");a=wade.getCameraPosition();(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))&&wade.warn("*** Invalid camera coodinates: "+a.x+", "+a.y+", "+a.z);for(a=0;a<this._sprites.length;a++)if(d=this._sprites[a].getPosition(),f=this._sprites[a].getSize(),g=isNaN(d.x)||isNaN(d.y),i=isNaN(f.x)||isNaN(f.y),g||i){c=(e=this._sprites[a].getSceneObject())&&
e.getName()||"";b=this._sprites[a].getName();if(!b)if(e)for(h=0;h<e.getSpriteCount();h++){if(e.getSprite(h)==this._sprites[a]){b="Sprite"+h;break}}else b="Unnamed Sprite";e=(c?c+".":"")+b;g&&wade.warn("*** "+e+" has an invalid position: "+d.x+", "+d.y);i&&wade.warn("*** "+e+" has an invalid size: "+f.x+", "+f.y)}return}this._quadTree.flagObjects(h,"needsDrawing");a=wade.cloneObject(h);for(c=0;c<this._sprites.length;c++)(this._sprites[c].needsDrawing||this._sprites[c].isAlwaysDrawing)&&this._sprites[c].isVisible()&&
wade.expandBox(h,this._sprites[c].boundingBox);wade.clampBoxToBox(h,b)}this._clearCanvas&&("2d"==this._renderMode?(d.save(),d.setTransform(1,0,0,1,0,0),this._needsFullRedraw?d.clearRect(0,0,Math.round(e),Math.round(f)):(a=this.worldBoxToCanvas(h),d.clearRect(Math.floor(a.minX+g-1),Math.floor(a.minY+i-1),Math.ceil(a.maxX-a.minX+2),Math.ceil(a.maxY-a.minY+2))),d.restore()):"webgl"==this._renderMode&&(this._needsFullRedraw?d.clear(d.COLOR_BUFFER_BIT):(a=this.worldBoxToCanvas(h),d.enable(d.SCISSOR_TEST),
d.scissor(Math.floor(a.minX+g-1),f-Math.floor(a.minY+i-1)-Math.ceil(a.maxY-a.minY+2),Math.ceil(a.maxX-a.minX+2),Math.ceil(a.maxY-a.minY+2)),d.clear(d.COLOR_BUFFER_BIT),d.disable(d.SCISSOR_TEST))));this.clearDirtyAreas();"2d"==this._renderMode?this._canvas.style.opacity!=this._opacity&&(this._canvas.style.opacity=this._opacity):1!=this._canvas.style.opacity&&(this._canvas.style.opacity=1);this._drawSprites(!0)}else a=this._scaleConversionFactor,c=g-this._cameraPosition.x*this._transform.translate*
a,h=i-this._cameraPosition.y*this._transform.translate*a,"webgl"==this._renderMode?(this._hasOwnCanvas&&d.clear(d.COLOR_BUFFER_BIT),this._f32CameraScaleTranslateTime[0]=a,this._f32CameraScaleTranslateTime[1]=this._cameraPosition.x*this._transform.translate*a,this._f32CameraScaleTranslateTime[2]=this._cameraPosition.y*this._transform.translate*a,d.uniform4fv(d.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime)):"2d"==this._renderMode&&(d.save(),d.setTransform(1,0,0,
1,0,0),d.clearRect(0,0,Math.round(e),Math.round(f)),d.restore(),d.setTransform(a,0,0,a,Math.round(c),Math.round(h))),this.clearDirtyAreas(),"2d"==this._renderMode&&this._canvas.style.opacity!=this._opacity&&(this._canvas.style.opacity=this._opacity),this._drawSprites();"webgl"==this._renderMode&&this._useOffScreenTarget&&this.drawRenderTargetToScreen()}};
Layer.prototype._drawBatch=function(){var a,b=this._context;if(this._batchSize<this._minBatchSize){this._bindSingleSpriteVertexBuffer();for(a=0;a<this._batchSize;a++)this._spriteBatch[a].draw(b)}else{wade.numDrawCalls++;for(a=0;a<this._batchSize;a++)this._spriteBatch[a].draw.batched.call(this._spriteBatch[a],b,a);b.setTextureImage(this._spriteBatch[0].getImageUsedInDraw());this._bindBatchedSpriteVertexBuffer();b.bufferSubData(b.ARRAY_BUFFER,0,b.batchedVertices);this.setShaderProgram(b.batchedShaderProgram);
b.drawElements(b.TRIANGLES,6*this._batchSize,b.UNSIGNED_SHORT,0)}};
Layer.prototype._processSpriteForBatching=function(a){if(a.isVisible()){var b=this._context,c=a.getImageUsedInDraw(),d=a.isUsingBatchableDraw(),e=!this._lastImageUsedInBatch||this._lastImageUsedInBatch==c;d&&e&&this._batchSize<this._maxBatchSize?(this._spriteBatch[this._batchSize++]=a,this._lastImageUsedInBatch=c):(this._drawBatch(),this._batchSize=0,this._lastImageUsedInBatch=null,d?(this._lastImageUsedInBatch=c,this._spriteBatch[this._batchSize++]=a):(this._bindSingleSpriteVertexBuffer(),a.draw(b)))}else this._invisibleSprites.push(a)};
Layer.prototype._drawSpritesWithBatching=function(a){var b;this._lastImageUsedInBatch=null;this._batchSize=this._invisibleSprites.length=0;if(a)for(a=0;a<this._sprites.length;a++)b=this._sprites[a],(b.needsDrawing||b.isAlwaysDrawing())&&this._processSpriteForBatching(b);else for(a=0;a<this._sprites.length;a++)b=this._sprites[a],this._processSpriteForBatching(b);this._drawBatch();this._lastImageUsedInBatch=null;for(a=0;a<this._invisibleSprites.length;a++)this._context.setTextureImage(this._invisibleSprites[a].getImageUsedInDraw(),
!0);this._bindSingleSpriteVertexBuffer()};Layer.prototype._drawSprites=function(a){if(this._batchingEnabled&&"webgl"==this._renderMode)return this._drawSpritesWithBatching(a);var b=this._context;if(a)for(a=0;a<this._sprites.length;a++){var c=this._sprites[a];(c.needsDrawing||c.isAlwaysDrawing())&&c.draw(b)}else for(a=0;a<this._sprites.length;a++)this._sprites[a].draw(b)};
Layer.prototype._updateBlurRenderTarget=function(){var a=this._context,b=this._quarterSizeRenderTarget.uniformValues.positionAndSize[2],c=this._quarterSizeRenderTarget.uniformValues.positionAndSize[3];this.setShaderProgram(a.defaultShaderProgram);a.uniform2fv(a.currentShader.uniforms.uViewportSize,new Float32Array([b,c]));a.viewport(0,0,b,c);a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);this._f32CameraScaleTranslateTime[0]=1;this._f32CameraScaleTranslateTime[1]=0;this._f32CameraScaleTranslateTime[2]=
0;this._f32CameraScaleTranslateTime[3]=wade.getAppTime();a.bindFramebuffer(a.FRAMEBUFFER,this._quarterSizeRenderTarget);a.clear(a.COLOR_BUFFER_BIT);a.uniform4fv(a.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime);a.uniform4fv(a.currentShader.uniforms.uPositionAndSize,this._quarterSizeRenderTarget.uniformValues.positionAndSize);a.uniform4fv(a.currentShader.uniforms.uAnimFrameInfo,this._mainRenderTarget.uniformValues.animFrameInfo);a.uniform4fv(a.currentShader.uniforms.uImageArea,
this._mainRenderTarget.uniformValues.imageArea);a.uniform2fv(a.currentShader.uniforms.uRotationAlpha,this._mainRenderTarget.uniformValues.rotationAlpha);a.bindTexture(a.TEXTURE_2D,this._mainRenderTarget.texture);a.drawArrays(a.TRIANGLE_STRIP,0,4);this.setShaderProgram(a.blurShaderProgram);a.uniform2fv(a.currentShader.uniforms.uViewportSize,new Float32Array([b,c]));a.uniform2fv(a.currentShader.uniforms.uDelta,new Float32Array([1.5/b,0]));a.bindFramebuffer(a.FRAMEBUFFER,this._blurRenderTargetH);a.clear(a.COLOR_BUFFER_BIT);
a.uniform4fv(a.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime);a.uniform4fv(a.currentShader.uniforms.uPositionAndSize,this._quarterSizeRenderTarget.uniformValues.positionAndSize);a.uniform4fv(a.currentShader.uniforms.uAnimFrameInfo,this._mainRenderTarget.uniformValues.animFrameInfo);a.uniform4fv(a.currentShader.uniforms.uImageArea,this._mainRenderTarget.uniformValues.imageArea);a.uniform2fv(a.currentShader.uniforms.uRotationAlpha,this._mainRenderTarget.uniformValues.rotationAlpha);
a.bindTexture(a.TEXTURE_2D,this._quarterSizeRenderTarget.texture);a.drawArrays(a.TRIANGLE_STRIP,0,4);a.uniform2fv(a.currentShader.uniforms.uDelta,new Float32Array([0,1.5/c]));a.bindFramebuffer(a.FRAMEBUFFER,this._blurRenderTargetHV);a.clear(a.COLOR_BUFFER_BIT);a.bindTexture(a.TEXTURE_2D,this._blurRenderTargetH.texture);a.drawArrays(a.TRIANGLE_STRIP,0,4);a.uniform2fv(a.currentShader.uniforms.uViewportSize,this._f32ViewportSize);a.viewport(0,0,4*b,4*c)};
Layer.prototype.drawRenderTargetToScreen=function(){var a=this._context;this._blur?(this._updateBlurRenderTarget(),this.setShaderProgram(a.blendShaderProgram),a.activeTexture(a.TEXTURE1),a.setTextureImage({imageName:"_layerBlur_"+this.id},!1,1),a.uniform1i(a.blendShaderProgram.uniforms.uOtherSampler,1),a.uniform1f(a.currentShader.uniforms.uBlendFactor,this._blur),a.activeTexture(a.TEXTURE0)):(this._alwaysUpdateBlur&&this._updateBlurRenderTarget(),this._postProcessShaderProgram&&this._postProcessShaderProgram!=
a.defaultShaderProgram?this.setShaderProgram(this._postProcessShaderProgram):1!=this._opacity?this.setShaderProgram(a.compositeShaderProgram):this.setShaderProgram(a.defaultShaderProgram));a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);this._f32CameraScaleTranslateTime[0]=1;this._f32CameraScaleTranslateTime[1]=0;this._f32CameraScaleTranslateTime[2]=0;this._f32CameraScaleTranslateTime[3]=wade.getAppTime();a.bindFramebuffer(a.FRAMEBUFFER,null);this._hasOwnCanvas&&
a.clear(a.COLOR_BUFFER_BIT);a.uniform4fv(a.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime);a.uniform4fv(a.currentShader.uniforms.uPositionAndSize,this._mainRenderTarget.uniformValues.positionAndSize);a.uniform4fv(a.currentShader.uniforms.uAnimFrameInfo,this._mainRenderTarget.uniformValues.animFrameInfo);a.uniform4fv(a.currentShader.uniforms.uImageArea,this._mainRenderTarget.uniformValues.imageArea);a.uniform2fv(a.currentShader.uniforms.uRotationAlpha,this._mainRenderTarget.uniformValues.rotationAlpha);
a.bindTexture(a.TEXTURE_2D,this._mainRenderTarget.texture);if(this._postProcessUniforms){var b=1,c=Sprite.prototype.uniformTypeNames,d;for(d in this._postProcessUniforms){var e=this._postProcessUniforms[d],f=c[e];if(f)if(this._typedPostProcessUniforms&&this._typedPostProcessUniforms[d]){for(e=0;e<this._typedPostProcessUniforms[d].length;e++)this._typedPostProcessUniforms[d][e]=this._customProperties[d]&&this._customProperties[d][e]||0;a[f](this._postProcessShaderProgram.uniforms[d],this._typedPostProcessUniforms[d])}else a[f](this._postProcessShaderProgram.uniforms[d],
this._customProperties[d]);else"sampler2D"==e&&(a.activeTexture(a.TEXTURE0+b),a.uniform1i(this._postProcessShaderProgram.uniforms[d],b),f=a.textures[this._customProperties[d]]?{imageName:this._customProperties[d]}:wade.getImage(wade.getFullPathAndFileName(this._customProperties[d])),a.setTextureImage(f,!1,b),b++,a.activeTexture(a.TEXTURE0))}}a.drawArrays(a.TRIANGLE_STRIP,0,4);b=this._scaleConversionFactor;this._f32CameraScaleTranslateTime[0]=b;this._f32CameraScaleTranslateTime[1]=this._cameraPosition.x*
this._transform.translate*b;this._f32CameraScaleTranslateTime[2]=this._cameraPosition.y*this._transform.translate*b;a.uniform4fv(a.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime);a.bindTexture(a.TEXTURE_2D,null);a.currentImage[0]=null;a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)};Layer.prototype.sort=function(a){this._sprites.sort(a||this._sortingFunction);this._needsFullRedraw=!0};
Layer.prototype.onCameraPositionChanged=function(a){if(0!=this._transform.translate&&(a.x!=this._cameraPosition.x||a.y!=this._cameraPosition.y)||0!=this._transform.scale&&a.z!=this._cameraPosition.z)this._needsFullRedraw=!0;this._cameraPosition={x:a.x,y:a.y,z:a.z};this._updateScaleConversionFactor()};Layer.prototype.onSpritePositionChanged=function(a){this._useQuadtree&&a.quadTreeNode&&(wade.expandBox(this._worldBounds,a.boundingBox),a.quadTreeNode.removeObject(a),this._addSpriteToQuadTree(a));this._movingSprites.push(a)};
Layer.prototype.worldPositionToScreen=function(a){return{x:this._scaleConversionFactor*(a.x-this._cameraPosition.x*this._transform.translate)/this._resolutionFactor,y:this._scaleConversionFactor*(a.y-this._cameraPosition.y*this._transform.translate)/this._resolutionFactor}};Layer.prototype.worldDirectionToScreen=function(a){return{x:this._scaleConversionFactor*a.x/this._resolutionFactor,y:this._scaleConversionFactor*a.y/this._resolutionFactor}};
Layer.prototype.worldBoxToScreen=function(a){var b={x:(a.maxX-a.minX)/2,y:(a.maxY-a.minY)/2},a=this.worldPositionToScreen({x:a.minX+b.x,y:a.minY+b.y}),b=this.worldDirectionToScreen(b);return{minX:a.x-b.x,minY:a.y-b.y,maxX:a.x+b.x,maxY:a.y+b.y}};Layer.prototype.worldUnitToScreen=function(){return this._scaleConversionFactor/this._resolutionFactor};
Layer.prototype.screenPositionToWorld=function(a){return{x:this._cameraPosition.x*this._transform.translate+a.x*this._resolutionFactor/this._scaleConversionFactor,y:this._cameraPosition.y*this._transform.translate+a.y*this._resolutionFactor/this._scaleConversionFactor}};Layer.prototype.screenDirectionToWorld=function(a){return{x:a.x*this._resolutionFactor/this._scaleConversionFactor,y:a.y*this._resolutionFactor/this._scaleConversionFactor}};
Layer.prototype.screenBoxToWorld=function(a){var b={x:(a.maxX-a.minX)/2,y:(a.maxY-a.minY)/2},a=this.screenPositionToWorld({x:a.minX+b.x,y:a.minY+b.y}),b=this.screenDirectionToWorld(b);return{minX:a.x-b.x,minY:a.y-b.y,maxX:a.x+b.x,maxY:a.y+b.y}};Layer.prototype.screenUnitToWorld=function(){return this._resolutionFactor/this._scaleConversionFactor};
Layer.prototype.worldPositionToCanvas=function(a){return{x:this._scaleConversionFactor*(a.x-this._cameraPosition.x*this._transform.translate),y:this._scaleConversionFactor*(a.y-this._cameraPosition.y*this._transform.translate)}};Layer.prototype.worldDirectionToCanvas=function(a){return{x:this._scaleConversionFactor*a.x,y:this._scaleConversionFactor*a.y}};
Layer.prototype.worldBoxToCanvas=function(a){var b={x:(a.maxX-a.minX)/2,y:(a.maxY-a.minY)/2},a=this.worldPositionToCanvas({x:a.minX+b.x,y:a.minY+b.y}),b=this.worldDirectionToCanvas(b);return{minX:a.x-b.x,minY:a.y-b.y,maxX:a.x+b.x,maxY:a.y+b.y}};Layer.prototype.worldUnitToCanvas=function(){return this._scaleConversionFactor};
Layer.prototype.canvasPositionToWorld=function(a){return{x:this._cameraPosition.x*this._transform.translate+a.x/this._scaleConversionFactor,y:this._cameraPosition.y*this._transform.translate+a.y/this._scaleConversionFactor}};Layer.prototype.canvasDirectionToWorld=function(a){return{x:a.x/this._scaleConversionFactor,y:a.y/this._scaleConversionFactor}};
Layer.prototype.canvasBoxToWorld=function(a){var b={x:(a.maxX-a.minX)/2,y:(a.maxY-a.minY)/2},a=this.canvasPositionToWorld({x:a.minX+b.x,y:a.minY+b.y}),b=this.canvasDirectionToWorld(b);return{minX:a.x-b.x,minY:a.y-b.y,maxX:a.x+b.x,maxY:a.y+b.y}};Layer.prototype.canvasUnitToWorld=function(){return 1/this._scaleConversionFactor};
Layer.prototype.resize=function(a,b){if(this._canvas){if("webgl"!=this._renderMode||this._hasOwnCanvas)this._canvas.width=Math.round(a*this._resolutionFactor),this._canvas.height=Math.round(b*this._resolutionFactor);if("webgl"==this._renderMode){var c=this._canvas.width,d=this._canvas.height,e=Math.floor(c/4),f=Math.floor(d/4);this._f32ViewportSize[0]=c;this._f32ViewportSize[1]=d;this._mainRenderTarget.uniformValues.positionAndSize[2]=c;this._mainRenderTarget.uniformValues.positionAndSize[3]=d;this._quarterSizeRenderTarget.uniformValues.positionAndSize[2]=
e;this._quarterSizeRenderTarget.uniformValues.positionAndSize[3]=f;this._hasOwnCanvas&&(this._context.viewport(0,0,c,d),this._context.uniform2fv(this._context.currentShader.uniforms.uViewportSize,this._f32ViewportSize),this._context.currentImage=[]);this._context.bindTexture(this._context.TEXTURE_2D,this._mainRenderTarget.texture);this._context.texImage2D(this._context.TEXTURE_2D,0,this._context.RGBA,c,d,0,this._context.RGBA,this._context.UNSIGNED_BYTE,null);this._context.bindTexture(this._context.TEXTURE_2D,
this._quarterSizeRenderTarget.texture);this._context.texImage2D(this._context.TEXTURE_2D,0,this._context.RGBA,e,f,0,this._context.RGBA,this._context.UNSIGNED_BYTE,null);this._context.bindTexture(this._context.TEXTURE_2D,this._blurRenderTargetH.texture);this._context.texImage2D(this._context.TEXTURE_2D,0,this._context.RGBA,e,f,0,this._context.RGBA,this._context.UNSIGNED_BYTE,null);this._context.bindTexture(this._context.TEXTURE_2D,this._blurRenderTargetHV.texture);this._context.texImage2D(this._context.TEXTURE_2D,
0,this._context.RGBA,e,f,0,this._context.RGBA,this._context.UNSIGNED_BYTE,null);this._context.bindTexture(this._context.TEXTURE_2D,null)}}this._needsFullRedraw=!0;this._smoothing||(this._smoothing=!0,this.setSmoothing(!1))};Layer.prototype.setCanvasClearing=function(a){this._clearCanvas=a};Layer.prototype.getContext=function(){return this._context};Layer.prototype.bringSpriteToFront=function(a){a.setDirtyArea();wade.removeObjectFromArray(a,this._sprites);this._sprites.push(a)};
Layer.prototype.pushSpriteToBack=function(a){a.setDirtyArea();wade.removeObjectFromArray(a,this._sprites);this._sprites.splice(0,0,a)};Layer.prototype.putSpriteBehindSprite=function(a,b){var c=this._sprites.indexOf(b);wade.removeObjectFromArray(a,this._sprites);this._sprites.splice(c,0,a)};Layer.prototype.setCanvasStyleSize=function(a,b){if(this._canvas&&(a!=this._canvas.style.width||b!=this._canvas.style.height))this._canvas.style.width=a,this._canvas.style.height=b};
Layer.prototype.compareSprites=function(a,b){return this._sortingFunction?this._sortingFunction(a,b):this._sprites.indexOf(a)-this._sprites.indexOf(b)};
Layer.prototype.removeCanvas=function(){var a=!0;if("webgl"==this._renderMode)if(this._hasOwnCanvas)for(var b=wade.getAllLayers(),c=0;c<b.length;c++){if(b[c]!=this&&b[c].getCanvas()==this._canvas){a=!1;this.disownCanvas();b[c].ownCanvas();break}}else a=!1;if(this._canvas)if(a)document.getElementById(wade.getContainerName()).removeChild(this._canvas),this._context&&this._context.isWebGl&&(resetContext(this._context),(a=this._context.getExtension("WEBGL_lose_context"))&&a.loseContext());else{b=wade.getAllLayers();
for(c=0;c<b.length;c++)b[c]!=this&&b[c].getCanvas()==this._canvas&&b[c].forceRedraw()}this._canvas=this._context=null};
Layer.prototype.initCanvas=function(){var a;if("webgl"==this._renderMode&&wade.areGlLayersMerged()){var b=wade.getAllLayers();a=[];for(var c=-1,d=0;d<b.length;d++)this==b[d]||"webgl"==b[d].getRenderMode()&&!b[d].hasOwnCanvas()||(-1==c&&this.id>b[d].id&&(c=a.push(this)-1),a.push(b[d]));-1==c&&(c=a.push(this)-1);b=a[c-1];a=a[c+1];a=b&&"webgl"==b.getRenderMode()&&b.getResolutionFactor()==this._resolutionFactor&&b||a&&"webgl"==a.getRenderMode()&&a.getResolutionFactor()==this._resolutionFactor&&a}if(a){if(this._canvas=
a.getCanvas(),this._context=a.getContext(),this._setupRenderTargets(),this._f32ViewportSize[0]=this._canvas.width,this._f32ViewportSize[1]=this._canvas.height,a.id<this.id?(this._hasOwnCanvas=!0,a.disownCanvas()):(this._hasOwnCanvas=!1,this._useOffScreenTarget=!0),this._context.currentImage)for(a=0;a<this._context.currentImage.length;a++)this._context.currentImage[a]=null}else this._createCanvas(),this._setupRenderTargets(),this._hasOwnCanvas=!0};
Layer.prototype.disownCanvas=function(){this._hasOwnCanvas=!1;this._needsFullRedraw=this._useOffScreenTarget=!0};Layer.prototype.ownCanvas=function(){this._needsFullRedraw=this._hasOwnCanvas=!0;this._canvas.style.zIndex=-this.id};Layer.prototype.hasOwnCanvas=function(){return this._hasOwnCanvas};
Layer.prototype._createCanvas=function(){if(!this._canvas){this._canvas=wade.createCanvas(this._resolutionFactor);this._canvas.id="wade_layer_"+this.id;this._canvas.style.zIndex=-this.id;if("2d"!=this._renderMode){try{this._context=this._canvas.getContext("webgl")||this._canvas.getContext("experimental-webgl"),this._context.isWebGl=!0}catch(a){}this._context?this._setupWebGl(this._context,this._canvas):wade.log("Unable to use WebGL in this browser, falling back to 2d canvas")}!this._context||"2d"==
this._renderMode?this._context=this._canvas.getContext("2d"):this._renderMode="webgl";this._context.imageSmoothingEnabled=this._context.mozImageSmoothingEnabled=this._context.msImageSmoothingEnabled=this._context.oImageSmoothingEnabled=this._smoothing;"2d"==this._renderMode&&this._context.save();this._needsFullRedraw=!0}};Layer.prototype.getCanvas=function(){return this._canvas};
Layer.prototype._updateScaleConversionFactor=function(){var a=wade.getCameraPosition();this._scaleConversionFactor=(this._transform.scale/a.z+1-this._transform.scale)*this._resolutionFactor};Layer.prototype._spriteSorter_bottomToTop=function(a,b){var c=a.getPosition().y+a.getSortPoint().y*a.getSize().y-b.getPosition().y-b.getSortPoint().y*b.getSize().y;return Math.abs(c)<wade.c_epsilon?a.id>b.id?1:-1:0<c?1:-1};
Layer.prototype._spriteSorter_topToBottom=function(a,b){var c=b.getPosition().y+b.getSortPoint().y*b.getSize().y-a.getPosition().y-a.getSortPoint().y*a.getSize().y;return Math.abs(c)<wade.c_epsilon?a.id>b.id?1:-1:0<c?1:-1};Layer.prototype._initQuadTree=function(){var a=(this._worldBounds.maxX-this._worldBounds.minX)/2,b=(this._worldBounds.maxY-this._worldBounds.minY)/2,c=this._worldBounds.minX+a,d=this._worldBounds.minY+b;this._quadTree=new QuadTreeNode(0,c-1.5*a,d-1.5*b,c+1.5*a,d+1.5*b)};
Layer.prototype._addSpriteToQuadTree=function(a){if(wade.boxContainsBox(this._quadTree,this._worldBounds))this._quadTree.addObject(a);else{this._initQuadTree();for(a=0;a<this._sprites.length;a++)this._quadTree.addObject(this._sprites[a])}};
Layer.prototype._joinDirtyAreas=function(){if(!this._dirtyAreas.length)return{minX:0,minY:0,maxX:0,maxY:0};for(var a=wade.getScreenWidth()/2,b=wade.getScreenHeight()/2,a=this.screenBoxToWorld({minX:-a,minY:-b,maxX:a,maxY:b}),b={minX:a.maxX,minY:a.maxY,maxX:a.minX,maxY:a.minY},c=0;c<this._dirtyAreas.length;c++){var d=this._dirtyAreas[c];wade.boxIntersectsBox(a,d)&&wade.expandBox(b,d)}wade.clampBoxToBox(b,a);if(b.maxX<=b.minX||b.maxY<=b.minY)b=0;return b};
Layer.prototype.setResolutionFactor=function(a){a!=this._resolutionFactor&&(this._resolutionFactor=a,this._updateScaleConversionFactor(),this.resize(wade.getScreenWidth(),wade.getScreenHeight()),this.removeCanvas(),this.initCanvas())};Layer.prototype.getResolutionFactor=function(){return this._resolutionFactor};
Layer.prototype.setSmoothing=function(a){a!=this._smoothing&&(this._smoothing=a,this._context.restore(),this._context.imageSmoothingEnabled=this._context.mozImageSmoothingEnabled=this._context.msImageSmoothingEnabled=this._context.oImageSmoothingEnabled=a,this._context.save(),this._needsFullRedraw=!0)};Layer.prototype.getSmoothing=function(){return this._smoothing};
Layer.prototype.addSpritesInAreaToArray=function(a,b,c){if(c&&this._sortingFunction){c=[];this._quadTree.addObjectsInAreaToArray(a,c);c.sort(this._sortingFunction);for(a=c.length-1;0<=a;a--)b.push(c[a])}else this._quadTree.addObjectsInAreaToArray(a,b,b.length)};Layer.prototype.toDataURL=function(){return this._canvas.toDataURL()};Layer.prototype.forceRedraw=function(){this._needsFullRedraw=!0};
Layer.prototype.setOpacity=function(a){a!=this._opacity&&(this._opacity=a,"webgl"==this._renderMode&&(this._mainRenderTarget.uniformValues.rotationAlpha[1]=a,this._useOffScreenTarget||(this._useOffScreenTarget=!0)),this._needsFullRedraw=!0)};Layer.prototype.getOpacity=function(){return this._opacity};
Layer.prototype.clear=function(){var a=wade.getScreenWidth()*this._resolutionFactor,b=wade.getScreenHeight()*this._resolutionFactor,c=this._context;"webgl"==this._renderMode?this._context.clear(this._context.COLOR_BUFFER_BIT):(c.save(),c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,Math.round(a),Math.round(b)),c.restore())};Layer.prototype.useQuadtree=function(a){if(a!=this._useQuadtree&&(this._useQuadtree=a)){this._quadTree.empty();for(a=0;a<this._sprites.length;a++)this._addSpriteToQuadTree(this._sprites[a])}};
Layer.prototype.isUsingQuadtree=function(){return this._useQuadtree};
Layer.prototype.set3DTransform=function(a,b,c,d){if(this._canvas){var e=this._canvas;if(c){e.style.MozTransition="-moz-transform "+c+"s";e.style.msTransition="-ms-transform "+c+"s";e.style.OTransition="-O-transform "+c+"s";e.style.WebkitTransition="-webkit-transform "+c+"s";e.style.transition="transform "+c+"s";var f=function(){d&&d();d=null;e.removeEventListener("transitionend",f)};e.addEventListener("transitionend",f,!0)}else e.style.MozTransition="-moz-transform 0",e.style.msTransition="-ms-transform 0",
e.style.OTransition="-O-transform 0",e.style.WebkitTransition="-webkit-transform 0",e.style.transition="transform 0";e.style.MozTransform=e.style.msTransform=e.style.OTransform=e.style.webkitTransform=e.style.transform=a;e.style.MozTransformOrigin=e.style.msTransformOrigin=e.style.OTransformOrigin=e.style.webkitTransformOrigin=e.style.transformOrigin=b;!c&&d&&d()}};Layer.prototype.getIndexOfSprite=function(a){return this._sprites.indexOf(a)};
Layer.prototype.setIndexOfSprite=function(a,b){var c=this._sprites.indexOf(a);return-1!=c&&b!=c?(wade.removeObjectFromArrayByIndex(c,this._sprites),this._sprites.length>b?(this._sprites.splice(b,0,a),b):this._sprites.push(a)-1):-1};
Layer.prototype.getPixelShader=function(a,b,c){if("webgl"!=this._renderMode)wade.log("cannot use pixel shaders in canvas mode");else{var d=a.pixelShaders[b];if(d)return d;d="";if(c)for(var e in c)c.hasOwnProperty(e)&&(d+="uniform "+c[e]+" "+e+";\n");e="precision mediump int; precision mediump float;\n\tvarying vec4 uvAlphaTime;\n\tuniform sampler2D uDiffuseSampler;\n\tuniform vec4 uCustomPsParameters;\n"+d+"void main(void) {\n#line 1\n"+b+"\n}";d=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(d,
e);a.compileShader(d);d.hash=wade.hashString(b).toString();d.customUniforms=c;if(a.getShaderParameter(d,a.COMPILE_STATUS))return wade.shaderSuccessLog("Pixel shader compiled successfully"),a.pixelShaders[b]=d;wade.shaderErrorLog("An error occurred compiling a pixel shader: "+a.getShaderInfoLog(d))}};
Layer.prototype.getVertexShader=function(a,b){if("webgl"!=this._renderMode)wade.log("cannot use vertex shaders in canvas mode");else{var c=a.vertexShaders[b];if(c)return c;c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,b);a.compileShader(c);c.hash=wade.hashString(b).toString();if(a.getShaderParameter(c,a.COMPILE_STATUS))return a.vertexShaders[b]=c;wade.log("An error occurred compiling a vertex shader: "+a.getShaderInfoLog(c))}};
Layer.prototype.getShaderProgram=function(a,b,c){if("webgl"!=this._renderMode)wade.log("cannot use shader programs in canvas mode");else{var b=b||a.defaultVertexShader,c=c||a.defaultPixelShader,d=a.shaderPrograms[b.hash+c.hash];if(d)return d;d=a.createProgram();a.attachShader(d,b);a.attachShader(d,c);a.linkProgram(d);if(a.getProgramParameter(d,a.LINK_STATUS)){d.attributes={};d.attributes.vertexPosition=a.getAttribLocation(d,"aVertexPosition");d.attributes.positionAndSize=a.getAttribLocation(d,"uPositionAndSize");
d.attributes.animFrameInfo=a.getAttribLocation(d,"uAnimFrameInfo");d.attributes.rotationAlpha=a.getAttribLocation(d,"uRotationAlpha");d.uniforms={};d.uniforms.uCameraScaleTranslateTime=a.getUniformLocation(d,"uCameraScaleTranslateTime");d.uniforms.uViewportSize=a.getUniformLocation(d,"uViewportSize");d.uniforms.uPositionAndSize=a.getUniformLocation(d,"uPositionAndSize");d.uniforms.uAnimFrameInfo=a.getUniformLocation(d,"uAnimFrameInfo");d.uniforms.uRotationAlpha=a.getUniformLocation(d,"uRotationAlpha");
d.uniforms.uDiffuseSampler=a.getUniformLocation(d,"uDiffuseSampler");d.uniforms.uOtherSampler=a.getUniformLocation(d,"uOtherSampler");if(c.customUniforms)for(var e in c.customUniforms)d.uniforms[e]=a.getUniformLocation(d,e);return a.shaderPrograms[b.hash+c.hash]=d}wade.log("Unable to link a WebGl shader program")}};Layer.prototype.getDefaultPixelShaderSource=function(){return"highp vec4 color = texture2D(uDiffuseSampler, uvAlphaTime.xy); \ncolor.w *= uvAlphaTime.z; \ngl_FragColor = color;"};
Layer.prototype.getCompositePixelShaderSource=function(){return"highp vec4 color = texture2D(uDiffuseSampler, uvAlphaTime.xy); \ncolor.w *= uvAlphaTime.z; \ncolor.xyz *= color.w;\ngl_FragColor = color;"};Layer.prototype.getBlurPixelShaderSource=function(){return"vec2 uv = uvAlphaTime.xy;\nhighp vec4 color = vec4(0.,0.,0.,0.);\nhighp vec4 c;\nc = texture2D(uDiffuseSampler, uv + uDelta * -2.); color += c * 1./16.;\nc = texture2D(uDiffuseSampler, uv + uDelta * -1.); color += c * 4./16.;\nc = texture2D(uDiffuseSampler, uv + uDelta *  0.); color += c * 6./16.;\nc = texture2D(uDiffuseSampler, uv + uDelta *  1.); color += c * 4./16.;\nc = texture2D(uDiffuseSampler, uv + uDelta *  2.); color += c * 1./16.;\ngl_FragColor = color;"};
Layer.prototype.getBlendPixelShaderSource=function(){return"vec2 uv = uvAlphaTime.xy;\ngl_FragColor = mix(texture2D(uDiffuseSampler, uv), texture2D(uOtherSampler, uv), uBlendFactor);\ngl_FragColor.w *= uvAlphaTime.z;\ngl_FragColor.xyz *= uvAlphaTime.z;"};
Layer.prototype.setShaderProgram=function(a){var b=this._context;b.currentShader!=a&&(b.useProgram(b.currentShader=a),b.uniform2fv(b.currentShader.uniforms.uViewportSize,this._f32ViewportSize),b.uniform4fv(b.currentShader.uniforms.uCameraScaleTranslateTime,this._f32CameraScaleTranslateTime))};
Layer.prototype._bindSingleSpriteVertexBuffer=function(){if(this._batchedBufferBound){this._batchedBufferBound=!1;var a=this._context;a.bindBuffer(a.ARRAY_BUFFER,a.squareVertexBuffer);a.vertexAttribPointer(a.defaultShaderProgram.attributes.vertexPosition,2,a.FLOAT,!1,0,0)}};
Layer.prototype._bindBatchedSpriteVertexBuffer=function(){if(!this._batchedBufferBound){this._batchedBufferBound=!0;var a=this._context;a.bindBuffer(a.ARRAY_BUFFER,a.batchedVertexBuffer);a.vertexAttribPointer(a.batchedShaderProgram.attributes.vertexPosition,2,a.FLOAT,!1,a.batchedQuadSize,0);a.vertexAttribPointer(a.batchedShaderProgram.attributes.positionAndSize,4,a.FLOAT,!1,a.batchedQuadSize,8);a.vertexAttribPointer(a.batchedShaderProgram.attributes.animFrameInfo,4,a.FLOAT,!1,a.batchedQuadSize,24);
a.vertexAttribPointer(a.batchedShaderProgram.attributes.rotationAlpha,2,a.FLOAT,!1,a.batchedQuadSize,40)}};
Layer.prototype._setupWebGl=function(a,b){a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT);a.vertexShaders={};a.pixelShaders={};a.shaderPrograms={};var c=a.defaultVertexShader=this.getVertexShader(a,"attribute vec2 aVertexPosition;\nuniform vec4 uCameraScaleTranslateTime;\nuniform vec2 uViewportSize;\nuniform vec4 uPositionAndSize;\nuniform vec4 uAnimFrameInfo;\nuniform vec2 uRotationAlpha;\nvarying highp vec4 uvAlphaTime;\nvoid main(void) {\nfloat s = sin(uRotationAlpha.x);\nfloat c = cos(uRotationAlpha.x);\nvec2 pos = aVertexPosition * uPositionAndSize.zw;\npos = vec2(pos.x * c - pos.y * s, pos.y * c + pos.x * s);\npos += uPositionAndSize.xy * 2.0;\npos *= uCameraScaleTranslateTime.x;\npos -= uCameraScaleTranslateTime.yz * 2.0;\npos /= uViewportSize;\npos.y *= -1.0;\nuvAlphaTime.xy = (aVertexPosition + 1.0) * 0.5;\nuvAlphaTime.x = (uAnimFrameInfo.z < 0.0)? 1.0 - uvAlphaTime.x : uvAlphaTime.x;\nuvAlphaTime.y = (uAnimFrameInfo.w < 0.0)? 1.0 - uvAlphaTime.y : uvAlphaTime.y;\nuvAlphaTime.xy *= abs(uAnimFrameInfo.zw);\nuvAlphaTime.xy += uAnimFrameInfo.xy;\nuvAlphaTime.z = uRotationAlpha.y;\nuvAlphaTime.w = uCameraScaleTranslateTime.w;\ngl_Position = vec4(pos, 0.0, 1.0);\n}"),d=
this.getDefaultPixelShaderSource(),e=a.defaultPixelShader=this.getPixelShader(a,d);if(d=this.getShaderProgram(a,c,e)){a.defaultShaderProgram=this._postProcessShaderProgram=d;this.setShaderProgram(d);var f=this.getBlurPixelShaderSource(),f=this.getPixelShader(a,f,{uDelta:"vec2"});a.blurShaderProgram=this.getShaderProgram(a,c,f);f=this.getBlendPixelShaderSource();f=this.getPixelShader(a,f,{uOtherSampler:"sampler2D",uBlendFactor:"float"});a.blendShaderProgram=this.getShaderProgram(a,c,f);f=this.getCompositePixelShaderSource();
f=this.getPixelShader(a,f);a.compositeShaderProgram=this.getShaderProgram(a,c,f);c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),a.STATIC_DRAW);a.squareVertexBuffer=c;a.enableVertexAttribArray(a.defaultShaderProgram.attributes.vertexPosition);c=a.defaultBatchedVertexShader=this.getVertexShader(a,"attribute vec2 aVertexPosition;\nuniform vec4 uCameraScaleTranslateTime;\nuniform vec2 uViewportSize;\nattribute vec4 uPositionAndSize;\nattribute vec4 uAnimFrameInfo;\nattribute vec2 uRotationAlpha;\nvarying highp vec4 uvAlphaTime;\nvoid main(void) {\nfloat s = sin(uRotationAlpha.x);\nfloat c = cos(uRotationAlpha.x);\nvec2 pos = aVertexPosition * uPositionAndSize.zw;\npos = vec2(pos.x * c - pos.y * s, pos.y * c + pos.x * s);\npos += uPositionAndSize.xy * 2.0;\npos *= uCameraScaleTranslateTime.x;\npos -= uCameraScaleTranslateTime.yz * 2.0;\npos /= uViewportSize;\npos.y *= -1.0;\nuvAlphaTime.xy = (aVertexPosition + 1.0) * 0.5;\nuvAlphaTime.x = (uAnimFrameInfo.z < 0.0)? 1.0 - uvAlphaTime.x : uvAlphaTime.x;\nuvAlphaTime.y = (uAnimFrameInfo.w < 0.0)? 1.0 - uvAlphaTime.y : uvAlphaTime.y;\nuvAlphaTime.xy *= abs(uAnimFrameInfo.zw);\nuvAlphaTime.xy += uAnimFrameInfo.xy;\nuvAlphaTime.z = uRotationAlpha.y;\nuvAlphaTime.w = uCameraScaleTranslateTime.w;\ngl_Position = vec4(pos, 0.0, 1.0);\n}");
if(e=this.getShaderProgram(a,c,e)){a.batchedShaderProgram=e;for(var f=a.createBuffer(),g=[1,1,0,0,16,16,0,0,1,-1,0,1,-1,1,0,0,16,16,0,0,1,-1,0,1,1,-1,0,0,16,16,0,0,1,-1,0,1,-1,-1,0,0,16,16,0,0,1,-1,0,1],i=[],e=0;e<this._maxBatchSize;e++)for(c=0;c<g.length;c++)i.push(g[c]);a.batchedVertices=i=new Float32Array(i);a.batchedQuadSize=g.length;a.bindBuffer(a.ARRAY_BUFFER,f);a.bufferData(a.ARRAY_BUFFER,i,a.DYNAMIC_DRAW);a.batchedVertexBuffer=f;f=a.batchedIndexBuffer=a.createBuffer();g=[0,1,2,1,3,2];i=[];
for(e=0;e<this._maxBatchSize;e++)for(c=0;c<g.length;c++)i.push(g[c]+4*e);a.batchedIndices=i=new Uint16Array(i);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,i,a.STATIC_DRAW);a.enableVertexAttribArray(a.batchedShaderProgram.attributes.vertexPosition);a.enableVertexAttribArray(a.batchedShaderProgram.attributes.positionAndSize);a.enableVertexAttribArray(a.batchedShaderProgram.attributes.animFrameInfo);a.enableVertexAttribArray(a.batchedShaderProgram.attributes.rotationAlpha);
a.vertexAttribPointer(a.batchedShaderProgram.attributes.vertexPosition,2,a.FLOAT,!1,a.batchedQuadSize,0);a.vertexAttribPointer(a.batchedShaderProgram.attributes.positionAndSize,4,a.FLOAT,!1,a.batchedQuadSize,8);a.vertexAttribPointer(a.batchedShaderProgram.attributes.animFrameInfo,4,a.FLOAT,!1,a.batchedQuadSize,24);a.vertexAttribPointer(a.batchedShaderProgram.attributes.rotationAlpha,2,a.FLOAT,!1,a.batchedQuadSize,40);this._batchedBufferBound=!0;this._bindSingleSpriteVertexBuffer();a.activeTexture(a.TEXTURE0);
a.uniform1i(d.uniforms.uDiffuseSampler,0);a.disable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);a.textures={};a.setTextureImage=function(b,c,d){var e=b&&b.imageName||"",d=d||0;if(a.currentImage[d]!=e){if(a.textures[e])c||a.bindTexture(a.TEXTURE_2D,a.textures[e]);else if(b){var f=a.createTexture();a.bindTexture(a.TEXTURE_2D,f);wade.texImage2D(a,{width:b&&b.width||0,height:b&&b.height||
0,image:b});a.textures[e]=f;wade.addImageUser(e,this);c&&(a.bindTexture(a.TEXTURE_2D,null),a.currentImage[d]=null)}else a.currentImage[d]=null;c||(a.currentImage[d]=e)}};a.setActiveImage=function(b){a.bindTexture(a.TEXTURE_2D,a.textures[b]);b=wade.getImage(b);wade.texImage2D(a,{width:b.width,height:b.height,image:b})};a.onImageUnloaded=function(b){a.deleteTexture(a.textures[b]);delete a.textures[b]};a.currentImage=[];a.globalAlpha=1;this._f32ViewportSize[0]=this._canvas.width;this._f32ViewportSize[1]=
this._canvas.height;a.viewport(0,0,b.width,b.height);a.uniform2fv(d.uniforms.uViewportSize,this._f32ViewportSize)}else wade.error("Unable to compile default batched shader")}else wade.error("Unable to compile default shader")};
Layer.prototype._createRenderTarget=function(a,b){var c=this._context,d=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,d);c.disable(c.DEPTH_TEST);d.texture=c.createTexture();c.bindTexture(c.TEXTURE_2D,d.texture);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a,
b,0,c.RGBA,c.UNSIGNED_BYTE,null);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d.texture,0);c.bindTexture(c.TEXTURE_2D,null);c.bindFramebuffer(c.FRAMEBUFFER,null);return d};
Layer.prototype._setupRenderTargets=function(){if("webgl"==this._renderMode){var a=this._canvas.width,b=this._canvas.height,c=Math.floor(a/4),d=Math.floor(b/4);this._mainRenderTarget=this._createRenderTarget(a,b);this._quarterSizeRenderTarget=this._createRenderTarget(c,d);this._blurRenderTargetH=this._createRenderTarget(c,d);this._blurRenderTargetHV=this._createRenderTarget(c,d);this._mainRenderTarget.uniformValues={positionAndSize:new Float32Array([0,0,a,b]),animFrameInfo:new Float32Array([0,0,1,
-1]),rotationAlpha:new Float32Array([0,this._opacity]),imageArea:new Float32Array([0,0,1,1])};this._quarterSizeRenderTarget.uniformValues={positionAndSize:new Float32Array([0,0,c,d])};this._context.textures["_layerRenderTarget_"+this.id]=this._mainRenderTarget.texture;this._context.textures["_layerBlur_"+this.id]=this._blurRenderTargetHV.texture}};
var resetContext=function(a){var b=a.getParameter(a.MAX_VERTEX_ATTRIBS),c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);for(var d=0;d<b;++d)a.disableVertexAttribArray(d),a.vertexAttribPointer(d,4,a.FLOAT,!1,0,0),a.vertexAttrib1f(d,0);a.deleteBuffer(c);b=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);for(d=0;d<b;++d)a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null);a.activeTexture(a.TEXTURE0);a.useProgram(null);a.bindBuffer(a.ARRAY_BUFFER,null);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
null);a.bindFramebuffer(a.FRAMEBUFFER,null);a.bindRenderbuffer(a.RENDERBUFFER,null);a.disable(a.BLEND);a.disable(a.CULL_FACE);a.disable(a.DEPTH_TEST);a.disable(a.DITHER);a.disable(a.SCISSOR_TEST);a.blendColor(0,0,0,0);a.blendEquation(a.FUNC_ADD);a.blendFunc(a.ONE,a.ZERO);a.clearColor(0,0,0,0);a.clearDepth(1);a.clearStencil(-1);a.colorMask(!0,!0,!0,!0);a.cullFace(a.BACK);a.depthFunc(a.LESS);a.depthMask(!0);a.depthRange(0,1);a.frontFace(a.CCW);a.hint(a.GENERATE_MIPMAP_HINT,a.DONT_CARE);a.lineWidth(1);
a.pixelStorei(a.PACK_ALIGNMENT,4);a.pixelStorei(a.UNPACK_ALIGNMENT,4);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);a.UNPACK_COLORSPACE_CONVERSION_WEBGL&&a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL);a.polygonOffset(0,0);a.sampleCoverage(1,!1);a.scissor(0,0,a.canvas.width,a.canvas.height);a.stencilFunc(a.ALWAYS,0,4294967295);a.stencilMask(4294967295);a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.viewport(0,0,a.canvas.width,a.canvas.height);
a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);for(var e in a.textures)a.textures.hasOwnProperty(e)&&(wade.removeImageUser(e,a),a.deleteTexture(a.textures[e]));delete a.textures;a.shaderPrograms={};a.pixelShaders={};a.vertexShaders={}};
Layer.prototype.setRenderMode=function(a,b,c){var d=b&&b.offScreenTarget||!this._hasOwnCanvas;c||(this._renderOptions=b&&wade.cloneObject(b));!!d!=!!this._useOffScreenTarget&&(this._useOffScreenTarget=!!d,this._needsFullRedraw=!0);if(a!=this._renderMode&&("webgl"==this._renderMode&&this._canvas&&!wade.isSharedCanvas(this._canvas)&&this._context&&resetContext(this._context),this.removeCanvas(),this._renderMode=a,"webgl"==this._renderMode&&!wade.isWebGlSupported()&&(this._renderMode="2d"),this.initCanvas(),
"webgl"==this._renderMode))for(a=0;a<this._sprites.length;a++)this._sprites[a].refreshShader();if((this._blur||this._postProcessShaderProgram!=this._context.defaultShaderProgram)&&!this._useOffScreenTarget)this._needsFullRedraw=this._useOffScreenTarget=!0};Layer.prototype.getRenderMode=function(){return this._renderMode};Layer.prototype.getF32ViewportSize=function(){return this._f32ViewportSize};
Layer.prototype.setPostProcessShader=function(a,b){if(a&&"webgl"!=this._renderMode)wade.warn("It is not possible to use post process shaders on a non-webgl layer. Post processing will be ignored for layer "+this.id);else if(!(this._postProcessShaderSource==a&&this._postProcessUniforms==b)){if(this._postProcessShaderSource=a){this.setRenderMode(this._renderMode,{offScreenTarget:!0},!0);var c=this._context,d=this.getPixelShader(c,a,b);this._postProcessShaderProgram=this.getShaderProgram(c,null,d);this._typedPostProcessUniforms=
{};if(b){this._postProcessUniforms=wade.cloneObject(b);for(var e in b)if(b.hasOwnProperty(e))switch(b[e]){case "vec2":this._typedPostProcessUniforms[e]=new Float32Array([0,0]);break;case "vec3":this._typedPostProcessUniforms[e]=new Float32Array([0,0,0]);break;case "vec4":this._typedPostProcessUniforms[e]=new Float32Array([0,0,0,0]);break;case "ivec2":this._typedPostProcessUniforms[e]=new Int32Array([0,0]);break;case "ivec3":this._typedPostProcessUniforms[e]=new Int32Array([0,0,0]);break;case "ivec4":this._typedPostProcessUniforms[e]=
new Int32Array([0,0,0,0])}}}else this._postProcessUniforms=this._typedPostProcessUniforms=null,this._postProcessShaderProgram=this._context.defaultShaderProgram,this.setRenderMode(this._renderMode,this._renderOptions);this._postProcessShaderProgram!=this._context.defaultShaderProgram&&(this._useOffScreenTarget=!0);this._needsFullRedraw=!0}};Layer.prototype.getPostProcessShader=function(){return this._postProcessShaderSource||this.getDefaultPixelShaderSource()};
Layer.prototype.getPostProcessShaderUniforms=function(){return this._typedPostProcessUniforms&&wade.cloneObject(this._postProcessUniforms)||null};Layer.prototype.setCustomProperty=function(a,b){this._customProperties[a]=b};Layer.prototype.getCustomProperty=function(a){return this._customProperties[a]};Layer.prototype.getCustomProperties=function(){return wade.cloneObject(this._customProperties)};Layer.prototype.setCustomProperties=function(a){this._customProperties=wade.cloneObject(a)};
Layer.prototype.getDefaultShaderProgram=function(){return this._context.defaultShaderProgram};Layer.prototype.enableBatching=function(a){this._batchingEnabled=!!a};Layer.prototype.isBatchingEnabled=function(){return!!this._batchingEnabled};Layer.prototype.setBlur=function(a){a!=this._blur&&(this._useOffScreenTarget=this._useOffScreenTarget||!!a,this._needsFullRedraw=!0,this._blur=a)};Layer.prototype.getBlur=function(){return this._blur};
Layer.prototype.alwaysUpdateBlur=function(a){this._alwaysUpdateBlur=a};function Path(a,b){this._inScene=!1;wade.isArray(a)?(this._nodes=a,this._name=b):(this._nodes=a&&a.nodes||[],this._name=a&&a.name||"");this._nodes=this._nodes||[];this._nodes.length||(this._nodes[0]={duration:0,tweenType:"no easing"});this._name=this._name||""}Path.prototype.setNodes=function(a){this._nodes=wade.cloneArray(a)};Path.prototype.setNode=function(a,b){this._nodes[a]=wade.cloneObject(b)};Path.prototype.getNodes=function(){return wade.cloneArray(this._nodes)};
Path.prototype.addNode=function(a){return this._nodes.push(a)-1};Path.prototype.removeNode=function(a){wade.removeObjectFromArrayByIndex(a||0,this._nodes)};Path.prototype.getNode=function(a){a=a||0;return this._nodes[a]&&wade.cloneObject(this._nodes[a])};Path.prototype.getNodeRef=function(a){return this._nodes[a||0]};Path.prototype.getNodeCount=function(){return this._nodes.length};Path.prototype.getName=function(){return this._name};
Path.prototype.setName=function(a){if(!this._name||this._name!=a){var b=this._name;this._name=a;wade.onObjectNameChange(this,b,this._name)}};Path.prototype.isInScene=function(){return this._inScene};Path.prototype.serialize=function(a){var b={type:"Path",nodes:wade.cloneArray(this._nodes),name:this._name};a&&(b=JSON.stringify(b,null,"\t"));return b};Path.prototype.clone=function(){var a=new Path(this.serialize());a._inScene=!1;return a};
Path.prototype.debugDraw=function(a,b){"undefined"==typeof a&&(a=!0);"undefined"==typeof b&&(b=1);if("ok"!=wade.getLoadingStatus("__wade_pathLine_")){var c=new Sprite(null,b);c.setSize(40,4);c.setDrawFunction(wade.drawFunctions.solidFill_("#eae"));c.drawToImage("__wade_pathLine_",!0,null,null,"","2d")}"ok"!=wade.getLoadingStatus("__wade_pathNode_")&&(c=new Sprite(null,b),c.setSize(51,51),c.setDrawFunction(wade.drawFunctions.radialGradientCircle_(["#b3b","#b3b","#e6e","#eae"],"rgba(0,0,0,0)")),c.drawToImage("__wade_pathNode_",
!0,null,null,"","2d"));"ok"!=wade.getLoadingStatus("__wade_pathSubNode_")&&(c=new Sprite(null,b),c.setSize(13,13),c.setDrawFunction(wade.drawFunctions.radialGradientCircle_(["#b3b","#b3b"],"rgba(0,0,0,0)")),c.drawToImage("__wade_pathSubNode_",!0,null,null,"","2d"));if(a){this._debugDraw||(this._debugDraw=new SceneObject,this._debugDraw.noExport=!0);this._debugDraw.isInScene()||wade.addSceneObject(this._debugDraw,!1);this._debugDraw.removeAllSprites();for(c=0;c<this._nodes.length;c++)if(this._nodes[c]&&
this._nodes[c].position){var d=new Sprite("__wade_pathNode_",b);d.nodeIndex=c;d.isNodeSprite=!0;var e={x:this._nodes[c].position.x,y:this._nodes[c].position.y,angle:this._nodes[c].rotation||0},f=new TextSprite(c.toString(),"16px Arial","#FFF","center",b);f.setOutline(1,"#FFF");f.nodeIndex=c;f.isNodeSprite=!0;if(this._nodes[c+1]&&this._nodes[c+1].position){var g={x:this._nodes[c].position.x,y:this._nodes[c].position.y},i=this._nodes[c+1].position,h=wade.vec2.sub(i,g),k=Math.floor(wade.vec2.length(h)/
32),j=new Sprite("__wade_pathLine_",b);j.setSize(wade.vec2.length(h),2);var l=wade.vec2.add(g,wade.vec2.scale(h,0.5));l.angle=Math.atan2(g.y-i.y,g.x-i.x);this._debugDraw.addSprite(j,l);i=this._getInterpolationFunction(c);for(j=0;j<k;j++)if(l={x:i(j/(k-1),g.x,h.x),y:i(j/(k-1),g.y,h.y)},j!=k-1){var m=new Sprite("__wade_pathSubNode_",b);m.nodeIndex=c;m.isIntermediateSprite=!0;this._debugDraw.addSprite(m,l)}}this._debugDraw.addSprite(d,e);e.y+=10;this._debugDraw.addSprite(f,{x:e.x,y:e.y-4,angle:e.angle})}}else wade.removeSceneObject(this._debugDraw),
this._debugDraw=null;return this._debugDraw};Path.getDebugDrawObject=function(){return this._debugDraw||null};
Path.prototype.evaluate=function(a,b){for(var c,d,e=0,f=0,g=0;g<this._nodes.length-1;g++)if(f=e,e+=this._nodes[g].duration,e>=b){var i=g;c=this._nodes[g];d=this._nodes[g+1];break}if(!c||!d)return this._nodes.length-1;e=(b-f)/c.duration;g=this._getInterpolationFunction(g);"undefined"!=typeof c.position&&a.setPosition(this._evaluateProperty("position",g,e,c,d));"undefined"!=typeof c.rotation&&a.setRotation(this._evaluateProperty("rotation",g,e,c,d));if("undefined"!=typeof c.size)for(var h=this._evaluateProperty("size",
g,e,c,d),f=0;f<a.getSpriteCount();f++)a.getSprite(f).setSize(h.x,h.y);if("undefined"!=typeof c.opacity)for(var k=this._evaluateProperty("opacity",g,e,c,d),f=0;f<a.getSpriteCount();f++){for(var h=a.getSprite(f),j=h.getDrawModifiers(),l=j.length-1;0<=l;l--){var m=j[l];("alpha"==m.type||"fadeOpacity"==m.type)&&wade.removeObjectFromArrayByIndex(l,j)}j.push({type:"alpha",alpha:k});l=h instanceof TextSprite?TextSprite.prototype:Sprite.prototype;l="webgl"==wade.getLayer(h.getLayerId()).getRenderMode()?l.draw_gl:
l.draw;h.setDrawFunction(l);h.setDrawModifiers(j)}if(c.properties&&d.properties)for(var q in c.properties){k=this._evaluateProperty(q,g,e,c.properties,d.properties);a[q]=k;for(f=0;f<a.getSpriteCount();f++)h=a.getSprite(f),h[q]=k}return i};
Path.prototype.setFromSceneObject=function(a,b){var b=b||0,c=this._nodes[b],d=this._nodes[b+1];if(c&&d){"undefined"!=typeof d.position&&(c.position=a.getPosition());"undefined"!=typeof d.rotation&&(c.rotation=a.getRotation());"undefined"!=typeof d.size&&a.getSprite()&&(c.size=a.getSprite().getSize());if("undefined"!=typeof d.opacity&&a.getSprite())for(var e=a.getSprite().getDrawModifiers(),f=0;f<e.length;f++)"alpha"==e[f].type&&(c.opacity=e[f].alpha||0);if(d.properties)for(var g in d.properties){c=
a[g];if("undefined"!=typeof c){"object"==typeof c&&(wade.isArray(c)?wade.cloneArray(c):wade.cloneObject(c));break}for(c=0;c<a.getSpriteCount();c++)if(d=a.getSprite(c)[g],"undefined"!=typeof d){"object"==typeof d&&(wade.isArray(d)?wade.cloneArray(d):wade.cloneObject(d));break}}}};Path.prototype.onAddToScene=function(){this._inScene=!0};Path.prototype.onRemoveFromScene=function(){this._inScene=!1;wade.removeSceneObject(this._debugDraw)};
Path.prototype._evaluateProperty=function(a,b,c,d,e){if("undefined"==typeof e[a])return d[a];var f=typeof d[a];if("object"==f){var f={},g;for(g in d[a])f[g]=this._evaluateProperty(g,b,c,d[a],e[a]);return f}return"number"==f?b(c,d[a],e[a]-d[a]):a[d]};Path.prototype._getInterpolationFunction=function(a){a=this._nodes[a];return this["_interpolate_"+a.tweenType+(a.easeIn?"1":"0")+(a.easeOut?"1":"0")]||this._lerp};Path.prototype._lerp=function(a,b,c){return c*a+b};
Path.prototype._interpolate_quadratic10=function(a,b,c){return c*a*a+b};Path.prototype._interpolate_quadratic01=function(a,b,c){return-c*a*(a-2)+b};Path.prototype._interpolate_quadratic11=function(a,b,c){a*=2;if(1>a)return c/2*a*a+b;a--;return-c/2*(a*(a-2)-1)+b};Path.prototype._interpolate_cubic10=function(a,b,c){return c*a*a*a+b};Path.prototype._interpolate_cubic01=function(a,b,c){a--;return c*(a*a*a+1)+b};
Path.prototype._interpolate_cubic11=function(a,b,c){a*=2;if(1>a)return c*a*a*a/2+b;a-=2;return c/2*(a*a*a+2)+b};Path.prototype._interpolate_quartic10=function(a,b,c){return c*a*a*a*a+b};Path.prototype._interpolate_quartic01=function(a,b,c){a--;return-c*(a*a*a*a-1)+b};Path.prototype._interpolate_quartic11=function(a,b,c){a*=2;if(1>a)return c*a*a*a*a/2+b;a-=2;return-c/2*(a*a*a*a-2)+b};Path.prototype._interpolate_quintic10=function(a,b,c){return c*a*a*a*a*a+b};
Path.prototype._interpolate_quintic01=function(a,b,c){a--;return c*(a*a*a*a*a+1)+b};Path.prototype._interpolate_quintic11=function(a,b,c){a*=2;if(1>a)return c*a*a*a*a*a/2+b;a-=2;return c/2*(a*a*a*a*a+2)+b};Path.prototype._interpolate_sinusoidal10=function(a,b,c){return-c*Math.cos(a*Math.PI/2)+c+b};Path.prototype._interpolate_sinusoidal01=function(a,b,c){return c*Math.sin(a*Math.PI/2)+b};Path.prototype._interpolate_sinusoidal11=function(a,b,c){return-c/2*(Math.cos(a*Math.PI)-1)+b};
Path.prototype._interpolate_exponential10=function(a,b,c){return c*Math.pow(2,10*(a-1))+b};Path.prototype._interpolate_exponential01=function(a,b,c){return c*(-Math.pow(2,-10*a)+1)+b};Path.prototype._interpolate_exponential11=function(a,b,c){a*=2;if(1>a)return c/2*Math.pow(2,10*(a-1))+b;a--;return c/2*(-Math.pow(2,-10*a)+2)+b};Path.prototype._interpolate_circular10=function(a,b,c){return-c*(Math.sqrt(1-a*a)-1)+b};
Path.prototype._interpolate_circular01=function(a,b,c){a--;return c*Math.sqrt(1-a*a)+b};Path.prototype._interpolate_circular11=function(a,b,c){a*=2;if(1>a)return-c/2*(Math.sqrt(1-a*a)-1)+b;a-=2;return c/2*(Math.sqrt(1-a*a)+1)+b};function QuadTreeNode(a,b,c,d,e){this._level=a;this.minX=b;this.minY=c;this.maxX=d;this.maxY=e;this._children=[];this._objects=[]}QuadTreeNode.prototype.c_idealObjectCountPerLevel=1;QuadTreeNode.prototype.c_maxLevels=8;
QuadTreeNode.prototype.addObject=function(a){if(!this._insertInChild(a)&&(a.quadTreeNode=this,this._objects.push(a),this._objects.length>this.c_idealObjectCountPerLevel&&!this._children.length&&this._level<this.c_maxLevels)){var a=this.minX+(this.maxX-this.minX)/2,b=this.minY+(this.maxY-this.minY)/2;this._children.push(new QuadTreeNode(this._level+1,this.minX,this.minY,a,b));this._children.push(new QuadTreeNode(this._level+1,a,this.minY,this.maxX,b));this._children.push(new QuadTreeNode(this._level+
1,this.minX,b,a,this.maxY));this._children.push(new QuadTreeNode(this._level+1,a,b,this.maxX,this.maxY));for(a=this._objects.length-1;0<=a;a--)this._insertInChild(this._objects[a])&&this.removeObject(this._objects[a])}};QuadTreeNode.prototype.removeObject=function(a){wade.removeObjectFromArray(a,this._objects)};
QuadTreeNode.prototype.getObjects=function(a){if(wade.boxIntersectsBox(this,a)){for(var b=[].concat(this._objects),c=0;c<this._children.length;c++)b=b.concat(this._children[c].getObjects(a));return b}return[]};
QuadTreeNode.prototype.addObjectsInAreaToArray=function(a,b,c){var d=c=c||0;if(wade.boxIntersectsBox(this,a)){for(var e=0;e<this._objects.length;e++)wade.boxIntersectsBox(a,this._objects[e].boundingBox)&&(b[c++]=this._objects[e]);for(e=0;e<this._children.length;e++)c+=this._children[e].addObjectsInAreaToArray(a,b,c)}return c-d};
QuadTreeNode.prototype.countObjects=function(a){if(wade.boxIntersectsBox(this,a)){for(var b=this._objects.length,c=0;c<this._children.length;c++)b+=this._children[c].countObjects(a);return b}return 0};QuadTreeNode.prototype.flagObjects=function(a,b){if(wade.boxIntersectsBox(this,a)){for(var c=0;c<this._objects.length;c++)wade.boxIntersectsBox(a,this._objects[c].boundingBox)&&(this._objects[c][b]=1);for(c=0;c<this._children.length;c++)this._children[c].flagObjects(a,b)}};
QuadTreeNode.prototype.empty=function(){for(var a=this._objects.length=0;a<this._children.length;a++)this._children[a].empty()};QuadTreeNode.prototype._insertInChild=function(a){for(var b=0;b<this._children.length;b++)if(wade.boxContainsBox(this._children[b],a.boundingBox))return this._children[b].addObject(a),!0;return!1};
function Renderer(){var a={},b=[],c=0,d=0,e=0,f="full",g=1920,i=1080,h=0,k=0,j={x:0,y:0,z:1},l={},m=!0,q=!1,u=0,x=0;this._createLayerIfNeeded=function(c,d){a[c]||(a[c]=new Layer(c,d),m||a[c].setSmoothing(m),b.push(a[c]),b.sort(this._layerSorter))};this.removeLayer=function(c){a[c]&&(wade.removeObjectFromArray(a[c],b),b.sort(this._layerSorter),a[c].removeCanvas(),a[c]=null)};this.removeUnusedLayers=function(a){for(var c=b.length-1;0<=c;c--)!b[c].getSpriteCount()&&(!a||-1==a.indexOf(b[c].id))&&this.removeLayer(b[c].id)};
this.getActiveLayerIds=function(){return wade.cloneArray(b)};this.init=function(a){e=a;a=document.getElementById(wade.getContainerName());c=parseInt(a.getAttribute("width"));d=parseInt(a.getAttribute("height"))};this.draw=function(a,j){var n,l,m;if(e.getSimulationDirtyState()||a||j){wade.numDrawCalls=0;var y=wade.logDrawTime&&console.time&&console.timeEnd&&0.02>Math.random();y&&console.time("Draw");var v=document.getElementById(wade.getContainerName()),z=wade.getForcedOrientation();n=wade.getContainerWidth();
l=wade.getContainerHeight();var F=q;switch(z){case "landscape":l>n&&(q=!q);break;case "portrait":n>l&&(q=!q);break;default:q=!1}if(q!=F){var A=q?"rotateZ(90deg)":"translate3d(0, 0, 0)";v.style.MozTransform=A;v.style.msTransform=A;v.style.OTransform=A;v.style.webkitTransform=A;v.style.transform=A}A=!1;n=wade.getContainerWidth();l=wade.getContainerHeight();var G=u!=n||x!=l;if(G){var s={width:n,height:l};e.processEvent("onContainerResize",s)||wade.app.onContainerResize&&wade.app.onContainerResize(s)}var B,
C;if("full"==f){var s=c,E=d;c=Math.max(Math.min(n,g),h);d=Math.max(Math.min(l,i),k);c>n||d>l?c/n>d/l?(d=Math.max(Math.min(Math.min(d,l)*c/n,i),k),B=n+"px",C=Math.floor(n*d/c)+"px"):(c=Math.max(Math.min(Math.min(c,n)*d/l,g),h),B=Math.floor(l*c/d)+"px",C=l+"px"):c<n&&d<l?c/n>d/l?(C=Math.floor(n*d/c)+"px",B=n+"px"):(C=l+"px",B=Math.floor(l*c/d)+"px"):(C=d+"px",B=c+"px");if(s!=c||E!=d)v.setAttribute("width",c.toString()),v.setAttribute("height",d.toString()),e.onResize(s,E,c,d),A=!0}else"stretch to fit"==
f?n/c>l/d?(B=Math.floor(l*c/d)+"px",C=n+"px"):(B=n+"px",C=Math.floor(n*d/c)+"px"):"container"==f&&(s=c,E=d,c=v.getAttribute("width"),d=v.getAttribute("height"),A=s!=c||E!=d,B=c+"px",C=d+"px",A&&(m=!0,e.onResize(s,E,c,d)));if(m=m||B&&C&&(B!=v.style.width||C!=v.style.height)||q!=F||q&&G)v.style.width=B,v.style.height=C,q?"landscape"==z?(z=getComputedStyle(v),z=(parseInt(z.marginLeft)+parseInt(z.marginRight))/2,v.style.marginLeft=z+"px",v.style.marginTop="auto"):"portrait"==z&&(z=getComputedStyle(v),
z=(parseInt(z.marginTop)+parseInt(z.marginBottom))/2,v.style.marginTop=z+"px",v.style.marginLeft="auto"):v.style.margin="auto";x=l;u=n;z={};for(n=0;n<b.length;n++)if(l=b[n],1!=l.getResolutionFactor()&&B&&C&&B==C&&"auto"==B?l.setCanvasStyleSize(v.getAttribute("width")+"px",v.getAttribute("height")+"px"):m&&l.setCanvasStyleSize(B,C),A&&l.resize(c,d),!a||!("number"==typeof a&&a!=l.id||a.indexOf&&-1==a.indexOf(l.id)))F=l.getCanvas().id,z[F]=z[F]||j||l.hasAnythingChanged();for(n=0;n<b.length;n++)l=b[n],
z[l.getCanvas().id]&&l.draw(j);y&&(console.timeEnd("Draw"),console.log("Number of draw calls: "+wade.numDrawCalls));e.clearSimulationDirtyState()}};this.addSprite=function(a){a.getLayer().addSprite(a)};this.removeSprite=function(a){a.getLayer().removeSprite(a)};this._layerSorter=function(a,b){return b.id-a.id};this.getLayer=function(b,c){this._createLayerIfNeeded(b,c);return a[b]};this.getLayerSorting=function(b){return a[b].getSorting()};this.setLayerSorting=function(b,c){this._createLayerIfNeeded(b);
a[b].setSorting(c)};this.setLayerTransform=function(b,c,d){this._createLayerIfNeeded(b);a[b].setTransform(c,d)};this.setLayerResolutionFactor=function(b,c){this._createLayerIfNeeded(b);a[b].setResolutionFactor(c)};this.getLayerResolutionFactor=function(b){return a[b]&&a[b].getResolutionFactor()};this.setResolutionFactor=function(a){for(var c=0;c<b.length;c++)b[c].setResolutionFactor(a)};this.setLayerSmoothing=function(b,c){this._createLayerIfNeeded(b);a[b].setSmoothing(c)};this.getLayerSmoothing=
function(b){return a[b]&&a[b].getSmoothing()};this.setSmoothing=function(a){m=a;for(a=0;a<b.length;a++)b[a].setSmoothing(m)};this.getSmoothing=function(){return m};this.getScreenWidth=function(){return c};this.getScreenHeight=function(){return d};this.setScreenSize=function(a,e){if(a!=c||e!=d){c=a;d=e;for(var f=0;f<b.length;f++)b[f].resize(c,d)}};this.getMaxScreenWidth=function(){return g};this.getMaxScreenHeight=function(){return i};this.setMaxScreenSize=function(a,b){g=a;i=b;if(c>g||d>i)e.setSimulationDirtyState(),
this.draw()};this.getMinScreenWidth=function(){return h};this.getMinScreenHeight=function(){return k};this.setMinScreenSize=function(a,b){h=a;k=b;if(c<h||d<k)e.setSimulationDirtyState(),this.draw()};this.setCanvasClearing=function(b,c){this._createLayerIfNeeded(b);a[b].setCanvasClearing(c)};this.setWindowMode=function(a){f=a};this.getWindowMode=function(){return f};this.getCameraPosition=function(){return{x:j.x,y:j.y,z:j.z}};this.setCameraPosition=function(a){var c=j;j={x:a.x,y:a.y,z:a.z};for(var d=
0;d<b.length;d++)b[d].onCameraPositionChanged(a);a={oldPosition:c,newPosition:{x:a.x,y:a.y,z:a.z}};(c.x!=j.x||c.y!=j.y||c.z!=j.z)&&!wade.processEvent("onCameraMove",a)&&wade.app&&wade.app.onCameraMove&&wade.app.onCameraMove(a)};this.worldPositionToScreen=function(a,b){return this.getLayer(a).worldPositionToScreen(b)};this.worldDirectionToScreen=function(a,b){return this.getLayer(a).worldDirectionToScreen(b)};this.worldBoxToScreen=function(a,b){return this.getLayer(a).worldBoxToScreen(b)};this.worldUnitToScreen=
function(a){return this.getLayer(a).worldUnitToScreen()};this.screenPositionToWorld=function(a,b){return this.getLayer(a).screenPositionToWorld(b)};this.screenDirectionToWorld=function(a,b){return this.getLayer(a).screenDirectionToWorld(b)};this.screenUnitToWorld=function(a){return this.getLayer(a).screenUnitToWorld()};this.screenBoxToWorld=function(a,b){return this.getLayer(a).screenBoxToWorld(b)};this.worldPositionToCanvas=function(a,b){return this.getLayer(a).worldPositionToCanvas(b)};this.worldDirectionToCanvas=
function(a,b){return this.getLayer(a).worldDirectionToCanvas(b)};this.worldBoxToCanvas=function(a,b){return this.getLayer(a).worldBoxToCanvas(b)};this.worldUnitToCanvas=function(a){return this.getLayer(a).worldUnitToCanvas()};this.canvasPositionToWorld=function(a,b){return this.getLayer(a).canvasPositionToWorld(b)};this.canvasDirectionToWorld=function(a,b){return this.getLayer(a).canvasDirectionToWorld(b)};this.canvasUnitToWorld=function(a){return this.getLayer(a).canvasUnitToWorld()};this.canvasBoxToWorld=
function(a,b){return this.getLayer(a).canvasBoxToWorld(b)};this.removeCanvases=function(){for(var a=0;a<b.length;a++)b[a].removeCanvas()};this.getNumExistingLayers=function(){return b.length};this.recreateCanvases=function(){for(var a=0;a<b.length;a++)b[a].initCanvas()};this.enableDoubleBuffering=function(a){if(a)for(a=0;a<b.length;a++)b[a].createSecondaryCanvas();else for(a=0;a<b.length;a++)b[a].removeSecondaryCanvas()};this.isScreenRotated=function(){return q};this.addSpritesInAreaToArray=function(c,
d,e,f){if("undefined"!=typeof e)a[e]&&a[e].addSpritesInAreaToArray(c,d,f);else for(e=0;e<b.length;e++)b[e].addSpritesInAreaToArray(c,d,f)};this.addObjectsInAreaToArray=function(a,b,c){var d=[];this.addSpritesInAreaToArray(a,d,c);for(a=0;a<d.length;a++)c=d[a].getSceneObject(),-1==b.lastIndexOf(c)&&b.push(c)};this.addSpritesInScreenAreaToArray=function(a,c,d){for(var e=0;e<b.length;e++){var f=wade.screenBoxToWorld(b[e].id,a);b[e].addSpritesInAreaToArray(f,c,d)}};this.addObjectsInScreenAreaToArray=function(a,
b){var c=[];this.addSpritesInScreenAreaToArray(a,c);for(var d=0;d<c.length;d++){var e=c[d].getSceneObject();-1==b.lastIndexOf(e)&&b.push(e)}};this.forceRedraw=function(c){if(c)a[c].forceRedraw();else for(c=0;c<b.length;c++)b[c].forceRedraw()};this.getActiveLayerIds=function(){for(var a=[],c=0;c<b.length;c++)a.push(b[c].id);return a};this.addImageUser=function(a,b){l[a]||(l[a]=[]);l[a].push(b)};this.removeImageUser=function(a,b){l[a]&&wade.removeObjectFromArray(b,l[a])};this.removeAllImageUsers=function(a){l[a]&&
(l[a].length=0)};this.getImageUsers=function(a){return l[a]};this.updateImageUsers=function(a){var b=l[a];if(b){for(var c=0;c<b.length;c++)if(b[c].setDirtyArea&&b[c].setDirtyArea(),b[c].setActiveImage(a),b[c].getAlphaThreshold&&b[c].getAlphaThreshold())var d=!0;d&&wade.getImageData(a)}};this.getLayerSettings=function(a){for(var c=[],d=0;d<b.length;d++){var e=b[d];if(!a||e.getSpriteCount()){var f={};try{f=JSON.parse(JSON.stringify(e.getCustomProperties()))}catch(j){}c[e.id]={scaleFactor:e.getScaleFactor(),
translateFactor:e.getTranslateFactor(),renderMode:e.getRenderMode(),useQuadtree:e.isUsingQuadtree(),resolutionFactor:e.getResolutionFactor(),blur:e.getBlur(),postProcessShader:e.getPostProcessShader()!=e.getDefaultPixelShaderSource()?e.getPostProcessShader():"",postProcessShaderUniforms:e.getPostProcessShaderUniforms(),properties:f}}}return c};this.getAllLayers=function(){return b}}
function SceneManager(){var a=[],b=[],c=[],d={onMouseDown:[],onMouseUp:[],onMouseMove:[],onMouseWheel:[],onClick:[],onMouseIn:[],onMouseOut:[],onKeyDown:[],onKeyUp:[],onKeyPress:[],onAppTimer:[],onSimulationStep:[],onUpdate:[],onResize:[],onContainerResize:[],onDeviceMotion:[],onDeviceOrientation:[],onSwipeLeft:[],onSwipeRight:[],onSwipeUp:[],onSwipeDown:[],onBlur:[],onFocus:[],onOverlap:[],onCameraMove:[],onGamepadButtonDown:[],onGamepadButtonUp:[]},e=wade.cloneObject(d),f=0,g=!1,i={},h={},k=0;this.init=
function(){this.renderer=new Renderer;this.renderer.init(this);wade.isUsingGlobalUnderscore()&&(_=i)};this.addSceneObject=function(b,c,e){var f=b.getGridRef();if(f&&"isometric"==f.type&&!wade.iso.addSceneObject(b,wade.iso.getFlatTileCoordinates(b.getPosition())))return null;a.push(b);b.autoListen=c;b.addToSceneParams=e?wade.extend(!0,{},e):null;b.addSpritesToRenderer(this.renderer);this.addNamedObject(b);if(c&&!b.isTemplate())for(var g in d)if(d.hasOwnProperty(g)){f=b[g];if(!f)for(var h=b.getBehaviors(),
c=0;c<h.length&&!f;c++)f=h[c][g];f&&wade.addEventListener(b,g)}if(b.isTemplate()){g=b.getSpriteCount();for(c=0;c<g;c++)b.getSprite(c).setVisible(!1)}!b.simulated&&b.needsSimulation()&&wade.simulateSceneObject(b,!0);wade.isImportingScene()?setTimeout(function(){b.processEvent("onAddToScene",e)},0):b.processEvent("onAddToScene",e);var i=b.getFlowChart();i&&wade.setTimeout(function(){b.isInScene()&&wade.runFlowChart(i,null,!0,0,b)},0)};this.addPath=function(a){b.push(a);this.addNamedObject(a);a.onAddToScene()};
this.addSceneObjectGroup=function(a){c.push(a);this.addNamedObject(a)};this.addNamedObject=function(a){var b=a.getName();b?i[b]?wade.warn("Warning: an object named "+b+" is already present in the scene. Duplicate names can cause unexpected behavior."):i[b]=a:(b="__wade_unnamed_sceneObject_"+k++,a.setName(b))};this.removeNamedObject=function(a){a&&delete i[a]};this.changeObjectName=function(a,b){this.removeNamedObject(b);this.addNamedObject(a)};this.getObjectByName=function(a){return i[a]};this.getObjects=
function(a,b,c){if(a){var d=[],e;if("undefined"==typeof b)for(e=0;e<c.length;e++)"undefined"!=typeof c[e][a]&&d.push(c[e]);else for(e=0;e<c.length;e++)c[e][a]==b&&d.push(c[e]);return d}return wade.cloneArray(c)};this.getSceneObjects=function(b,c){return this.getObjects(b,c,a)};this.getPaths=function(a,c){return this.getObjects(a,c,b)};this.removeEventListener=function(a,b){wade.removeObjectFromArray(a,d[b])};this.removeGlobalEventListener=function(a,b){wade.removeObjectFromArray(a,e[b])};this.removeSceneObject=
function(b){if(b){var c=b.getGridRef();c&&"isometric"==c.type&&wade.iso.removeSceneObject(b);b.processEvent("onRemoveFromScene");wade.removeObjectFromArray(b,a);(c=b.getName())&&this.removeNamedObject(c);for(var f in d)d.hasOwnProperty(f)&&(d[f].length&&this.removeEventListener(b,f),e[f].length&&this.removeGlobalEventListener(b,f));b.removeSpritesFromRenderer();b.flowChartStatus&&(b.flowChartStatus.cancelled=!0)}};this.removePath=function(a){if(a){wade.removeObjectFromArray(a,b);var c=a.getName();
c&&this.removeNamedObject(c);a.onRemoveFromScene()}};this.removeSceneObjectGroup=function(a){a&&(wade.removeObjectFromArray(a,c),(a=a.getName())&&this.removeNamedObject(a))};this.clear=function(){for(var d=a.length-1;0<=d;d--)this.removeSceneObject(a[d]);for(d=b.length-1;0<=d;d--)this.removePath(b[d]);for(d=c.length-1;0<=d;d--)this.removeSceneObjectGroup(c[d])};this.step=function(){var a=wade.logSimulationTime&&console.time&&console.timeEnd&&0.02>Math.random();a&&console.time("Simulation");for(var b=
d.onSimulationStep,c=0;c<b.length;c++)b[c].step();f+=wade.c_timeStep;this.processEvent("onUpdate");b=d.onOverlap;for(c=0;c<b.length;c++)if(b[c].isInScene()){var e=b[c].getOverlappingObjects(),i=b[c].getName(),k={};h[i]||(h[i]={});for(var p=0;p<e.length;p++){var r=e[p].getName();h[i][r]||b[c].processEvent("onOverlap",{otherObject:e[p]});k[r]=!0}h[i]=k}a&&console.timeEnd("Simulation");g=!0};this.addEventListener=function(a,b){!d[b]&&(d[b]=[]);!e[b]&&(e[b]=[]);-1==d[b].indexOf(a)&&d[b].push(a)};this.addGlobalEventListener=
function(a,b){!d[b]&&(d[b]=[]);!e[b]&&(e[b]=[]);-1==e[b].indexOf(a)&&e[b].push(a)};this.getEventListeners=function(a,b){var c=[],e,f;switch(a){case "onMouseDown":case "onMouseUp":case "onMouseMove":case "onMouseWheel":case "onClick":case "onMouseIn":case "onMouseOut":case "onSwipeLeft":case "onSwipeRight":case "onSwipeUp":case "onSwipeDown":var g={x:b.screenPosition.x,y:b.screenPosition.y};for(e=d[a].length-1;0<=e;e--){f=d[a][e];var h=f.getSpriteAtPosition(g);h.isPresent&&(f.eventResponse={spriteIndex:h.spriteIndex,
position:h.relativeWorldPosition,screenPosition:g,topLayer:h.topLayer,button:b.button,value:b.value,shift:b.shift,ctrl:b.ctrl,alt:b.alt,meta:b.meta,pointerId:b.pointerId||0},c.push(f))}c.sort(this.eventListenersSorter);break;default:for(e=d[a].length-1;0<=e;e--)f=d[a][e],f.eventResponse=b,c.push(f)}return c};this.eventListenersSorter=function(a,b){return a.eventResponse.topLayer-b.eventResponse.topLayer||-wade.getLayer(a.eventResponse.topLayer).compareSprites(a.getSprite(a.eventResponse.spriteIndex),
b.getSprite(b.eventResponse.spriteIndex))};this.isObjectListeneningForEvent=function(a,b){var c=d[b];return!!(c&&0<=c.indexOf(a))};this.onResize=function(b,c,d,e){for(var f=0;f<a.length;f++){var g=a[f],h=g.getPosition(),i=g.getAlignment(),k=0,t=0;switch(i.x){case "right":k=(d-b)/2;break;case "left":k=-(d-b)/2}switch(i.y){case "top":t=-(e-c)/2;break;case "bottom":t=(e-c)/2}g.setPosition(h.x+k,h.y+t);if(g.isMoving()&&(k||t))(h=g.getTargetPosition())&&g.moveTo(h.x+k,h.y+t,g.getMovementSpeed())}b={width:d,
height:e};this.processEvent("onResize",b)||wade.app.onResize&&wade.app.onResize(b)};this.processEvent=function(a,b){for(var c=this.getEventListeners(a,b),d=!1,f=0;f<c.length;f++){var g=c[f];if(g.processEvent(a,g.eventResponse)){d=!0;break}}c=b&&wade.cloneObject(b)||{};c.global=!0;for(f=0;f<e[a].length;f++)e[a][f].processEvent(a,c);return d};this.appTimerEvent=function(){for(var a=0;a<d.onAppTimer.length;a++)d.onAppTimer[a].processEvent("onAppTimer");wade.app&&wade.app.onAppTimer&&wade.app.onAppTimer()};
this.updateMouseInOut=function(a,b){var c,d,e="undefined"!=typeof a.x;if(e){var f=this.getEventListeners("onMouseOut",{screenPosition:a});for(c=0;c<f.length&&!(d=f[c],!d.getSpriteAtPosition(b).isPresent&&d.processEvent("onMouseOut",d.eventResponse));c++);}f=this.getEventListeners("onMouseIn",{screenPosition:b});for(c=0;c<f.length&&!(d=f[c],(!e||!d.getSpriteAtPosition(a).isPresent)&&d.processEvent("onMouseIn",d.eventResponse));c++);};this.getAppTime=function(){return f};this.getSimulationDirtyState=
function(){return g};this.clearSimulationDirtyState=function(){g=!1};this.setSimulationDirtyState=function(){g=!0};this.draw=function(a,b){this.renderer.draw(a,b)};this.exportSceneObjects=function(b,c){for(var d=[],e=0;e<a.length;e++)b&&(-1!=b.indexOf(a[e])||a[e].getName()&&-1!=b.indexOf(a[e].getName()))||a[e].noExport||d.push(a[e].serialize(!1,null,c));return d};this.exportPaths=function(a){for(var c=[],d=0;d<b.length;d++)(!a||!(-1!=a.indexOf(b[d])||b[d].getName()&&-1!=a.indexOf(b[d].getName())))&&
c.push(b[d].serialize(!1));return c};this.exportSceneObjectGroups=function(a){for(var b=[],d=0;d<c.length;d++)(!a||!(-1!=a.indexOf(c[d])||c[d].getName()&&-1!=a.indexOf(c[d].getName())))&&b.push(c[d].serialize(!1));return b};this.getSceneObjectIndex=function(b){return a.indexOf(b)};this.getPathIndex=function(a){return b.indexOf(a)};this.getSceneObjectGroupIndex=function(a){return c.indexOf(a)};this.getSceneObjectGroups=function(a){if(!a)return wade.extend([],c);wade.isArray(a)||(a=[a]);for(var b=[],
d=0;d<c.length;d++){for(var e=!0,f=0;f<a.length;f++)if(-1==c[d].indexOf(a[f])){e=!1;break}e&&b.push(c[d])}};this.setObjectIndex=function(a,b,c){var d=c.indexOf(a);return-1!=d&&b!=d?(wade.removeObjectFromArrayByIndex(d,c),c.length>b?(c.splice(b,0,a),b):c.push(a)-1):-1};this.setSceneObjectIndex=function(b,c){return this.setObjectIndex(b,c,a)};this.setPathIndex=function(a,c){return this.setObjectIndex(a,c,b)};this.setSceneObjectGroupIndex=function(a,b){return this.setObjectIndex(a,b,c)}}
function SceneObject(a,b,c,d,e){this._behaviors=[];this._spriteOffsets=[];this._moving=!1;this._linearVelocity={x:0,y:0};this._animationsPlaying=this._targetPosition=0;this._inScene=!1;this._pathTime=this._angularVelocity=this._renderer=0;this._pathSpeed=1;this._pathNodeIndex=-1;this._isTemplate=!1;this._rotationTarget={valid:!1,value:0};this._timeouts=[];this.addToSceneParams=this._flowChart=this._grid=null;this.autoListen=!1;var f="object"==typeof a&&!wade.isArray(a)&&!(a instanceof Sprite)&&!(a instanceof
TextSprite)&&a;if(f){this._position={x:a.position&&a.position.x||0,y:a.position&&a.position.y||0};this._rotation=a.rotation||0;this._alignment={x:a.alignment&&a.alignment.x||0,y:a.alignment&&a.alignment.y||0};this._name=a.name;this._isTemplate=a.isTemplate;this._behaviorClasses=[];this._sprites=[];this._flowChart=a.flowChart||null;this._grid=a.grid||null;if(this._path=a.path)this._path=wade.getPath(this._path);wade.isDebugMode()&&!this._name&&(wade.unnamedSceneObjectsCount=(wade.unnamedSceneObjectsCount||
0)+1,this._name="Unnamed_Scene_Object_"+wade.unnamedSceneObjectsCount);if(a.behaviors)for(b=0;b<a.behaviors.length;b++)a.behaviors[b].name&&this._behaviorClasses.push(window[a.behaviors[b].name]);if(a.sprites)for(b=0;b<a.sprites.length;b++)c="TextSprite"==a.sprites[b].type?new TextSprite(a.sprites[b]):new Sprite(a.sprites[b]),this.addSprite(c,a.spriteOffsets&&a.spriteOffsets[b]);a.functions&&this.importFunctions(a.functions);if(a.properties)for(var g in a.properties)if(a.properties.hasOwnProperty(g))try{this[g]=
JSON.parse(JSON.stringify(a.properties[g]))}catch(i){}}else this._position={x:c?c:0,y:d?d:0},this._behaviorClasses=b,this._sprites=a,this._alignment={x:0,y:0},this._rotation=0,this._name=e||"",this._path=null;if(this._sprites){wade.isArray(this._sprites)||(this._sprites=[this._sprites]);for(b=0;b<this._sprites.length;b++)this._sprites[b].setSceneObject(this),(c=this._spriteOffsets[b])?(c.x=c.x||0,c.y=c.y||0,c.angle=c.angle||0,"number"!=typeof c.originalX&&(c.originalX=c.x,c.originalY=c.y,this._rotation&&
wade.vec2.rotateInPlace(c,this._rotation)),this._sprites[b].setPosition(this._position.x+c.x,this._position.y+c.y),this._sprites[b].setRotation(this._rotation+c.angle)):(this._sprites[b].setPosition(this._position),this._spriteOffsets.push({x:0,y:0,originalX:0,originalY:0,angle:0}),this._sprites[b].setRotation(this._rotation)),this._sprites[b].getAnimation&&this._sprites[b].getAnimation().isPlaying()&&this._animationsPlaying++}else this._sprites=[];if(this._behaviorClasses){wade.isArray(this._behaviorClasses)||
(this._behaviorClasses=[this._behaviorClasses]);for(b=0;b<this._behaviorClasses.length;b++)this._behaviors[b]=new this._behaviorClasses[b],this._behaviors[b].owner=this}if(f){"undefined"!=typeof a.visible&&this.setVisible(a.visible);if(a.behaviors)for(b=0;b<a.behaviors.length;b++)if(a.behaviors[b].properties)for(g in a.behaviors[b].properties)a.behaviors[b].properties.hasOwnProperty(g)&&(f=a.behaviors[b].properties[g],this._behaviors[b][g]=f&&"object"==typeof f?wade.isArray(f)?wade.cloneArray(f):
wade.cloneObject(f):f);a.addToScene&&(a=a.addToScene,wade.addSceneObject(this,a.autoListen,a.params))}this._path&&this.step()}SceneObject.prototype.setPosition=function(a,b){var c,d;"object"==typeof a?(c=a.x,d=a.y):(c=a,d=b);this._position.x=c;this._position.y=d;for(c=0;c<this._sprites.length;c++)this._sprites[c].setPosition(this._position.x+this._spriteOffsets[c].x,this._position.y+this._spriteOffsets[c].y)};SceneObject.prototype.getPosition=function(){return{x:this._position.x,y:this._position.y}};
SceneObject.prototype.setRotation=function(a){this._rotation=a;for(var b=0;b<this._sprites.length;b++){var c=this._spriteOffsets[b];this._sprites[b].setRotation(a+c.angle);if(c.originalX||c.originalY){var d=wade.vec2.rotate({x:c.originalX,y:c.originalY},a);c.x=d.x;c.y=d.y;this._sprites[b].setPosition(this._position.x+c.x,this._position.y+c.y)}}};SceneObject.prototype.getRotation=function(){return this._rotation};
SceneObject.prototype.moveTo=function(a,b,c){this._targetPosition={x:a,y:b};var d=a-this._position.x,e=b-this._position.y,f=Math.sqrt(d*d+e*e);f>c*wade.c_timeStep?(this._linearVelocity={x:d*c/f,y:e*c/f},!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!0),this._moving=!0):(this.setPosition(a,b),this.stopMoving())};
SceneObject.prototype.rotateTo=function(a,b){this._rotation%=6.28318530718;a%=6.28318530718;0>a&&(a+=6.28318530718);var c=(a-this._rotation)%6.28318530718;0>c&&(c+=6.28318530718);c>b*wade.c_timeStep?(this.setAngularVelocity(b),this._rotationTarget.value=a,this._rotationTarget.valid=!0):(this.setRotation(a),this.setAngularVelocity(0))};
SceneObject.prototype.stopMoving=function(){!this._animationsPlaying&&(!this._angularVelocity&&!this._path&&!this._timeouts.length&&this._moving)&&wade.simulateSceneObject(this,!1);var a=this._moving;this._moving=!1;this._targetPosition=0;this._linearVelocity.x=this._linearVelocity.y=0;a&&this.processEvent("onMoveComplete")};
SceneObject.prototype.step=function(){if(this._moving)if(this._targetPosition){var a=this._position.x-this._targetPosition.x,b=this._position.y-this._targetPosition.y;(this._linearVelocity.x*this._linearVelocity.x+this._linearVelocity.y*this._linearVelocity.y)*wade.c_timeStep*wade.c_timeStep<a*a+b*b?this.setPosition(this._position.x+this._linearVelocity.x*wade.c_timeStep,this._position.y+this._linearVelocity.y*wade.c_timeStep):(this.setPosition(this._targetPosition.x,this._targetPosition.y),this.stopMoving())}else this.setPosition(this._position.x+
this._linearVelocity.x*wade.c_timeStep,this._position.y+this._linearVelocity.y*wade.c_timeStep);if(a=this._angularVelocity){var a=a*wade.c_timeStep,c=this._rotation,b=c+a;if(this._rotationTarget.valid){var d=this._rotationTarget.value,c=d-c;0>c&&(c+=6.28318530718);Math.abs(c)<Math.abs(a)?(this.setRotation(d),this.setAngularVelocity(0),this.processEvent("onRotationComplete")):(b%=6.28318530718,0>b&&(b+=6.28318530718),this.setRotation(b))}else b%=6.28318530718,0>b&&(b+=6.28318530718),this.setRotation(b)}if(this._animationsPlaying)for(a=
0;a<this._sprites.length;a++)this._sprites[a].step();if(this._path){a=this._path.evaluate(this,this._pathTime);for(b=this._pathNodeIndex+1;b<=a;b++)this.process("onPathNode",{path:this._path,nodeIndex:b});this._pathNodeIndex=a;this._pathTime+=wade.c_timeStep*this._pathSpeed}for(a=this._timeouts.length-1;0<=a;a--)if(b=this._timeouts[a],0>(b.time-=1E3*wade.c_timeStep))wade.removeObjectFromArrayByIndex(a,this._timeouts),!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&
wade.simulateSceneObject(this,!1),b.callback&&b.callback()};SceneObject.prototype.playAnimation=function(a,b){for(var c=0;c<this._sprites.length;c++)this._sprites[c].playAnimation(a,b)};SceneObject.prototype.stopAnimation=function(){for(var a=0;a<this._sprites.length;a++)this._sprites[a].stopAnimation()};SceneObject.prototype.resumeAnimation=function(){for(var a=0;a<this._sprites.length;a++)this._sprites[a].resumeAnimation()};
SceneObject.prototype.getBehavior=function(a){if(a){for(var b=0;b<this._behaviors.length;b++)if(this._behaviors[b].name==a)return this._behaviors[b];return null}return this._behaviors[0]};SceneObject.prototype.getBehaviorByIndex=function(a){return this._behaviors[a||0]};SceneObject.prototype.getBehaviors=function(){return wade.cloneArray(this._behaviors)};SceneObject.prototype.getAlignment=function(){return{x:this._alignment.x,y:this._alignment.y}};
SceneObject.prototype.setAlignment=function(a,b){this._alignment.x=a;this._alignment.y=b};
SceneObject.prototype.processEvent=function(a,b){if(this._isTemplate)return!1;switch(a){case "onAnimationStart":!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!0);b.restarting||this._animationsPlaying++;break;case "onAnimationEnd":1==this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!1),this._animationsPlaying--}return this.process(a,
b)};SceneObject.prototype.process=function(a,b){var c=!1;this[a]&&(c=this[a](b));for(var d=0;d<this._behaviors.length;d++)this._behaviors[d][a]&&(c=c||this._behaviors[d][a](b));return c};
SceneObject.prototype.getSpriteAtPosition=function(a){for(var b={isPresent:!1,topLayer:9999,spriteIndex:0},c=0;c<this._sprites.length;c++){var d=this._sprites[c];if(d.containsScreenPoint(a)&&d.isVisible()){var e=d.getLayer(),f=!b.isPresent||e.id<b.topLayer;e.id==b.topLayer&&b.isPresent&&(f=0<e.compareSprites(d,this._sprites[b.spriteIndex]));f&&(b={isPresent:!0,topLayer:e.id,spriteIndex:c},d=d.getWorldOffset(a),e=this._spriteOffsets[c],d.x+=e.x,d.y+=e.y,b.relativeWorldPosition=d)}}return b};
SceneObject.prototype.setSpriteOffsets=function(a){var b;if(wade.isArray(a))for(b=this._spriteOffsets.length=0;b<a.length;b++){var c=this._spriteOffsets[b]=a[b];c.x=c.originalX=c.x||0;c.y=c.originalY=c.y||0;c.angle=c.angle||0;this._rotation&&wade.vec2.rotateInPlace(c,this._rotation)}else a.x=a.originalX=a.x||0,a.y=a.originalY=a.y||0,a.angle=a.angle||0,this._spriteOffsets=[a],this._rotation&&wade.vec2.rotateInPlace(a,this._rotation);for(b=0;b<this._spriteOffsets.length;b++)this._sprites[b]&&(this._sprites[b].setPosition(this._position.x+
this._spriteOffsets[b].x,this._position.y+this._spriteOffsets[b].y),this._sprites[b].setRotation(this._rotation+this._spriteOffsets[b].angle))};SceneObject.prototype.getSpriteOffset=function(a){a=a||0;if("string"==typeof a&&!parseInt(a))for(var b=0;b<this._sprites[b].length;b++)if(this._sprites[b].getName()==a){a=b;break}a=this._spriteOffsets[a];return{x:a.x,y:a.y,angle:a.angle}};
SceneObject.prototype.setSpriteOffset=function(a,b){a=a||0;if("string"==typeof a&&!parseInt(a))for(var c=0;c<this._sprites.length;c++)if(this._sprites[c].getName()==a){a=c;break}c=this._spriteOffsets[a];c.x=c.originalX=b.x||0;c.y=c.originalY=b.y||0;c.angle=b.angle||0;this._rotation&&wade.vec2.rotateInPlace(c,this._rotation);this._sprites[a]&&(this._sprites[a].setPosition(this._position.x+c.x,this._position.y+c.y),this._sprites[a].setRotation(this._rotation+c.angle))};
SceneObject.prototype.isMoving=function(){return this._moving};SceneObject.prototype.setVisible=function(a){for(var b=0;b<this._sprites.length;b++)this._sprites[b].setVisible(a)};SceneObject.prototype.isVisible=function(a){if(a){for(a=0;a<this._sprites.length;a++)if(!this._sprites[a].isVisible())return!1;return!0}for(a=0;a<this._sprites.length;a++)if(this._sprites[a].isVisible())return!0;return!1};
SceneObject.prototype.addSprite=function(a,b,c){"undefined"==typeof c?c=this._sprites.length:c>this._sprites.length&&(c=this._sprites.length);a.setSceneObject(this);this._sprites.splice(c,0,a);b=b?{x:b.x||0,y:b.y||0,angle:b.angle||0,originalX:b.x||0,originalY:b.y||0}:{x:0,y:0,angle:0,originalX:0,originalY:0};this._rotation&&wade.vec2.rotateInPlace(b,this._rotation);this._spriteOffsets.splice(c,0,b);a.setPosition(this._position.x+b.x,this._position.y+b.y);a.setRotation(this._rotation+b.angle);this._inScene&&
this._renderer.addSprite(a);return c};SceneObject.prototype.removeSpriteByIndex=function(a){this._renderer.removeSprite(this._sprites[a]);wade.removeObjectFromArrayByIndex(a,this._sprites);wade.removeObjectFromArrayByIndex(a,this._spriteOffsets)};SceneObject.prototype.removeSprite=function(a){for(var b=0;b<this._sprites.length;b++)if(this._sprites[b]==a){this.removeSpriteByIndex(b);break}};
SceneObject.prototype.removeAllSprites=function(){for(var a=this._sprites.length-1;0<=a;a--)this._renderer.removeSprite(this._sprites[a]);this._spriteOffsets.length=0;this._sprites.length=0};SceneObject.prototype.getSprite=function(a){return this._sprites[a||0]||this.getSpriteByName(a)};SceneObject.prototype.getSpriteByName=function(a){for(var b=0;b<this._sprites.length;b++)if(this._sprites[b].getName()==a)return this._sprites[b];return null};SceneObject.prototype.getSpriteIndex=function(a){return this._sprites.indexOf(a)};
SceneObject.prototype.isInScene=function(){return this._inScene};SceneObject.prototype.getSpriteCount=function(){return this._sprites.length};SceneObject.prototype.addBehavior=function(a){this._behaviorClasses?this._behaviorClasses.push(a):this._behaviorClasses=[a];a=new a;a.owner=this;this._behaviors.push(a);return a};
SceneObject.prototype.removeBehavior=function(a){for(var b=0;b<this._behaviors.length;b++)if(a==this._behaviors[b].name)return wade.removeObjectFromArrayByIndex(b,this._behaviors),wade.removeObjectFromArrayByIndex(b,this._behaviorClasses),!0;return!1};SceneObject.prototype.removeBehaviorByIndex=function(a){wade.removeObjectFromArrayByIndex(a,this._behaviors)};SceneObject.prototype.isAnimating=function(){return this._animationsPlaying?!0:!1};
SceneObject.prototype.getTargetPosition=function(){return this._targetPosition?{x:this._targetPosition.x,y:this._targetPosition.y}:null};SceneObject.prototype.getTargetRotation=function(){return this._rotationTarget.valid?this._rotationTarget.value:this._rotation};SceneObject.prototype.getMovementSpeed=function(){return Math.sqrt(this._linearVelocity.x*this._linearVelocity.x+this._linearVelocity.y*this._linearVelocity.y)};
SceneObject.prototype.overlapsSprite=function(a,b){for(var c=0;c<this._sprites.length;c++)if(this._sprites[c].overlapsSprite(a,b))return!0;return!1};SceneObject.prototype.overlapsObject=function(a,b){for(var c=a.getSpriteCount(),d=0;d<c;d++)if(this.overlapsSprite(a.getSprite(d),b))return!0;return!1};
SceneObject.prototype.clone=function(a,b){var c=new SceneObject;wade.extend(c,this);c._inScene=!1;c._isTemplate=!1;c._name="";c._sprites=[];for(var d=0;d<this._sprites.length;d++){var e=this._sprites[d].clone();e._sceneObject=c;this._isTemplate&&e.setVisible(!0);c._sprites.push(e)}c._position={x:this._position.x,y:this._position.y};c._linearVelocity={x:this._linearVelocity.x,y:this._linearVelocity.y};c._targetPosition=this._targetPosition?{x:this._targetPosition.x,y:this._targetPosition.y}:0;c._alignment=
{x:this._alignment.x,y:this._alignment.y};c._spriteOffsets=wade.extend(!0,[],this._spriteOffsets);c._timeouts=[];for(d=0;d<this._timeouts.length;d++)e=this._timeouts[d].time-((new Date).getTime()-this._timeouts[d].startTime),0<=e&&(this._timeouts[d].interval?c.interval(e,this._timeouts[d].name,this._timeouts[d].data,this._timeouts[d].variance):c.schedule(e,this._timeouts[d].name,this._timeouts[d].data,this._timeouts[d].variance));c._flowChart=this._flowChart&&wade.cloneObject(this._flowChart)||null;
c._grid=this._grid&&wade.cloneObject(this._grid)||null;c._behaviorClasses=wade.cloneArray(this._behaviorClasses);c._behaviors=[];if(c._behaviorClasses)for(d=0;d<c._behaviorClasses.length;d++){if("function"==typeof this._behaviors[d].clone)c._behaviors[d]=this._behaviors[d].clone(c);else{c._behaviors[d]=new this._behaviorClasses[d];for(var f in this._behaviors[d])if(this._behaviors[d].hasOwnProperty(f))if(e=typeof this._behaviors[d][f],this._behaviors[d][f]&&"object"==e)c._behaviors[d][f]=wade.isArray(this._behaviors[d][f])?
wade.cloneArray(this._behaviors[d][f]):wade.cloneObject(this._behaviors[d][f]);else if("function"!=e||!c._behaviors[d][f])c._behaviors[d][f]=this._behaviors[d][f]}c._behaviors[d].owner=c}if("undefined"!=typeof a||"undefined"!=typeof b)"undefined"==typeof a&&(a=this._position.x),"undefined"==typeof b&&(b=this._position.y),c.setPosition(a,b);c.instanceOf=this.instanceOf||this._name||"";this.simulated&&(c.simulated=!1,wade.simulateSceneObject(c,!0));return c};
SceneObject.prototype.toGrid=function(a,b,c,d){var e,f,c=c||0,d=d||0,g=this._position,i=Infinity;f=Infinity;var h=-Infinity,k=-Infinity;for(e=0;e<this.getSpriteCount();e++){var j=this.getSprite(e),l=this.getSpriteOffset(e),j=j.getSize(),i=Math.min(i,l.x-j.x/2);f=Math.min(f,l.y-j.y/2);h=Math.max(h,l.x+j.x/2);k=Math.max(k,l.y+j.y/2)}i=h-i;k-=f;h=[[this]];for(e=1;e<=a;e++){h[e-1]=h[e-1]||[];for(f=1;f<=b;f++)1==e&&1==f||(l=this.clone(g.x+(e-1)*(i+c),g.y+(f-1)*(k+d)),wade.addSceneObject(l),h[e-1].push(l))}return h};
SceneObject.prototype.serialize=function(a,b,c){for(var d=0;d<this._behaviors.length;d++)this._behaviors[d].preSerialize&&this._behaviors[d].preSerialize();var e={type:"SceneObject",position:{x:this._position.x,y:this._position.y},rotation:this._rotation,behaviors:[],sprites:[],spriteOffsets:[],flowChart:this._flowChart&&wade.cloneObject(this._flowChart),grid:this._grid&&wade.cloneObject(this._grid),alignment:{x:this._alignment.x||"center",y:this._alignment.y||"center"},name:this._name,isTemplate:this._isTemplate,
path:this._path?this._path.getName():"",addToScene:this._inScene?{autoListen:this.autoListen,params:this.addToSceneParams}:null,properties:{}};if(this._behaviorClasses)for(d=0;d<this._behaviorClasses.length;d++){var f=this._behaviors[d].name||this._behaviorClasses[d].name;if(!f){for(var g in window)try{if(window.hasOwnProperty(g)&&"function"==typeof window[g]&&window[g]==this._behaviorClasses[d]){f=g;break}}catch(i){}f||wade.warn("Warning - Trying to export a scene object with an unnamed behavior, which will be skipped. Add a 'name' property to your behaviors to correct this.")}if(f){var h;
if(this._behaviors[d].serialize)h=this._behaviors[d].serialize();else{h={};for(var k in this._behaviors[d])if(this._behaviors[d].hasOwnProperty(k)&&"_"!=k[0]&&"name"!=k)try{var j=JSON.stringify(this._behaviors[d][k]);h[k]=JSON.parse(j)}catch(l){}}f={name:f};h&&(f.properties=h);e.behaviors.push(f)}}for(d=0;d<this._spriteOffsets.length;d++)g=this._sprites[d].baseOffset?{x:this._sprites[d].baseOffset.x,y:this._sprites[d].baseOffset.y}:{x:"number"==typeof this._spriteOffsets[d].originalX?this._spriteOffsets[d].originalX:
this._spriteOffsets[d].x,y:"number"==typeof this._spriteOffsets[d].originalY?this._spriteOffsets[d].originalY:this._spriteOffsets[d].y},g.angle=this._spriteOffsets[d].angle,e.spriteOffsets.push(g);for(d=0;d<this._sprites.length;d++)e.sprites.push(this._sprites[d].serialize());d="autoListen addToSceneParams simulated eventResponse flowChartStatus iso".split(" ");b&&(d=d.concat(b));for(var m in this)if(this.hasOwnProperty(m)&&"_"!=m[0]&&-1==d.indexOf(m))if(c&&"function"==typeof this[m])e.functions=
e.functions||{},e.functions[m]=this[m].toString();else try{var q=JSON.stringify(this[m]);e.properties[m]=JSON.parse(q)}catch(u){}for(d=this._behaviors.length-1;0<=d;d--)this._behaviors[d].postSerialize&&this._behaviors[d].postSerialize();return a?JSON.stringify(e,null,"\t"):e};SceneObject.prototype.getOverlappingObjects=function(a,b){for(var c=[],d=0;d<this._sprites.length;d++)for(var e=this._sprites[d].getOverlappingObjects(a,b),f=0;f<e.length;f++)(0==d||-1==c.indexOf(e[f]))&&c.push(e[f]);return new SceneObjectGroup(c)};
SceneObject.prototype.setAngularVelocity=function(a){a?!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!0):(this._angularVelocity&&(!this._animationsPlaying&&!this._moving&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!1),this._rotationTarget.valid=!1);this._angularVelocity=a};SceneObject.prototype.getAngularVelocity=function(){return this._angularVelocity};
SceneObject.prototype.setVelocity=function(a,b){var c="object"==typeof a?a:{x:a,y:b};c.x||c.y?(this._linearVelocity.x=c.x,this._linearVelocity.y=c.y,this._targetPosition=0,!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!0),this._moving=!0):(this._linearVelocity.x||this._linearVelocity.y)&&this.stopMoving()};SceneObject.prototype.getVelocity=function(){return{x:this._linearVelocity.x,y:this._linearVelocity.y}};
SceneObject.prototype.schedule=function(a,b,c){if(this.isInScene()){var d=this;this._timeouts.push({name:b,time:a,data:c,callback:function(){d.process(b,c)}});this.simulated||wade.simulateSceneObject(this,!0)}else wade.warn("Warning - Trying to schedule an event for an object that is not in the scene.")};
SceneObject.prototype.interval=function(a,b,c,d){if(this.isInScene()){var e=this,f=a;d&&(f+=2*Math.random()*d-d);this._timeouts.push({interval:!0,name:b,time:f,data:c,variance:d,callback:function(){e.process(b,c);e.interval(a,b,c,d)}});this.simulated||wade.simulateSceneObject(this,!0)}else wade.warn("Warning - Trying to schedule an event for an object that is not in the scene.")};
SceneObject.prototype.unschedule=function(a){if(a)for(var b=this._timeouts.length-1;0<=b;b--)this._timeouts[b].name==a&&wade.removeObjectFromArrayByIndex(b,this._timeouts);else this._timeouts.length=0;!this._animationsPlaying&&(!this._moving&&!this._angularVelocity&&!this._path&&!this._timeouts.length)&&wade.simulateSceneObject(this,!1)};SceneObject.prototype.setName=function(a){a=a||"";if(!this._name||this._name!=a){var b=this._name;this._name=a;wade.onObjectNameChange(this,b,this._name)}};
SceneObject.prototype.getName=function(){return this._name};SceneObject.prototype.listenFor=function(a){wade.addEventListener(this,a)};SceneObject.prototype.stopListeningFor=function(a){wade.removeEventListener(this,a)};SceneObject.prototype.isListeningFor=function(a){return wade.isEventListener(this,a)};SceneObject.prototype.isTemplate=function(){return this._isTemplate};SceneObject.prototype.setAsTemplate=function(a){"undefined"==typeof a&&(a=!0);this._isTemplate=a};
SceneObject.prototype.fadeIn=function(a,b){var c=this._sprites.length;if(c){for(var d=0;d<c-1;d++)this.getSprite(d).fadeIn(a);this.getSprite(c-1).fadeIn(a,b)}else setTimeout(function(){b&&b()},0)};SceneObject.prototype.fadeOut=function(a,b){var c=this._sprites.length;if(c){for(var d=0;d<c-1;d++)this.getSprite(d).fadeOut(a);this.getSprite(c-1).fadeOut(a,b)}else setTimeout(function(){b&&b()},0)};
SceneObject.prototype.importFunctions=function(a){var b=wade.isDebugMode(),c="",d;for(d in a)if(a.hasOwnProperty(d))if(b)c+="\nthis."+d+" = "+a[d];else try{eval("this."+d+" = "+a[d])}catch(e){wade.error("Script error in "+this._name+"."+d+": "+e.message)}if(b){c+="\n//# sourceURL=wade://wade.app/SceneObjects/_."+this._name.replace(/ /g,"_");try{eval(c),this._functionsScript=c}catch(f){for(d in a)if(a.hasOwnProperty(d))try{eval("this."+d+" = "+a[d])}catch(g){wade.error("Script error in "+this._name+
"."+d+": "+g.message)}}}};SceneObject.prototype.getPath=function(){return this._path};
SceneObject.prototype.setPath=function(a,b,c){this._pathTime=0;this._pathSpeed="undefined"==typeof c?1:c;this._pathNodeIndex=-1;a&&"string"==typeof a&&(a=wade.getPath(a));if(a){b?(this._path=a.clone(),this._path.setFromSceneObject(this,0)):this._path=a;!this._animationsPlaying&&(!this._moving&&!this._angularVelocity)&&wade.simulateSceneObject(this,!0);a=this._path.evaluate(this,this._pathTime);for(b=this._pathNodeIndex+1;b<=a;b++)this.process("onPathNode",{path:this._path,nodeIndex:b});this._pathNodeIndex=
a}else this._path=null,!this._animationsPlaying&&(!this._moving&&!this._angularVelocity)&&wade.simulateSceneObject(this,!1)};SceneObject.prototype.getFunctionsScript=function(){return this._functionsScript||""};
SceneObject.prototype.drawToImage=function(a,b){if(this._sprites.length)if(1==this._sprites.length)this._sprites[0].drawToImage(a,b);else{for(var c=Infinity,d=Infinity,e=-Infinity,f=-Infinity,g=0;g<this._sprites.length;g++)var i=this._sprites[g].getSize(),c=Math.min(c,this._spriteOffsets[g].x-i.x/2),d=Math.min(d,this._spriteOffsets[g].y-i.y/2),e=Math.max(e,this._spriteOffsets[g].x+i.x/2),f=Math.max(f,this._spriteOffsets[g].y+i.y/2);g=new Sprite;g.setDrawFunction(wade.doNothing);g.setSize(e-c,f-d);
g.drawToImage(a,b);c={x:(c+e)/2,y:(d+f)/2};for(g=0;g<this._sprites.length;g++)this._sprites[g].drawToImage(a,!1,wade.vec2.sub(this._spriteOffsets[g],c))}else b&&wade.setImage(a,wade.getImage(),!0)};SceneObject.prototype.setFlowChart=function(a){this._flowChart=wade.cloneObject(a)};SceneObject.prototype.getFlowChart=function(){return this._flowChart};SceneObject.prototype.setGrid=function(a){this._grid=wade.cloneObject(a)};SceneObject.prototype.getGrid=function(){return this._grid&&wade.cloneObject(this._grid)};
SceneObject.prototype.getGridRef=function(){return this._grid};SceneObject.prototype.isOnScreen=function(){for(var a=0;a<this._sprites.length;a++)if(this._sprites[a].isOnScreen())return!0;return!1};SceneObject.prototype.getBoundingBox=function(){if(!this._sprites.length)return{minX:0,minY:0,maxX:0,maxY:0};for(var a=wade.cloneObject(this._sprites[0].boundingBox),b=1;b<this._sprites.length;b++)wade.expandBox(a,this._sprites[b].boundingBox);return a};
SceneObject.prototype.getScreenBoundingBox=function(){if(!this._sprites.length)return{minX:0,minY:0,maxX:0,maxY:0};for(var a=this._sprites[0].getScreenBoundingBox(),b=1;b<this._sprites.length;b++)wade.expandBox(a,this._sprites[b].getScreenBoundingBox());return a};SceneObject.prototype.addSpritesToRenderer=function(a){this._inScene=!0;this._renderer=a;for(var b=0;b<this._sprites.length;b++)a.addSprite(this._sprites[b])};
SceneObject.prototype.removeSpritesFromRenderer=function(){if(this._inScene){this._inScene=!1;for(var a=0;a<this._sprites.length;a++)this._sprites[a].isVisible()&&this._sprites[a].setDirtyArea(),this._renderer.removeSprite(this._sprites[a])}};SceneObject.prototype.needsSimulation=function(){return this._animationsPlaying||this._moving||this._angularVelocity||this._path||this._timeouts.length};
SceneObject.prototype.unscheduleAll=function(){wade.warn("Warning - SceneObject.unscheduleAll() is now deprecated and will be removed in future versions of WADE. Use unschedule with no parameters instead");this._timeouts.length=0};
function SceneObjectGroup(a){var b;b=a&&a.sceneObjectNames?a.sceneObjectNames.map(function(a){return wade.getSceneObject(a)}):wade.isArray(a)?a:[];b._name=a&&a.name||"";b._isInScene=!1;for(var c in SceneObjectGroup.prototype)SceneObjectGroup.prototype.hasOwnProperty(c)&&"undefined"==typeof b[c]&&(b[c]=SceneObjectGroup.prototype[c]);for(var d in SceneObject.prototype)"function"==typeof SceneObject.prototype[d]&&(SceneObject.prototype.hasOwnProperty(d)&&"undefined"==typeof b[d])&&function(a){b[a]=function(){for(var c,
d=0;d<b.length;d++){var i=b[d][a].apply(b[d],arguments);"undefined"!=typeof i&&!c&&(c=[],c.length=d);c&&c.push(i)}return c}}(d);return b}SceneObjectGroup.prototype.getGroupBoundingBox=function(){if(!this.length)return{minX:0,minY:0,maxX:0,maxY:0};for(var a=this[0].getBoundingBox(),b=1;b<this.length;b++)wade.expandBox(a,this[b].getBoundingBox());return a};
SceneObjectGroup.prototype.getGroupScreenBoundingBox=function(){if(!this.length)return{minX:0,minY:0,maxX:0,maxY:0};for(var a=this[0].getScreenBoundingBox(),b=1;b<this.length;b++)wade.expandBox(a,this[b].getScreenBoundingBox());return a};SceneObjectGroup.prototype.getGroupCenter=function(){var a=this.getGroupBoundingBox();return{x:(a.minX+a.maxX)/2,y:(a.minY+a.maxY)/2}};SceneObjectGroup.prototype.getGroupSize=function(){var a=this.getGroupBoundingBox();return{x:a.maxX-a.minX,y:a.maxY-a.minY}};
SceneObjectGroup.prototype.serialize=function(a){var b={type:"SceneObjectGroup",name:this._name,sceneObjectNames:this.map(function(a){return a&&a.getName()||""})};return a?JSON.stringify(b):b};SceneObjectGroup.prototype.setGroupCenter=function(a,b){var c,d;"object"==typeof a?(c=a.x,d=a.y):(c=a,d=b);var e=this.getGroupCenter();c-=e.x;d-=e.y;for(e=0;e<this.length;e++){var f=this[e].getPosition();this[e].setPosition(f.x+c,f.y+d)}};
SceneObjectGroup.prototype.translateGroup=function(a,b){var c,d;"object"==typeof a?(c=a.x,d=a.y):(c=a,d=b);for(var e=0;e<this.length;e++){var f=this[e].getPosition();this[e].setPosition(f.x+c,f.y+d)}};SceneObjectGroup.prototype.rotateGroup=function(a){for(var b=this.getGroupCenter(),c=0;c<this.length;c++){var d=this[c].getRotation();this[c].setRotation(d+a);d=this[c].getPosition();d=wade.vec2.sub(d,b);wade.vec2.rotateInPlace(d,a);this[c].setPosition(wade.vec2.add(d,b))}};
SceneObjectGroup.prototype.setName=function(a){if(!this._name||this._name!=a){var b=this._name;this._name=a;wade.onObjectGroupNameChange(this,b,this._name)}};SceneObjectGroup.prototype.getName=function(){return this._name};SceneObjectGroup.prototype.isInScene=function(){return this._inScene};
function Sprite(a,b){this._animations={};this._currentAnimation="default";var c=new Animation(a&&("string"==typeof a?a:a.image));c.sprite=this;c.name=this._currentAnimation;c.isDefault=!0;this._animations[this._currentAnimation]=c;this._numAnimations=1;this._scaleFactor={x:1,y:1};this._imageArea={minX:0,minY:0,maxX:1,maxY:1};this._name="";this._alwaysDraw=!1;this._drawModifiers=[];var d;if(c="object"==typeof a&&a){var e=a;this._sortPoint=e.sortPoint||{x:0,y:0};this._layer=wade.getLayer(e.layer||wade.defaultLayer);
d=this._animations[this._currentAnimation].getFrameSize();this._size=e.size?{x:e.size.x,y:e.size.y}:d;this._sizeWasSet=!e.autoResize;this._name=e.name||"";this._alwaysDraw=!!e.alwaysDraw;this._staticImageName=e.image;this._visible="undefined"==typeof e.visible?!0:e.visible;this._pixelPerfectMouseEvents=("boolean"==typeof e.pixelPerfectMouseEvents?e.pixelPerfectMouseEvents?1:0:e.pixelPerfectMouseEvents)||0;d=e.image;if(e.animations)for(var f in e.animations)e.animations.hasOwnProperty(f)&&this.addAnimation(new Animation(e.animations[f]),
!0);e.pixelShader&&this.setPixelShader(e.pixelShader,e.pixelShaderUniforms);e.imageArea&&(this._imageArea.minX=e.imageArea.minX,this._imageArea.minY=e.imageArea.minY,this._imageArea.maxX=e.imageArea.maxX,this._imageArea.maxY=e.imageArea.maxY,this._scaleFactor.x=this._imageArea.maxX-this._imageArea.minX,this._scaleFactor.y=this._imageArea.maxY-this._imageArea.minY);if(e.properties)for(var g in e.properties)if(e.properties.hasOwnProperty(g))try{this[g]=JSON.parse(JSON.stringify(e.properties[g]))}catch(i){}}else this._staticImageName=
a,this._sortPoint={x:0,y:0},this._layer=null!==b?wade.getLayer(b?b:wade.defaultLayer):null,this._size=this._animations[this._currentAnimation].getImageSize(),this._sizeWasSet=!1,this._visible=!0,d=a;this._sceneObject=null;this._position={x:0,y:0};this._rotation=this._cornerY=this._cornerX=0;this._f32PositionAndSize=[0,0,0,0];this._f32AnimFrameInfo=[this._imageArea.minX,this._imageArea.minY,this._imageArea.maxX-this._imageArea.minX,this._imageArea.maxY-this._imageArea.minY];this._f32RotationAlpha=
[0,0];try{this._f32PositionAndSize=new Float32Array(this._f32PositionAndSize),this._f32AnimFrameInfo=new Float32Array(this._f32AnimFrameInfo),this._f32RotationAlpha=new Float32Array(this._f32RotationAlpha)}catch(h){}this._animations[this._currentAnimation].setImageArea(this._imageArea.minX,this._imageArea.minY,this._imageArea.maxX,this._imageArea.maxY);this.orientedBoundingBox={};this.boundingBox={};this.updateBoundingBox();this.setActiveImage(wade.getFullPathAndFileName(d));this.draw=this._layer&&
"2d"==this._layer.getRenderMode()?this.draw_2d:this.draw_gl;c&&e.drawModifiers&&this.setDrawModifiers(e.drawModifiers);c&&(e.currentAnimation&&e.animations&&e.animations[e.currentAnimation]&&!e.animations[e.currentAnimation].stopped)&&this.playAnimation(e.currentAnimation,e.animations[e.currentAnimation].playMode)}
Sprite.prototype.setPosition=function(a,b){var c,d;"object"==typeof a?(c=a.x,d=a.y):(c=a,d=b);this.setDirtyArea();this._position.x=c;this._position.y=d;this.updateBoundingBox();this._cornerX=c-this._size.x/2;this._cornerY=d-this._size.y/2;this.setDirtyArea()};Sprite.prototype.getPosition=function(){return{x:this._position.x,y:this._position.y}};
Sprite.prototype.setRotation=function(a){a!=this._rotation&&(this.setDirtyArea(),this._rotation=a,this.updateOrientedBoundingBox(),this.updateBoundingBox(),this.setDirtyArea())};Sprite.prototype.getRotation=function(){return this._rotation};
Sprite.prototype.setSize=function(a,b,c){this._sizeWasSet=!0;"object"==typeof a&&(c=b,b=a.y,a=a.x);if(a!=this._size.x||b!=this._size.y){this.setDirtyArea();this._size={x:a,y:b};var d=this._animations[this._currentAnimation];d.getRelativeImageName()&&!c?(c=d.getFrameSize(),this._scaleFactor.x=this._size.x/c.x,this._scaleFactor.y=this._size.y/c.y):this._scaleFactor.x=this._scaleFactor.y=1;this._cornerX=this._position.x-a/2;this._cornerY=this._position.y-b/2;this._rotation&&this.updateOrientedBoundingBox();
this.updateBoundingBox();this.setDirtyArea()}};Sprite.prototype.getSize=function(){return{x:this._size.x,y:this._size.y}};Sprite.prototype.setSortPoint=function(a,b){this._sortPoint.x=a;this._sortPoint.y=b};Sprite.prototype.getSortPoint=function(){return{x:this._sortPoint.x,y:this._sortPoint.y}};
Sprite.prototype.addAnimation=function(a,b,c){"string"!=typeof a&&a instanceof Animation&&(c=b,b=a,a="");a=a||b.name;a||(wade.unnamedAnimationCount=wade.unnamedAnimationCount+1||1,a="__wade_unnamed_anim_"+wade.unnamedAnimationCount);var d=1==this._numAnimations&&!this._animations[this._currentAnimation].getImageName(),e=!c&&!this._sizeWasSet&&d;d&&!c&&(delete this._animations[this._currentAnimation],this._numAnimations=0);this._animations[a]||this._numAnimations++;this._animations[a]=b;b.name=a;b.sprite=
this;1==this._numAnimations&&!c&&(this.playAnimation(a),e&&"ok"==wade.getLoadingStatus(b.getImageName())&&(a=b.getFrameSize(),this.setSize(a.x,a.y)),this.updateBoundingBox())};Sprite.prototype.getAnimation=function(a){return this._animations[a||this._currentAnimation]};
Sprite.prototype.playAnimation=function(a,b){var c=this._animations[a];if(c){a!=this._currentAnimation&&this.setDirtyArea();this._currentAnimation=a;c.play(b);var d=c.getFrameSize();this._scaleFactor.x=this._size.x/d.x;this._scaleFactor.y=this._size.y/d.y;this.setActiveImage(c.getImageName());this.updateBoundingBox()}};Sprite.prototype.getScaleFactor=function(){return{x:this._scaleFactor.x,y:this._scaleFactor.y}};
Sprite.prototype.step=function(){var a=this._animations[this._currentAnimation];a&&a.isPlaying()&&a.step()};Sprite.prototype.setSceneObject=function(a){if(a!=this._sceneObject){var b=this._animations[this._currentAnimation];b&&b.isPlaying()&&(a&&a.processEvent("onAnimationStart",{name:this._currentAnimation}),this._sceneObject&&this._sceneObject.processEvent("onAnimationEnd",{name:this._currentAnimation}));this._sceneObject=a}};Sprite.prototype.getSceneObject=function(){return this._sceneObject};
Sprite.prototype.getScreenPositionAndExtents=function(){var a=this._layer.worldDirectionToScreen(this.getSize()),b=this._layer.worldPositionToScreen(this._position);return{extents:{x:a.x/2,y:a.y/2},position:b}};
Sprite.prototype.containsScreenPoint=function(a){var b;if(this._rotation)b=wade.screenPositionToWorld(this._layer.id,a),b=wade.orientedBoxContainsPoint(this.orientedBoundingBox,b);else{b=this.getScreenPositionAndExtents();var c=b.position.y-b.extents.y,d=b.position.x+b.extents.x,e=b.position.y+b.extents.y;b=a.x>=b.position.x-b.extents.x&&a.x<=d&&a.y>=c&&a.y<=e}if(!b||!this.getAlphaThreshold||!this.getAlphaThreshold()||!this._image)return b;b=this._animations[this._currentAnimation];c=b.getFrameCorner();
d=b.getFrameSize();e=b.getOffset_ref();a=wade.screenPositionToWorld(this.getLayerId(),a);wade.vec2.subInPlace(a,this.getPosition());wade.vec2.subInPlace(a,e);this._rotation&&wade.vec2.rotateInPlace(a,-this._rotation);wade.vec2.addInPlace(a,wade.vec2.scale(this._size,0.5));a.x=Math.floor(a.x*d.x/this._size.x+c.x);a.y=Math.floor(a.y*d.y/this._size.y+c.y);b=wade.getImageData(b.getRelativeImageName());return b.data[4*(a.y*b.width+a.x)+3]>=this._pixelPerfectMouseEvents};
Sprite.prototype.getWorldOffset=function(a){a=this._layer.screenPositionToWorld(a);return{x:a.x-this._position.x,y:a.y-this._position.y}};Sprite.prototype.setDirtyArea=function(){this._layer&&this._layer.isUsingQuadtree()&&this._layer.addDirtyArea(this.boundingBox)};Sprite.prototype.setVisible=function(a){a!=this._visible&&(this._visible=a,this.setDirtyArea())};Sprite.prototype.isVisible=function(){return this._visible};
Sprite.prototype.setImageFile=function(a,b){this.setDirtyArea();var c=this._animations[this._currentAnimation]&&this._animations[this._currentAnimation].isDefault;this._animations[this._currentAnimation]=new Animation(a,1,1,0);this._animations[this._currentAnimation].isDefault=c;if(b||!this._sizeWasSet)c=this._animations[this._currentAnimation].getFrameSize(),this.setSize(c.x,c.y);this._staticImageName=a;this.setActiveImage(wade.getFullPathAndFileName(a));this.setDirtyArea()};
Sprite.prototype.bringToFront=function(){!this._sceneObject||!this._sceneObject.isInScene()?wade.log("Cannot change the order of sprites before they are added to the scene"):this._layer.bringSpriteToFront(this)};Sprite.prototype.pushToBack=function(){!this._sceneObject||!this._sceneObject.isInScene()?wade.log("Cannot change the order of sprites before they are added to the scene"):this._layer.pushSpriteToBack(this)};
Sprite.prototype.putBehindSprite=function(a){this._layer!=a._layer?wade.log("Cannot put a sprite behind another sprite that is on a different layer"):!this._sceneObject||!this._sceneObject.isInScene()||!a._sceneObject||!a._sceneObject.isInScene()?wade.log("Cannot change the order of sprites before they are added to the scene"):this._layer.putSpriteBehindSprite(this,a)};Sprite.prototype.getCurrentAnimation=function(){return this._animations[this._currentAnimation]};
Sprite.prototype.getCurrentAnimationName=function(){return this._currentAnimation};Sprite.prototype.hasAnimation=function(a){return this._animations[a]?!0:!1};Sprite.prototype.setDrawFunction=function(a){this._f32RotationAlpha[1]=1;this.draw=a;this.setDirtyArea()};Sprite.prototype.getDrawFunction=function(){return this.draw};
Sprite.prototype.setDrawModifiers=function(a){var b=this instanceof TextSprite?TextSprite.prototype:Sprite.prototype,b="webgl"==this._layer.getRenderMode()?b.draw_gl:b.draw_2d;if(a){a=wade.isArray(a)?wade.extend([],a):[a];for(b=this._drawModifiers.length=0;b<a.length;b++){var c=a[b];this._drawModifiers.push(wade.cloneObject(c));switch(c.type){case "alpha":1!=c.alpha&&this.setDrawFunction(wade.drawFunctions.alpha_(c.alpha,this.getDrawFunction()));break;case "fadeOpacity":this.setDrawFunction(wade.drawFunctions.fadeOpacity_(c.start,
c.end,c.time,this.getDrawFunction()));break;case "mirror":this.setDrawFunction(wade.drawFunctions.mirror_(this.getDrawFunction()));break;case "flip":this.setDrawFunction(wade.drawFunctions.flip_(this.getDrawFunction()));break;case "blink":this.setDrawFunction(wade.drawFunctions.blink_(c.timeOn,c.timeOff,this.getDrawFunction()));break;case "additive":this.setDrawFunction(wade.drawFunctions.additive_(this.getDrawFunction()))}}}else this.setDrawFunction(b)};Sprite.prototype.getDrawModifiers=function(){return wade.cloneArray(this._drawModifiers)};
Sprite.prototype.overlapsSprite=function(a,b){var c=this._layer.id,d=a.getLayer().id,e=this.getRotation(),b=b||"axis-aligned",f=a.getRotation();if("axis-aligned"==b||"oriented"==b&&!e&&!f){if(c==d)return wade.boxIntersectsBox(this.boundingBox,a.boundingBox);c=wade.worldBoxToScreen(c,this.boundingBox);d=wade.worldBoxToScreen(d,a.boundingBox);return wade.boxIntersectsBox(c,d)}if("oriented"==b)return e?f?wade.orientedBoxIntersectsOrientedBox(this.orientedBoundingBox,a.orientedBoundingBox):wade.orientedBoxIntersectsBox(this.orientedBoundingBox,
a.boundingBox):wade.orientedBoxIntersectsBox(a.orientedBoundingBox,this.boundingBox);if("pixel"==b){var g,i,h,k,j,l,m;this instanceof TextSprite?(this.isCached()||this.cache(),e={x:0,y:0},i=this.getSize(),h={x:0,y:0},g=this.getImageName(),wade.setImage(g,this.getCachedImage()),g=wade.getImageData(g)):(g=this._animations[this._currentAnimation],e=g.getFrameCorner(),i=g.getFrameSize(),h=g.getOffset_ref(),g=wade.getImageData(g.getRelativeImageName()));a instanceof TextSprite?(a.isCached()||a.cache(),
j={x:0,y:0},l=a.getSize(),m={x:0,y:0},k=a.getImageName(),wade.setImage(k,a.getCachedImage()),k=wade.getImageData(k)):(k=a.getCurrentAnimation(),j=k.getFrameCorner(),l=k.getFrameSize(),m=k.getOffset(),k=wade.getImageData(k.getRelativeImageName()));for(var q=a.getPosition(),u=a.getSize(),x=j.y;x<j.y+l.y;x++)for(var p=j.x;p<j.x+l.x;p++)if(k.data[4*(p+x*k.width)+3]){var r={x:p-j.x,y:x-j.y};wade.vec2.mulInPlace(r,wade.vec2.div(u,l));wade.vec2.subInPlace(r,wade.vec2.scale(u,0.5));f&&wade.vec2.rotateInPlace(r,
f);wade.vec2.addInPlace(r,m);wade.vec2.addInPlace(r,q);c!=d&&(r=wade.worldPositionToScreen(d,r),r=wade.screenPositionToWorld(c,r));wade.vec2.subInPlace(r,this.getPosition());wade.vec2.subInPlace(r,h);this._rotation&&wade.vec2.rotateInPlace(r,-this._rotation);wade.vec2.addInPlace(r,wade.vec2.scale(this._size,0.5));r.x=Math.floor(r.x*i.x/this._size.x+e.x);r.y=Math.floor(r.y*i.y/this._size.y+e.y);if(0<=r.x&&0<=r.y&&r.x<g.width&&r.y<g.height&&g.data[4*(r.y*g.width+r.x)+3])return!0}return!1}};
Sprite.prototype.getImageName=function(){return this._activeImage};Sprite.prototype.getAllImageNames=function(){var a=this.getImageName()?[this.getImageName()]:[],b;for(b in this._animations)if(this._animations.hasOwnProperty(b)){var c=this._animations[b].getImageName();c&&-1==a.indexOf(c)&&a.push(c)}return a};
Sprite.prototype.setLayer=function(a){this._sceneObject&&this._sceneObject.isInScene()?(this._layer&&this._layer.removeSprite(this),this._layer=wade.getLayer(a?a:1),this._layer.addSprite(this)):this._layer=wade.getLayer(a?a:1)};
Sprite.prototype.drawToImage=function(a,b,c,d,e,f){var g=c||{x:0,y:0},i=document.createElement("canvas"),f=f||this._layer&&this._layer.getRenderMode()||"2d";if("webgl"==f)wade.textureTargetCount=wade.textureTargetCount+1||1,i="__wade_textureTarget_"+wade.textureTargetCount,this.drawToTexture(i,i+"_cpu"),g=new Sprite(i+"_cpu",this.getLayerId()),d?d.verticalScale*=-1:d={horizontalScale:1,verticalScale:-1,horizontalSkew:0,verticalSkew:0,horizontalTranslate:0,verticalTranslate:0},g.drawToImage(a,b,c,
d,e,"2d"),d.verticalScale*=-1,this._layer.getContext().onImageUnloaded(i);else{c=i.getContext(f);b||"ok"!=wade.getLoadingStatus(a)?(i.width=this.boundingBox.maxX-this.boundingBox.minX+Math.abs(g.x),i.height=this.boundingBox.maxY-this.boundingBox.minY+Math.abs(g.y)):(b=wade.getImage(a),i.width=b.width,i.height=b.height,c.drawImage(b,0,0));var b={x:this._position.x,y:this._position.y},f=d&&"undefined"!=typeof d.horizontalScale&&d.horizontalScale||1,h=d&&"undefined"!=typeof d.verticalScale&&d.verticalScale||
1;this._position.x=g.x*f+i.width/(2*f);this._position.y=g.y*h+i.height/(2*h);this._cornerX=this._position.x-this._size.x/2;this._cornerY=this._position.y-this._size.y/2;g=c.globalCompositeOperation;e&&(c.globalCompositeOperation=e);d?(c.save(),c.setTransform(d.horizontalScale,d.horizontalSkew,d.verticalSkew,d.verticalScale,d.horizontalTranslate,d.verticalTranslate),this.draw(c),c.restore()):this.draw(c);c.globalCompositeOperation=g;this._position=b;this._cornerX=this._position.x-this._size.x/2;this._cornerY=
this._position.y-this._size.y/2;wade.setImage(a,i)}};
Sprite.prototype.drawToTexture=function(a,b){var c=this._layer.getContext();if(!c.isWebGl)return wade.warn("Sprite.drawToTexture is only supported in webgl mode. You can try using Sprite.drawToImage for canvas-based rendering"),null;var d=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,d);d.width=this._size.x;d.height=this._size.y;d=c.createTexture();c.bindTexture(c.TEXTURE_2D,d);wade.texImage2D(c,{width:this._size.x,height:this._size.y});c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,
c.TEXTURE_2D,d,0);a&&(c.textures[a]=d);c.currentImage[0]=null;var e=c.getParameter(c.VIEWPORT),f=Math.floor(this._size.x),g=Math.floor(this._size.y),i=this._layer.getF32ViewportSize();i[0]=f;i[1]=g;c.uniform2fv(c.currentShader.uniforms.uViewportSize,i);c.viewport(0,0,f,g);var h=this._f32PositionAndSize[0],k=this._f32PositionAndSize[1],j=this._rotation;this._f32PositionAndSize[0]=0;this._f32PositionAndSize[1]=0;this._f32RotationAlpha[0]=0;this.draw(c);if(b){var l=new Uint8Array(4*f*g);c.readPixels(0,
0,f,g,c.RGBA,c.UNSIGNED_BYTE,l);f=new ImageData(new Uint8ClampedArray(l),f,g);wade.putImageData(b,f)}this._f32PositionAndSize[0]=h;this._f32PositionAndSize[1]=k;this._f32RotationAlpha[0]=j;c.viewport(e[0],e[1],e[2],e[3]);i[0]=e[2]-e[0];i[1]=e[3]-e[1];c.uniform2fv(c.currentShader.uniforms.uViewportSize,i);c.bindFramebuffer(c.FRAMEBUFFER,null);return d};Sprite.prototype.stopAnimation=function(){var a=this._animations[this._currentAnimation];a&&a.stop()};
Sprite.prototype.resumeAnimation=function(){var a=this._animations[this._currentAnimation];a&&a.resume()};
Sprite.prototype.clone=function(){var a=new Sprite(null,this._layer.id);wade.extend(a,this);a._sceneObject=0;a.quadTreeNode=0;if(this._animations){a._animations={};for(var b in this._animations)this._animations.hasOwnProperty(b)&&(a._animations[b]=this._animations[b].clone(),a._animations[b].sprite=a)}a._position={x:this._position.x,y:this._position.y};a._sortPoint={x:this._sortPoint.x,y:this._sortPoint.y};a._size={x:this._size.x,y:this._size.y};a._scaleFactor={x:this._scaleFactor.x,y:this._scaleFactor.y};
a.boundingBox=wade.extend({},this.boundingBox);a.orientedBoundingBox=wade.extend({},this.orientedBoundingBox);a._f32AnimFrameInfo=[this._f32AnimFrameInfo[0],this._f32AnimFrameInfo[1],this._f32AnimFrameInfo[2],this._f32AnimFrameInfo[3]];a._f32PositionAndSize=[this._f32PositionAndSize[0],this._f32PositionAndSize[1],this._f32PositionAndSize[2],this._f32PositionAndSize[3]];a._f32RotationAlpha=[this._f32RotationAlpha[0],this._f32RotationAlpha[1]];try{a._f32AnimFrameInfo=new Float32Array(a._f32AnimFrameInfo),
a._f32PositionAndSize=new Float32Array(a._f32PositionAndSize),a._f32RotationAlpha=new Float32Array(a._f32RotationAlpha)}catch(c){}a._activeImage&&wade.addImageUser(a._activeImage,a);return a};
Sprite.prototype.serialize=function(a,b){var c={type:"Sprite",animations:{},currentAnimation:this.getCurrentAnimationName(),sortPoint:{x:this._sortPoint.x,y:this._sortPoint.y},layer:this._layer.id,autoResize:!this._sizeWasSet,visible:this._visible,image:this._staticImageName||"",imageArea:{minX:this._imageArea.minX,minY:this._imageArea.minY,maxX:this._imageArea.maxX,maxY:this._imageArea.maxY},alwaysDraw:!!this._alwaysDraw,name:this._name,drawModifiers:wade.cloneArray(this._drawModifiers),pixelShader:this._pixelShaderSource||
"",pixelShaderUniforms:this._pixelShaderUniforms?wade.cloneObject(this._pixelShaderUniforms):null,pixelPerfectMouseEvents:this._pixelPerfectMouseEvents||0,properties:{}};this._sizeWasSet&&!(1==this._size.x&&1==this._size.y)&&(c.size={x:this._size.x,y:this._size.y});for(var d in this._animations)this._animations.hasOwnProperty(d)&&!this._animations[d].isDefault&&(c.animations[d]=this._animations[d].serialize());d="sceneObject boundingBox orientedBoundingBox id needsDrawing uniformTypeNames baseOffset".split(" ");
b&&(d=d.concat(b));for(var e in this)if(this.hasOwnProperty(e)&&"_"!=e[0]&&-1==d.indexOf(e))try{var f=JSON.stringify(this[e]);c.properties[e]=JSON.parse(f)}catch(g){}return a?JSON.stringify(c,null,"\t"):c};Sprite.prototype.setName=function(a){this._name=a};Sprite.prototype.getName=function(){return this._name};
Sprite.prototype.getOverlappingObjects=function(a,b){var c,b=b||"axis-aligned";if("axis-aligned"==b){var d;a?(c=wade.worldBoxToScreen(this._layer.id,this.boundingBox),d=wade.getObjectsInScreenArea(c)):d=wade.getObjectsInArea(this.boundingBox,this._layer.id);this._sceneObject&&wade.removeObjectFromArray(this._sceneObject,d);return d}c=[];d=[];a?(c=wade.worldBoxToScreen(this._layer.id,this.boundingBox),c=wade.getSpritesInScreenArea(c)):c=wade.getSpritesInArea(this.boundingBox,this._layer.id);for(var e=
this._rotation?"orientedBox":"box",f=this._rotation?this.orientedBoundingBox:this.boundingBox,g=0;g<c.length;g++){var i=c[g];if(i!=this){var h=i.getRotation(),k=h?i.orientedBoundingBox:i.boundingBox,h=h?wade[e+"IntersectsOrientedBox"]:wade[e+"IntersectsBox"];this._layer.id!=i.getLayerId()&&(k=wade.screenBoxToWorld(this._layer.id,wade.worldBoxToScreen(i.getLayerId(),k)));h.call(wade,f,k)&&d.push(i)}}for(e=c.length=0;e<d.length;e++)f=d[e].getSceneObject(),-1==c.lastIndexOf(f)&&("pixel"!=b||this.overlapsSprite(d[e],
"pixel"))&&c.push(f);return c};Sprite.prototype.getLayerId=function(){return this._layer.id};
Sprite.prototype.cache=function(){wade.spriteCacheCount=wade.spriteCacheCount+1||1;var a="__wade_sprite_cache"+wade.spriteCacheCount,b=this._rotation;b&&(this._rotation=0,this.updateOrientedBoundingBox(),this.updateBoundingBox());this.drawToImage(a,!0);b&&(this._rotation=b,this.updateOrientedBoundingBox(),this.updateBoundingBox());this.setImageFile(a,!0);this.draw="2d"==this._layer.getRenderMode()?this.draw_2d:this.draw_gl;this.setDirtyArea()};Sprite.prototype.getIndexInLayer=function(){return this._layer.getIndexOfSprite(this)};
Sprite.prototype.setIndexInLayer=function(a){this.setDirtyArea();return this._layer.setIndexOfSprite(this,a)};
Sprite.prototype.setPixelShader=function(a,b){if(this._pixelShaderSource=a){var c=this._layer.getContext(),d=this._layer.getPixelShader(c,a,b);this._shaderProgram=this._layer.getShaderProgram(c,null,d);this._shaderContext=c;this._typedPixelShaderUniforms={};if(b){this._pixelShaderUniforms=wade.cloneObject(b);for(var e in b)if(b.hasOwnProperty(e))switch(b[e]){case "vec2":this._typedPixelShaderUniforms[e]=new Float32Array([0,0]);break;case "vec3":this._typedPixelShaderUniforms[e]=new Float32Array([0,
0,0]);break;case "vec4":this._typedPixelShaderUniforms[e]=new Float32Array([0,0,0,0]);break;case "ivec2":this._typedPixelShaderUniforms[e]=new Int32Array([0,0]);break;case "ivec3":this._typedPixelShaderUniforms[e]=new Int32Array([0,0,0]);break;case "ivec4":this._typedPixelShaderUniforms[e]=new Int32Array([0,0,0,0])}}}else this._shaderProgram=this._pixelShaderUniforms=this._typedPixelShaderUniforms=null};Sprite.prototype.getPixelShader=function(){return this._pixelShaderSource||this._layer.getDefaultPixelShaderSource()};
Sprite.prototype.getPixelShaderUniforms=function(){return this._pixelShaderUniforms&&wade.cloneObject(this._pixelShaderUniforms)||null};Sprite.prototype.alwaysDraw=function(a){"undefined"==typeof a&&(a=!0);a!=this._alwaysDraw&&((this._alwaysDraw=a)?this._layer.addAlwaysDrawSprite(this):this._layer.removeAlwaysDrawSprite(this))};Sprite.prototype.isAlwaysDrawing=function(){return!!this._alwaysDraw};
Sprite.prototype.setImageArea=function(a,b,c,d){this._imageArea.minX=this._f32AnimFrameInfo[0]=a;this._imageArea.minY=this._f32AnimFrameInfo[1]=b;this._imageArea.maxX=c;this._imageArea.maxY=d;this._f32AnimFrameInfo[2]=c-a;this._f32AnimFrameInfo[3]=d-b;this._animations[this._currentAnimation].isDefault&&this._animations[this._currentAnimation].setImageArea(this._imageArea.minX,this._imageArea.minY,this._imageArea.maxX,this._imageArea.maxY)};
Sprite.prototype.getImageArea=function(){return{minX:this._imageArea.minX,minY:this._imageArea.minY,maxX:this._imageArea.maxX,maxY:this._imageArea.maxY}};Sprite.prototype.fadeIn=function(a,b){"undefined"==typeof a&&(a=1);this.setVisible(!0);var c=Sprite.prototype.draw;this instanceof TextSprite&&(c=TextSprite.prototype.draw,this.cache());this.setDrawFunction(wade.drawFunctions.fadeOpacity_(0,1,a,c,function(){setTimeout(function(){b&&b()},0)}))};
Sprite.prototype.fadeOut=function(a,b){"undefined"==typeof a&&(a=1);var c=this;this.setDrawFunction(wade.drawFunctions.fadeOpacity_(1,0,a,this instanceof TextSprite?TextSprite.prototype.draw:Sprite.prototype.draw,function(){setTimeout(function(){c.setVisible(!1);b&&b()},0)}))};Sprite.prototype.isUsingPixelPerfectMouseEvents=function(){wade.warn("Sprite.isUsingPixelPerfectMouseEvents is deprecated. Please use Sprite.getAlphaThreshold instead");return this._pixelPerfectMouseEvents||0};
Sprite.prototype.getAlphaThreshold=function(){return this._pixelPerfectMouseEvents||0};Sprite.prototype.usePixelPerfectMouseEvents=function(a){"undefined"==typeof a&&(a=1);"boolean"==typeof a&&(a=1);this._pixelPerfectMouseEvents=a};
Sprite.prototype.isOnScreen=function(){if(!this.boundingBox||!this._sceneObject||!this._sceneObject.isInScene()||!this._visible)return!1;var a=wade.getScreenWidth()/2,b=wade.getScreenHeight()/2;return wade.boxIntersectsBox({minX:-a,minY:-b,maxX:a,maxY:b},wade.worldBoxToScreen(this._layer.id,this.boundingBox))};Sprite.prototype.getScreenBoundingBox=function(){return wade.worldBoxToScreen(this._layer.id,this.boundingBox)};
Sprite.prototype.isUsingBatchableDraw=function(){return this.draw.batched&&(!this._shaderProgram||this._shaderProgram==this._layer.getDefaultShaderProgram())};Sprite.prototype.getLayer=function(){return this._layer};Sprite.prototype.onAnimationStart=function(a,b){this._sceneObject&&this._sceneObject.processEvent("onAnimationStart",{name:a,restarting:b})};Sprite.prototype.onAnimationEnd=function(a){this._sceneObject&&this._sceneObject.processEvent("onAnimationEnd",{name:a})};
Sprite.prototype.updateBoundingBox=function(){var a=this._animations[this._currentAnimation].getOffset_ref();if(this._rotation)this.boundingBox.minX=this._position.x-this.orientedBoundingBox.rx-wade.c_epsilon+a.x,this.boundingBox.minY=this._position.y-this.orientedBoundingBox.ry-wade.c_epsilon+a.y,this.boundingBox.maxX=this._position.x+this.orientedBoundingBox.rx+wade.c_epsilon+a.x,this.boundingBox.maxY=this._position.y+this.orientedBoundingBox.ry+wade.c_epsilon+a.y;else{var b=this._size.x/2,c=this._size.y/
2;this.boundingBox.minX=this._position.x-b-wade.c_epsilon+a.x;this.boundingBox.minY=this._position.y-c-wade.c_epsilon+a.y;this.boundingBox.maxX=this._position.x+b+wade.c_epsilon+a.x;this.boundingBox.maxY=this._position.y+c+wade.c_epsilon+a.y}this.orientedBoundingBox.centerX=this._position.x+a.x;this.orientedBoundingBox.centerY=this._position.y+a.y;this._f32PositionAndSize&&(this._f32PositionAndSize[0]=this._position.x+a.x,this._f32PositionAndSize[1]=this._position.y+a.y,this._f32PositionAndSize[2]=
this._size.x,this._f32PositionAndSize[3]=this._size.y);this._sceneObject&&this._sceneObject.isInScene()&&this._layer.onSpritePositionChanged(this)};
Sprite.prototype.updateOrientedBoundingBox=function(){var a=this._size.x/2,b=this._size.y/2,c=Math.cos(this._rotation),d=Math.sin(this._rotation),e=a*c,f=a*d,d=b*d,c=b*c,g=e+d,i=f-c,h=e-d,k=f+c;this.orientedBoundingBox.rx=Math.max(Math.abs(g),Math.abs(h));this.orientedBoundingBox.ry=Math.max(Math.abs(i),Math.abs(k));this.orientedBoundingBox.rx0=g;this.orientedBoundingBox.ry0=i;this.orientedBoundingBox.rx1=h;this.orientedBoundingBox.ry1=k;this.orientedBoundingBox.axisXx=e;this.orientedBoundingBox.axisXy=
f;this.orientedBoundingBox.axisYx=-d;this.orientedBoundingBox.axisYy=c;this.orientedBoundingBox.rotation=this._rotation;this.orientedBoundingBox.halfWidth=a;this.orientedBoundingBox.halfHeight=b;this._f32RotationAlpha&&(this._f32RotationAlpha[0]=this._rotation)};
Sprite.prototype.draw_2d=function(a){var b,c,d,e,f,g;if(a.isWebGl)return this.draw==Sprite.prototype.draw_2d&&(this.draw=Sprite.prototype.draw_gl),this.draw_gl(a);this._visible&&(wade.numDrawCalls++,this._rotation&&(a.save(),a.translate(this._position.x,this._position.y),a.rotate(this._rotation),a.translate(-this._position.x,-this._position.y)),(b=this._animations&&this._animations[this._currentAnimation])?(c=b.getFrameCorner_ref(),d=b.getFrameSize_ref(),e=b.getOffset_ref(),a.drawImage(b.getImage(),
c.x,c.y,d.x,d.y,this._position.x-this._size.x/2+e.x,this._position.y-this._size.y/2+e.y,this._size.x,this._size.y)):(b=this._image.width,c=this._image.height,d=this._imageArea.minX,e=this._imageArea.minY,f=this._imageArea.maxX,g=this._imageArea.maxY,a.drawImage(this._image,d*b,e*c,(f-d)*b,(g-e)*c,this._cornerX,this._cornerY,this._size.x,this._size.y)),this._rotation&&a.restore())};
Sprite.prototype.draw_gl=function(a){if(!a.isWebGl)return this.draw==Sprite.prototype.draw_gl&&(this.draw=Sprite.prototype.draw_2d),this.draw_2d(a);var b=c&&c.getImage()||this._image;if(this._visible){wade.numDrawCalls++;var c=this._animations&&this._animations[this._currentAnimation];this._f32RotationAlpha[1]=a.globalAlpha;"lighter"==a.globalCompositeOperation&&a.blendFuncSeparate(a.SRC_ALPHA,a.ONE,a.SRC_ALPHA,a.ONE);var d=this._shaderProgram||a.defaultShaderProgram;this._layer.setShaderProgram(d);
a.uniform4fv(d.uniforms.uPositionAndSize,this._f32PositionAndSize);a.uniform4fv(d.uniforms.uAnimFrameInfo,c&&c.getF32AnimFrameInfo()||this._f32AnimFrameInfo);a.uniform2fv(d.uniforms.uRotationAlpha,this._f32RotationAlpha);this._setPixelShaderUniforms(a,d);a.setTextureImage(b);a.drawArrays(a.TRIANGLE_STRIP,0,4);a.globalCompositeOperation&&"sourceOver"!=a.globalCompositeOperation&&a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)}else a.setTextureImage(b,!0)};
Sprite.prototype.draw_gl.batched=function(a,b){var c=this._animations&&this._animations[this._currentAnimation];this._layer.setShaderProgram(this._shaderProgram||a.defaultShaderProgram);var d=b*a.batchedQuadSize,e=a.batchedQuadSize/4,c=c&&c.getF32AnimFrameInfo()||this._f32AnimFrameInfo;this._f32RotationAlpha[1]=a.globalAlpha;for(var f=0;4>f;f++){var g=e*f;a.batchedVertices[d+g+2]=this._f32PositionAndSize[0];a.batchedVertices[d+g+3]=this._f32PositionAndSize[1];a.batchedVertices[d+g+4]=this._f32PositionAndSize[2];
a.batchedVertices[d+g+5]=this._f32PositionAndSize[3];a.batchedVertices[d+g+6]=c[0];a.batchedVertices[d+g+7]=c[1];a.batchedVertices[d+g+8]=c[2];a.batchedVertices[d+g+9]=c[3];a.batchedVertices[d+g+10]=this._f32RotationAlpha[0];a.batchedVertices[d+g+11]=this._f32RotationAlpha[1]}};Sprite.prototype.draw=Sprite.prototype.draw_gl;
Sprite.prototype.setActiveImage=function(a){var b=this._activeImage;this._activeImage&&b!=a&&wade.removeImageUser(this._activeImage,this);this._activeImage=a;this._image=wade.getImage(a,"");a&&(b!=a&&wade.addImageUser(a,this),"ok"!=wade.getLoadingStatus(a)&&wade.isAutoLoadingImages()?(wade.log("Loading "+a),wade.preloadImage(a)):(this.getAlphaThreshold()&&wade.getImageData(a),(a=this._animations[this._currentAnimation].getImageName()==wade.getFullPathAndFileName(a))&&this._animations[this._currentAnimation].refreshImage(),
this._sizeWasSet||(a?(a=this._animations[this._currentAnimation].getFrameSize(),this.setSize(a.x,a.y)):this.setSize(this._image.width,this._image.height))))};Sprite.prototype.refreshShader=function(){var a=this._layer.getContext();this._pixelShaderSource&&(this._shaderContext&&this._shaderContext!=a)&&(this._shaderProgram=this._layer.getShaderProgram(a,null,this._layer.getPixelShader(a,this._pixelShaderSource,this._pixelShaderUniforms)),this._shaderContext=a)};
Sprite.prototype._setPixelShaderUniforms=function(a,b){if(this._pixelShaderUniforms){var c=1,d;for(d in this._pixelShaderUniforms){var e=this._pixelShaderUniforms[d],f=this.uniformTypeNames[e];if(f)if(this._typedPixelShaderUniforms&&this._typedPixelShaderUniforms[d]){for(e=0;e<this._typedPixelShaderUniforms[d].length;e++)this._typedPixelShaderUniforms[d][e]=this[d]&&this[d][e]||0;a[f](b.uniforms[d],this._typedPixelShaderUniforms[d])}else a[f](b.uniforms[d],this[d]);else"sampler2D"==e&&(a.activeTexture(a.TEXTURE0+
c),a.uniform1i(b.uniforms[d],c),f=a.textures[this[d]]?{imageName:this[d]}:wade.getImage(wade.getFullPathAndFileName(this[d])),a.setTextureImage(f,!1,c),c++,a.activeTexture(a.TEXTURE0))}}};Sprite.prototype.getImageUsedInDraw=function(){var a=this._animations&&this._animations[this._currentAnimation];return a?a.getImage():this._image};
Sprite.prototype.uniformTypeNames={vec4:"uniform4fv",vec3:"uniform3fv",vec2:"uniform2fv","float":"uniform1f",ivec4:"uniform4iv",ivec3:"uniform3iv",ivec2:"uniform2iv","int":"uniform1i"};
function TextSprite(a,b,c,d,e){if("object"==typeof a&&a){var f=a,a=f.text;this._font=f.font||"12px Arial";this._alignment=f.alignment||"left";this._color=f.color||"#000";this._visible="undefined"!=typeof f.visible?f.visible:!0;this._layer=wade.getLayer(f.layer||wade.defaultLayer);this._maxWidth=f.maxWidth||0;this._shadowColor=f.shadowColor||"#000";this._shadowBlur=f.shadowBlur||0;this._shadowOffset={x:f.shadowOffset&&f.shadowOffset.x,y:f.shadowOffset&&f.shadowOffset.y};this._lineSpacing=f.lineSpacing||
1;this._maxLines=f.maxLines||0;this._outlineColor=f.outlineColor||"#000";this._outlineWidth=f.outlineWidth||0;this._boundsScale={x:f.boundsScale&&f.boundsScale.x,y:f.boundsScale&&f.boundsScale.y};this._sortPoint={x:f.sortPoint&&f.sortPoint.x,y:f.sortPoint&&f.sortPoint.y};this._fixedSize="undefined"==typeof f.fixedSize?!1:f.fixedSize;this._name=f.name||"";this._alwaysDraw=!!f.alwaysDraw}else this._font=b||"12px Arial",this._alignment=d||"left",this._color=c||"#000",this._visible=!0,this._layer=wade.getLayer(e||
wade.defaultLayer),this._maxWidth=0,this._shadowColor="#000",this._shadowBlur=0,this._shadowOffset={x:0,y:0},this._lineSpacing=1,this._maxLines=0,this._outlineColor="#000",this._outlineWidth=0,this._boundsScale={x:1,y:1},this._sortPoint={x:0,y:0},this._fixedSize=!1,this._name="",this._alwaysDraw=!1;this._cornerY=this._cornerX=this._image=0;this._drawModifiers=[];this._sceneObject=0;this._position={x:0,y:0};this._centerOffset={x:0,y:0};this._size={x:0,y:0};this._numLines=1;this._lines=[];this._lineHeight=
12;this._imageArea={minX:0,minY:0,maxX:1,maxY:1};this._rotation=0;this.orientedBoundingBox={};this.boundingBox={minX:0,minY:0,maxX:0,maxY:0};try{this._f32PositionAndSize=new Float32Array([0,0,0,0]),this._f32AnimFrameInfo=new Float32Array([0,0,1,1]),this._f32RotationAlpha=new Float32Array([0,0])}catch(g){}this.setText(a||"");f&&f.drawModifiers&&this.setDrawModifiers(f.drawModifiers)}TextSprite.prototype.setPosition=Sprite.prototype.setPosition;TextSprite.prototype.getPosition=Sprite.prototype.getPosition;
TextSprite.prototype.setSortPoint=Sprite.prototype.setSortPoint;TextSprite.prototype.getSortPoint=Sprite.prototype.getSortPoint;TextSprite.prototype.getLayer=Sprite.prototype.getLayer;TextSprite.prototype.getLayerId=Sprite.prototype.getLayerId;TextSprite.prototype.getScreenBox=Sprite.prototype.getScreenBox;TextSprite.prototype.containsScreenPoint=Sprite.prototype.containsScreenPoint;TextSprite.prototype.getWorldOffset=Sprite.prototype.getWorldOffset;
TextSprite.prototype.updateOrientedBoundingBox=Sprite.prototype.updateOrientedBoundingBox;TextSprite.prototype.setVisible=Sprite.prototype.setVisible;TextSprite.prototype.isVisible=Sprite.prototype.isVisible;TextSprite.prototype.bringToFront=Sprite.prototype.bringToFront;TextSprite.prototype.pushToBack=Sprite.prototype.pushToBack;TextSprite.prototype.putBehindSprite=Sprite.prototype.putBehindSprite;TextSprite.prototype.getDrawFunction=Sprite.prototype.getDrawFunction;
TextSprite.prototype.setDrawFunction=Sprite.prototype.setDrawFunction;TextSprite.prototype.overlapsSprite=Sprite.prototype.overlapsSprite;TextSprite.prototype.getRotation=Sprite.prototype.getRotation;TextSprite.prototype.setRotation=Sprite.prototype.setRotation;TextSprite.prototype.getSceneObject=Sprite.prototype.getSceneObject;TextSprite.prototype.getOverlappingObjects=Sprite.prototype.getOverlappingObjects;TextSprite.prototype.setName=Sprite.prototype.setName;TextSprite.prototype.getName=Sprite.prototype.getName;
TextSprite.prototype.getIndexInLayer=Sprite.prototype.getIndexInLayer;TextSprite.prototype.setIndexInLayer=Sprite.prototype.setIndexInLayer;TextSprite.prototype.setDrawModifiers=Sprite.prototype.setDrawModifiers;TextSprite.prototype.getDrawModifiers=Sprite.prototype.getDrawModifiers;TextSprite.prototype.alwaysDraw=Sprite.prototype.alwaysDraw;TextSprite.prototype.isAlwaysDrawing=Sprite.prototype.isAlwaysDrawing;TextSprite.prototype.fadeIn=Sprite.prototype.fadeIn;TextSprite.prototype.fadeOut=Sprite.prototype.fadeOut;
TextSprite.prototype.refreshShader=Sprite.prototype.refreshShader;TextSprite.prototype.getImageUsedInDraw=Sprite.prototype.getImageUsedInDraw;TextSprite.prototype.isUsingBatchableDraw=Sprite.prototype.isUsingBatchableDraw;TextSprite.prototype.getScreenBoundingBox=Sprite.prototype.getScreenBoundingBox;TextSprite.prototype._setPixelShaderUniforms=Sprite.prototype._setPixelShaderUniforms;TextSprite.prototype.setDirtyArea=function(){Sprite.prototype.setDirtyArea.apply(this)};
TextSprite.prototype.drawToImage=function(a,b,c,d,e){var f=c||{x:0,y:0},c=document.createElement("canvas"),g=c.getContext("2d");b||"ok"!=wade.getLoadingStatus(a)?(c.width=this.boundingBox.maxX-this.boundingBox.minX+Math.abs(f.x),c.height=this.boundingBox.maxY-this.boundingBox.minY+Math.abs(f.y)):(b=wade.getImage(a),c.width=b.width,c.height=b.height,g.drawImage(b,0,0));b={x:this._position.x,y:this._position.y};this._position.x=f.x+c.width/(2*(d&&d.horizontalScale||1))-this._centerOffset.x;this._position.y=
f.y+c.height/(2*(d&&d.verticalScale||1))-this._centerOffset.y;this._cornerX=this._position.x-this._size.x/2+this._centerOffset.x;this._cornerY=this._position.y-this._size.y/2+this._centerOffset.y;f=g.globalCompositeOperation;e&&(g.globalCompositeOperation=e);d?(g.save(),g.setTransform(d.horizontalScale,d.horizontalSkew,d.verticalSkew,d.verticalScale,d.horizontalTranslate,d.verticalTranslate),this.draw(g),g.restore()):this.draw(g);g.globalCompositeOperation=f;this._position=b;this._cornerX=this._position.x-
this._size.x/2+this._centerOffset.x;this._cornerY=this._position.y-this._size.y/2+this._centerOffset.y;wade.setImage(a,c)};
TextSprite.prototype.cache=function(){this._cachedImageName||(wade.textSpriteCacheCount=wade.textSpriteCacheCount+1||1,this._cachedImageName="__wade_TextSprite_cache_"+wade.textSpriteCacheCount);var a=this._rotation;a&&(this._rotation=0,this.updateOrientedBoundingBox(),this.updateBoundingBox());this.drawToImage(this._cachedImageName,!0);a&&(this._rotation=a,this.updateOrientedBoundingBox(),this.updateBoundingBox());this._image=wade.getImage(this._cachedImageName);wade.releaseImageReference(this._cachedImageName)};
TextSprite.prototype.isCached=function(){return!!this._image};TextSprite.prototype.getImageName=function(){return this._cachedImageName||"__wade_TextSprite_no_image"};TextSprite.prototype.getAllImageNames=function(){return[this.getImageName()]};TextSprite.prototype.setActiveImage=function(){};
TextSprite.prototype.getScreenPositionAndExtents=function(){var a={x:(this.boundingBox.maxX+this.boundingBox.minX)/2,y:(this.boundingBox.maxY+this.boundingBox.minY)/2},b=this._layer.worldDirectionToScreen({x:this.boundingBox.maxX-this.boundingBox.minX,y:this.boundingBox.maxY-this.boundingBox.minY}),a=this._layer.worldPositionToScreen(a);return{extents:{x:b.x/2,y:b.y/2},position:a}};
TextSprite.prototype.updateBoundingBox=function(){if(this._rotation)this.boundingBox.minX=this._position.x-this.orientedBoundingBox.rx-wade.c_epsilon+this._centerOffset.x,this.boundingBox.minY=this._position.y-this.orientedBoundingBox.ry-wade.c_epsilon+this._centerOffset.y,this.boundingBox.maxX=this._position.x+this.orientedBoundingBox.rx+wade.c_epsilon+this._centerOffset.x,this.boundingBox.maxY=this._position.y+this.orientedBoundingBox.ry+wade.c_epsilon+this._centerOffset.y;else{var a=this._size.x/
2,b=this._size.y/2;this.boundingBox.minX=this._position.x-a-wade.c_epsilon+this._centerOffset.x;this.boundingBox.minY=this._position.y-b-wade.c_epsilon+this._centerOffset.y;this.boundingBox.maxX=this._position.x+a+wade.c_epsilon+this._centerOffset.x;this.boundingBox.maxY=this._position.y+b+wade.c_epsilon+this._centerOffset.y}this.orientedBoundingBox.centerX=this._position.x+this._centerOffset.x;this.orientedBoundingBox.centerY=this._position.y+this._centerOffset.y;this._f32PositionAndSize&&(this._f32PositionAndSize[0]=
this.orientedBoundingBox.centerX,this._f32PositionAndSize[1]=this.orientedBoundingBox.centerY,this._f32PositionAndSize[2]=this._size.x,this._f32PositionAndSize[3]=this._size.y);this._sceneObject&&this._sceneObject.isInScene()&&this._layer.onSpritePositionChanged(this)};TextSprite.prototype.setText=function(a){this.setDirtyArea();this._text=a.toString();this._fixedSize||(this._updateSize(),this.setDirtyArea());this._image=0};TextSprite.prototype.getText=function(){return this._text};
TextSprite.prototype.setMaxWidth=function(a){this._maxWidth=a;!this._fixedSize&&this._updateSize();this._image=0};TextSprite.prototype.setMaxLines=function(a){if(this._maxLines!=a){if(this._maxLines=a)this._numLines=Math.min(this._numLines,this._maxLines);!this._fixedSize&&this._updateSize();this._image=0}};TextSprite.prototype.setColor=function(a){this._color=a;this.setDirtyArea();this._image=0};
TextSprite.prototype.setShadow=function(a,b,c,d){this._shadowColor=a;this._shadowBlur=b;this._shadowOffset={x:c?c:0,y:d?d:0};this.setDirtyArea();this._fixedSize||(this._updateSize(),this.setDirtyArea());this._image=0};TextSprite.prototype.setFont=function(a){this._font=a;this.setDirtyArea();this._fixedSize||(this._updateSize(),this.setDirtyArea());this._image=0};
TextSprite.prototype.setLineSpacing=function(a){this._lineSpacing=a;this.setDirtyArea();this._fixedSize||(this._updateSize(),this.setDirtyArea());this._image=0};TextSprite.prototype.setAlignment=function(a){this._alignment=a;this.setDirtyArea();this._fixedSize||(this._updateSize(),this.setDirtyArea());this._image=0};TextSprite.prototype.getLine=function(a){return this._lines[a].text};TextSprite.prototype.getNumLines=function(){return this._numLines};TextSprite.prototype.getLineWidth=function(a){return this._lines[a].width};
TextSprite.prototype.setOutline=function(a,b){this._outlineWidth=a;this._outlineColor=b||"#000";this.setDirtyArea();this._image=0};
TextSprite.prototype.clone=function(){var a=new TextSprite;wade.extend(a,this);a._sceneObject=0;a.quadTreeNode=0;a._position={x:this._position.x,y:this._position.y};a._sortPoint={x:this._sortPoint.x,y:this._sortPoint.y};a._boundsScale={x:this._boundsScale.x,y:this._boundsScale.y};a._shadowOffset={x:this._shadowOffset.x,y:this._shadowOffset.y};a._centerOffset={x:this._centerOffset.x,y:this._centerOffset.y};a._size={x:this._size.x,y:this._size.y};a.boundingBox=wade.extend({},this.boundingBox);a.orientedBoundingBox=
wade.extend({},this.orientedBoundingBox);try{a._f32AnimFrameInfo=this._f32AnimFrameInfo?new Float32Array([this._f32AnimFrameInfo[0],this._f32AnimFrameInfo[1],this._f32AnimFrameInfo[2],this._f32AnimFrameInfo[3]]):new Float32Array([0,0,1,1]),a._f32PositionAndSize=this._f32PositionAndSize?new Float32Array([this._f32PositionAndSize[0],this._f32PositionAndSize[1],this._f32PositionAndSize[2],this._f32PositionAndSize[3]]):new Float32Array([0,0,1,1]),a._f32RotationAlpha=this._f32RotationAlpha?new Float32Array([this._f32RotationAlpha[0],
this._f32RotationAlpha[1]]):new Float32Array([0,0])}catch(b){}this._cachedImageName&&(a._cachedImageName=0,a.cache());return a};
TextSprite.prototype.serialize=function(a,b){var c={type:"TextSprite",text:this._text,name:this._name,font:this._font,alignment:this._alignment,color:this._color,visible:this._visible,layer:this._layer.id,maxWidth:this._maxWidth,shadowColor:this._shadowColor,shadowBlur:this._shadowBlur,shadowOffset:{x:this._shadowOffset.x,y:this._shadowOffset.y},lineSpacing:this._lineSpacing,maxLines:this._maxLines,outlineColor:this._outlineColor,outlineWidth:this._outlineWidth,boundsScale:{x:this._boundsScale.x,
y:this._boundsScale.y},sortPoint:{x:this._sortPoint.x,y:this._sortPoint.y},fixedSize:this._fixedSize,drawModifiers:wade.cloneArray(this._drawModifiers),properties:{}},d;for(d in this._animations)this._animations.hasOwnProperty(d)&&!this._animations[d].isDefault&&(c.animations[d]=this._animations[d].serialize());d=["sceneObject","boundingBox","orientedBoundingBox","id","needsDrawing"];b&&(d=d.concat(b));for(var e in this)if(this.hasOwnProperty(e)&&"_"!=e[0]&&-1==d.indexOf(e))try{var f=JSON.stringify(this[e]);
c.properties[e]=JSON.parse(f)}catch(g){}return a?JSON.stringify(c,null,"\t"):c};TextSprite.prototype.scaleBounds=function(a,b){this._boundsScale={x:a,y:b};this._updateSize();this._image=0};TextSprite.prototype.setFixedSize=function(a){"undefined"==typeof a&&(a=!0);this._fixedSize=a};TextSprite.prototype.getSize=function(){return{x:this._size.x,y:this._size.y}};
TextSprite.prototype._updateSize=function(){var a=wade.getInternalContext();this._lines.length=0;TextSprite.textMeasuring||(TextSprite.textMeasuring={},TextSprite.textMeasuring.text=document.createElement("span"),TextSprite.textMeasuring.text.style.whiteSpace="nowrap",TextSprite.textMeasuring.block=document.createElement("div"),TextSprite.textMeasuring.block.style.display="inline-block",TextSprite.textMeasuring.block.style.width="1px",TextSprite.textMeasuring.block.style.height="0px",TextSprite.textMeasuring.div=
document.createElement("div"),TextSprite.textMeasuring.div.style.whiteSpace="nowrap",TextSprite.textMeasuring.div.style.position="absolute",TextSprite.textMeasuring.div.appendChild(TextSprite.textMeasuring.text),TextSprite.textMeasuring.div.appendChild(TextSprite.textMeasuring.block));document.body.appendChild(TextSprite.textMeasuring.div);TextSprite.textMeasuring.text.style.font=this._font;TextSprite.textMeasuring.text.textContent=this._text;TextSprite.textMeasuring.block.style.verticalAlign="bottom";
var b=TextSprite.textMeasuring.text.getBoundingClientRect().top,c=TextSprite.textMeasuring.block.getBoundingClientRect().top-b;TextSprite.textMeasuring.block.style.verticalAlign="baseline";c||(c=3*a.measureText("m").width+this._outlineWidth);this._centerOffset.y=c/2+(b-TextSprite.textMeasuring.block.getBoundingClientRect().top);document.body.removeChild(TextSprite.textMeasuring.div);this._lineHeight=c;this._refresh(0,this._lines,a);this._numLines=this._lines.length;for(b=a=0;b<this._lines.length;b++)a=
Math.max(a,this._lines[b].width);this._size.x=a;this._size.y=c+(this._numLines-1)*this._lineSpacing*c;this._centerOffset.y+=(this._size.y-c)/2;switch(this._alignment){case "left":this._centerOffset.x=a/2;break;case "right":this._centerOffset.x=-a/2;break;case "center":this._centerOffset.x=0}this._shadowColor&&(this._size.x+=Math.abs(this._shadowOffset.x)+Math.max(8,2*this._shadowBlur),this._size.y+=Math.abs(this._shadowOffset.y)+Math.max(8,2*this._shadowBlur));this._outlineWidth&&(this._size.x+=this._outlineWidth,
this._size.y+=this._outlineWidth);this._size.x+=3;this._size.y+=3;this._size.x*=this._boundsScale.x;this._size.y*=this._boundsScale.y;this.updateBoundingBox()};TextSprite.prototype._calculateHeight=function(){return height};
TextSprite.prototype.draw_2d=function(a){if(a.isWebGl)TextSprite.prototype.draw_gl.call(this,a);else if(this._visible&&this._text)if(this._image){this._cornerX=this._position.x-this._size.x/2+this._centerOffset.x;this._cornerY=this._position.y-this._size.y/2+this._centerOffset.y;var b=this._position.x,c=this._position.y;this._position.x=this.orientedBoundingBox.centerX;this._position.y=this.orientedBoundingBox.centerY;Sprite.prototype.draw_2d.call(this,a);this._position.x=b;this._position.y=c}else this._refresh(1,
0,a)};TextSprite.prototype.draw_gl=function(a){if(a.isWebGl){if(this._visible&&this._text){if(!this._image){var b=this.getDrawModifiers();this.setDrawModifiers();this.cache();this.setDrawModifiers(b)}this._activeImage=this._cachedImageName;this._cornerX=this.boundingBox.minX;this._cornerY=this.boundingBox.minY;Sprite.prototype.draw_gl.call(this,a)}}else TextSprite.prototype.draw_2d.call(this,a)};TextSprite.prototype.draw=TextSprite.prototype.draw_gl;TextSprite.prototype.step=function(){};
TextSprite.prototype.playAnimation=function(){};TextSprite.prototype.setSceneObject=function(a){this._sceneObject=a};
TextSprite.prototype._refresh=function(a,b,c){c=c||wade.getInternalContext();this._rotation&&(c.save(),c.translate(this._position.x+this._centerOffset.x,this._position.y+this._centerOffset.y),c.rotate(this._rotation),c.translate(-this._position.x-this._centerOffset.x,-this._position.y-this._centerOffset.y));c.font=this._font;c.fillStyle=this._color;c.textAlign=this._alignment;this._shadowColor&&(c.shadowColor=this._shadowColor,c.shadowBlur=this._shadowBlur,c.shadowOffsetX=this._shadowOffset.x,c.shadowOffsetY=
this._shadowOffset.y);if(this._outlineWidth){var d=c.strokeStyle,e=c.lineWidth;c.lineWidth=this._outlineWidth;c.strokeStyle=this._outlineColor}if(!this._maxWidth&&0>this._text.indexOf("\n"))a&&(c.fillText(this._text,this._position.x,this._position.y),this._outlineWidth&&c.strokeText(this._text,this._position.x,this._position.y)),b&&b.push({width:c.measureText(this._text).width+this._outlineWidth,text:this._text});else{for(var f=0,g=this._text.split("\n"),i=0;i<g.length&&(!this._maxLines||f<this._maxLines);i++){for(var h=
g[i].split(" "),k=1,j;0<h.length&&k<=h.length;)if(j=h.slice(0,k).join(" "),c.measureText(j).width+this._outlineWidth>this._maxWidth&&0<this._maxWidth){1==k&&(k=2);j=h.slice(0,k-1).join(" ");if(!this._maxLines||f<this._maxLines)a&&(c.fillText(j,this._position.x,this._position.y+this._lineHeight*this._lineSpacing*f),this._outlineWidth&&c.strokeText(this._text,this._position.x,this._position.y)),b&&b.push({width:c.measureText(j).width+this._outlineWidth,text:j});f++;h=h.splice(k-1);k=1}else k++;if(0<
k&&(!this._maxLines||f<this._maxLines))j=h.join(" "),a&&(c.fillText(j,this._position.x,this._position.y+this._lineHeight*this._lineSpacing*f),this._outlineWidth&&c.strokeText(this._text,this._position.x,this._position.y)),b&&b.push({width:c.measureText(j).width+this._outlineWidth,text:j}),f++}this._numLines=f}this._shadowColor&&(c.shadowColor="rgba(0, 0, 0, 0)");this._outlineWidth&&(c.strokeStyle=d,c.lineWidth=e);this._rotation&&c.restore()};TextSprite.prototype.getCachedImage=function(){return this._image};
function Wade(){var a=this,b=0,c=0,d=0,e=0,f=0,g=0,i=!1,h=!1,k="",j=1,l=[],m=[],q=0,u=1,x="none",p=new Image,r=[],n={},t=[],w,y,v,z,F,A,G,s,B=!0,C=!0,E={},H={},D=[],J=0,M=!0,O={}.hasOwnProperty.toString,P=O.call(Object),N=1,K="wade_main_div",L=!1,I={straight:[{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1},{x:1,y:1}],diagonal:[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}],both:[{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1},{x:1,y:1},{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}]};I["top-down straight"]=I.diagonal;I["top-down diagonal"]=
I.straight;I["iso straight"]=I.straight;I["iso diagonal"]=I.diagonal;p.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII=";this.app=0;this.c_timeStep=1/60;this.defaultLayer=1;this._appData=0;this.c_epsilon=1E-4;this.init=function(a,f,g){var g=g||{},h=g.forceReload,i=g.updateCallback;A=g.forceWebGl;var j=g.container;C="undefined"!=typeof g.globalUnderscore?!!g.globalUnderscore:!0;K=j||"wade_main_div";var p=function(){var a=window.applicationCache;
if(a)if(a.status==a.UPDATEREADY)wade.log("a new version of the app is available"),i?i():(alert("A new version is available.\nPlease press OK to restart."),a.swapCache(),window.location.reload(!0),window.location=window.location);else{try{a.update()}catch(b){}a.addEventListener("updateready",p,!1)}};p();a&&(k=a.substr(0,Math.max(a.lastIndexOf("/"),a.lastIndexOf("\\"))+1));for(var n=0,j=["ms","moz","webkit","o"],l=0;l<j.length&&!window.requestAnimationFrame;l++)window.requestAnimationFrame=window[j[l]+
"RequestAnimationFrame"],window.cancelAnimationFrame=window[j[l]+"CancelAnimationFrame"]||window[j[l]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-n)),d=window.setTimeout(function(){a(b+c)},c);n=b+c;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});j="undefined"==typeof g.audio||g.audio;s=g.audioContext;if(j&&!s){try{window.AudioContext=window.AudioContext||
window.webkitAudioContext;s=new AudioContext;var r=XMLHttpRequest&&"string"===typeof(new XMLHttpRequest).responseType}catch(t){}r||wade.warn("Warning: the WebAudio API is not supported in this environment. Audio functionality will be limited")}c=new AssetLoader;c.init(!1);d=new AssetLoader;d.init(!0);b=new SceneManager;b.init();e=new InputManager;("undefined"==typeof g.input||g.input)&&e.init();v=document.createElement("canvas");v.width=v.height=256;z=v.getContext("2d");this.proceduralImages.init();
G=!!g.debug;this._appData=f?f:{};a?c.loadAppScript(a,h):window.App?this.instanceApp():wade.warn("Warning - App is not defined.");this.event_mainLoop()};this.stop=function(){f&&cancelAnimationFrame(f);g&&clearTimeout(g);this.setLoadingImages([]);wade.stopInputEvents()};this.stopInputEvents=function(){e.deinit()};this.restartInputEvents=function(){e.init()};this.cancelInputEvents=function(a){e.cancelEvents(a)};this.getBasePath=function(){return k};this.setBasePath=function(a){k=a||""};this.getFullPathAndFileName=
function(a){if(!a||"procedural_"==a.substr(0,11)||k&&a.substr(0,k.length)==k)return a;var b=a[0];return"\\"==b||"/"==b||-1!=a.indexOf(":")?a:k+a};this.loadScript=function(a,b,d,e,f){a=this.getFullPathAndFileName(a);c.loadScript(a,b,d,e,f)};this.preloadScript=function(a,b,c,e,f){a=this.getFullPathAndFileName(a);d.loadScript(a,b,c,e,f)};this.getScript=function(a){a=this.getFullPathAndFileName(a);return c.getScript(a)};this.setScript=function(a,b,e){a=this.getFullPathAndFileName(a);c.setScript(a,b);
e&&d.setScript(a,b)};this.loadJson=function(a,b,d,e,f){a=this.getFullPathAndFileName(a);c.loadJson(a,b,d,e,f)};this.preloadJson=function(a,b,c,e,f){a=this.getFullPathAndFileName(a);d.loadJson(a,b,c,e,f)};this.getJson=function(a){a=this.getFullPathAndFileName(a);return c.getJson(a)};this.setJson=function(a,b,e){a=this.getFullPathAndFileName(a);c.setJson(a,b);e&&d.setJson(a,b)};this.loadText=function(a,b,d,e,f){a=this.getFullPathAndFileName(a);c.loadText(a,b,d,e,f)};this.preloadText=function(a,b,c,
e,f){a=this.getFullPathAndFileName(a);d.loadText(a,b,c,e,f)};this.getText=function(a){a=this.getFullPathAndFileName(a);return c.getText(a)};this.setText=function(a,b,e){a=this.getFullPathAndFileName(a);c.setText(a,b);e&&d.setText(a,b)};this.loadImage=function(a,b,d){a=this.getFullPathAndFileName(a);c.loadImage(a,b,d)};this.loadImages=function(a){for(var b=0;b<a.length;b++)this.loadImage(a[b])};this.preloadImage=function(a,b,c){a=this.getFullPathAndFileName(a);d.loadImage(a,b,c)};this.unloadImage=
function(a){a=this.getFullPathAndFileName(a);c.unloadImage(a);d.unloadImage(a);delete E[a]};this.unloadAllImages=function(){c.unloadAllImages();d.unloadAllImages();E=[]};this.getImage=function(a,b){if(a){var d=this.getFullPathAndFileName(a);return c.getImage(d,b)}return p};this.setImage=function(a,e,f){a=this.getFullPathAndFileName(a);c.setImage(a,e);f&&d.setImage(a,e);delete E[a];b.renderer.updateImageUsers(a)};this.loadAudio=function(a,b,d,e,f){a=this.getFullPathAndFileName(a);c.loadAudio(a,b,d,
e,f)};this.preloadAudio=function(a,b,c,e,f){a=this.getFullPathAndFileName(a);d.loadAudio(a,b,c,e,f)};this.unloadAudio=function(a){a=this.getFullPathAndFileName(a);c.unloadAudio(a);d.unloadAudio(a)};this.unloadAllAudio=function(){c.unloadAllAudio();d.unloadAllAudio()};this.setAudio=function(a,b,e,f){a=this.getFullPathAndFileName(a);c.setAudio(a,b,e);f&&d.setAudio(a,b,e)};this.playAudio=function(a,b,c){if("ok"!=this.getLoadingStatus(this.getFullPathAndFileName(a)))return-1;var d=this.getAudio(a);if(s){var e=
s.createBufferSource();e.buffer=d;e.loop=!!b;e.connect(s.destination);e.endEventFired=!1;e.onended=function(){e.endEventFired=!0;c&&(c(),c=null)};e.start(0);r.push(e);if(c&&!b){var f=function(){e.playbackState!=e.FINISHED_STATE?setTimeout(f,wade.c_timeStep):e.onended&&!e.endEventFired&&(e.endEventFired=!0,e.onended())};e.checkEnded=setTimeout(f,1E3*e.buffer.duration+wade.c_timeStep)}}else d.alreadyPlayed&&!d.ended&&(d=new Audio(d.src),this.setAudio(a,d)),d.loop=b,d.alreadyPlayed=!0,b&&d.addEventListener("ended",
function(){this.currentTime=0;this.play()},!1),d.play(),r.push(d);return r.length};this.stopAudio=function(a){if("undefined"==typeof a)for(a=0;a<r.length;a++)r[a]&&(r[a].stop(),r[a].checkEnded&&clearTimeout(r[a].checkEnded));else if(a=r[a-1])a.stop(),a.checkEnded&&clearTimeout(a.checkEnded)};this.playAudioSegment=function(a,b,c,d){if("ok"!=this.getLoadingStatus(this.getFullPathAndFileName(a)))return-1;b=b||0;a=this.getAudio(this.getFullPathAndFileName(a));if(s){var e=s.createBufferSource();e.buffer=
a;e.connect(s.destination);e.endEventFired=!1;e.onended=function(){e.endEventFired=!0;d&&(d(),d=null)};e.start(0,b);if(d){var f=function(){e.playbackState!=e.FINISHED_STATE?setTimeout(f,wade.c_timeStep):e.onended&&!e.endEventFired&&(e.endEventFired=!0,e.onended())};e.checkEnded=setTimeout(f,1E3*(e.buffer.duration-b)+wade.c_timeStep)}c&&e.stop(c);r.push(e)}else c=c||a.duration,a.alreadyPlayed&&!a.ended&&(a=new Audio(a.src)),a.addEventListener("timeupdate",function(){this.currentTime>=c&&(this.pause(),
this.ended=!0,d&&d())},!1),a.alreadyPlayed=!0,a.play(),r.push(a);return r.length-1};this.loadFont=function(a,b,d){a=this.getFullPathAndFileName(a);c.loadFont(a,b,d)};this.preloadFont=function(a,b,c){a=this.getFullPathAndFileName(a);d.loadFont(a,b,c)};this.getFont=function(a){a=this.getFullPathAndFileName(a);return c.getFont(a)};this.setFont=function(a,b,e){a=this.getFullPathAndFileName(a);c.setFont(a,b);e&&d.setFont(a,b)};this.getLoadingStatus=function(a){a=this.getFullPathAndFileName(a);return c.getLoadingStatus(a)};
this.instanceApp=function(){this.app=new App;this.app.appData=this._appData;this.app.load&&this.app.load();i=!1;h=!0};this.initializeApp=function(){i=!0;this.app.init?this.app.init():wade.warn("Warning: Unable to initialize app. App.init function is missing.");g=setTimeout(function(){wade.event_appTimerEvent()},1E3*j)};this.getGamepadData=function(){return e.getGamepadData()};this.processEvent=function(a,c){return b.processEvent(a,c)};this.addEventListener=function(a,c){b.addEventListener(a,c)};this.removeEventListener=
function(a,c){b.removeEventListener(a,c)};this.isEventListener=function(a,c){return b.isObjectListeneningForEvent(a,c)};this.addGlobalEventListener=function(a,c){b.addGlobalEventListener(a,c)};this.removeGlobalEventListener=function(a,c){b.removeGlobalEventListener(a,c)};this.getCameraPosition=function(){return b.renderer.getCameraPosition()};this.setCameraPosition=function(a){b.renderer.setCameraPosition(a)};this.getAppTime=function(){return b.getAppTime()};this.getClockTime=function(){return window.performance&&
window.performance.now?window.performance.now():(new Date).getTime()};this.setAppTimerInterval=function(a){j=a};this.removeObjectFromArrayByIndex=function(a,b){if(0<=a){var c=b.slice(a+1||b.length);b.length=a;return b.push.apply(b,c)}return b};this.removeObjectFromArray=function(a,b){var c=b.lastIndexOf(a);return-1!=c?this.removeObjectFromArrayByIndex(c,b):b};this.addSceneObject=function(a,c,d){"undefined"==typeof c&&(c=!0);b.addSceneObject(a,c,d);return a};this.removeSceneObject=function(a){b.removeSceneObject("string"==
typeof a?this.getSceneObject(a):a)};this.removeSceneObjects=function(a){for(var c=0;c<a.length;c++)b.removeSceneObject(a[c])};this.clearScene=function(){b.clear()};this.getLayerSorting=function(a){return b.renderer.getLayerSorting(a)};this.setLayerSorting=function(a,c){b.renderer.setLayerSorting(a,c)};this.setLayerTransform=function(a,c,d){b.renderer.setLayerTransform(a,c,d)};this.setLayerResolutionFactor=function(a,c){b.renderer.setLayerResolutionFactor(a,c)};this.getLayerResolutionFactor=function(a){return b.renderer.getLayerResolutionFactor(a)};
this.setResolutionFactor=function(a){u=a;b.renderer.setResolutionFactor(u)};this.getResolutionFactor=function(){return u};this.getScreenWidth=function(){return b.renderer.getScreenWidth()};this.getScreenHeight=function(){return b.renderer.getScreenHeight()};this.setScreenSize=function(a,c){b.renderer.setScreenSize(a,c)};this.getContainerWidth=function(){return this.isScreenRotated()?window.innerHeight:window.innerWidth};this.getContainerHeight=function(){return this.isScreenRotated()?window.innerWidth:
window.innerHeight};this.setCanvasClearing=function(a,c){b.renderer.setCanvasClearing(a,c)};this.setWindowMode=function(a){b.renderer.setWindowMode(a)};this.getWindowMode=function(){return b.renderer.getWindowMode()};this.loadPage=function(a){window.self.location=a};this.cloneObject=function(a){return wade.extend(!0,{},a)};this.cloneArray=function(a){return wade.extend(!0,[],a)};this.simulateSceneObject=function(a,c){c?a.simulated||(b.addEventListener(a,"onSimulationStep"),a.simulated=!0):a.simulated&&
(b.removeEventListener(a,"onSimulationStep"),a.simulated=!1)};this.setMaxScreenSize=function(a,c){b.renderer.setMaxScreenSize(a,c)};this.getMaxScreenWidth=function(){return b.renderer.getMaxScreenWidth()};this.getMaxScreenHeight=function(){return b.renderer.getMaxScreenHeight()};this.setMinScreenSize=function(a,c){return b.renderer.setMinScreenSize(a,c)};this.getMinScreenWidth=function(){return b.renderer.getMinScreenWidth()};this.getMinScreenHeight=function(){return b.renderer.getMinScreenHeight()};
this.createCanvas=function(a){var a=a||1,b=document.getElementById(K),c=document.getElementById(K),d=parseInt(c.getAttribute("width")),c=parseInt(c.getAttribute("height")),e=document.createElement("canvas");e.width=Math.round(d*a);e.height=Math.round(c*a);e.style.position=b.style.position;e.style.margin="auto";e.style.top=0;e.style.left=0;e.style.right=0;e.style.bottom=0;e.style.backfaceVisibility=e.style.WebkitBackfaceVisibility=e.style.MozBackfaceVisibility=e.style.OBackfaceVisibility="hidden";
var a=e.style.width.toString().toLowerCase(),f=e.style.height.toString().toLowerCase();a==f&&"auto"==a?(e.style.width=d+"px",e.style.height=c+"px"):(e.style.width=b.style.width,e.style.height=b.style.height);e.style.MozTransform=e.style.msTransform=e.style.OTransform=e.style.WebkitTransform=e.style.transform="translate3d(0,0,0)";b.appendChild(e);return e};this.deleteCanvases=function(){b.renderer.removeCanvases()};this.recreateCanvases=function(){b.renderer.recreateCanvases()};this.isAppInitialized=
function(){return i};this.boxContainsBox=function(a,b){return a.minX<b.minX&&a.maxX>b.maxX&&a.minY<b.minY&&a.maxY>b.maxY};this.boxIntersectsBox=function(a,b){return!(a.maxX<b.minX||a.minX>b.maxX||a.maxY<b.minY||a.minY>b.maxY)};this.boxContainsPoint=function(a,b){return b.x>=a.minX&&b.x<=a.maxX&&b.y>=a.minY&&b.y<=a.maxY};this.orientedBoxContainsPoint=function(a,b){var c=Math.sin(a.rotation),d=Math.cos(a.rotation),e=b.x-a.centerX,f=b.y-a.centerY,g=d*e+c*f,c=d*f-c*e;return g>=-a.halfWidth&&g<=a.halfWidth&&
c>=-a.halfHeight&&c<=a.halfHeight};this.orientedBoxIntersectsOrientedBox=function(a,b){var c=b.centerX-a.centerX,d=b.centerY-a.centerY,e=a.axisXx,f=a.axisXy,g=a.axisYx,h=a.axisYy,i=b.axisXx,k=b.axisXy,j=b.axisYx,p=b.axisYy;return!(Math.abs(c*e+d*f)>e*e+f*f+Math.abs(i*e+k*f)+Math.abs(j*e+p*f)||Math.abs(c*g+d*h)>g*g+h*h+Math.abs(i*g+k*h)+Math.abs(j*g+p*h)||Math.abs(c*i+d*k)>i*i+k*k+Math.abs(i*e+k*f)+Math.abs(i*g+k*h)||Math.abs(c*j+d*p)>j*j+p*p+Math.abs(j*e+p*f)+Math.abs(j*g+p*h))};this.boxIntersectsOrientedBox=
function(a,b){var c=(a.minX+a.maxX)/2-b.centerX,d=(a.minY+a.maxY)/2-b.centerY,e=(a.maxX-a.minX)/2,f=(a.maxY-a.minY)/2,g=b.axisXx,h=b.axisXy,i=b.axisYx,k=b.axisYy;return!(Math.abs(c*e)>e*e+Math.abs(g*e)+Math.abs(i*e)||Math.abs(d*f)>f*f+Math.abs(h*f)+Math.abs(k*f)||Math.abs(c*g+d*h)>g*g+h*h+Math.abs(g*e)+Math.abs(h*f)||Math.abs(c*i+d*k)>i*i+k*k+Math.abs(i*e)+Math.abs(k*f))};this.orientedBoxIntersectsBox=function(a,b){return this.boxIntersectsOrientedBox(b,a)};this.expandBox=function(a,b){a.minX=Math.min(a.minX,
b.minX);a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,b.maxY)};this.clampBoxToBox=function(a,b){a.minX=Math.min(b.maxX,Math.max(a.minX,b.minX));a.minY=Math.min(b.maxY,Math.max(a.minY,b.minY));a.maxX=Math.max(b.minX,Math.min(a.maxX,b.maxX));a.maxY=Math.max(a.minY,Math.min(a.maxY,b.maxY))};this.postObject=function(a,b,c,d){b={data:JSON.stringify(b)};d&&wade.extend(b,d);b=JSON.stringify(b);this.ajax({type:"POST",url:a,data:b,success:c,dataType:"json"})};this.setGlobalLoadingCallback=
function(a){c.setGlobalCallback(a)};this.setMainLoop=function(a,b,c){for(var b=b||"_wade_default",d=0;d<m.length&&m[d].name!=b;d++);m[d]={func:a,name:b,priority:c||0};m.sort(function(a,b){return b.priority-a.priority})};this.setLoadingImages=function(a,b){for(var c=0;c<l.length;c++)document.body.removeChild(l[c]);l.length=0;wade.isArray(a)||(a=[a]);for(c=0;c<a.length;c++){var d=document.createElement("img");d.className="loadingImage_class";d.style.display="none";var e=document.getElementById("container");
document.body.insertBefore(d,e);d.src=this.getFullPathAndFileName(a[c]);l.push(d);b&&d.addEventListener("click",function(){window.open(b,"_blank")})}};this.worldPositionToScreen=function(a,c){return b.renderer.worldPositionToScreen(a,c)};this.worldDirectionToScreen=function(a,c){return b.renderer.worldDirectionToScreen(a,c)};this.worldBoxToScreen=function(a,c){return b.renderer.worldBoxToScreen(a,c)};this.worldUnitToScreen=function(a){return b.renderer.worldUnitToScreen(a)};this.screenPositionToWorld=
function(a,c){return b.renderer.screenPositionToWorld(a,c)};this.screenDirectionToWorld=function(a,c){return b.renderer.screenDirectionToWorld(a,c)};this.screenBoxToWorld=function(a,c){return b.renderer.screenBoxToWorld(a,c)};this.screenUnitToWorld=function(a){return b.renderer.screenUnitToWorld(a)};this.worldPositionToCanvas=function(a,c){return b.renderer.worldPositionToCanvas(a,c)};this.worldDirectionToCanvas=function(a,c){return b.renderer.worldDirectionToCanvas(a,c)};this.worldBoxToCanvas=function(a,
c){return b.renderer.worldBoxToCanvas(a,c)};this.worldUnitToCanvas=function(a){return b.renderer.worldUnitToCanvas(a)};this.canvasPositionToWorld=function(a,c){return b.renderer.canvasPositionToWorld(a,c)};this.canvasDirectionToWorld=function(a,c){return b.renderer.canvasDirectionToWorld(a,c)};this.canvasBoxToWorld=function(a,c){return b.renderer.canvasBoxToWorld(a,c)};this.canvasUnitToWorld=function(a){return b.renderer.canvasUnitToWorld(a)};this.setMinimumInputEventInterval=function(a,b){e.setMinimumIntervalBetweenEvents(a,
b)};this.isMouseDown=function(a){return e.isMouseDown(a)};this.isKeyDown=function(a){return e.isKeyDown(a)};this.unpackSpriteSheet=function(a,b,c,d,e){for(var c=c||1,d=d||1,f=this.getImage(a),g=f.width/c,f=f.height/d,h=0;h<b.length&&h<c*d;h++){var i=document.createElement("canvas");i.width=g;i.height=f;(new Animation(a,c,d,1,!1,h,h)).draw(i.getContext("2d"),{x:g/2,y:f/2},{x:g,y:f});wade.setImage(b[h]||a+"_"+h,i)}e&&this.unloadImage(a)};this.storeLocalObject=function(a,b){localStorage.setItem(a,JSON.stringify(b))};
this.retrieveLocalObject=function(a){return(a=localStorage.getItem(a))&&JSON.parse(a)};this.setFullScreen=function(a){var b=document.documentElement;a||"undefined"==typeof a?a=b.requestFullScreen||b.requestFullscreen||b.mozRequestFullScreen||b.mozRequestFullscreen||b.webkitRequestFullScreen||b.webkitRequestFullscreen||b.msRequestFullScreen||b.msRequestFullscreen:(b=document,a=b.exitFullscreen||b.msExitFullscreen||b.mozCancelFullScreen||b.webkitCancelFullScreen);a&&a.call(b)};this.setLayerSmoothing=
function(a,c){"undefined"==typeof c&&(c=!0);b.renderer.setLayerSmoothing(a,c)};this.getLayerSmoothing=function(a){return b.renderer.getLayerSmoothing(a)};this.setSmoothing=function(a){"undefined"==typeof a&&(a=!0);b.renderer.setSmoothing(a)};this.getSmoothing=function(){return b.renderer.getSmoothing()};this.setClickTolerance=function(a){e.setClickTolerance(a)};this.getMousePosition=function(){return e.getMousePosition()};this.isWebAudioSupported=function(){return!!s};this.forceOrientation=function(a){if(x!=
a){switch(a){case "landscape":x="landscape";break;case "portrait":x="portrait";break;default:x="none"}b.setSimulationDirtyState();b.draw()}};this.getForcedOrientation=function(){return x};this.isScreenRotated=function(){return b.renderer.isScreenRotated()};this.moveCamera=function(a,b,c){"object"!=typeof a||"number"!=typeof a.x||"number"!=typeof a.y||"number"!=typeof a.z?wade.log("Warning - invalid destination for wade.moveCamera(). It needs to be an object with x, y, and z fields."):"number"!=typeof b&&
"function"!=typeof b?wade.log("Warning - invalid speed for wade.moveCamera(). It needs to be a number, or a function that returns a number."):this.setMainLoop(function(){var d=wade.getCameraPosition(),e=a.x-d.x,f=a.y-d.y,g=a.z-d.z,h=Math.sqrt(e*e+f*f+g*g),i="number"==typeof b?b:b(h)||0;h<=i*wade.c_timeStep?(wade.setCameraPosition(a),wade.setMainLoop(0,"_wade_camera"),c&&c(),d={cameraPosition:wade.getCameraPosition()},wade.processEvent("onCameraMove",d)||wade.app.onCameraMoveComplete&&wade.app.onCameraMoveComplete(d)):
wade.setCameraPosition({x:d.x+e*i*wade.c_timeStep/h,y:d.y+f*i*wade.c_timeStep/h,z:d.z+g*i*wade.c_timeStep/h})},"_wade_camera")};this.setCameraTarget=function(a,b,c){a?(b=b||0,c=c||{x:0,y:0},this.setMainLoop(function(){if(a.isInScene()){var d=a.getPosition(),e=wade.getCameraPosition();d.x+=c.x;d.y+=c.y;d.z=e.z;if(b){var e={x:d.x*(1-b)+e.x*b,y:d.y*(1-b)+e.y*b,z:d.z*(1-b)+e.z*b},f=e.x-d.x,g=e.y-d.y,h=e.z-d.z;f*f+g*g+h*h>b*b&&(d=e)}wade.setCameraPosition(d)}},"_wade_cameraTarget")):this.setMainLoop(0,
"_wade_cameraTarget")};this.setCameraBounds=function(a,b,c,d,e,f){var g="undefined"==typeof a||null===a,h="undefined"==typeof c||null===c,i="undefined"==typeof e||null===e,k="undefined"==typeof b||null===b,j="undefined"==typeof d||null===d,p="undefined"==typeof f||null===f;g&&h&&i&&k&&j&&p?this.setMainLoop(null,"_wade_cameraBounds"):this.setMainLoop(function(){var n=wade.getCameraPosition();!g&&(n.x=Math.max(a,n.x));!h&&(n.y=Math.max(c,n.y));!i&&(n.z=Math.max(e,n.z));!k&&(n.x=Math.min(b,n.x));!j&&
(n.y=Math.min(d,n.y));!p&&(n.z=Math.min(f,n.z));wade.setCameraPosition(n)},"_wade_cameraBounds",-1)};this.getObjectsInArea=function(a,c){var d=[];b.renderer.addObjectsInAreaToArray(a,d,c);return new SceneObjectGroup(d)};this.getObjectsInScreenArea=function(a){var c=[];b.renderer.addObjectsInScreenAreaToArray(a,c);return new SceneObjectGroup(c)};this.getSpritesInArea=function(a,c,d){var e=[];b.renderer.addSpritesInAreaToArray(a,e,c,d);return e};this.getSpritesInScreenArea=function(a,c){if(!a)var d=
this.getScreenWidth()/2,e=this.getScreenHeight()/2,a={minX:-d,minY:-e,maxX:d,maxY:e};d=[];b.renderer.addSpritesInScreenAreaToArray(a,d,c);return d};this.getSceneObject=function(a){return(a=b.getObjectByName(a))&&a instanceof SceneObject?a:null};this.getSceneObjects=function(a,c){return new SceneObjectGroup(b.getSceneObjects(a,c))};this.getImageData=function(a,b,d,e,f){var g=this.getFullPathAndFileName(a);if(E[g]&&!b&&!d&&!e&&!f)return E[g];var h=c.getImage(g),i;if(h.getContext)i=h.getContext("2d");
else{var k=h,h=document.createElement("canvas");h.width=k.width;h.height=k.height;i=h.getContext("2d");i.drawImage(k,0,0);wade.setImage(a,h)}b=b||0;d=d||0;e=e||h.width;f=f||h.height;a=!b&&!d&&e==h.width&&f==h.height;if(E[g]&&a)return E[g];b=i.getImageData(b,d,e,f);E[g]=a?b:i.getImageData(0,0,h.width,h.height);return b};this.putImageData=function(a,d,e,f,g,h,i,k){var e=e||0,f=f||0,g=g||0,h=h||0,i=i||d.width,k=k||d.height,j=this.getFullPathAndFileName(a),p,n;if("ok"==c.getLoadingStatus(j))if(p=c.getImage(j),
p.getContext)n=p.getContext("2d");else{var l=p;p=document.createElement("canvas");p.width=l.width;p.height=l.height;n=p.getContext("2d");n.drawImage(l,0,0);wade.setImage(a,p)}else p=document.createElement("canvas"),p.width=i,p.height=k,n=p.getContext("2d"),wade.setImage(a,p);n.putImageData(d,g,h,e,f,i,k);E[j]=n.getImageData(0,0,p.width,p.height);b.renderer.updateImageUsers(j)};this.enableMultitouch=function(a){"undefined"==typeof a&&(a=!0);e.enableMultitouch(a)};this.isMultitouchEnabled=function(){return e.isMultitouchEnabled()};
this.getVersion=function(){return"4.0.1"};this.requireVersion=function(a,b,c){for(var d=["4","0","1"],e=a.split("."),f=0;f<e.length;f++){var g=d[f]||0;if(g>e[f])break;else if(g<e[f]){c=c||"A newer version of WADE is required ("+a+")";switch(b){case "alert":alert(c);break;case "console":wade.log(c)}return!1}}return!0};this.getLoadingPercentage=function(){return c.getPercentageComplete()};this.setLoadingBar=function(a,b,c,d){if(a){var a=document.createElement("div"),e=document.createElement("div");a.style.backgroundColor=
c||"red";a.style.borderRadius="13px";a.style.padding="3px";a.style.width="50%";a.style.height="20px";a.style.position="absolute";a.style.left=b?2*b.x+"px":0;a.style.right=0;a.style.top=b?2*b.y+"px":0;a.style.bottom=0;a.style.margin="auto";e.style.backgroundColor=d||"orange";e.style.borderRadius="10px";e.style.height="20px";e.style.width=0;a.appendChild(e);a.id="__wade_loading_bar";w=a;w.inner=e;document.body.appendChild(a)}else w&&document.body.removeChild(w),w=null};this.areGamepadsSupported=function(){return!(!navigator.webkitGetGamepads&&
!navigator.getGamepads)};this.enableGamepads=function(){e.enableGamepads()};this.getImageDataURL=function(a){var b=wade.getImage(a);if(b.toDataURL)return b.toDataURL();(new Sprite(a)).drawToImage(a,!0);return wade.getImage(a).toDataURL()};this.getLayerDataURL=function(a){return this.getLayer(a).toDataURL()};this.log=function(a){console.log(a)};this.warn=function(a){console.warn(a)};this.error=function(a){console.error(a)};this.forceRedraw=function(a){b.setSimulationDirtyState();b.renderer.forceRedraw(a)};
this.forEachPixel=function(a,b,c){for(var d=this.getImageData(a),e=0;e<d.width;e++)for(var f=0;f<d.height;f++){var g=4*(e+f*d.width),h=b(d.data[g],d.data[g+1],d.data[g+2],d.data[g+3],e,f);h&&(d.data[g]=h.r||0,d.data[g+1]=h.g||0,d.data[g+2]=h.b||0,d.data[g+3]=h.a||0)}wade.putImageData(c||a,d)};this.getLayerCanvas=function(a){return wade.getLayer(a||1).getCanvas()};this.drawLayerToImage=function(a,b,c,d,e,f,g){var h=wade.getLayerCanvas(a),i="__wade_layer"+a;wade.draw(a);var k=function(){var k=h;h=this;
wade.setImage(i,h);var j=new Sprite(i),p=1,n=1;if(wade.isSharedCanvas(k)||"2d"==wade.getLayerRenderMode(a))p=wade.getLayerOpacity(a),n=wade.getLayerResolutionFactor(a);1!=p&&j.setDrawFunction(wade.drawFunctions.alpha_(p,j.draw));e||(e={horizontalScale:1/n,verticalScale:1/n,horizontalSkew:0,verticalSkew:0,horizontalTranslate:0,verticalTranslate:0});j.drawToImage(b,c,d,e,f,"2d");g&&setTimeout(g,0)};if("webgl"==wade.getLayerRenderMode(a)){var p=h.toDataURL(),j=new Image;j.onload=k;j.src=p}else k.call(h)};
this.screenCapture=function(a,c){wade.draw();wade.createTransparentImage(a,wade.getScreenWidth(),wade.getScreenHeight());var d=b.renderer.getActiveLayerIds();if(d.length){var e=0,f=0,g=function(b){return function(){k[b].canvas=this;if(++e==f){for(var d in k){var g="__wade_layer_"+d;wade.setImage(g,k[d].canvas);var h=new Sprite(g),i=k[d].opacity;1!=i&&h.setDrawFunction(wade.drawFunctions.alpha_(i,h.draw));i=k[d].resolution;h.drawToImage(a,!1,null,{horizontalScale:1/i,verticalScale:1/i,horizontalSkew:0,
verticalSkew:0,horizontalTranslate:0,verticalTranslate:0},"","2d");wade.unloadImage(g)}c&&setTimeout(c,0)}}},h,i,k={};for(h=0;h<d.length;h++)if(i=wade.getLayerCanvas(d[h]),!k[i.id]){f++;var j=1,p=1;if(wade.isSharedCanvas(i)||"2d"==wade.getLayerRenderMode(d[h]))j=wade.getLayerOpacity(d[h]),p=wade.getLayerResolutionFactor(d[h]);k[i.id]={canvas:i,opacity:j,resolution:p}}for(var n in k)i=k[n].canvas,d=i.toDataURL(),h=new Image,h.onload=g(n),h.src=d}else setTimeout(c,0)};this.setLayerOpacity=function(a,
b){this.getLayer(a).setOpacity(b)};this.getLayerOpacity=function(a){a=parseFloat(this.getLayer(a).getOpacity());return isNaN(a)?1:a};this.getContainerName=function(){return K};this.fadeInLayer=function(a,b,c){var d="__wade_fadeLayer_"+a;wade.setLayerOpacity(a,0);this.setMainLoop(function(){var e=wade.getLayerOpacity(a),e=Math.min(1,e+wade.c_timeStep/b);1-e<wade.c_epsilon&&(e=1);wade.setLayerOpacity(a,e);1==e&&(wade.setMainLoop(null,d),c&&c())},d)};this.fadeOutLayer=function(a,b,c){var d="__wade_fadeLayer_"+
a;wade.setLayerOpacity(a,1);this.setMainLoop(function(){var e=wade.getLayerOpacity(a),e=Math.max(0,e-wade.c_timeStep/b);e<wade.c_epsilon&&(e=0);wade.setLayerOpacity(a,e);0==e&&(wade.setMainLoop(null,d),c&&c())},d)};this.clearCanvas=function(a){this.getLayer(a).clear()};this.draw=function(a){b.draw(a,!0)};this.exportScene=function(a,c,d){d={sceneObjects:b.exportSceneObjects(c,d),paths:b.exportPaths(c)};d.sceneObjectGroups=b.exportSceneObjectGroups(c);d.layers=b.renderer.getLayerSettings(!0);d.minScreenSize=
{x:wade.getMinScreenWidth(),y:wade.getMinScreenHeight()};d.maxScreenSize={x:wade.getMaxScreenWidth(),y:wade.getMaxScreenHeight()};d.orientation=wade.getForcedOrientation();d.windowMode=wade.getWindowMode();d.defaultLayer=wade.defaultLayer||1;return a?JSON.stringify(d):d};this.importScene=function(a,b,c,d,e){L=!0;b&&wade.setLoadingBar(!0,b.position,b.backColor,b.foreColor);var f=a.sceneObjects,g=a.paths,b=a.images||[];if(f)for(var h=0;h<f.length;h++)if(f[h].sprites)for(var i=0;i<f[h].sprites.length;i++)if(f[h].sprites[i].image&&
-1==b.indexOf(f[h].sprites[i].image)&&"procedural_"!=f[h].sprites[i].image.substr(0,11)&&b.push(f[h].sprites[i].image),f[h].sprites[i].animations)for(var k in f[h].sprites[i].animations)if(f[h].sprites[i].animations.hasOwnProperty(k)){var j=f[h].sprites[i].animations[k].image;j&&"procedural_"!=j.substr(0,11)&&-1==b.indexOf(j)&&b.push(j)}var p=0,n=b.length,l=function(){if(++p==n){e&&wade.clearScene();if(a.scripts)for(var b=0;b<a.scripts.length;b++)try{eval.call(window,wade.getScript(a.scripts[b]))}catch(c){wade.error("Unable to execute script "+
a.scripts[b]+" - "+c.message)}a.minScreenSize&&wade.setMinScreenSize(a.minScreenSize.x,a.minScreenSize.y);a.maxScreenSize&&wade.setMaxScreenSize(a.maxScreenSize.x,a.maxScreenSize.y);a.windowMode&&wade.setWindowMode(a.windowMode);a.orientation&&wade.forceOrientation(a.orientation);if(a.layers)for(b=0;b<a.layers.length;b++)if(a.layers[b]){var d="number"!=typeof a.layers[b].scaleFactor?1:a.layers[b].scaleFactor,f="number"!=typeof a.layers[b].translateFactor?1:a.layers[b].translateFactor,h="undefined"!=
typeof a.layers[b].useQuadtree?a.layers[b].useQuadtree:!0,i="number"!=typeof a.layers[b].resolutionFactor?1:a.layers[b].resolutionFactor,k=a.layers[b].blur||0,j=a.layers[b].postProcessShader||"",l=a.layers[b].postProcessShaderUniforms,Q=a.layers[b].properties||{};wade.setLayerRenderMode(b,"2d"==a.layers[b].renderMode?"2d":"webgl",{offScreenTarget:!(!j&&!k)});wade.setLayerTransform(b,d,f);wade.useQuadtree(b,h);wade.setLayerResolutionFactor(b,i);wade.setBlur(b,k);wade.setPostProcessShader(b,j,l);wade.setLayerCustomProperties(b,
Q)}a.defaultLayer&&(wade.defaultLayer=a.defaultLayer);if(g)for(b=0;b<g.length;b++)d=new Path(g[b]),wade.addPath(d);a.modules&&a.modules.iso?wade.iso.importScene(a.modules.iso,r):r()}},r=function(){if(f){var b={};for(h=0;h<f.length;h++){var c=new SceneObject(f[h]);if(a.loadGlTextures)for(i=0;i<c.getSpriteCount();i++){var d=c.getSprite(i),e=d.getLayerId();if("webgl"==wade.getLayerRenderMode(e)){b[e]=b[e]||[];for(var d=d.getAllImageNames(),g=0;g<d.length;g++)-1==b[e].indexOf(d[g])&&b[e].push(d[g])}}}for(var k in b){c=
wade.getLayer(k).getContext();for(h=0;h<b[k].length;h++)c.setTextureImage(wade.getImage(b[k][h]),!0)}}if(a.sceneObjectGroups)for(h=0;h<a.sceneObjectGroups.length;h++)b=new SceneObjectGroup(a.sceneObjectGroups[h]),wade.addSceneObjectGroup(b);if(a.modules)if(b=Object.keys(a.modules),!b.length||1==b.length&&a.modules.iso)t();else{var b=function(){++p==n&&t()},j;for(j in a.modules)"iso"!=j&&a.modules.hasOwnProperty(j)&&(wade[j]&&wade[j].importScene?(n++,wade[j].importScene(a.modules[j],b)):(wade.error("The scene being imported contains data for module "+
j+", but the module isn't available or not up to date"),n++,setTimeout(b,0)))}else t()},t=function(){setTimeout(function(){L=!1;a.timeline&&wade.startTimeline(a.timeline);a.flowChart&&wade.runFlowChart(a.flowChart);c&&c()},0)},m=function(a){return function(){wade.error(a);l()}},w=d?"pre":"";if(a.json){var n=n+a.json.length,y={};a.json.forEach(function(a){if("object"==typeof a)var b=a.resource,c=a.target;else b=a;a=b+"___"+c;y[a]?n--:(wade[w+"loadJson"](b,null,function(a){c&&(wade.app[c]=wade.isArray(a)?
wade.cloneArray(a):wade.cloneObject(a));l()},!1,m("Failed to load JSON file "+b)),y[a]=!0)})}if(a.text){var n=n+a.text.length,q={};a.text.forEach(function(a){if("object"==typeof a)var b=a.resource,c=a.target;else b=a;a=b+"___"+c;q[a]?n--:(wade[w+"loadText"](b,null,function(a){c&&(wade.app[c]=a);l()},!1,m("Failed to load text file "+b)),q[a]=!0)})}if(a.audio&&(!a.webAudioOnly||wade.isWebAudioSupported())){n+=a.audio.length;for(h=0;h<a.audio.length;h++)if(a.audio.indexOf(a.audio[h])==h)wade[w+"loadAudio"](a.audio[h],
!1,!1,l,m("Failed to load audio file "+a.audio[h]));else n--}if(a.fonts){n+=a.fonts.length;for(h=0;h<a.fonts.length;h++)if(a.fonts.indexOf(a.fonts[h])==h)wade[w+"loadFont"](a.fonts[h],l,m("Failed to load font file "+a.fonts[h]));else n--}if(a.scripts){n+=a.scripts.length;for(h=0;h<a.scripts.length;h++)if(a.scripts.indexOf(a.scripts[h])==h)wade[w+"loadScript"](a.scripts[h],l,!1,m("Failed to load script file "+a.scripts[h]),!0);else n--}if(b.length)for(h=0;h<b.length;h++)if(b.indexOf(b[h])==h)wade[w+
"loadImage"](b[h],l,m("Failed to load image file "+b[h]));else n--;n||(n=1,l())};this.loadScene=function(a,b,c,d){wade.loadJson(a,null,function(a){wade.importScene(a,b,c,!1,d)})};this.preloadScene=function(a,b,c,d){wade.preloadJson(a,null,function(a){wade.importScene(a,b,c,!0,d)})};this.useQuadtree=function(a,b){"undefined"==typeof b&&(b=!0);this.getLayer(a).useQuadtree(b)};this.isUsingQuadtree=function(a){return this.getLayer(a).isUsingQuadtree()};this.pauseSimulation=function(a){if(a)for(var b=
0;b<m.length;b++){if(m[b].name==a){m[b].paused=!0;break}}else y=!0};this.resumeSimulation=function(a){var b;if(a)for(b=0;b<m.length;b++){if(m[b].name==a){m[b].paused=!1;break}}else{for(b=0;b<m.length;b++)m[b].paused=!1;y=!1}};this.setCatchUpBuffer=function(a){N=a};this.getCatchUpBuffer=function(){return N};this.preventIframe=function(){if(!window.location||!window.top.location||!location||!top.location||window.location!==window.top.location||location!==top.location)wade=0};this.siteLock=function(a){var b=
"localhost";try{b=top.location.hostname}catch(c){try{b=this.getHostName(top.location.origin)}catch(d){try{b=this.getHostName(top.location.href)}catch(e){}}}b=b.toLowerCase();b!=a.toLowerCase()&&("localhost"!=b&&"127.0.0.1"!=b)&&(wade=0)};this.getHostName=function(a){var b=URL||webkitURL;try{a=(new b(a)).hostname}catch(c){b=a.indexOf("//"),-1!=b&&(a=a.substr(b+2)),b=a.indexOf("/"),-1!=b&&(a=a.substr(0,b)),b=a.indexOf(":"),-1!=b&&(a=a.substr(0,b)),b=a.indexOf("?"),-1!=b&&(a=a.substr(0,b))}return a};
this.whitelistReferrers=function(a){var b=document.referrer;if(b){var b=this.getHostName(b),c;if("string"==typeof a)c=[a.toLowerCase()];else if(wade.isArray(a)){c=[];for(var d=0;d<a.length;d++)c.push(a[d].toLowerCase())}else return;b&&-1==c.indexOf(b.toLowerCase())&&(wade=0)}};this.blacklistReferrers=function(a){var b=document.referrer;if(b&&(b=this.getHostName(b))){var c;if("string"==typeof a)c=[a.toLowerCase()];else if(wade.isArray(a)){c=[];for(var d=0;d<a.length;d++)c.push(a[d].toLowerCase())}else return;
b&&-1!=c.indexOf(b.toLowerCase())&&(wade=0)}};this.removeLayer=function(a){b.renderer.removeLayer(a)};this.removeUnusedLayers=function(a){b.renderer.removeUnusedLayers(a)};this.setLayer3DTransform=function(a,b,c,d,e){this.getLayer(a).set3DTransform(b||"translate3d(0, 0, 0)",c||"50% 50%",d,e)};this.skipMissedFrames=function(){q=(new Date).getTime()};this.getSceneObjectIndex=function(a){return b.getSceneObjectIndex(a)};this.setSceneObjectIndex=function(a,c){return b.setSceneObjectIndex(a,c)};this.setSwipeTolerance=
function(a,b){e.setSwipeTolerance(a,b||3)};this.setLayerRenderMode=function(a,b,c){this.getLayer(a,b).setRenderMode(b,c)};this.getLayerRenderMode=function(a){return this.getLayer(a).getRenderMode()};this.isWebGlSupported=function(){if("undefined"!=typeof F)return!!F;try{var a=document.createElement("canvas"),b=a.getContext("webgl",{failIfMajorPerformanceCaveat:!A})||a.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!A})}catch(c){return F=!1}return F=!!b};this.isDebugMode=function(){return!!G};
this.getWebAudioContext=function(){return s};this.getActiveLayerIds=function(){return b.renderer.getActiveLayerIds()};this.hashString=function(a){var b,c,d,e=0;if(!a.length)return e;b=0;for(d=a.length;b<d;b++)c=a.charCodeAt(b),e=(e<<5)-e+c,e|=0;return e};this.createPseudoArray=function(a,b){for(var c=[],d={isPseudoArray:!0},e=0;e<a;e++)(function(a){Object.defineProperty(d,a.toString(),{enumerable:!0,set:function(d){var e=a>=c.length;c[a]=d;b(a,d,e)},get:function(){return c[a]}})})(e);Object.defineProperty(d,
"length",{enumerable:!0,set:function(a){for(var d=c.length-1;d>=a;d--)b(d);c.length=a},get:function(){return c.length}});d.push=function(){for(var a=0;a<arguments.length;a++){var d=c.push(arguments[a])-1;b(d,arguments[a],!0)}};return d};this.autoLoadImages=function(a){"undefined"==typeof a&&(a=!0);B=a};this.isAutoLoadingImages=function(){return B};this.addPath=function(a){b.addPath(a)};this.removePath=function(a){b.removePath("string"==typeof a?this.getPath(a):a)};this.getPaths=function(a,c){return b.getPaths(a,
c)};this.getPath=function(a){return(a=b.getObjectByName(a))&&a instanceof Path?a:null};this.getObjectByName=function(a){return b.getObjectByName(a)};this.addSceneObjectGroup=function(a){b.addSceneObjectGroup(a)};this.removeSceneObjectGroup=function(a){b.removeSceneObjectGroup("string"==typeof a?this.getSceneObjectGroup(a):a)};this.getSceneObjectGroup=function(a){return(a=b.getObjectByName(a))&&wade.isArray(a)&&a.getGroupCenter?a:null};this.getSceneObjectGroups=function(a){return b.getSceneObjectGroups(a)};
this.getKeyName=function(a){return e.getKeyName(a)};this.getKeyCode=function(a){return e.getKeyCode(a)};this.isArray=function(a){return Array.isArray(a)};this.ajax=function(a){var a=a||{},b=a.type||"GET",c=a.url;if(c){"undefined"!=typeof a.cache&&!a.cache&&(c+=/\?/.test(c)?"&":"?"+(new Date).getTime());var d=function(){a.error&&a.error(this.responseText)},e=new XMLHttpRequest;e.addEventListener("load",function(){var b=this.responseText;if(a.dataType)switch(a.dataType){case "json":try{b=JSON.parse(b)}catch(c){wade.error("Failed to load JSON data from "+
a.url+" : "+c);a.error&&a.error(b);return}}a.success&&a.success(b)});e.addEventListener("error",d);e.open(b,c);a.timeout&&(e.addEventListener("timeout",d),e.timeout=a.timeout);a.contentType&&e.setRequestHeader("Content-type",a.contentType);e.send(a.data||null)}else wade.error("Invalid ajax request - url was not specified")};this.startTimeline=function(b,c,d){b.events||(b.events=[]);c=c||0;d||(d=this.timelineUid=this.timelineUid+1||1,d="__wade_timeline_"+d,n[d]={timeline:b,time:c,active:!0});var e=
"clock"==b.referenceTime?this.getClockTime()/1E3:this.getAppTime(),f=function(){var f=("clock"==b.referenceTime?a.getClockTime()/1E3:a.getAppTime())-e+c;n[d].time=f;for(var h=0,g=0;g<b.events.length;g++)if(!b.events[g].processed&&b.events[g].code&&(h++,f>=b.events[g].time)){b.events[g].processed=!0;var i="(function(){"+b.events[g].code+"})()";if(G){var k=t.length;t.push({time:b.events[g].time,code:b.events[g].code});i+="\n//# sourceURL=timeline_event_"+k+"_"+b.events[g].time+"s.js"}eval.call(window,
i)}h||a.setMainLoop(null,d)};this.setMainLoop(f,d);f();return d};this.stopTimeline=function(a){n[a]&&(n[a].active=!1);this.setMainLoop(null,a)};this.resumeTimeline=function(a){n[a].active=!0;this.startTimeline(n[a].timeline,n[a].time,a)};this.getProcessedTimelineEvent=function(a){return!G?(wade.error("Cannot call wade.getProcessedTimelineEvent when not in debug mode"),{time:0,code:""}):t[a||0]};this.clearTimelines=function(){for(var a in n)this.stopTimeline(a);n={}};this.createTransparentImage=function(a,
b,c){var d=new Sprite;d.setDrawFunction(wade.doNothing);d.setSize(b,c);d.drawToImage(a,!0,null,null,"","2d")};this.getTimelines=function(){return n};this.setPostProcessShader=function(a,b,c){this.getLayer(a).setPostProcessShader(b,c)};this.getPostProcessShader=function(a){return this.getLayer(a).getPostProcessShader()};this.getPostProcessShaderUniforms=function(a){return this.getLayer(a).getPostProcessShaderUniforms()};this.setLayerCustomProperty=function(a,b,c){this.getLayer(a).setCustomProperty(b,
c)};this.setLayerCustomProperties=function(a,b){this.getLayer(a).setCustomProperties(b)};this.getLayerCustomProperty=function(a,b){return this.getLayer(a).getCustomProperty(b)};this.getLayerCustomProperties=function(a){return this.getLayer(a).getCustomProperties()};this.setTimeout=function(b,c){if("function"==typeof c&&"number"==typeof b)var d=c,c=b,b=d;D.push({f:b,time:1E3*a.getAppTime()+c,uid:++J});return J};this.setInterval=function(b,c){if("function"==typeof c&&"number"==typeof b)var d=c,c=b,
b=d;D.push({f:b,time:1E3*a.getAppTime()+c,repeat:c,uid:++J});return J};this.clearTimeout=function(a){for(var b=0;b<D.length;b++)if(D[b].uid==a&&!D[b].repeat)return wade.removeObjectFromArrayByIndex(b,D),!0;return!1};this.clearInterval=function(a){for(var b=0;b<D[b];b++)if(D[b].uid==a&&D[b].repeat)return wade.removeObjectFromArrayByIndex(b,D),!0;return!1};this.clearAllTimeoutsAndIntervals=function(){var a=D.length;D.length=0;return!!a};this.runFlowChart=function(a,b,c,d,e){"undefined"==typeof c&&(c=
!0);var d=d||0,f={visitedNodes:[],startTime:wade.getAppTime(),flowChartData:wade.cloneObject(a)},g=function(a){e&&e.isInScene&&!e.isInScene()||f.cancelled?(f.running=!1,e&&delete e.next):(a.func||(a.func=k(a)),f.visitedNodes.push(a.uid),e&&(e.next=h),a.func.call(e||i))},h=function(a){var b=f.currentNode.children&&f.currentNode.children[Object.keys(f.currentNode.children)[0]],a="undefined"==typeof a?b:f.currentNode.children&&f.currentNode.children[a];f.currentNode=(a||"number"==typeof a)&&j[a];f.currentNode?
wade.setTimeout(function(){g(f.currentNode)},d||0):(f.currentNode=null,f.running=!1,a={flowChartData:f.flowChartData},e&&e.process("onFlowChartEnd",a),wade.app.onFlowChartEnd&&wade.app.onFlowChartEnd(a))},i={next:h},k=function(a){var b=a.code;a.func=b?eval.call(window,"(function(){"+b+"})"):wade.doNothing},j=f.flowChartData.boxes,n;for(n in j)if(j.hasOwnProperty(n)&&(c&&k(j[n]),!f.currentNode)){if(!b&&(j[n].startNode&&"number"!=typeof b)&&(f.currentNode=j[n],!c))break;if((b||"number"==typeof b)&&
(j[n].title==b||n==b))if(f.currentNode=j[n],!c)break}f.currentNode=f.currentNode||j[Object.keys(j)[0]];if(!f.currentNode)return wade.warn("Unable to run flow chart - no start node was found"),null;f.running=!0;g(f.currentNode);e&&(e.flowChartStatus=f);return f};this.mergeGlLayers=function(a){"undefined"==typeof a&&(a=!0);if(!!a!==!!M){M=!!a;for(var a=this.getAllLayers(),b=0;b<a.length;b++)"webgl"==a[b].getRenderMode()&&(a[b].removeCanvas(),a[b].initCanvas())}};this.areGlLayersMerged=function(){return M};
this.findPath=function(a){var b={x:a.start.x,y:a.start.y},c=a.target.x,d=a.target.y,e=a.collisionMap,f=a.boundaries||{minX:0,minY:0,maxX:e[0].length-1,maxY:e[0][0].length-1},g=a.heightMap,h=a.movementOffsets||I.straight;"string"==typeof h&&(h=I[h]);var i=a.maxPathLength||0,k=a.maxStepHeight,j="undefined"!=typeof k,n,p=[],l=[b];b.gScore=0;b.hScore=Math.abs(b.x-c)+Math.abs(b.y-d);for(b.fScore=b.hScore;l.length;){for(var r=l[0].fScore,t=l[0],m=0,a=1;a<l.length;a++){n=l[a];var w=n.fScore;w<r&&(t=n,r=
w,m=a)}if(t.x==c&&t.y==d){c=[];for(a=t;a.cameFrom;)c.push(a),a=a.cameFrom;c.push(b);b=[];for(a=0;a<c.length;a++)b.push(c[c.length-1-a]);return b}wade.removeObjectFromArrayByIndex(m,l);p.push(t);if(!(i&&t.gScore>=i)){r=g&&g[t.x]&&g[t.x][t.y]||0;for(a=0;a<h.length;a++)if(m=h[a],m={x:t.x+m.x,y:t.y+m.y},!(m.x<f.minX||m.y<f.minY||m.x>f.maxX||m.y>f.maxY))if(!(j&&Math.abs((g[m.x]&&g[m.x][m.y]||0)-r)>k)&&(!e[m.x]||!e[m.x][m.y])){w=!1;for(n=0;n<p.length;n++){var y=p[n];if(y.x==m.x&&y.y==m.y){w=!0;break}}if(!w){w=
t.gScore+1;y=!1;for(n=0;n<l.length;n++){var q=l[n];if(q.x==m.x&&q.y==m.y){y=!0;m=q;break}}n=!1;y?w<m.gScore&&(n=!0):(l.push(m),m.hScore=Math.abs(m.x-c)+Math.abs(m.y-d),n=!0);n&&(m.cameFrom=t,m.gScore=w,m.fScore=m.gScore+m.hScore)}}}}return[]};this.enableBatching=function(a,c){"undefined"==typeof c&&(c=!0);if("undefined"==typeof a||null===a)for(var d=b.renderer.getActiveLayerIds(),e=0;e<d.length;e++)this.getLayer(d[e]).enableBatching(c);else this.getLayer(a).enableBatching(c)};this.isBatchingEnabled=
function(a){return this.getLayer(a).isBatchingEnabled()};this.setBlur=function(a,c,d){c=c||0;if("undefined"==typeof a||null===a)for(var a=b.renderer.getActiveLayerIds(),e=0;e<a.length;e++)d?H[a[e]]={startValue:this.getLayer(a[e]).getBlur(),endValue:c,time:d,startTime:this.getAppTime()}:(this.getLayer(a[e]).setBlur(c),delete H[a[e]]);else d?H[a]={startValue:this.getLayer(a).getBlur(),endValue:c,time:d,startTime:this.getAppTime()}:(this.getLayer(a).setBlur(c),delete H[a])};this.getBlur=function(a){return this.getLayer(a).getBlur()};
this.alwaysUpdateBlur=function(a,c){"undefined"==typeof c&&(c=!0);if("undefined"==typeof a||null===a)for(var d=b.renderer.getActiveLayerIds(),e=0;e<d.length;e++)this.getLayer(d[e]).alwaysUpdateBlur(!!c);else this.getLayer(a).alwaysUpdateBlur(!!c)};this.getPathIndex=function(a){return b.getPathIndex(a)};this.setPathIndex=function(a,c){return b.setPathIndex(a,c)};this.doNothing=function(){};this.isImportingScene=function(){return!!L};this.getAudio=function(a){a=this.getFullPathAndFileName(a);return c.getAudio(a)};
this.playSilentSound=function(){if(s){var a=s.createOscillator();a.frequency.value=440;var b=s.createGain();b.gain.value=0;a.connect(b);b.connect(s.destination);a.start?a.start(0):a.noteOn(0);a.stop?a.stop(0.001):a.noteOff(0.001)}else{a=new Audio;a.src="data:audio/wav;base64,UklGRjoAAABXQVZFZm10IBAAAAABAAEA6AcAANAPAAACABAAZGF0YQYAAAAAAAAAAAA%3D";try{a.play()}catch(c){}}};this.event_mainLoopCallback_=function(){return function(){a.event_mainLoop()}};this.event_mainLoop=function(){var d,e;f=requestAnimationFrame(this.event_mainLoopCallback_());
if(!L)if(c.isFinishedLoading()){for(d=0;d<l.length;d++)"none"!=l[d].style.display&&(l[d].style.display="none");w&&"none"!=w.style.display&&(w.style.display="none");if(i){d=a.getAppTime();for(var g in H)e=(d-H[g].startTime)/H[g].time,1<=e?(a.getLayer(g).setBlur(H[g].endValue),delete H[g]):a.getLayer(g).setBlur(H[g].startValue*(1-e)+H[g].endValue*e);b.draw();d=(new Date).getTime();g=0;e=Math.round((d-q)/(1E3*wade.c_timeStep));q?g=Math.min(3,e):q=d;g&&(e>N/wade.c_timeStep?(g=1,q=d):q+=1E3*g*wade.c_timeStep);
for(d=0;d<g&&!y;d++){b.step();var k=1E3*a.getAppTime();for(e=D.length-1;0<=e;e--)if(k>=D[e].time){var j=D[e];j.repeat?j.time+=j.repeat:a.removeObjectFromArrayByIndex(e,D);j.f()}for(e=0;e<m.length;e++)m[e].paused||(k=m[e].func)&&k()}y&&b.setSimulationDirtyState()}else h&&this.initializeApp()}else{q=(new Date).getTime();for(d=0;d<l.length;d++)l[d].src&&(l[d].style.display="inline");w&&(w.inner.style.width=this.getLoadingPercentage()+"%")}};this.event_appTimerEvent=function(){g=setTimeout("wade.event_appTimerEvent();",
1E3*j);b.appTimerEvent()};this.onObjectNameChange=function(a,c){a.isInScene()&&b.changeObjectName(a,c)};this.onObjectGroupNameChange=function(a,c){b.changeObjectName(a,c)};this.getLayer=function(a,c){return b.renderer.getLayer(a,c)};this.getAllLayers=function(){return b.renderer.getAllLayers()};this.isSharedCanvas=function(a){for(var b=this.getAllLayers(),c=0,d=0;d<b.length;d++)if(b[d].getCanvas()==a&&2==++c)return!0;return!1};this.updateMouseInOut=function(a,c){b.updateMouseInOut(a,c)};this.addImageUser=
function(a,c){b.renderer.addImageUser(a,c)};this.removeImageUser=function(a,c){b.renderer.removeImageUser(a,c)};this.removeAllImageUsers=function(a){b.renderer.removeAllImageUsers(a)};this.getInternalContext=function(){return z};this.getImageUsers=function(a){return b.renderer.getImageUsers(a)};this.releaseImageReference=function(a){c.releaseImageReference(this.getFullPathAndFileName(a))};this.extend=function(){var a,b,c,d,e,f=arguments[0]||{},g=1,h=arguments.length,i=!1;"boolean"===typeof f&&(i=
f,f=arguments[g]||{},g++);"object"!==typeof f&&"function"!==typeof f&&(f={});g===h&&(f=this,g--);for(;g<h;g++)if(null!=(a=arguments[g]))for(b in a)c=f[b],d=a[b],f!==d&&(i&&d&&(wade.isPlainObject(d)||(e=wade.isArray(d)))?(e?(e=!1,c=c&&wade.isArray(c)?c:[]):c=c&&wade.isPlainObject(c)?c:{},f[b]=wade.extend(i,c,d)):void 0!==d&&(f[b]=d));return f};this.isPlainObject=function(a){if(!a)return!1;try{if("[object Object]"!==toString.call(a))return!1}catch(b){try{if("[object Object]"!==Object.prototype.toString.call(a))return!1}catch(c){}}a=
Object.getPrototypeOf(a);if(!a)return!0;a=Object.hasOwnProperty.call(a,"constructor")&&a.constructor;return"function"===typeof a&&O.call(a)===P};this.texImage2D=function(a,b){var c=b.width,d=b.height,e=!(c&c-1||d&d-1);b.image?a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b.image):a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,d,0,a.RGBA,a.UNSIGNED_BYTE,null);e?(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST),
a.generateMipmap(a.TEXTURE_2D)):(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE))};this.isUsingGlobalUnderscore=function(){return C};this.shaderErrorLog=this.log;this.shaderSuccessLog=this.doNothing;this.deprecate=function(b,c){this[b]=function(){a.warn("wade."+b+" is deprecated. Please use wade."+c+" instead");
return a[c].apply(a,arguments)}};window.console||(window.console={});window.console.log||(window.console.log=this.doNothing);window.console.warn||(window.console.warn=window.console.log);window.console.error||(window.console.error=window.console.warn);this.deprecate("playAudioSegmentIfAvailable","playAudioSegment");this.deprecate("playAudioIfAvailable","playAudio");this.deprecate("setMainLoopCallback","setMainLoop")}wade=new Wade;
function Wade_drawFunctions(){this.gradientFill_=function(a,b){return function(c){if(this._visible)if(c.isWebGl)wade.error("wade.drawFunctions.gradientFill_ is not available in webgl mode");else{var d=!this._gradient||this._gradient.colors!=b||this._gradient.direction!=a||this._gradient.size.x!=this._size.x||this._gradient.size.y!=this._size.y||this._gradient.position.x!=this._position.x||this._gradient.position.y!=this._position.y,e=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5;if(d&&
2<=b.length){this._gradient={colors:b,direction:a,size:{x:this._size.x,y:this._size.y},position:{x:this._position.x,y:this._position.y}};this._gradient.gradient=c.createLinearGradient((this._position.x-this._size.x/2+e)*a.x,(this._position.y-this._size.y/2+e)*a.y,(this._position.x+this._size.x/2-e)*a.x,(this._position.y+this._size.y/2-e)*a.y);for(d=0;d<b.length;d++)this._gradient.gradient.addColorStop(d/(b.length-1),b[d])}this._gradient&&this._gradient.gradient?(c.save(),this._rotation&&(c.translate(this._position.x,
this._position.y),c.rotate(this._rotation),c.translate(-this._position.x,-this._position.y)),c.fillStyle=this._gradient.gradient,c.fillRect(this._position.x-this._size.x/2+e,this._position.y-this._size.y/2+e,this._size.x-e,this._size.y-e),c.restore()):wade.warn("Warning: attempting to draw a sprite with an invalid linear gradient")}}};this.solidFill_=function(a){return function(b){if(this._visible)if(b.isWebGl)wade.error("wade.drawFunctions.solidFill_ is not available in webgl mode");else{this._rotation&&
(b.save(),b.translate(this._position.x,this._position.y),b.rotate(this._rotation),b.translate(-this._position.x,-this._position.y));var c=b.fillStyle;this._layer&&wade.screenUnitToWorld(this._layer.id);b.fillStyle=a;b.fillRect(this._position.x-this._size.x/2,this._position.y-this._size.y/2,this._size.x,this._size.y);b.fillStyle=c;this._rotation&&b.restore()}}};this.solidFillInt_=function(a){return function(b){if(this._visible)if(b.isWebGl)wade.error("wade.drawFunctions.solidFillInt_ is not available in webgl mode");
else{this._rotation&&(b.save(),b.translate(this._position.x,this._position.y),b.rotate(this._rotation),b.translate(-this._position.x,-this._position.y));var c=b.fillStyle,d=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5;b.fillStyle=a;b.fillRect(Math.floor(this._position.x-this._size.x/2+d),Math.floor(this._position.y-this._size.y/2+d),Math.floor(this._size.x-d),Math.floor(this._size.y-d));b.fillStyle=c;this._rotation&&b.restore()}}};this.drawRect_=function(a,b){return function(c){if(this._visible)if(c.isWebGl)wade.error("wade.drawFunctions.drawRect_ is not available in webgl mode");
else{this._rotation&&(c.save(),c.translate(this._position.x,this._position.y),c.rotate(this._rotation),c.translate(-this._position.x,-this._position.y));var d=c.fillStyle,e=c.lineWidth,f=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5;c.strokeStyle=a;c.lineWidth=b;c.strokeRect(this._position.x-this._size.x/2+b+f,this._position.y-this._size.y/2+b+f,this._size.x-2*b-f,this._size.y-2*b-f);c.fillStyle=d;c.lineWidth=e;this._rotation&&c.restore()}}};this.radialGradientCircle_=function(a,b){b=
b||"rgba(0, 0, 0, 0)";return function(c){if(this._visible)if(c.isWebGl)wade.error("wade.drawFunctions.radialGradientCircle_ is not available in webgl mode");else{var d=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5,e=Math.min(this._size.x,this._size.y)/2-d;if(!this._gradient||this._gradient.colors!=a||this._gradient.minRadius!=e||this._gradient.position.x!=this._position.x||this._gradient.position.y!=this._position.y){this._gradient={colors:a,minRadius:e,position:{x:this._position.x,y:this._position.y}};
this._gradient.gradient=c.createRadialGradient(this._position.x,this._position.y,0,this._position.x,this._position.y,e);for(e=0;e<a.length;e++)this._gradient.gradient.addColorStop(e/a.length,a[e]);this._gradient.gradient.addColorStop(1,b)}c.save();this._rotation&&(c.translate(this._position.x,this._position.y),c.rotate(this._rotation),c.translate(-this._position.x,-this._position.y));c.fillStyle=this._gradient.gradient;c.fillRect(this._position.x-this._size.x/2+d,this._position.y-this._size.y/2+d,
this._size.x-d,this._size.y-d);c.restore()}}};this.solidFade_=function(a,b,c,d,e,f,g,i,h,k){var j=0;return function(l){if(this._visible)if(l.isWebGl)wade.error("wade.drawFunctions.solidFade_ is not available in webgl mode");else{if(!this._animations.__fade){var m=new Animation("",1,1,1,!0);this.addAnimation("__fade",m)}this.playAnimation("__fade");var m=l.fillStyle,q=j/h,u=Math.floor(a*(1-q)+e*q),x=Math.floor(b*(1-q)+f*q),p=Math.floor(c*(1-q)+g*q),q=d*(1-q)+i*q;this._rotation&&(l.save(),l.translate(this._position.x,
this._position.y),l.rotate(this._rotation),l.translate(-this._position.x,-this._position.y));l.fillStyle="rgba("+u+","+x+","+p+","+q+")";u=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5;l.fillRect(this._position.x-this._size.x/2+u,this._position.y-this._size.y/2+u,this._size.x-u,this._size.y-u);l.fillStyle=m;this._rotation&&l.restore();j<h&&(j++,j==h&&k&&k())}}};this.grid_=function(a,b,c,d){return function(e){if(this._visible)if(e.isWebGl)wade.error("wade.drawFunctions.grid_ is not available in webgl mode");
else{d=d||1;e.save();e.lineWidth=d;e.strokeStyle=c;e.lineJoin="round";e.lineCap="round";this._rotation&&(e.translate(this._position.x,this._position.y),e.rotate(this._rotation),e.translate(-this._position.x,-this._position.y));for(var f=(this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5)*d,g=(this._size.x-2*f)/a,i=(this._size.y-2*f)/b,h=this._position.x-this._size.x/2+f,k=this._position.y-this._size.y/2+f,j=this._position.x+this._size.x/2-f,f=this._position.y+this._size.y/2-f,l=h,m=k,q=0;q<=
b;q++)e.beginPath(),e.moveTo(h,m),e.lineTo(j,m),e.stroke(),m+=i;for(i=0;i<=a;i++)e.beginPath(),e.moveTo(l,k),e.lineTo(l,f),e.stroke(),l+=g;e.restore()}}};this.alpha_=function(a,b){var b=b||Sprite.prototype.draw,c=function(c){if(this._visible){var e=c.globalAlpha;c.globalAlpha=a;b.call(this,c);c.globalAlpha=e}};b.batched&&(c.batched=function(c,e){var f=c.globalAlpha;this._f32RotationAlpha[1]=c.globalAlpha=a;b.batched.call(this,c,e);c.globalAlpha=f});return c};this.blink_=function(a,b,c){var d=1,e=
a;return function(f){if(this._visible){if(0>(e-=wade.c_timeStep))e=d?b:a,d=!d;d&&c.call(this,f);this.setDirtyArea()}}};this.additive_=function(a){a=a||Sprite.prototype.draw;return function(b){var c=b.globalCompositeOperation;b.globalCompositeOperation="lighter";a.call(this,b);b.globalCompositeOperation=c}};this.fadeOpacity_=function(a,b,c,d,e){var f=(b-a)*wade.c_timeStep/c,g=a,d=d||Sprite.prototype.draw,i=function(c){if(this._visible){var k=g;g=Math[b>a?"min":"max"](b,g+f);var j=c.globalAlpha;c.globalAlpha=
g;d.call(this,c);c.globalAlpha=j;g==b&&(1==g||0==g)?this.getDrawFunction()==i&&this.setDrawFunction(d):g!=k&&this.setDirtyArea();g==b&&(e&&e(),e=null)}};d.batched&&(i.batched=function(c,k){var j=g;g=Math[b>a?"min":"max"](b,g+f);var l=c.globalAlpha;this._f32RotationAlpha[1]=c.globalAlpha=g;d.batched.call(this,c,k);c.globalAlpha=l;g==b&&(1==g||0==g)?this.getDrawFunction()==i&&this.setDrawFunction(d):g!=j&&this.setDirtyArea();g==b&&(e&&e(),e=null)});return i};this.resizeOverTime_=function(a,b,c,d,e,
f,g){var i=(c-a)*wade.c_timeStep/e,h=a,k=(d-b)*wade.c_timeStep/e,j=b,f=f||Sprite.prototype.draw,l=function(e){this._visible&&(h=Math[c>a?"min":"max"](c,h+i),j=Math[d>b?"min":"max"](d,j+k),this.setSize(h,j),f.call(this,e),h==c&&j==d&&(l==this.getDrawFunction()&&this.setDrawFunction(f),g&&g(),g=null))};return l};this.resizePeriodically_=function(a,b,c,d,e,f){var g=1,i=(c-a)*wade.c_timeStep/e,h=a,k=(d-b)*wade.c_timeStep/e,j=b,f=f||Sprite.prototype.draw;return function(e){if(this._visible){var m=1==g?
c:a,q=1==g?b:d,u=1==g?d:b;h=Math[m>(1==g?a:c)?"min":"max"](m,h+i*g);j=Math[u>q?"min":"max"](u,j+k*g);this.setSize(h,j);f.call(this,e);h==m&&j==u&&(g*=-1)}}};this.mirror_=function(a){var a=a||Sprite.prototype.draw,b=function(b){b.isWebGl?(this._f32AnimFrameInfo[2]*=-1,this._animations&&this._animations[this._currentAnimation].mirror()):b.scale(-1,1);var d=this._position.x,e=this._cornerX;this._position.x*=-1;this._cornerX=this._position.x-this._size.x/2;a.call(this,b);this._position.x=d;this._cornerX=
e;b.isWebGl?(this._f32AnimFrameInfo[2]*=-1,this._animations&&this._animations[this._currentAnimation].mirror()):b.scale(-1,1)};a.batched&&(b.batched=function(b,d){this._f32AnimFrameInfo[2]*=-1;this._animations&&this._animations[this._currentAnimation].mirror();a.batched.call(this,b,d);this._f32AnimFrameInfo[2]*=-1;this._animations&&this._animations[this._currentAnimation].mirror()});return b};this.flip_=function(a){var a=a||Sprite.prototype.draw,b=function(b){b.isWebGl?(this._f32AnimFrameInfo[3]*=
-1,this._animations&&this._animations[this._currentAnimation].flip()):b.scale(1,-1);var d=this._position.y,e=this._cornerY;this._position.y*=-1;this._cornerY=this._position.y-this._size.y/2;a.call(this,b);this._position.y=d;this._cornerY=e;b.isWebGl?(this._f32AnimFrameInfo[3]*=-1,this._animations&&this._animations[this._currentAnimation].flip()):b.scale(1,-1)};a.batched&&(b.batched=function(b,d){this._f32AnimFrameInfo[3]*=-1;this._animations&&this._animations[this._currentAnimation].flip();a.batched.call(this,
b,d);this._f32AnimFrameInfo[3]*=-1;this._animations&&this._animations[this._currentAnimation].flip()});return b};this.composite_=function(a,b){b=b||Sprite.prototype.draw;return function(c){if(a!=c.globalCompositeOperation){var d=c.globalCompositeOperation;c.globalCompositeOperation=a;b.call(this,c);c.globalCompositeOperation=d}else b.call(this,c)}};this.boundingBox_=function(a,b,c){a=a||"red";b=b||"blue";c=c||Sprite.prototype.draw;return function(d){if(this._visible)if(d.isWebGl)wade.error("wade.drawFunctions.boundingBox_ is not available in webgl mode");
else{d.save();d.lineWidth=1;var e=this._layer?0.5*wade.screenUnitToWorld(this._layer.id):0.5;if(this._rotation){d.strokeStyle=b;d.lineJoin="round";d.lineCap="round";d.beginPath();var f=-this.orientedBoundingBox.axisXx-this.orientedBoundingBox.axisYx,g=-this.orientedBoundingBox.axisXx+this.orientedBoundingBox.axisYx,i=this.orientedBoundingBox.axisXx+this.orientedBoundingBox.axisYx,h=this.orientedBoundingBox.axisXx-this.orientedBoundingBox.axisYx,k=-this.orientedBoundingBox.axisXy-this.orientedBoundingBox.axisYy,
j=-this.orientedBoundingBox.axisXy+this.orientedBoundingBox.axisYy,l=this.orientedBoundingBox.axisXy+this.orientedBoundingBox.axisYy,m=this.orientedBoundingBox.axisXy-this.orientedBoundingBox.axisYy,f=f+(0<f?-e:e),g=g+(0<g?-e:e),h=h+(0<h?-e:e),i=i+(0<i?-e:e),k=k+(0<k?-e:e),j=j+(0<j?-e:e),m=m+(0<m?-e:e),l=l+(0<l?-e:e);d.moveTo(this.orientedBoundingBox.centerX+f,this.orientedBoundingBox.centerY+k);d.lineTo(this.orientedBoundingBox.centerX+g,this.orientedBoundingBox.centerY+j);d.lineTo(this.orientedBoundingBox.centerX+
i,this.orientedBoundingBox.centerY+l);d.lineTo(this.orientedBoundingBox.centerX+h,this.orientedBoundingBox.centerY+m);d.lineTo(this.orientedBoundingBox.centerX+f,this.orientedBoundingBox.centerY+k);d.stroke()}d.strokeStyle=a;d.beginPath();d.moveTo(this.boundingBox.minX+e,this.boundingBox.minY+e);d.lineTo(this.boundingBox.maxX-e,this.boundingBox.minY+e);d.lineTo(this.boundingBox.maxX-e,this.boundingBox.maxY-e);d.lineTo(this.boundingBox.minX+e,this.boundingBox.maxY-e);d.lineTo(this.boundingBox.minX+
e,this.boundingBox.minY+e);d.stroke();d.restore();c.call(this,d)}}};this.transparent_=function(){return function(){}}}wade.drawFunctions=new Wade_drawFunctions;
function Wade_vec2(){this.add=function(a,b){return{x:a.x+b.x,y:a.y+b.y}};this.sub=function(a,b){return{x:a.x-b.x,y:a.y-b.y}};this.mul=function(a,b){return{x:a.x*b.x,y:a.y*b.y}};this.div=function(a,b){return{x:a.x/b.x,y:a.y/b.y}};this.dot=function(a,b){return a.x*b.x+a.y*b.y};this.lengthSquared=function(a){return a.x*a.x+a.y*a.y};this.length=function(a){return Math.sqrt(a.x*a.x+a.y*a.y)};this.normalize=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return{x:a.x/b,y:a.y/b}};this.normalizeIfPossible=function(a){var b=
Math.sqrt(a.x*a.x+a.y*a.y);return b<wade.c_epsilon?{x:a.x,y:a.y}:{x:a.x/b,y:a.y/b}};this.scale=function(a,b){return{x:a.x*b,y:a.y*b}};this.clamp=function(a,b,c){return{x:Math.min(Math.max(a.x,b),c),y:Math.min(Math.max(a.y,b),c)}};this.rotate=function(a,b){var c=Math.sin(b),d=Math.cos(b);return{x:d*a.x-c*a.y,y:c*a.x+d*a.y}};this.addInPlace=function(a,b){a.x+=b.x;a.y+=b.y};this.subInPlace=function(a,b){a.x-=b.x;a.y-=b.y};this.mulInPlace=function(a,b){a.x*=b.x;a.y*=b.y};this.divInPlace=function(a,b){a.x/=
b.x;a.y/=b.y};this.normalizeInPlace=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);a.x/=b;a.y/=b};this.normalizeInPlaceIfPossible=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);b>=wade.c_epsilon&&(a.x/=b,a.y/=b)};this.scaleInPlace=function(a,b){a.x*=b;a.y*=b};this.clampInPlace=function(a,b,c){a.x=Math.min(Math.max(a.x,b),c);a.y=Math.min(Math.max(a.y,b),c)};this.rotateInPlace=function(a,b){var c=Math.sin(b),d=Math.cos(b),e=c*a.x+d*a.y;a.x=d*a.x-c*a.y;a.y=e};this.minComponent=function(a){return Math.min(a.x,
a.y)};this.maxComponent=function(a){return Math.max(a.x,a.y)};this.equal=function(a,b,c){c=c||0;return Math.abs(a.x-b.x)<=c&&Math.abs(a.y-b.y)<=c}}wade.vec2=new Wade_vec2;
wade.proceduralImages=new function(){var a=[];this.init=function(){var b=new Sprite(null,null);b.setSize(32,32);b.setDrawFunction(wade.drawFunctions.solidFill_("white"));b.drawToImage("procedural_square",!0);a.push("procedural_square");b.setDrawFunction(wade.drawFunctions.drawRect_("white",3));b.drawToImage("procedural_square_border",!0);b.setDrawFunction(wade.drawFunctions.drawRect_("red",2));b.drawToImage("procedural_square_border",!1);a.push("procedural_square_border");b.setDrawFunction(function(a){var b=
this.getPosition();a.closePath();a.beginPath();a.fillStyle="white";a.arc(b.x,b.y,16,0,2*Math.PI,!1);a.fill()});b.drawToImage("procedural_circle",!0);a.push("procedural_circle");b.setDrawFunction(wade.drawFunctions.radialGradientCircle_(["white"],"rgba(255, 255, 255, 0)"));b.drawToImage("procedural_fadingCircle",!0);a.push("procedural_fadingCircle");b.setDrawFunction(function(a){var b=this.getPosition();a.closePath();a.beginPath();a.fillStyle="white";a.moveTo(-32/6+b.x,-32/6+b.y);a.lineTo(0+b.x,-16+
b.y);a.lineTo(32/6+b.x,-32/6+b.y);a.lineTo(16+b.x,0+b.y);a.lineTo(32/6+b.x,32/6+b.y);a.lineTo(0+b.x,16+b.y);a.lineTo(-32/6+b.x,32/6+b.y);a.lineTo(-16+b.x,0+b.y);a.lineTo(-32/6+b.x,-32/6+b.y);a.fill()});b.drawToImage("procedural_star",!0);a.push("procedural_star")};this.list=function(){return wade.cloneArray(a)}};
Wade_iso=function(){var a=this,b=1.018,c=30,d=25,e={},f=[],g,i,h,k,j,l,m=function(){g||a.init()};this.init=function(p){g=!0;p=p||{};"number"==typeof p.tileScaleFactor&&(b=p.tileScaleFactor);"number"==typeof p.terrainLayerId&&(c=p.terrainLayerId);"number"==typeof p.objectsLayerId&&(d=p.objectsLayerId);p.dontClearCanvas&&wade.setCanvasClearing(c,!1);wade.setLayerSorting(d,"bottomToTop");i=new SceneObject(0,TerrainBehavior,0,0,"iso_terrain");i.iso={};h=i.getBehavior();"object"==typeof p.tileSize&&(h.c_tileSize=
wade.cloneObject(p.tileSize));if("object"==typeof p.numTiles)var r=p.numTiles.x,n=p.numTiles.z;r=r||0;n=n||0;r&&n&&wade.addSceneObject(i,!1);this.gameObjects=[];this.gridObjects=[];this.collisionMap=[];f=[];j=p.movementDirection||"diagonal";l=u(j);var t=new Sprite(0,c);t.setSize(h.c_tileSize.x,h.c_tileSize.x);t.setDrawFunction(wade.drawFunctions.solidFill_("white"));t.setRotation(Math.PI/4);var m=new Sprite(0,c);m.setSize(h.c_tileSize.x,h.c_tileSize.x);m.setDrawFunction(wade.drawFunctions.grid_(1,
1,"black",2));m.setRotation(Math.PI/4);var y=new Sprite(0,c);y.setDrawFunction(function(){});var v=Math.ceil(h.c_tileSize.x*Math.sqrt(2));y.setSize(v,v);y.drawToImage("_wade_isoDefault",!0);t.drawToImage("_wade_isoDefault",!1,null,null,"","2d");t=new Sprite("_wade_isoDefault",c);t.setSize(h.c_tileSize.x,h.c_tileSize.y);t.drawToImage("_wade_isoDefault",!0,null,null,"","2d");y.drawToImage("_wade_isoGrid",!0,null,null,"","2d");m.drawToImage("_wade_isoGrid",!1,null,null,"","2d");t=new Sprite("_wade_isoGrid",
c);t.setSize(h.c_tileSize.x,h.c_tileSize.y);t.drawToImage("_wade_isoGrid",!0,null,null,"","2d");p.map?(e={},"string"==typeof p.map?wade.loadJson(p.map,null,function(a){k={data:wade.cloneObject(a)};h.loadData_begin(k.data,q("terrain",p.callback));x(k.data,p.callback)}):(k=wade.cloneObject(p.map),h.loadData_begin(k.data,q("terrain",p.callback)),x(k.data,p.callback))):h.setNumTiles(r,n);wade.setMainLoop(function(){for(var b=f.length-1;0<=b;b--){var c=f[b],d=c.getPosition(),e=h.getFlatTileCoordinates(d.x,
d.y),g=h.getFlatWorldCoordinates(e.x,e.z),i=d.x-g.x,g=d.y-g.y,k=h.c_tileSize.x/2,n=h.c_tileSize.y/2,p=wade.c_epsilon;("both"==j||"straight"==j)&&Math.abs(i)<p&&g*g>=n*n-p||Math.abs(g)<p&&i*i>=k*k-p||(a.updateObjectTile(c,e.x,e.z)?(c.iso.previousPosition.x=d.x,c.iso.previousPosition.y=d.y):(c.setPosition(c.iso.previousPosition),c.processEvent("onStuck",{})),c.iso.targetCoords&&(c.iso.targetCoords.x==e.x&&c.iso.targetCoords.z==e.z)&&(c.iso.targetCoords=0,wade.removeObjectFromArray(c,f)))}},"_wade_isoMovingObjects");
!p.map&&p.callback&&p.callback()};this.importScene=function(a,b){m();k={data:a};h.loadData_begin(k.data,q("terrain",b));x(k.data,b)};this.getTileSize=function(){m();return wade.cloneObject(h.c_tileSize)};this.getValidMovementDirections=function(){m();return wade.cloneArray(l)};this.getTileScaleFactor=function(){m();return b};this.setTileHeight=function(a,b,c){h.setTileHeight(a,b,c||0)};this.getTileHeight=function(a,b){return h.getTileHeight(a,b)};this.addTileHeight=function(a,b,c){h.addTileHeight(a,
b,c)};this.getNumTiles=function(){return h?{x:h.numTilesX,z:h.numTilesZ}:{x:0,z:0}};this.getTileSprite=function(a,b){return h&&h.tileSprites[a]&&h.tileSprites[a][b]};this.getTileData=function(a,b){return h&&h.getTileData(a,b)};this.getTransitionSprite=function(a,b){return h&&h.transitionSprites[a]&&h.transitionSprites[a][b]};this.getTransitionData=function(a,b){return h&&h.getTransitionData(a,b)};this.getDetailSprite=function(a,b){return h&&h.detailSprites[a]&&h.detailSprites[a][b]};this.getDetailData=
function(a,b){return h&&h.getDetailData(a,b)};this.getTerrainLayerId=function(){return c};this.getTerrain=function(){m();return i};this.getObjectsLayerId=function(){return d};this.checkCollisionsAtTile=function(a,b){return!(!this.collisionMap||!this.collisionMap[a]||!this.collisionMap[a][b])};this.clearCollisions=function(a,b){var c=this.getNumTiles();if("undefined"==typeof a)for(var d=0;d<c.x;d++)for(var e=0;e<c.z;e++)this.collisionMap[d]&&(this.collisionMap[d][e]=null);else this.collisionMap[a]&&
(this.collisionMap[a][b]=null)};this.setCollisionAtTile=function(a,b,c){this.collisionMap[a]||(this.collisionMap[a]=[]);this.collisionMap[a][b]=c};this.setNumTiles=function(a,b){m();a&&b&&!wade.getSceneObject("iso_terrain")?wade.addSceneObject(i,!0):!a&&(!b&&wade.getSceneObject("iso_terrain"))&&wade.removeSceneObject(i);h.setNumTiles(a,b)};this.createObject=function(a,b,c){wade.warn('wade.iso.createObject is deprecated and will be removed soon - instead you can create a regular SceneObject with a "grid" property that describes its collision and grid maps');
m();var a=a||{},c=c?wade.cloneObject(c):{},b=b||{x:0,z:0},e=h.getFlatWorldCoordinates(b.x,b.z);if(a.properties&&Object.keys(a.properties).length){var f={};wade.extend(!0,f,a.properties,c);c=f}if(!this.canAddSceneObject({getGridRef:function(){return a}},b))return null;b=[];f=[];if(a.sprites)for(var g=wade.isArray(a.sprites)?a.sprites:[a.sprites],i=0;i<g.length;i++){var k=g[i];k.layer=d;k.sortPoint||(k.sortPoint={x:0,y:0.5});var j="TextSprite"==k.type?new TextSprite(k):new Sprite(k);b.push(j);f.push(k.offset||
{x:0,y:0})}var l=a.behaviors;if(l){wade.isArray(l)||(l=[l]);for(var q=0;q<l.length;q++)"string"==typeof l[q]&&("function"==typeof window[l[q]]?l[q]=window[l[q]]:function(a){l[q]=function(){this.name=a}}(l[q]))}var s=new SceneObject(b,l,e.x,e.y,c.name);s.setSpriteOffsets(f);s.setGrid({type:"isometric",gridMap:a.gridMap,collisionMap:a.collisionMap});var u=c.flowChart;delete c.flowChart;wade.extend(s,c);delete s.name;s.functions&&(e=s.functions,delete s.functions,s.importFunctions(e));s.setName(c.name||
"");!a.dontAddToScene&&!c.dontAddToScene&&(wade.addSceneObject(s,!0),s.iso.objectData.name=a.name);u&&wade.setTimeout(function(){s.isInScene()&&wade.runFlowChart(u,null,!0,0,s)},0);return s};this.canAddSceneObject=function(a,b){var c=a.getGridRef(),d,e,f;if(!c.gridMap)if(c.gridSize){c.gridMap=[];for(d=0;d<c.gridSize.x;d++)for(e=0;e<c.gridSize.z;e++)c.gridMap.push({x:d,z:e});delete c.gridSize}else c.gridMap=[{x:0,z:0}];if(!c.collisionMap&&c.collisionSize){c.collisionMap=[];for(d=0;d<c.collisionSize.x;d++)for(e=
0;e<c.collisionSize.z;e++)c.collisionMap.push({x:d,z:e});delete c.collisionSize}if(c.collisionMap)for(d=0;d<c.collisionMap.length;d++)if(e=c.collisionMap[d].x+b.x,f=c.collisionMap[d].z+b.z,this.collisionMap[e]){if(this.collisionMap[e][f])return!1}else this.collisionMap[e]=[];return!0};this.addSceneObject=function(a,b){if(!this.canAddSceneObject(a,b))return!1;var c,d,e,f=a.getGridRef();a.iso={objectData:{gridMap:f.gridMap,collisionMap:f.collisionMap,name:a.getName()},gridCoords:{x:b.x,z:b.z}};this.gameObjects.push(a);
for(c=0;c<f.gridMap.length;c++)d=f.gridMap[c].x+b.x,e=f.gridMap[c].z+b.z,this.gridObjects[d]||(this.gridObjects[d]=[]),this.gridObjects[d][e]||(this.gridObjects[d][e]=[]),this.gridObjects[d][e].push(a);if(f.collisionMap)for(c=0;c<f.collisionMap.length;c++)d=f.collisionMap[c].x+b.x,e=f.collisionMap[c].z+b.z,this.collisionMap[d]||(this.collisionMap[d]=[]),this.collisionMap[d][e]=a;for(c=0;c<a.getSpriteCount();c++)d=a.getSprite(c),d.baseOffset=a.getSpriteOffset(c),a.setSpriteOffset(c,{x:d.baseOffset.x,
y:d.baseOffset.y-this.getTileHeight(b.x,b.z)});return!0};this.deleteObject=function(a){wade.warn("wade.iso.deleteObject is deprecated and will be removed soon - instead you can use wade.iso.removeSceneObject");this.removeSceneObject(a)};this.removeSceneObject=function(a){m();var b=this.gameObjects.length;wade.removeObjectFromArray(a,this.gameObjects);if(b!=this.gameObjects.length){var c,d,e=a.getGrid(),f=e.collisionMap;if(f)for(b=0;b<f.length;b++)c=f[b].x+a.iso.gridCoords.x,d=f[b].z+a.iso.gridCoords.z,
this.collisionMap[c]&&this.collisionMap[c][d]&&(this.collisionMap[c][d]=0);e=(e=e.gridMap)||[{x:0,z:0}];for(b=0;b<e.length;b++)c=e[b].x+a.iso.gridCoords.x,d=e[b].z+a.iso.gridCoords.z,this.gridObjects[c]&&this.gridObjects[c][d]&&wade.removeObjectFromArray(a,this.gridObjects[c][d]);wade.removeSceneObject(a);for(b=0;b<a.getSpriteCount();b++)c=a.getSprite(b),a.setSpriteOffset(b,c.baseOffset),delete c.baseOffset}};this.removeSceneObjects=function(a){for(var b=a.length-1;0<=b;b--)this.removeSceneObject(a[b])};
this.reset=function(){g?(f.length=0,e={},this.setNumTiles(0,0),this.gameObjects.length=this.gridObjects.length=this.collisionMap.length=0):m()};this.deleteObjectByName=function(a){(a=g&&wade.getSceneObject(a))&&this.deleteObject(a)};this.deleteObjectsInTile=function(a,b){if(!g||!this.gridObjects[a])return!1;var c=this.gridObjects[a][b];if(!c)return!1;if(c.length){for(var d=c.length-1;0<=d;d--)this.deleteObject(c[d]);return!0}return!1};this.constrainCamera=function(a){m();"undefined"==typeof a&&(a=
!0);a?wade.setMainLoop(function(){var a=wade.getScreenWidth()/2,b=wade.getScreenHeight()/2,a={minX:-a,minY:-b,maxX:a,maxY:b},b=wade.getLayer(c).screenBoxToWorld(a),a=(b.maxX-b.minX)/2,b=(b.maxY-b.minY)/2,d,e,f,g;d={x:0,y:0};e=h.getWorldCoordinates(0,h.numTilesZ-1);e.x-=h.c_tileSize.x/2;f=h.getWorldCoordinates(h.numTilesX-1,0);f.x+=h.c_tileSize.x/2;g=h.getWorldCoordinates(h.numTilesX-1,h.numTilesZ-1);g.y-=h.c_tileSize.y/2;var i=function(a,b){var c={};c.start=a;c.end=b;c.slope=(b.y-a.y)/(b.x-a.x);c.intercept=
c.start.y-c.start.x*c.slope;c.getX=function(a){return(a-this.intercept)/this.slope};return c},k;k=i(d,f);d=i(d,e);f=i(g,f);e=i(g,e);i=wade.getCameraPosition();i.y+b>-a/2?i.y=-a/2-b:i.y-b<g.y+a/2&&(i.y=g.y+a/2+b);i.x-=Math.max(0,i.x+a-Math.min(k.getX(i.y+b),f.getX(i.y-b)));i.x+=Math.max(0,Math.max(d.getX(i.y+b),e.getX(i.y-b))-(i.x-a));wade.setCameraPosition(i)},"_wade_isoConstrainCamera"):wade.setMainLoop(null,"_wade_isoConstrainCamera")};this.swapObjects=function(a,b){m();var c,d,e,f=a.getGridRef();
c=b.getGridRef();var g=f.gridMap||[{x:0,z:0}],i=c.gridMap||[{x:0,z:0}],f=f.collisionMap,k=c.collisionMap,j=a.iso.gridCoords,l=b.iso.gridCoords;if(f)for(c=0;c<f.length;c++)d=f[c].x+j.x,e=f[c].z+j.z,this.collisionMap[d][e]=0;for(c=0;c<g.length;c++)d=g[c].x+j.x,e=g[c].z+j.z,wade.removeObjectFromArray(a,this.gridObjects[d][e]);if(k)for(c=0;c<k.length;c++)d=k[c].x+l.x,e=k[c].z+l.z,this.collisionMap[d][e]=0;for(c=0;c<i.length;c++)d=i[c].x+l.x,e=i[c].z+l.z,wade.removeObjectFromArray(b,this.gridObjects[d][e]);
c=j;j=l;l=c;a.iso.gridCoords=j;b.iso.gridCoords=l;if(f)for(c=0;c<f.length;c++)d=f[c].x+j.x,e=f[c].z+j.z,this.collisionMap[d]||(this.collisionMap[d]=[]),this.collisionMap[d][e]=a;for(c=0;c<g.length;c++)d=g[c].x+j.x,e=g[c].z+j.z,this.gridObjects[d]||(this.gridObjects[d]=[]),this.gridObjects[d][e]||(this.gridObjects[d][e]=[]),this.gridObjects[d][e].push(a);if(k)for(c=0;c<k.length;c++)d=k[c].x+l.x,e=k[c].z+l.z,this.collisionMap[d]||(this.collisionMap[d]=[]),this.collisionMap[d][e]=b;for(c=0;c<g.length;c++)d=
g[c].x+j.x,e=g[c].z+j.z,this.gridObjects[d]||(this.gridObjects[d]=[]),this.gridObjects[d][e]||(this.gridObjects[d][e]=[]),this.gridObjects[d][e].push(b);a.setPosition(h.getFlatWorldCoordinates(j.x,j.z));b.setPosition(h.getFlatWorldCoordinates(l.x,l.z));g=this.getTileHeight(j.x,j.z);i=this.getTileHeight(l.x,l.z);for(c=0;c<a.getSpriteCount();c++)a.setSpriteOffset(c,a.getSprite(c).baseOffset-g);for(c=0;c<b.getSpriteCount();c++)b.setHeightOffset(c,b.getSprite(c).baseOffset-i)};this.findPath=function(a,
b,c,d,e){m();a={start:{x:a.x,y:a.z},target:{x:b.x,y:b.z},collisionMap:this.collisionMap,movementOffsets:c||j,boundaries:{minX:0,minY:0,maxX:h.numTilesX-1,maxY:h.numTilesZ-1},heightMap:h.getHeightMap(),maxStepHeight:d,maxPathLength:e};a=wade.findPath(a);for(b=0;b<a.length;b++)a[b].z=a[b].y;return a};this.moveObjectToTile=function(b,c,d,e){m();if("string"==typeof b&&(b=wade.getSceneObject(b),!b))return!1;if(!e)return a.updateObjectTile(b,c,d)?(b.setPosition(h.getFlatWorldCoordinates(c,d)),b.iso.targetCoords=
0,wade.removeObjectFromArray(b,f),!0):!1;if(b.iso.gridCoords.x==c&&b.iso.gridCoords.z==d)return!0;b.iso.targetCoords={x:c,z:d};b.iso.previousPosition=b.getPosition();f.push(b);c=h.getFlatWorldCoordinates(c,d);b.moveTo(c.x,c.y,e);return!0};this.setTile=function(a,b,c,d){m();return h.setTile(a,b,c,d)};this.setTransition=function(a,b,c){m();h.setTransition(a,b,c)};this.setDetail=function(a,b,c){m();h.setDetail(a,b,c)};this.getWorldCoordinates=function(a,b){m();"object"==typeof a&&(b=a.z,a=a.x);return h.getWorldCoordinates(a,
b)};this.getFlatWorldCoordinates=function(a,b){m();"object"==typeof a&&(b=a.z,a=a.x);return h.getFlatWorldCoordinates(a,b)};this.getTileCoordinates=function(a,b){m();"object"==typeof a&&(b=a.y,a=a.x);return h.getTileCoordinates(a,b)};this.getFlatTileCoordinates=function(a,b){m();"object"==typeof a&&(b=a.y,a=a.x);return h.getFlatTileCoordinates(a,b)};this.getTileTexture=function(a,b){return g&&h.getTileTexture(a,b)};this.setHighlight=function(a,b){m();h.setHighlight(a,b)};this.getHighlightObjects=
function(){return g?h.getHighlightObjects():[]};this.getObjectsInTile=function(a,b){m();var c=this.gridObjects[a]&&this.gridObjects[a][b];return c&&wade.cloneArray(c)||[]};this.sortTerrainTiles=function(){m();h.sort()};this.drawGrid=function(a){m();"undefined"==typeof a&&(a=!0);h.drawGrid(a)};this.draw_=function(a,b){b=b||"blue";return function(c){var d=this._position,e=this._size.x/2,f=this._size.y/2,g=c.strokeStyle,h=c.fillStyle;a&&(c.strokeStyle=a);c.fillStyle=b;c.beginPath();c.moveTo(d.x-e,d.y);
c.lineTo(d.x,d.y+f);c.lineTo(d.x+e,d.y);c.lineTo(d.x,d.y-f);g&&c.stroke();h&&c.fill();c.strokeStyle=g;c.fillStyle=h}};this.exportMap=function(a){m();for(var b={version:"2.0",terrain:{numTilesX:h.numTilesX,numTilesZ:h.numTilesZ,tileData:[],tileDataIds:[],transitionData:[],transitionDataIds:[],detailData:[],detailDataIds:[],tileHeight:[]}},c=0;c<h.numTilesX;c++){b.terrain.tileDataIds[c]=[];b.terrain.transitionDataIds[c]=[];b.terrain.tileHeight[c]=[];for(var d=0;d<h.numTilesZ;d++){if(h.tileData[c]&&
h.tileData[c][d]){var e=h.tileData[c][d],f=b.terrain.tileData.indexOf(e);-1==f&&(f=b.terrain.tileData.push(e)-1);b.terrain.tileDataIds[c][d]=f;b.terrain.tileHeight[c][d]=h.tileHeight[c]&&h.tileHeight[c][d]||0}else b.terrain.tileDataIds[c][d]=-1;h.transitionData[c]&&h.transitionData[c][d]?(e=h.transitionData[c][d],f=b.terrain.transitionData.indexOf(e),-1==f&&(f=b.terrain.transitionData.push(e)-1),b.terrain.transitionDataIds[c][d]=f):b.terrain.transitionDataIds[c][d]=-1}}for(c=0;c<h.numTilesX;c++){b.terrain.detailDataIds[c]=
[];for(d=0;d<h.numTilesZ;d++)h.detailData[c]&&h.detailData[c][d]?(e=h.detailData[c][d],f=b.terrain.detailData.indexOf(e),-1==f&&(f=b.terrain.detailData.push(e)-1),b.terrain.detailDataIds[c][d]=f):b.terrain.detailDataIds[c][d]=-1}if(a)try{b=JSON.stringify(b)}catch(g){wade.log("Unable to convert map data to a string. It may contain circular references.")}return b};this.updateObjectTile=function(b,c,d){m();if(b.iso.gridCoords.x==c&&b.iso.gridCoords.z==d)return!0;var e,f,g,h=b.iso.objectData.gridMap||
[{x:0,z:0}],i=b.iso.objectData.collisionMap;if(i)for(e=0;e<i.length;e++)if(f=i[e].x+c,g=i[e].z+d,a.collisionMap[f]&&a.collisionMap[f][g]&&a.collisionMap[f][g]!=b)return!1;for(e=0;e<h.length;e++)f=h[e].x+b.iso.gridCoords.x,g=h[e].z+b.iso.gridCoords.z,wade.removeObjectFromArray(b,a.gridObjects[f][g]);if(i)for(e=0;e<i.length;e++)f=i[e].x+b.iso.gridCoords.x,g=i[e].z+b.iso.gridCoords.z,a.collisionMap[f]&&a.collisionMap[f][g]&&(a.collisionMap[f][g]=0);for(e=0;e<h.length;e++)f=h[e].x+c,g=h[e].z+d,a.gridObjects[f]||
(a.gridObjects[f]=[]),a.gridObjects[f][g]||(a.gridObjects[f][g]=[]),a.gridObjects[f][g].push(b);if(i)for(e=0;e<i.length;e++)f=i[e].x+c,g=i[e].z+d,a.collisionMap[f]||(a.collisionMap[f]=[]),a.collisionMap[f][g]=b;if(b.iso.gridCoords.x!=c||b.iso.gridCoords.z!=d)var k={x:b.iso.gridCoords.x,z:b.iso.gridCoords.z};b.iso.gridCoords.x=c;b.iso.gridCoords.z=d;for(e=0;e<b.getSpriteCount();e++)f=b.getSprite(e).baseOffset,b.setSpriteOffset(e,{x:f.x,y:f.y-a.getTileHeight(c,d)});k&&b.process("onIsoTileChange",{previousTile:k,
currentTile:{x:c,z:d}});return!0};var q=function(a,b){return function(){e[a]=1;e.terrain&&e.objects&&b&&b()}},u=function(a){switch(a){case "straight":return[{x:-1,z:-1},{x:-1,z:1},{x:1,z:-1},{x:1,z:1}];case "diagonal":return[{x:0,z:-1},{x:0,z:1},{x:-1,z:0},{x:1,z:0}];case "both":return[{x:-1,z:-1},{x:-1,z:1},{x:1,z:-1},{x:1,z:1},{x:0,z:-1},{x:0,z:1},{x:-1,z:0},{x:1,z:0}]}return[]},x=function(b,c){var d,e,f,g,h=[],i={},k=0;if(b.gameObjects){for(d=0;d<b.gameObjectData.length;d++){for(e=0;e<b.gameObjectData[d].sprites.length;e++){var j=
b.gameObjectData[d].sprites[e].image;j&&!i[j]&&(h.push(j),i[j]=1);if(b.gameObjectData[d].sprites[e].animations)for(f=0;f<b.gameObjectData[d].sprites[e].animations.length;f++)j=b.gameObjectData[d].sprites[e].animations[f].image,i[j]||(h.push(j),i[j]=1)}if(e=b.gameObjectData[d].portraits)for(g in e)e.hasOwnProperty(g)&&!i[e[g]]&&(h.push(e[g]),i[e[g]]=1)}if(h.length)for(d=0;d<h.length;d++)wade.loadImage(h[d],function(){if(++k==h.length){if(b.gameObjects)for(var d=0;d<b.gameObjects.length;d++)a.createObject(b.gameObjectData[b.gameObjects[d].templateId],
b.gameObjects[d].gridCoords,b.gameObjects[d].instanceData);q("objects",c)()}});else q("objects",c)()}else q("objects",c)()}};wade.iso=new Wade_iso;
function TerrainBehavior(){this.name="TerrainBehavior";this.tileSprites=[];this.tileData=[];this.gridSprites=[];this.transitionSprites=[];this.transitionData=[];this.detailSprites=[];this.detailData=[];this.tileHeight=[];this.c_tileSize={x:256,y:128};this.c_origin={x:0,y:-this.c_tileSize.y/2};this.numTilesZ=this.numTilesX=0;this.tileHighlightObjects=[];var a=!1;this.onAddToScene=function(){this.owner.listenFor("onMouseDown");this.owner.listenFor("onMouseUp");this.owner.listenFor("onMouseClick");this.owner.listenFor("onMouseMove");
wade.setLayerSorting(wade.iso.getTerrainLayerId(),this.sortingFunction)};this.sortingFunction=function(a,c){return c.customSortIndex-a.customSortIndex||a.customSortOrder-c.customSortOrder};this.getTileHighlightObject=function(a){if(!this.tileHighlightObjects[a])if(this.highlightTexture){var c=new Sprite(this.highlightTexture,wade.iso.getTerrainLayerId());c.setSize(this.c_tileSize.x,this.c_tileSize.y);c.customSortOrder=4;c.customSortIndex=0;this.tileHighlightObjects[a]=new SceneObject(c);this.tileHighlightObjects[a].iso=
{gridCoords:{x:0,z:0}};wade.addSceneObject(this.tileHighlightObjects[a])}else this.highlightSprite&&(c=this.highlightSprite.clone(),c.customSortOrder=4,c.customSortIndex=0,this.tileHighlightObjects[a]=new SceneObject(c),this.tileHighlightObjects[a].iso={gridCoords:{x:0,z:0}},wade.addSceneObject(this.tileHighlightObjects[a]));return this.tileHighlightObjects[a]};this.hideTileHighlightObjects=function(){for(var a=0;a<this.tileHighlightObjects.length;a++)this.tileHighlightObjects[a]&&this.tileHighlightObjects[a].setVisible(!1)};
this.getHighlightObjects=function(){return wade.extend([],this.tileHighlightObjects)};this.loadData_begin=function(a,c){this.finishedLoading_=!1;this.loadingList=[];var d={_wade_isoDefault:1};this.completeRequests=0;var e,f;for(e=0;e<a.terrain.tileData.length;e++)f=a.terrain.tileData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);for(e=0;e<a.terrain.transitionData.length;e++)f=a.terrain.transitionData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);for(e=0;e<a.terrain.detailData.length;e++)f=
a.terrain.detailData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);if(this.loadingList.length)for(e=0;e<this.loadingList.length;e++)wade.loadImage(this.loadingList[e],this.onLoadingRequestComplete_(a,c));else this.onLoadingRequestComplete_(a,c)(!0)};this.onLoadingRequestComplete_=function(a,c){var d=this;return function(e){if(!0===e||++d.completeRequests==d.loadingList.length)d.loadData_end(a),!d.owner.isInScene()&&(d.numTilesX&&d.numTilesZ)&&wade.addSceneObject(d.owner,!1),d.finishedLoading_=
!0,c&&c()}};this.loadData_end=function(b){var c,d;this.numTilesX=b.terrain.numTilesX;this.numTilesZ=b.terrain.numTilesZ;for(c=0;c<this.numTilesX;c++){this.tileSprites[c]=[];this.tileData[c]=[];this.transitionSprites[c]=[];this.transitionData[c]=[];for(d=0;d<this.numTilesZ;d++){this.setTile(c,d,b.terrain.tileData[b.terrain.tileDataIds[c][d]],b.terrain.tileHeight&&b.terrain.tileHeight[c]&&b.terrain.tileHeight[c][d]||0);var e=b.terrain.transitionData[b.terrain.transitionDataIds[c][d]];e&&this.setTransition(c,
d,e)}}for(c=0;c<this.numTilesX;c++){this.detailSprites[c]=[];this.detailData[c]=[];for(d=0;d<this.numTilesZ;d++)(e=b.terrain.detailData[b.terrain.detailDataIds[c][d]])&&this.setDetail(c,d,e)}a&&(this.drawGrid(!1),this.drawGrid(!0))};this.setNumTiles=function(b,c){var d,e;if(a){var f=!0;this.drawGrid(!1)}for(d=b;d<this.numTilesX;d++)for(e=0;e<this.numTilesZ;e++)this.setTile(d,e,0),this.setTransition(d,e,0);for(e=c;e<this.numTilesZ;e++)for(d=0;d<this.numTilesX;d++)this.setTile(d,e,0),this.setTransition(d,
e,0);for(d=b;d<this.numTilesX;d++)for(e=0;e<this.numTilesZ;e++)this.setDetail(d,e,0);for(e=c;e<this.numTilesZ;e++)for(d=0;d<this.numTilesX;d++)this.setDetail(d,e,0);this.tileData.length=this.transitionData.length=this.detailData.length=this.tileSprites.length=this.transitionSprites.length=this.detailSprites.length=this.gridSprites.length=this.tileHeight.length=b;for(d=0;d<b;d++)this.tileData[d]&&(this.tileData[d].length=c),this.transitionData[d]&&(this.transitionData[d].length=c),this.detailData[d]&&
(this.detailData[d].length=c),this.tileSprites[d]&&(this.tileSprites[d].length=c),this.transitionSprites[d]&&(this.transitionSprites[d].length=c),this.detailSprites[d]&&(this.detailSprites[d].length=c),this.gridSprites[d]&&(this.gridSprites[d].length=c),this.tileHeight[d]&&(this.tileHeight[d].length=c);var g={texture:"_wade_isoDefault"};for(d=this.numTilesX;d<b;d++){this.tileSprites[d]=[];this.tileData[d]=[];this.transitionSprites[d]=[];this.transitionData[d]=[];for(e=0;e<c;e++)this.setTile(d,e,g)}for(e=
this.numTilesZ;e<c;e++)for(d=0;d<this.numTilesX;d++)this.setTile(d,e,g);for(d=this.numTilesX;d<b;d++)this.detailSprites[d]=[],this.detailData[d]=[];this.numTilesX=b;this.numTilesZ=c;f&&this.drawGrid(!0)};this.setTile=function(a,c,d,e){var f=wade.iso.collisionMap;if(!d||d.collision){if(f[a]&&f[a][c]&&!f[a][c].isTerrainTile)return!1;f[a]||(f[a]=[]);f[a][c]={isTerrainTile:!0,tileData:d}}else f[a]&&(f[a][c]&&f[a][c].isTerrainTile)&&(f[a][c]=0);this.tileSprites[a]||(this.tileSprites[a]=[]);this.tileData[a]||
(this.tileData[a]=[]);this.tileHeight[a]||(this.tileHeight[a]=[]);if(d){e=e||0;this.tileHeight[a][c]=e;var g,i,h,k,j,l;g=!0;if(f=d.texture)j=wade.getImage(f),k=j.width,j=j.height;d.rotation&&(f+="_iso_rot_"+d.rotation,"ok"!=wade.getLoadingStatus(f)&&(h=new Sprite(d.texture),h.setRotation(d.rotation*Math.PI/2),h.drawToImage(f,!0)));l=d.scale||1;h=this.c_tileSize.x*wade.iso.getTileScaleFactor()*l;var m=i=this.c_tileSize.y*wade.iso.getTileScaleFactor()*l,q={x:this.c_origin.x+(a-c)*this.c_tileSize.x/
2,y:this.c_origin.y-(a+c)*this.c_tileSize.y/2};this.tileSprites[a][c]&&(l=this.tileSprites[a][c],d.animation||this.tileData[a][c].animation?(this.owner.removeSprite(l),this.tileSprites[a][c]=0):(l.setImageFile(f),d.imageArea?(l.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),d.customHeight&&(g=d.imageArea.maxX-d.imageArea.minX,i=d.imageArea.maxY-d.imageArea.minY,i=this.c_tileSize.x*wade.iso.getTileScaleFactor()*i/g)):d.customHeight&&(k&&j)&&(i=this.c_tileSize.x*wade.iso.getScaleFactor()*
j/k),l.setSize(h,i),q.y+=(i-m)/2-e,this.owner.setSpriteOffset(this.owner.getSpriteIndex(l),q),g=!1));g&&(d.animation?(l=new Sprite(0,wade.iso.getTerrainLayerId()),f=new Animation(f,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,!0),l.addAnimation("default",f),l.playAnimation("default")):l=new Sprite(f,wade.iso.getTerrainLayerId()),l.customSortOrder=0,l.customSortIndex=a+c,l.gridCoords={x:a,z:c},d.imageArea?(l.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),
d.customHeight&&(g=d.imageArea.maxX-d.imageArea.minX,i=d.imageArea.maxY-d.imageArea.minY,i=this.c_tileSize.x*wade.iso.getTileScaleFactor()*i/g)):d.customHeight&&(k&&j)&&(i=this.c_tileSize.x*wade.iso.getScaleFactor()*j/k),l.setSize(h,i),q.y+=(i-m)/2-e,this.tileSprites[a][c]=l,this.owner.addSprite(l,q));k={x:this.c_origin.x+(a-c)*this.c_tileSize.x/2,y:this.c_origin.y-(a+c)*this.c_tileSize.y/2-e};this.transitionSprites[a]&&this.transitionSprites[a][c]&&this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.transitionSprites[a][c]),
k);this.detailSprites[a]&&this.detailSprites[a][c]&&this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.detailSprites[a][c]),k);k=wade.iso.getObjectsInTile(a,c);for(j=0;j<k.length;j++)for(f=0;f<k[j].getSpriteCount();f++)h=k[j].getSprite(f).baseOffset,k[j].setSpriteOffset(f,{x:h.x,y:h.y-e});this.gridSprites[a]&&this.gridSprites[a][c]&&this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.gridSprites[a][c]),this.getWorldCoordinates(a,c))}else this.tileSprites[a]&&this.tileSprites[a][c]&&this.owner.removeSprite(this.tileSprites[a][c]),
this.tileSprites[a][c]=0,this.transitionSprites[a]&&this.transitionSprites[a][c]&&this.setTransition(a,c,null),this.detailSprites[a]&&this.detailSprites[a][c]&&this.setDetail(a,c,null),this.tileHeight[a]&&this.tileHeight[a][c]&&(this.tileHeight[a][c]=0);this.tileData[a][c]=d;return!0};this.setTransition=function(a,c,d){this.transitionSprites[a]||(this.transitionSprites[a]=[]);this.transitionData[a]||(this.transitionData[a]=[]);if(d){var e=!0,f=d.texture;if(d.rotation&&(f+="_iso_rot_"+d.rotation,"ok"!=
wade.getLoadingStatus(f))){var g=new Sprite(d.texture);g.setRotation(d.rotation*Math.PI/2);g.drawToImage(f,!0)}var i=d.scale||1,g=this.c_tileSize.x*wade.iso.getTileScaleFactor()*i,i=this.c_tileSize.y*wade.iso.getTileScaleFactor()*i;this.transitionSprites[a][c]&&(d.animation||this.transitionData[a][c].animation?(this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=0):(this.transitionSprites[a][c].setImageFile(f),d.imageArea&&this.transitionSprites[a][c].setImageArea(d.imageArea.minX,
d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),this.transitionSprites[a][c].setSize(g*wade.iso.getTileScaleFactor(),i*wade.iso.getTileScaleFactor()),e=!1));var h={x:this.c_origin.x+(a-c)*this.c_tileSize.x/2,y:this.c_origin.y-(a+c)*this.c_tileSize.y/2-this.getTileHeight(a,c)};e&&(d.animation?(e=new Sprite(0,wade.iso.getTerrainLayerId()),f=new Animation(d.texture,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,!0),e.addAnimation("default",f),e.playAnimation("default")):e=new Sprite(f,
wade.iso.getTerrainLayerId()),e.setPosition(h),e.setSize(g*wade.iso.getTileScaleFactor(),i*wade.iso.getTileScaleFactor()),e.customSortOrder=1,e.customSortIndex=a+c,d.imageArea&&e.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),this.owner.addSprite(e),this.transitionSprites[a][c]=e);this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.transitionSprites[a][c]),h)}else this.transitionSprites[a][c]&&this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=
0;this.transitionData[a][c]=d};this.setDetail=function(a,c,d){this.detailSprites[a]||(this.detailSprites[a]=[]);this.detailData[a]||(this.detailData[a]=[]);if(d){var e=!0,f=d.texture;if(d.rotation&&(f+="_iso_rot_"+d.rotation,"ok"!=wade.getLoadingStatus(f))){var g=new Sprite(d.texture);g.setRotation(d.rotation*Math.PI/2);g.drawToImage(f,!0)}var g=d.scale||1,i=this.c_tileSize.x*wade.iso.getTileScaleFactor()*g,h=this.c_tileSize.y*wade.iso.getTileScaleFactor()*g;this.detailSprites[a][c]&&(d.animation||
this.detailData[a][c].animation?(this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=0):(this.detailSprites[a][c].setImageFile(f),d.imageArea&&this.detailSprites[a][c].setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),this.detailSprites[a][c].setSize(i*wade.iso.getTileScaleFactor(),h*wade.iso.getTileScaleFactor()),e=!1));var k={x:this.c_origin.x+(a-c)*this.c_tileSize.x/2,y:this.c_origin.y-(a+c)*this.c_tileSize.y/2-this.getTileHeight(a,
c)};e&&(d.animation?(e=new Sprite(0,wade.iso.getTerrainLayerId()),f=new Animation(d.texture,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,!0),e.addAnimation("default",f),e.playAnimation("default")):e=new Sprite(f,wade.iso.getTerrainLayerId()),e.setSize(i*wade.iso.getTileScaleFactor()*g,h*wade.iso.getTileScaleFactor()*g),e.customSortOrder=2,e.customSortIndex=a+c,d.imageArea&&e.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),this.owner.addSprite(e),
this.detailSprites[a][c]=e);this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.detailSprites[a][c]),k)}else this.detailSprites[a][c]&&this.owner.removeSprite(this.detailSprites[a][c]),this.detailSprites[a][c]=0;this.detailData[a][c]=d};this.getWorldCoordinates=function(a,c){return{x:(a-c)*this.c_tileSize.x/2,y:-(a+c+1)*this.c_tileSize.y/2-(this.tileHeight[a]&&this.tileHeight[a][c]||0)}};this.getFlatWorldCoordinates=function(a,c){return{x:(a-c)*this.c_tileSize.x/2,y:-(a+c+1)*this.c_tileSize.y/
2}};this.getTileCoordinates=function(a,c){for(var d=wade.getSpritesInArea({minX:a,minY:c,maxX:a,maxY:c},wade.iso.getTerrainLayerId(),!0),e=this.c_tileSize.y*wade.iso.getTileScaleFactor(),f=this.c_tileSize.x*wade.iso.getTileScaleFactor()/2,g=e/2,i=f*g,h=0;h<d.length;h++){var k=d[h];if(k.gridCoords){var j=this.tileData[k.gridCoords.x][k.gridCoords.z],l=k.getPosition(),l=wade.vec2.sub({x:a,y:c},l);if(j&&j.customHeight){var j=j.scale||1,m=k.getSize();if(l.y+m.y/2>e*j)continue;l.y+=(m.y-e)/2}if(Math.abs(l.x)*
g+Math.abs(l.y)*f<=i)return{x:k.gridCoords.x,z:k.gridCoords.z,valid:!0}}}d=a/this.c_tileSize.x-c/this.c_tileSize.y;e=-(a/this.c_tileSize.x+c/this.c_tileSize.y);d=Math.floor(d);e=Math.floor(e);return{x:d,z:e,valid:0<=d&&0<=e&&d<this.numTilesX&&e<this.numTilesZ}};this.getFlatTileCoordinates=function(a,c){var d=a/this.c_tileSize.x-c/this.c_tileSize.y,e=-(a/this.c_tileSize.x+c/this.c_tileSize.y),d=Math.floor(d),e=Math.floor(e);return{x:d,z:e,valid:0<=d&&0<=e&&d<this.numTilesX&&e<this.numTilesZ}};this.onMouseDown=
function(a){if(wade.app.onIsoTerrainMouseDown){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,c.z);return wade.app.onIsoTerrainMouseDown(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};this.onClick=function(a){if(wade.app.onIsoTerrainClick){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,c.z);return wade.app.onIsoTerrainClick(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};
this.onMouseUp=function(a){if(wade.app.onIsoTerrainMouseUp){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,c.z);return wade.app.onIsoTerrainMouseUp(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};this.setHighlight=function(a,c){var d;this.highlightOffsets=c||[{x:0,z:0}];if(a instanceof Sprite){if(this.highlightTexture)for(d=0;d<this.tileHighlightObjects.length;d++)wade.removeSceneObject(this.tileHighlightObjects[d]),this.tileHighlightObjects[d]=
null;this.highlightSprite=a;this.highlightTexture=null}else{if(this.highlightSprite){for(d=0;d<this.tileHighlightObjects.length;d++)wade.removeSceneObject(this.tileHighlightObjects[d]);this.tileHighlightObjects.length=0}this.highlightTexture=a;this.highlightSprite=null}if(this.highlightTexture&&this.highlightOffsets&&this.highlightOffsets.length)for(d=0;d<this.tileHighlightObjects.length;d++)this.getTileHighlightObject(d).getSprite(0).setImageFile(a);else if(this.highlightSprite)for(d=0;d<this.tileHighlightObjects.length;d++)this.getTileHighlightObject(d);
else this.hideTileHighlightObjects()};this.onMouseMove=function(a){var c,d;c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid&&(this.highlightTexture||this.highlightSprite)&&this.highlightOffsets&&this.highlightOffsets.length)for(var e=0;e<this.highlightOffsets.length;e++){var f=this.highlightOffsets[e];d=this.getWorldCoordinates(c.x+f.x,c.z+f.z);var g=this.getTileHighlightObject(e);g.setPosition(d);g.setVisible(!0);g.iso.gridCoords.x=c.x+f.x;g.iso.gridCoords.z=c.z+f.z}else this.hideTileHighlightObjects();
wade.app.onIsoTerrainMouseMove&&wade.app.onIsoTerrainMouseMove(wade.extend({},a,{gridCoords:c}))};this.sort=function(){wade.getLayer(wade.iso.getTerrainLayerId()).sort(this.sortingFunction)};this.drawGrid=function(b){var c,d=wade.iso.getTerrainLayerId();if(b&&!a){for(b=0;b<this.numTilesX;b++){this.gridSprites[b]=[];for(c=0;c<this.numTilesZ;c++){var e=new Sprite("_wade_isoGrid",d);e.customSortOrder=3;e.customSortIndex=b+c;var f={x:this.c_origin.x+(b-c)*this.c_tileSize.x/2,y:this.c_origin.y-(b+c)*this.c_tileSize.y/
2-(this.tileHeight[b]&&this.tileHeight[b][c]||0)};e.setSize(this.c_tileSize.x*wade.iso.getTileScaleFactor(),this.c_tileSize.y*wade.iso.getTileScaleFactor());this.owner.addSprite(e,f);this.gridSprites[b][c]=e}}a=!0}else if(!b&&a){for(b=0;b<this.gridSprites.length;b++)for(c=0;c<this.gridSprites[b].length;c++)this.owner.removeSprite(this.gridSprites[b][c]);this.gridSprites.length=0;a=!1}};this.getTileTexture=function(a,c){return this.tileSprites[a]&&this.tileSprites[a][c]&&this.tileSprites[a][c].getImageName()};
this.getTileData=function(a,c){return this.tileData[a]&&this.tileData[a][c]&&wade.cloneObject(this.tileData[a][c])};this.getTransitionData=function(a,c){return this.transitionData[a]&&this.transitionData[a][c]&&wade.cloneObject(this.transitionData[a][c])};this.getDetailData=function(a,c){return this.detailData[a]&&this.detailData[a][c]&&wade.cloneObject(this.detailData[a][c])};this.setTileHeight=function(a,c,d){this.setTile(a,c,this.tileData[a]&&this.tileData[a][c],d)};this.getTileHeight=function(a,
c){return this.tileHeight[a]&&this.tileHeight[a][c]||0};this.addTileHeight=function(a,c,d){var e=this,f={x:0,y:d};["gridSprites","tileSprites","transitionSprites","detailSprites"].forEach(function(d){d=e[d];d[a]&&d[a][c]&&(d=e.owner.getSpriteIndex(d[a][c]),e.owner.setSpriteOffset(d,wade.vec2.add(e.owner.getSpriteOffset(d),f)))});this.tileHeight[a][c]+=d};this.getHeightMap=function(){return this.tileHeight}}
function IsoCharacter(){var a=this,b=[],c,d="forward",e,f;this.name="IsoCharacter";this.movementSpeed=160;this.maxStepHeight=20;this.variationProbability=0.1;this.setDestination=function(a){var b=this.owner.getPosition(),c=wade.iso.getFlatTileCoordinates(b.x,b.y),d=this.getNextDestination();if(d){var e=d.x-c.x;e&&(e/=Math.abs(e));var m=d.z-c.z;m&&(m/=Math.abs(m));c.x+=e;c.z+=m}e=wade.iso.findPath(c,a,f,this.maxStepHeight);if(e.length){m=wade.iso.getFlatWorldCoordinates(c.x,c.z);this.clearDestinations();
if(Math.abs(b.x-m.x)>wade.c_epsilon||Math.abs(b.y-m.z)>wade.c_epsilon){if(d&&d.x==a.x&&d.z==a.z)return!1;g(c);this._goToNextDestination()}if(c.x==a.x&&c.z==a.z)return!1;for(b=1;b<e.length-1;b++)c=e[b].z-e[b-1].z,d=e[b+1].z-e[b].z,(e[b].x-e[b-1].x!=e[b+1].x-e[b].x||c!=d)&&g(e[b]);g(a);return!0}return!1};this.clearDestinations=function(){b.length=0};this.setMovementType=function(a){f=a};this.getNextDestination=function(){return this._nextDestination};this.setDirection=function(a){this.owner.isMoving()||
this.owner.playAnimation("Idle_iso_"+a)};this.goToObject=function(a){if("string"==typeof a&&(a=wade.getSceneObject(a),!a))return;var b=this.owner.iso.gridCoords,c=[],d=a.interactionOffset||a.iso.objectData.interactionOffset;d&&c.push({x:a.iso.gridCoords.x+d.x,z:a.iso.gridCoords.z+d.z,object:a});c.push({x:a.iso.gridCoords.x,z:a.iso.gridCoords.z,object:a});for(var d=wade.iso.getValidMovementDirections(),f=[],g=0;g<d.length;g++)f.push({x:a.iso.gridCoords.x+d[g].x,z:a.iso.gridCoords.z+d[g].z,object:a});
f.sort(function(a,c){var d,e;d=b.x-a.x;e=b.z-a.z;var f=d*d+e*e;d=b.x-c.x;e=b.z-c.z;return f-(d*d+e*e)});for(g=0;g<f.length;g++)c.push(f[g]);for(g=0;g<c.length;g++)if(c[g].x!=b.x||c[g].z!=b.z){if(this.setDestination(c[g]))break}else{e=a;this.owner.processEvent("onMoveComplete");break}};this.startWandering=function(a,b,d){c={probability:a,stepDistance:b,targetObject:d}};this.stopWandering=function(){c=0};this.onMoveComplete=function(){if(b.length)this._goToNextDestination();else{this.owner.playAnimation("Idle_iso_"+
this.lastDirection);this.lastDirection="";var a=this._nextDestination;this._nextDestination=null;this.owner.processEvent("onDestinationReached",{destination:a});if(e){a=[{x:0,z:0}];e.interactionOffset&&a.push({x:-e.interactionOffset.x,z:-e.interactionOffset.z});for(var a=a.concat(wade.iso.getValidMovementDirections()),c=0;c<a.length;c++)for(var d=wade.iso.getObjectsInTile(this.owner.iso.gridCoords.x+a[c].x,this.owner.iso.gridCoords.z+a[c].z),f=0;f<d.length;f++)if(d[f]==e){var g={"01":"se",11:"s",
10:"sw","1-1":"w","0-1":"nw","-1-1":"n","-10":"ne","-11":"e"}[(this.owner.iso.gridCoords.x-e.iso.gridCoords.x).toString()+(this.owner.iso.gridCoords.z-e.iso.gridCoords.z).toString()];g&&this.setDirection(g);this.owner.processEvent("onObjectReached",{object:d[f]})}}}};this.onAddToScene=function(){wade.addEventListener(this.owner,"onAppTimer")};this.onAppTimer=function(){c&&Math.random()<c.probability&&this._wander();if(Math.random()<this.variationProbability){var a=this.owner.getSprite(0),b=a.getCurrentAnimationName(),
e=b.indexOf("_variation_");0<=e&&(b=b.substr(0,e));for(var f=0;a.hasAnimation(b+"_variation_"+f);f++);f&&!a.getCurrentAnimation().isPlaying()&&(e&&"reverse"==d?b=a.getCurrentAnimationName():(b+="_variation_"+Math.floor(Math.random()*f),d="forward"),this.owner.playAnimation(b,d),d="forward"==d?"reverse":"forward")}};this._wander=function(){if(!b.length){var a={x:this.owner.iso.gridCoords.x,z:this.owner.iso.gridCoords.z},d=Math.round(2*Math.random()*c.stepDistance-c.stepDistance),e=Math.round(2*Math.random()*
c.stepDistance-c.stepDistance);if(c&&c.targetObject){var f="string"==typeof c.targetObject?wade.getSceneObject(c.targetObject):c.targetObject;f&&(0.5>Math.random()&&0>(f.gridCoords.x-a.x)*d&&(d*=-1),0.5>Math.random()&&0>(f.gridCoords.z-a.z)*e&&(e*=-1))}if(d||e)a.x+=d,a.z+=e,!wade.iso.checkCollisionsAtTile(a.x,a.z)&&!this.setDestination(a)&&(a.x-=d,this.setDestination(a)||(a.z-=e,a.x+=d,this.setDestination(a)))}};this._goToNextDestination=function(){if(b[0]){var a=this.owner.iso.gridCoords,c=b[0];
this._nextDestination=b[0];e=b[0].object;wade.removeObjectFromArrayByIndex(0,b);wade.iso.moveObjectToTile(this.owner,c.x,c.z,this.movementSpeed);var d=c.x-a.x,a=c.z-a.z;d&&(d/=Math.abs(d));a&&(a/=Math.abs(a));var f;switch(d.toString()+a){case "-1-1":f="s";break;case "-10":f="sw";break;case "-11":f="w";break;case "0-1":f="se";break;case "01":f="nw";break;case "1-1":f="e";break;case "10":f="ne";break;case "11":f="n"}f!=this.lastDirection&&(this.lastDirection=f,this.owner.playAnimation("Walk_iso_"+this.lastDirection))}};
var g=function(c){b.push(c);a.owner.isMoving()||a._goToNextDestination()}}
function IsoActionCharacter(){var a="se",b={n:{x:0,y:-1},ne:{x:0.89443,y:-0.44721},e:{x:1,y:0},se:{x:0.89443,y:0.44721},s:{x:0,y:1},sw:{x:-0.89443,y:0.44721},w:{x:-1,y:0},nw:{x:-0.89443,y:-0.44721}},c={ne:{x:0.89443,y:0.44721},se:{x:-0.89443,y:0.44721},sw:{x:-0.89443,y:-0.44721},nw:{x:0.89443,y:-0.44721}};this.name="IsoActionCharacter";this.movementSpeed=160;this.maxStepHeight=20;this.controls={up:38,down:40,left:37,right:39};this.gamePadIndex=0;this.gamePadControls={up:{axis:1,axisDirection:-1,buttons:[]},
down:{axis:1,axisDirection:1,buttons:[]},left:{axis:0,axisDirection:-1,buttons:[]},right:{axis:0,axisDirection:1,buttons:[]}};this._gamepadStates={up:!1,down:!1,left:!1,right:!1};this._keyStates={up:!1,down:!1,left:!1,right:!1};this._inputState=function(a){return this._gamepadStates[a]||this._keyStates[a]};this.animations={idle_n:"idle_n",idle_ne:"idle_ne",idle_e:"idle_e",idle_se:"idle_se",idle_s:"idle_s",idle_sw:"idle_sw",idle_w:"idle_w",idle_nw:"idle_nw",walk_n:"walk_n",walk_ne:"walk_ne",walk_e:"walk_e",
walk_se:"walk_se",walk_s:"walk_s",walk_sw:"walk_sw",walk_w:"walk_w",walk_nw:"walk_nw"};this.velocity={x:0,y:0};this.inGrid=function(a,b){var c=wade.iso.getNumTiles();return!(a>=c.x||b>=c.z||0>a||0>b)};this.velocityToDirection=function(a){var b={n:0,ne:Math.PI/4,e:Math.PI/2,se:3*Math.PI/4,s:Math.PI,sw:5*Math.PI/4,w:3*Math.PI/2,nw:7*Math.PI/4},a=Math.atan2(a.y,a.x)+Math.PI/2;0>a&&(a+=2*Math.PI);var c="n",g=1E5,i;for(i in b)if(b.hasOwnProperty(i)){var h=Math.abs(a-b[i]);h<g&&(g=h,c=i)}return c};this.updateGamepadState=
function(){for(var a in this._gamepadStates)this._gamepadStates.hasOwnProperty(a)&&(this._gamepadStates[a]=!1);var b=wade.getGamepadData()[this.gamePadIndex];if(b)for(a in this.gamePadControls)if(this.gamePadControls.hasOwnProperty(a)){var c=this.gamePadControls[a];if(-1!=c.axis){var g=c.axisDirection,i=b.axes[c.axis];if((0==g?0:Math.abs(g)/g)==(0==i?0:Math.abs(i)/i)&&0.4<Math.abs(i))this._gamepadStates[a]=!0}for(g=0;g<c.buttons.length;g++)if(b.buttons[c.buttons[g]]&&b.buttons[c.buttons[g]].pressed){this._gamepadStates[a]=
!0;break}}};this.onKeyDown=function(a){for(var b in this.controls)this.controls.hasOwnProperty(b)&&this.controls[b]==a.keyCode&&(this._keyStates[b]=!0);return!0};this.onKeyUp=function(a){for(var b in this.controls)this.controls.hasOwnProperty(b)&&this.controls[b]==a.keyCode&&(this._keyStates[b]=!1);return!0};this.updateVelocity=function(){var a={x:0,y:0},c=!0,f;for(f in this._keyStates)this._keyStates.hasOwnProperty(f)&&!1!=this._inputState(f)&&("up"==f&&(wade.vec2.addInPlace(a,b.n),c=!1),"down"==
f&&(wade.vec2.addInPlace(a,b.s),c=!1),"left"==f&&(wade.vec2.addInPlace(a,b.w),c=!1),"right"==f&&(wade.vec2.addInPlace(a,b.e),c=!1));a=this.velocityToDirection(a);this.velocity=wade.vec2.scale(b[a],this.movementSpeed);c&&(this.velocity={x:0,y:0});this.owner.setVelocity(this.velocity.x,this.velocity.y);return{noMove:c,vel:this.velocity,direction:a}};this.updateAnimation=function(b,c){var f=this.owner.getSprite();c?f.getCurrentAnimationName()!=this.animations["idle_"+a]&&f.playAnimation(this.animations["idle_"+
a],"forwards"):f.getCurrentAnimationName()!=this.animations["walk_"+b]&&(f.playAnimation(this.animations["walk_"+b],"forwards"),a=b)};this.illegalTile=function(a,b){var c=wade.iso.getTileHeight(a.x,a.z),c=wade.iso.getTileHeight(b.x,b.z)-c;return Math.abs(c)>this.maxStepHeight||!this.inGrid(b.x,b.z)||wade.iso.checkCollisionsAtTile(b.x,b.z)};this.handleTileTransition=function(a,e,f,g){if(!(f.x==g.x&&f.z==g.z)&&this.illegalTile(f,g)&&(g=wade.cloneObject(c[g.z>f.z?"nw":g.z<f.z?"se":g.x>f.x?"ne":g.x<f.x?
"sw":null]),e=wade.vec2.dot(e,g),this.velocity=g=wade.vec2.scale(g,e),this.owner.setVelocity(this.velocity),g=this.calcFutureCoords(a,this.velocity),this.illegalTile(f,g))){var e=[],i;for(i in b)if(b.hasOwnProperty(i)){var g={x:a.x+this.velocity.x*wade.c_timeStep+4*b[i].x*this.movementSpeed/100,y:a.y+this.velocity.y*wade.c_timeStep+4*b[i].y*this.movementSpeed/100},h=wade.iso.getFlatTileCoordinates(g.x,g.y);!this.illegalTile(f,h)&&!(h.x==f&&h.z==f.z)&&e.push({worldCoords:g,tileCoords:h})}f=null;i=
-1;for(g=0;g<e.length;g++)h=wade.vec2.dot(wade.vec2.normalize(this.velocity),wade.vec2.normalize(wade.vec2.sub(a,e[g].worldCoords))),h>i&&(i=h,f=e[g].worldCoords);f?this.owner.setPosition(f):this.owner.setVelocity(this.velocity={x:0,y:0})}};this.calcFutureCoords=function(a,b){return wade.iso.getFlatTileCoordinates(a.x+b.x*wade.c_timeStep,a.y+b.y*wade.c_timeStep)};this.onUpdate=function(){this.updateGamepadState();var a=this.updateVelocity(),b=a.vel;this.updateAnimation(a.direction,a.noMove);var a=
this.owner.getPosition(),c=wade.iso.getFlatTileCoordinates(a.x,a.y),g=this.calcFutureCoords(a,b);this.handleTileTransition(a,b,c,g);wade.iso.updateObjectTile(this.owner,c.x,c.z)}}
Wade_tilemap=function(){var a=this,b=30,c={},d,e,f,g;this.collisionMap=[];var i=function(b){d||a.init(b&&b.terrain)};this.init=function(a){d=!0;a=a||{};"number"==typeof a.terrainLayerId&&(b=a.terrainLayerId);a.dontClearCanvas&&wade.setCanvasClearing(b,!1);e=new SceneObject(0,TiledTerrain,0,0,"tilemap_terrain");e.tilemap={};f=e.getBehavior();"object"==typeof a.tileSize&&(f.c_tileSize=wade.cloneObject(a.tileSize));if("object"==typeof a.numTiles)var i=a.numTiles.x,l=a.numTiles.y;else void 0!=a.numTilesX&&
void 0!=a.numTilesY&&(i=a.numTilesX,l=a.numTilesY);i=i||0;l=l||0;i&&l&&wade.addSceneObject(e,!0);var m=new Sprite(0,b);m.setSize(f.c_tileSize.x,f.c_tileSize.x);m.setDrawFunction(wade.drawFunctions.solidFill_("white"));m.drawToImage("_wade_tilemapDefault",!1,null,null,"","2d");m=new Sprite(0,b);m.setSize(f.c_tileSize.x,f.c_tileSize.x);m.setDrawFunction(wade.drawFunctions.drawRect_("purple",2));m.drawToImage("_wade_tilemapGrid",!1,null,null,"","2d");a.map?(c={},"string"==typeof a.map?wade.loadJson(a.map,
null,function(b){g={data:wade.cloneObject(b)};f.loadData_begin(g.data,h("terrain",a.callback))}):(g=wade.cloneObject(a.map),f.loadData_begin(g.data,h("terrain",a.callback)))):f.setNumTiles(i,l);!a.map&&a.callback&&a.callback()};this.importScene=function(a,b){this.reset(a);g={data:a};f.loadData_begin(g.data,h("terrain",b))};var h=function(a,b){return function(){c[a]=1;c.terrain&&b&&b()}};this.getTileSize=function(){i();return wade.cloneObject(f.c_tileSize)};this.getTileSprite=function(a,b){return f&&
f.tileSprites[a]&&f.tileSprites[a][b]};this.getTileData=function(a,b){return f&&f.getTileData(a,b)};this.getTransitionSprite=function(a,b){return f&&f.transitionSprites[a]&&f.transitionSprites[a][b]};this.getTransitionData=function(a,b){return f&&f.getTransitionData(a,b)};this.getDetailSprite=function(a,b){return f&&f.detailSprites[a]&&f.detailSprites[a][b]};this.getDetailData=function(a,b){return f&&f.getDetailData(a,b)};this.checkCollisionsAtTile=function(a,b,c){a=this.collisionMap&&this.collisionMap[a]&&
this.collisionMap[a][b];return c&&a==c?!1:!!a};this.setTiles=function(a,b,c,d,e,g){i();return f.setTiles(a,b,c,d,e,g)};this.setTile=function(a,b,c){i();return f.setTile(a,b,c)};this.setTransitions=function(a,b,c,d,e,g){i();return f.setTransitions(a,b,c,d,e,g)};this.setTransition=function(a,b,c){i();return f.setTransition(a,b,c)};this.setDetails=function(a,b,c,d,e,g){i();return f.setDetails(a,b,c,d,e,g)};this.setDetail=function(a,b,c){i();return f.setDetail(a,b,c)};this.setNumTiles=function(a,b){i();
a&&b&&!wade.getSceneObject("tilemap_terrain")?wade.addSceneObject(e,!0):!a&&(!b&&wade.getSceneObject("tilemap_terrain"))&&wade.removeSceneObject(e);f.setNumTiles(a,b)};this.getWorldCoordinates=function(a,b){i();"object"==typeof a&&"undefined"==typeof b&&(b=a.y,a=a.x);return f.getWorldCoordinates(a,b)};this.getTileCoordinates=function(a,b){i();"object"==typeof a&&"undefined"==typeof b&&(b=a.y,a=a.x);return f.getTileCoordinates(a,b)};this.getNumTiles=function(){return f?{x:f.numTilesX,y:f.numTilesY}:
{x:0,y:0}};this.getTerrainLayerId=function(){return b};this.getTerrain=function(){i();return e};this.getTileScaleFactor=function(){i();return 1};this.reset=function(){d?(this.setNumTiles(0,0),this.collisionMap.length=0,c={}):i()};this.findPath=function(a,b,c,d){i();return wade.findPath({start:{x:a.x,y:a.y},target:{x:b.x,y:b.y},collisionMap:this.collisionMap,movementOffsets:c,boundaries:{minX:0,minY:0,maxX:f.numTilesX-1,maxY:f.numTilesY-1},maxPathLength:d})};this.moveObjectToTile=function(b,c,d,e){i();
var g=b.getBehavior("TilemapCharacter"),h=g.tileCoordinates();if("string"==typeof b&&(b=wade.getSceneObject(b),!b))return!1;if(!e)return a.updateObjectTile(b,c,d)?(b.setPosition(f.getWorldCoordinates(c,d)),g.targetCoords=0,!0):!1;if(h.x==c&&h.y==d)return!0;g.targetCoords={x:c,y:d};g.previousPosition=b.getPosition();c=f.getWorldCoordinates(c,d);b.moveTo(c.x,c.y,e);return!0};this.exportMap=function(a){i();for(var b={version:"1.0",terrain:{numTilesX:f.numTilesX,numTilesY:f.numTilesY,tileData:[],tileDataIds:[],
transitionData:[],transitionDataIds:[],detailData:[],detailDataIds:[]}},c=0;c<f.numTilesX;c++){b.terrain.tileDataIds[c]=[];b.terrain.transitionDataIds[c]=[];for(var d=0;d<f.numTilesY;d++){if(f.tileData[c]&&f.tileData[c][d]){var e=f.tileData[c][d],g=b.terrain.tileData.indexOf(e);-1==g&&(g=b.terrain.tileData.push(e)-1);b.terrain.tileDataIds[c][d]=g}else b.terrain.tileDataIds[c][d]=-1;f.transitionData[c]&&f.transitionData[c][d]?(e=f.transitionData[c][d],g=b.terrain.transitionData.indexOf(e),-1==g&&(g=
b.terrain.transitionData.push(e)-1),b.terrain.transitionDataIds[c][d]=g):b.terrain.transitionDataIds[c][d]=-1}}for(c=0;c<f.numTilesX;c++){b.terrain.detailDataIds[c]=[];for(d=0;d<f.numTilesY;d++)f.detailData[c]&&f.detailData[c][d]?(e=f.detailData[c][d],g=b.terrain.detailData.indexOf(e),-1==g&&(g=b.terrain.detailData.push(e)-1),b.terrain.detailDataIds[c][d]=g):b.terrain.detailDataIds[c][d]=-1}if(a)try{b=JSON.stringify(b)}catch(h){wade.log("Unable to convert map data to a string. It may contain circular references.")}return b};
this.drawGrid=function(a){i();"undefined"==typeof a&&(a=!0);f.drawGrid(a)}};wade.tilemap=new Wade_tilemap;
function TiledTerrain(){this.name="TiledTerrain";this.tileSprites=[];this.tileData=[];this.gridSprites=[];this.transitionSprites=[];this.transitionData=[];this.detailSprites=[];this.detailData=[];this.c_tileSize={x:128,y:128};this.c_origin={x:0,y:0};this.numTilesY=this.numTilesX=0;this.tileHighlightObjects=[];var a=!1;this.onAddToScene=function(){this.owner.listenFor("onMouseDown");this.owner.listenFor("onMouseUp");this.owner.listenFor("onMouseClick");this.owner.listenFor("onMouseMove");wade.setLayerSorting(wade.tilemap.getTerrainLayerId(),
this.sortingFunction)};this.getTileHighlightObject=function(a){if(!this.tileHighlightObjects[a])if(this.highlightTexture){var c=new Sprite(this.highlightTexture,wade.tilemap.getTerrainLayerId());c.setSize(this.c_tileSize.x,this.c_tileSize.y);c.customSortOrder=4;c.customSortIndex=0;this.tileHighlightObjects[a]=new SceneObject(c);this.tileHighlightObjects[a].tilemap={gridCoords:{x:0,y:0}};wade.addSceneObject(this.tileHighlightObjects[a])}else this.highlightSprite&&(c=this.highlightSprite.clone(),c.customSortOrder=
4,c.customSortIndex=0,this.tileHighlightObjects[a]=new SceneObject(c),this.tileHighlightObjects[a].tilemap={gridCoords:{x:0,y:0}},wade.addSceneObject(this.tileHighlightObjects[a]));return this.tileHighlightObjects[a]};this.hideTileHighlightObjects=function(){for(var a=0;a<this.tileHighlightObjects.length;a++)this.tileHighlightObjects[a]&&this.tileHighlightObjects[a].setVisible(!1)};this.getHighlightObjects=function(){return wade.extend([],this.tileHighlightObjects)};this.loadData_begin=function(a,
c){this.finishedLoading_=!1;this.loadingList=[];var d={_wade_tilemapDefault:1};this.completeRequests=0;var e,f;for(e=0;e<a.terrain.tileData.length;e++)f=a.terrain.tileData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);for(e=0;e<a.terrain.transitionData.length;e++)f=a.terrain.transitionData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);for(e=0;e<a.terrain.detailData.length;e++)f=a.terrain.detailData[e].texture,d[f]||(this.loadingList.push(f),d[f]=1);if(this.loadingList.length)for(e=0;e<this.loadingList.length;e++)wade.loadImage(this.loadingList[e],
this.onLoadingRequestComplete_(a,c));else this.onLoadingRequestComplete_(a,c)(!0)};this.onLoadingRequestComplete_=function(a,c){var d=this;return function(e){if(!0===e||++d.completeRequests==d.loadingList.length)d.loadData_end(a),!d.owner.isInScene()&&(d.numTilesX&&d.numTilesY)&&wade.addSceneObject(d.owner,!1),d.finishedLoading_=!0,c&&c()}};this.loadData_end=function(a){var c,d;this.numTilesX=a.terrain.numTilesX;this.numTilesY=a.terrain.numTilesY;for(c=0;c<this.numTilesX;c++){this.tileSprites[c]=
[];this.tileData[c]=[];this.transitionSprites[c]=[];this.transitionData[c]=[];this.detailSprites[c]=[];this.detailData[c]=[];for(d=0;d<this.numTilesY;d++){var e=a.terrain.transitionData[a.terrain.transitionDataIds[c][d]],f=a.terrain.detailData[a.terrain.detailDataIds[c][d]];this.setTile(c,d,a.terrain.tileData[a.terrain.tileDataIds[c][d]]);e&&this.setTransition(c,d,e);f&&this.setDetail(c,d,f)}}};this.setNumTiles=function(b,c){var d,e;if(a){var f=!0;this.drawGrid(!1)}for(d=b;d<this.numTilesX;d++)for(e=
0;e<this.numTilesY;e++)this.setTile(d,e,0),this.setTransition(d,e,0);for(e=c;e<this.numTilesY;e++)for(d=0;d<this.numTilesX;d++)this.setTile(d,e,0),this.setTransition(d,e,0);for(d=b;d<this.numTilesX;d++)for(e=0;e<this.numTilesY;e++)this.setDetail(d,e,0);for(e=c;e<this.numTilesY;e++)for(d=0;d<this.numTilesX;d++)this.setDetail(d,e,0);this.tileData.length=this.transitionData.length=this.detailData.length=this.tileSprites.length=this.transitionSprites.length=this.detailSprites.length=this.gridSprites.length=
b;for(d=0;d<b;d++)this.tileData[d]&&(this.tileData[d].length=c),this.transitionData[d]&&(this.transitionData[d].length=c),this.detailData[d]&&(this.detailData[d].length=c),this.tileSprites[d]&&(this.tileSprites[d].length=c),this.transitionSprites[d]&&(this.transitionSprites[d].length=c),this.detailSprites[d]&&(this.detailSprites[d].length=c),this.gridSprites[d]&&(this.gridSprites[d].length=c);var g=this.numTilesX,i=this.numTilesY;this.numTilesX=b;this.numTilesY=c;var h={texture:"_wade_tilemapDefault"};
for(d=g;d<b;d++){this.tileSprites[d]=[];this.tileData[d]=[];this.transitionSprites[d]=[];this.transitionData[d]=[];this.detailSprites[d]=[];this.detailData[d]=[];for(e=0;e<c;e++)this.setTile(d,e,h)}for(e=i;e<c;e++)for(d=0;d<g;d++)this.setTile(d,e,h);f&&this.drawGrid(!0)};this.setTiles=function(a,c,d,e,f,g){for(var d=d||0,e=e||0,f=f||this.numTilesX,g=g||this.numTilesY,i=0;i<a.length;i++){var h=i%this.numTilesX,k=Math.floor(i/this.numTilesX);h>=d&&(h<f&&k>=e&&k<g)&&this.setTile(h,k,c[a[i]])}};this.setTile=
function(a,c,d){var e=wade.tilemap.collisionMap;if(!d||d.collision){if(e[a]&&e[a][c]&&!e[a][c].isTerrainTile)return!1;e[a]||(e[a]=[]);e[a][c]={isTerrainTile:!0,tileData:d}}else e[a]&&(e[a][c]&&e[a][c].isTerrainTile)&&(e[a][c]=0);this.tileSprites[a]||(this.tileSprites[a]=[]);this.tileData[a]||(this.tileData[a]=[]);if(d){var f,g,i,h,k=!0,j=d.texture;j&&(e=wade.getImage(j),f=e.width,g=e.height);d.rotation&&(j+="_tilemap_rot_"+d.rotation,"ok"!=wade.getLoadingStatus(j)&&(e=new Sprite(d.texture),e.setRotation(d.rotation*
Math.PI/2),e.drawToImage(j,!0)));h=d.scale||1;e=this.c_tileSize.x*wade.tilemap.getTileScaleFactor()*h;i=this.c_tileSize.y*wade.tilemap.getTileScaleFactor()*h;var l=this.getWorldCoordinates(a,c);this.tileSprites[a][c]&&(h=this.tileSprites[a][c],d.animation||this.tileData[a][c].animation?(this.owner.removeSprite(h),this.tileSprites[a][c]=0):(h.setImageFile(j),d.imageArea&&h.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),h.setSize(e,i),this.owner.setSpriteOffset(this.owner.getSpriteIndex(h),
l),k=!1));k&&(d.animation?(h=new Sprite(0,wade.tilemap.getTerrainLayerId()),k=new Animation(j,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,!0),h.addAnimation("default",k),h.playAnimation("default")):h=new Sprite(j,wade.tilemap.getTerrainLayerId()),h.customSortOrder=0,h.customSortIndex=a+c,h.gridCoords={x:a,y:c},d.imageArea?(h.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),d.customHeight&&(f=d.imageArea.maxX-d.imageArea.minX,g=d.imageArea.maxY-
d.imageArea.minY,i=this.c_tileSize.x*wade.tilemap.getTileScaleFactor()*g/f)):d.customHeight&&(f&&g)&&(i=this.c_tileSize.x*wade.tilemap.getScaleFactor()*g/f),h.setSize(e,i),this.tileSprites[a][c]=h,this.owner.addSprite(h,l))}else this.tileSprites[a]&&this.tileSprites[a][c]&&this.owner.removeSprite(this.tileSprites[a][c]),this.tileSprites[a][c]=0,this.transitionSprites[a]&&this.transitionSprites[a][c]&&this.setTransition(a,c,null),this.detailSprites[a]&&this.detailSprites[a][c]&&this.setDetail(a,c,
null);this.tileData[a][c]=d;return!0};this.hideTileHighlightObjects=function(){for(var a=0;a<this.tileHighlightObjects.length;a++)this.tileHighlightObjects[a]&&this.tileHighlightObjects[a].setVisible(!1)};this.getHighlightObjects=function(){return wade.extend([],this.tileHighlightObjects)};this.setTransitions=function(a,c,d,e,f,g){for(var d=d||0,e=e||0,f=f||this.numTilesX,g=g||this.numTilesY,i=0;i<a.length;i++){var h=i%this.numTilesX,k=Math.floor(i/this.numTilesX);h>=d&&(h<f&&k>=e&&k<g)&&this.setTransition(h,
k,c[a[i]])}};this.setTransition=function(a,c,d){this.transitionSprites[a]||(this.transitionSprites[a]=[]);this.transitionData[a]||(this.transitionData[a]=[]);if(d){var e=!0,f=d.texture;if(d.rotation&&(f+="_tilemap_rot_"+d.rotation,"ok"!=wade.getLoadingStatus(f))){var g=new Sprite(d.texture);g.setRotation(d.rotation*Math.PI/2);g.drawToImage(f,!0)}this.transitionSprites[a][c]&&(d.animation||this.transitionData[a][c].animation?(this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=
0):(this.transitionSprites[a][c].setImageFile(f),d.imageArea&&this.transitionSprites[a][c].setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),e=!1));g=this.getWorldCoordinates(a,c);if(e){var i=d.scale||1,e=this.c_tileSize.x*wade.tilemap.getTileScaleFactor()*i,i=this.c_tileSize.y*wade.tilemap.getTileScaleFactor()*i;if(d.animation){var f=new Sprite(0,wade.tilemap.getTerrainLayerId()),h=new Animation(d.texture,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,
!0);f.addAnimation("default",h);f.playAnimation("default")}else f=new Sprite(f,wade.tilemap.getTerrainLayerId());f.setPosition(g);f.setSize(e*wade.tilemap.getTileScaleFactor(),i*wade.tilemap.getTileScaleFactor());f.customSortOrder=1;f.customSortIndex=a+c;d.imageArea&&f.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY);this.owner.addSprite(f);this.transitionSprites[a][c]=f}this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.transitionSprites[a][c]),g)}else this.transitionSprites[a][c]&&
this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=0;this.transitionData[a][c]=d};this.setDetails=function(a,c,d,e,f,g){for(var d=d||0,e=e||0,f=f||this.numTilesX,g=g||this.numTilesY,i=0;i<a.length;i++){var h=i%this.numTilesX,k=Math.floor(i/this.numTilesX);h>=d&&(h<f&&k>=e&&k<g)&&this.setDetail(h,k,c[a[i]])}};this.setDetail=function(a,c,d){this.detailSprites[a]||(this.detailSprites[a]=[]);this.detailData[a]||(this.detailData[a]=[]);if(d){var e=!0,f=d.texture;if(d.rotation&&
(f+="_tilemap_rot_"+d.rotation,"ok"!=wade.getLoadingStatus(f))){var g=new Sprite(d.texture);g.setRotation(d.rotation*Math.PI/2);g.drawToImage(f,!0)}this.detailSprites[a][c]&&(d.animation||this.detailData[a][c].animation?(this.owner.removeSprite(this.transitionSprites[a][c]),this.transitionSprites[a][c]=0):(this.detailSprites[a][c].setImageFile(f),d.imageArea&&this.detailSprites[a][c].setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY),e=!1));g=this.getWorldCoordinates(a,
c);if(e){var e=d.scale||1,i=this.c_tileSize.x*wade.tilemap.getTileScaleFactor()*e,h=this.c_tileSize.y*wade.tilemap.getTileScaleFactor()*e;if(d.animation){var f=new Sprite(0,wade.tilemap.getTerrainLayerId()),k=new Animation(d.texture,d.animation.numFrames.x,d.animation.numFrames.y,d.animation.speed,!0);f.addAnimation("default",k);f.playAnimation("default")}else f=new Sprite(f,wade.tilemap.getTerrainLayerId());f.setSize(i*wade.tilemap.getTileScaleFactor()*e,h*wade.tilemap.getTileScaleFactor()*e);f.customSortOrder=
2;f.customSortIndex=a+c;d.imageArea&&f.setImageArea(d.imageArea.minX,d.imageArea.minY,d.imageArea.maxX,d.imageArea.maxY);this.owner.addSprite(f);this.detailSprites[a][c]=f}this.owner.setSpriteOffset(this.owner.getSpriteIndex(this.detailSprites[a][c]),g)}else this.detailSprites[a][c]&&this.owner.removeSprite(this.detailSprites[a][c]),this.detailSprites[a][c]=0;this.detailData[a][c]=d};this.getWorldCoordinates=function(a,c){return{x:a*this.c_tileSize.x+this.c_origin.x,y:c*this.c_tileSize.y+this.c_origin.y,
valid:0<=a&&0<=c&&a<this.numTilesX&&c<this.numTilesY}};this.getTileCoordinates=function(a,c){var d=Math.floor((a+this.c_tileSize.x/2-this.c_origin.x)/this.c_tileSize.x),e=Math.floor((c+this.c_tileSize.y/2-this.c_origin.y)/this.c_tileSize.y);return{x:d,y:e,valid:!!(0<=d&&d<=this.numTilesX-1)&&!!(0<=e&&e<=this.numTilesY-1)}};this.onMouseDown=function(a){if(wade.app.onTilemapTerrainMouseDown){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,c.y);
return wade.app.onTilemapTerrainMouseDown(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};this.onClick=function(a){if(wade.app.onTilemapTerrainClick){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,c.y);return wade.app.onTilemapTerrainClick(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};this.onMouseUp=function(a){if(wade.app.onTilemapTerrainMouseUp){var c=this.getTileCoordinates(a.position.x,a.position.y);if(c.valid){var d=this.getWorldCoordinates(c.x,
c.y);return wade.app.onTilemapTerrainMouseUp(wade.extend({gridCoords:c,worldCoords:d},a))}}return!1};this.setHighlight=function(a,c){var d;this.highlightOffsets=c||[{x:0,z:0}];if(a instanceof Sprite){if(this.highlightTexture)for(d=0;d<this.tileHighlightObjects.length;d++)wade.removeSceneObject(this.tileHighlightObjects[d]),this.tileHighlightObjects[d]=null;this.highlightSprite=a;this.highlightTexture=null}else{if(this.highlightSprite){for(d=0;d<this.tileHighlightObjects.length;d++)wade.removeSceneObject(this.tileHighlightObjects[d]);
this.tileHighlightObjects.length=0}this.highlightTexture=a;this.highlightSprite=null}if(this.highlightTexture&&this.highlightOffsets&&this.highlightOffsets.length)for(d=0;d<this.tileHighlightObjects.length;d++)this.getTileHighlightObject(d).getSprite(0).setImageFile(a);else if(this.highlightSprite)for(d=0;d<this.tileHighlightObjects.length;d++)this.getTileHighlightObject(d);else this.hideTileHighlightObjects()};this.onMouseMove=function(a){var c,d;c=this.getTileCoordinates(a.position.x,a.position.y);
if(c.valid&&(this.highlightTexture||this.highlightSprite)&&this.highlightOffsets&&this.highlightOffsets.length)for(var e=0;e<this.highlightOffsets.length;e++){var f=this.highlightOffsets[e];d=this.getWorldCoordinates(c.x+f.x,c.y+f.y);var g=this.getTileHighlightObject(e);g.setPosition(d);g.setVisible(!0);g.tilemap.gridCoords.x=c.x+f.x;g.tilemap.gridCoords.y=c.y+f.y}else this.hideTileHighlightObjects();wade.app.onTilemapTerrainMouseMove&&wade.app.onTilemapTerrainMouseMove(wade.extend({},a,{gridCoords:c}))};
this.sortingFunction=function(a,c){return c.customSortIndex-a.customSortIndex||a.customSortOrder-c.customSortOrder};this.sort=function(){wade.getLayer(wade.tilemap.getTerrainLayerId()).sort(this.sortingFunction)};this.getTileTexture=function(a,c){return this.tileSprites[a]&&this.tileSprites[a][c]&&this.tileSprites[a][c].getImageName()};this.getTileData=function(a,c){return this.tileData[a]&&this.tileData[a][c]&&wade.cloneObject(this.tileData[a][c])};this.getTransitionData=function(a,c){return this.transitionData[a]&&
this.transitionData[a][c]&&wade.cloneObject(this.transitionData[a][c])};this.getDetailData=function(a,c){return this.detailData[a]&&this.detailData[a][c]&&wade.cloneObject(this.detailData[a][c])};this.drawGrid=function(b){var c,d=wade.tilemap.getTerrainLayerId();if(b&&!a){for(b=0;b<this.numTilesX;b++){this.gridSprites[b]=[];for(c=0;c<this.numTilesY;c++){var e=new Sprite("_wade_tilemapGrid",d);e.customSortOrder=3;e.customSortIndex=b+c;var f=this.getWorldCoordinates(b,c);e.setSize(this.c_tileSize.x*
wade.tilemap.getTileScaleFactor(),this.c_tileSize.y*wade.tilemap.getTileScaleFactor());this.owner.addSprite(e,f);this.gridSprites[b][c]=e}}a=!0}else if(!b&&a){for(b=0;b<this.gridSprites.length;b++)for(c=0;c<this.gridSprites[b].length;c++)this.owner.removeSprite(this.gridSprites[b][c]);this.gridSprites.length=0;a=!1}}};
TilemapCharacter = function()
{
    var self = null;
    var destinations = [];
    var targetObject;
    var followingPath = false;
    var lastAnimation = null;
    var lastDirection = "s";
    var rotation = 0;
    var unitDirections =
    {
        n : {x:0, y:-1},
        ne: {x:0.7071067811865475 , y:-0.7071067811865475},
        e : {x:1, y:0},
        se: {x:0.7071067811865475 , y:0.7071067811865475},
        s : {x:0, y:1},
        sw: {x:-0.7071067811865475, y:0.7071067811865475},
        w : {x:-1, y:0},
        nw: {x:-0.7071067811865475, y:-0.7071067811865475}
    };
    var rotations =
    {
        "n" : 0,
        "ne": Math.PI/4,
        "e" : Math.PI/2,
        "se": Math.PI*3/4,
        "s" : Math.PI,
        "sw": Math.PI*5/4,
        "w" : Math.PI*3/2,
        "nw": Math.PI*7/4
    };

    this.drawCollisionBox = true;

    this.maxPathLength = 18;


    /**
     * Constructs a collision box based on the bounding boxes of all sprites belonging to the scene object.
     * @returns {object} Returns a collision box of form {minX, minY, maxX, maxY}
     */
    this.generateCollisionBox = function()
    {
        var box = null;
        for(var i=0; i<this.owner.getSpriteCount(); i++)
        {
            var sprite = this.owner.getSprite(i);
            var bound = sprite.boundingBox;
            if(!box)
            {
                box = bound;
            }
            wade.expandBox(box, bound);
        }
        return box;
    };

    /**
     * Initialises the collision box and sets the local rotation value from the parent
     * If drawCollisionBox flag is true, draws the debug collision box
     * @returns {object} Returns a collision box of form {minX, minY, maxX, maxY}
     */
    this.onAddToScene = function(params)
    {
        self = this;
        this.collisionBox = this.generateCollisionBox();
        this._tileCoordinates = this.tileCoordinates();
        if(this.drawCollisionBox)
        {
            var sp = new Sprite("procedural_square_border", 3);
            this._debugDrawCollision = new SceneObject(sp);

            if(!wade.getSceneObject("debugOffset"))
            {
                wade.addSceneObject(this._debugDrawCollision, true);
            }
        }
        this.setRotationOffset((params && params.rotationOffset) || this.rotationOffset);
        rotation = this.owner.getRotation();
    };

    /**
     * The name of the behavior. This is set to 'TilemapCharacter'.
     * @type {string}
     */
    this.name = 'TilemapCharacter';

    /**
     * Automatically rotates object to match movement
     * @type {boolean}
     */
    this.automaticRotations = true;

    /**
     * Used for automatic rotations. A sprite can have any orientation
     * This offset is used when calculate the rotation angles for each direction
     * @type {number}
     */
    this.rotationOffset = 0;

    /**
     * Calculates the rotations needed for the character
     * @param offset The rotation offset to use when automatic rotations is enabled
     */
    this.setRotationOffset = function(offset)
    {
        this.rotationOffset = offset;
        this.autoRotations = wade.cloneObject(rotations);
        for(var it in this.autoRotations)
        {
            if(this.autoRotations.hasOwnProperty(it))
            {
                this.autoRotations[it] += this.rotationOffset;
            }
        }
    };

    /**
     * Whether or not to allow diagonal movement, true by default
     * @type {boolean}
     */
    this.allowDiagonal = true;

    /**
     * A flag that specifies if the character can be controlled by player input
     * @type {boolean}
     */
    this.allowInput = true;

    /**
     * The movement speed of the character (in world units per second). Note that changing this won't affect any movement that is currently in progress, only future movements. Default is 160.
     * @type {number}
     */
    this.movementSpeed = 100;

    /**
     * Keyboard keys to control the character. By default arrow keys are used
     * @type {{up: number, down: number, left: number, right: number}}
     */
    this.controls =
    {
        up:38,   // Up    arrow default
        down:40, // Down  arrow default
        left:37, // Left  arrow default
        right:39 // Right arrow default
    };

    /**
     * The game pad to use
     * @type {number} Number representing gamepad
     */
    this.gamePadIndex = 0;

    /**
     * Axis and direction of gamepad controls
     * @type {{up: {axis: number, axisDirection: number, buttons: Array}, down: {axis: number, axisDirection: number, buttons: Array}, left: {axis: number, axisDirection: number, buttons: Array}, right: {axis: number, axisDirection: number, buttons: Array}}}
     */
    this.gamePadControls =
    {
        up:{axis:1, axisDirection:-1, buttons:[]},
        down:{axis:1, axisDirection:1, buttons:[]},
        left:{axis:0, axisDirection:-1, buttons:[]},
        right:{axis:0,axisDirection:1, buttons:[]}
    };

    /**
     * Current state of the gamepad to base movement off
     * @type {{up: boolean, down: boolean, left: boolean, right: boolean}}
     */
    this._gamepadStates =
    {
        up:false,
        down:false,
        left:false,
        right:false
    };

    /**
     * Current state of the keys to base movement off
     * @type {{up: boolean, down: boolean, left: boolean, right: boolean}}
     */
    this._keyStates =
    {
        up:false,
        down:false,
        left:false,
        right:false
    };

    /**
     * Looks at both keyboard and gamepad state data to determine movement
     * @param direction The direction we are wanting to move
     * @returns {*} Whether or not there is input for the provided direction
     * @private
     */
    this._inputState = function(direction)
    {
        return (this._gamepadStates[direction] || this._keyStates[direction]);
    };

    /**
     * Specify the animation names to use for various walking and idle states
     * @type {{idle_n: string, idle_ne: string, idle_e: string, idle_se: string, idle_s: string, idle_sw: string, idle_w: string, idle_nw: string, walk_n: string, walk_ne: string, walk_e: string, walk_se: string, walk_s: string, walk_sw: string, walk_w: string, walk_nw: string}}
     */
    this.animations =
    {
        idle_n : "idle_n",
        idle_ne: "idle_ne",
        idle_e : "idle_e",
        idle_se: "idle_se",
        idle_s : "idle_s",
        idle_sw: "idle_sw",
        idle_w : "idle_w",
        idle_nw: "idle_nw",
        walk_n : "walk_n",
        walk_ne: "walk_ne",
        walk_e : "walk_e",
        walk_se: "walk_se",
        walk_s : "walk_s",
        walk_sw: "walk_sw",
        walk_w : "walk_w",
        walk_nw: "walk_nw"
    };

    /**
     * Current velocity of the object
     * @type {{x: number, y:number}}
     */
    this.velocity = {x:0, y:0};

    /**
     * Applies one tick of velocity to the position, and returns the final cell co-ordinates
     * @param pos The current position
     * @param vel The current velocity in units per second
     * @returns {*} The cell co-ordinates we will be in
     */
    this.calcFutureCoords = function(pos, vel)
    {
        return {x:pos.x + vel.x*wade.c_timeStep, y:pos.y + vel.y*wade.c_timeStep};
    };

    /**
     * Helper Function - Returns whether the co-ordinates are inside the tilemap boundary
     * @param x The x cell co-ordinate
     * @param y The y cell co-ordinate
     * @returns {boolean} Returns true if co-ordinates exist on map
     */
    this.inGrid = function(x, y)
    {
        var size = wade.tilemap.getNumTiles();
        return !(x >= size.x || y >= size.y || x < 0 || y < 0);
    };

    /**
     *
     * @param box Takes a bounding box in the form (minX, minY, maxX, maxY}
     * @returns {boolean} Returns true if the bounding box is completely inside the tilemap area
     */
    this.boxInGrid = function(box)
    {
        var corners = boxToCorners(box);
        for(var i=0; i<corners.length; i++)
        {
            var point = wade.tilemap.getTileCoordinates(corners[i].x, corners[i].y);
            if(!this.inGrid(point.x, point.y))
            {
                return false;
            }
        }
        return true;
    };

    /**
     * Returns the closest movement direction given a provided velocity
     * @param vel Velocity or unit vector to calculate direction from
     */
    this.velocityToDirection = function(vel)
    {
        var directions =
        {
            n : 0,
            ne: Math.PI/4,
            e : Math.PI/2,
            se: Math.PI*3/4,
            s : Math.PI,
            sw: Math.PI*5/4,
            w : Math.PI*3/2,
            nw: Math.PI*7/4
        };

        var difference = Math.atan2(vel.y, vel.x) + Math.PI/2;
        if (difference < 0)
        {
            difference += Math.PI*2;
        }
        var closestIt  = "n";
        var closestVal = 100000;
        for(var it in directions)
        {
            if(!directions.hasOwnProperty(it))
            {
                continue;
            }
            var dif = Math.abs(difference - directions[it]);
            if(dif < closestVal)
            {
                closestVal = dif;
                closestIt = it;
            }
        }
        return closestIt;
    };

    /**
     * Samples the gamepad to get the current states of the buttons and axis
     * If buttons are pressed, the state is stored in this._gamepadStates
     * Analog values that exceed a threshold value are also stored as true in this._gamepadStates
     */
    this.updateGamepadState = function()
    {
        var analogThreshold = 0.4; // The minimum value for analog to register as 1 for digital conversion
        var sign = function(val) // Math.sign is not widely supported
        {
            return (val == 0 ? 0 : Math.abs(val)/val);
        };

        // Set all to false
        for(var it in this._gamepadStates)
        {
            if(this._gamepadStates.hasOwnProperty(it))
            {
                this._gamepadStates[it] = false;
            }
        }

        var data = wade.getGamepadData();
        var pad = data[this.gamePadIndex];
        if(!pad)
        {
            return;
        }
        for(it in this.gamePadControls)
        {
            if(!this.gamePadControls.hasOwnProperty(it))
            {
                continue;
            }
            var control = this.gamePadControls[it];
            if(control.axis != -1) // Handle the axis
            {
                var dir = control.axisDirection;
                var padAxis = pad.axes[control.axis];
                if((sign(dir) == sign(padAxis)) && Math.abs(padAxis) > analogThreshold)
                {
                    this._gamepadStates[it] = true;
                }
            }
            for(var i=0; i<control.buttons.length; i++) // Handle the buttons
            {
                if(pad.buttons[control.buttons[i]] && pad.buttons[control.buttons[i]].pressed)
                {
                    this._gamepadStates[it] = true;
                    break;
                }
            }
        }
    };

    /**
     * Updates keyboard state
     * @param data Event data that specifies keyCode among other things
     * @returns {boolean}
     */
    this.onKeyDown = function(data)
    {
        for(var it in this.controls)
        {
            if(!this.controls.hasOwnProperty(it))
            {
                continue;
            }
            if(this.controls[it] == data.keyCode)
            {
                this._keyStates[it] = true;
            }
        }
    };

    /**
     * Updates keyboard state
     * @param data Event data that specifies keyCode among other things
     * @returns {boolean}
     */
    this.onKeyUp = function(data)
    {
        for(var it in this.controls)
        {
            if(!this.controls.hasOwnProperty(it))
            {
                continue;
            }
            if(this.controls[it] == data.keyCode)
            {
                this._keyStates[it] = false;
            }
        }
    };

    /**
     * Adds a direction velocity, taking into account diagonal motion
     * @param noMove Whether or not a velocity component has already been added
     * @param vel The current velocity
     * @param direction A string representing the compass direction
     */
    this.updateVelComponent = function(noMove, vel, direction)
    {
        if(!noMove && !this.allowDiagonal)
        {
            return; // We are all ready moving in straight line
        }
        wade.vec2.addInPlace(vel, unitDirections[direction]);
    };

    /**
     * Updates the velocity and calculates the closest direction for the animation system
     * @returns {{noMove: boolean, vel: {x: number, y: number}, direction: *}} Data relevant to resolving movement
     */
    this.updateVelocity = function()
    {
        var vel = {x:0, y:0};
        var noMove = true;
        if(this.allowInput)
        {
            for(var it in this._keyStates)
            {
                if(!this._keyStates.hasOwnProperty(it) || this._inputState(it) == false)
                {
                    continue;
                }
                // Sum velocity
                if(it == "up")
                {
                    this.updateVelComponent(noMove, vel, "n");
                    noMove = false;
                }
                if(it == "down")
                {
                    this.updateVelComponent(noMove, vel, "s");
                    noMove = false;
                }
                if(it == "left")
                {
                    this.updateVelComponent(noMove, vel, "w");
                    noMove = false;
                }
                if(it == "right")
                {
                    this.updateVelComponent(noMove, vel, "e");
                    noMove = false;
                }
            }
        }

        var direction = this.velocityToDirection(vel);
        this.velocity = wade.vec2.scale(unitDirections[direction], this.movementSpeed);

        if(followingPath) // If we are following a path, do not override velocity
        {
            this.velocity = this.owner.getVelocity();
            direction = this.velocityToDirection(this.velocity);
        }
        else
        {
            if(noMove)
            {
                this.velocity = {x:0, y:0};
            }
            this.owner.setVelocity(this.velocity.x, this.velocity.y);
        }
        return {noMove:noMove, vel:this.velocity, direction:direction};
    };

    /**
     * Plays the correct animation depending on the control input state
     * @param direction A string represent the compass direction that most closely matches the characters movement
     * @param noMove A flag specifying that no input controls are active
     */
    this.updateAnimation = function(direction, noMove)
    {
        var sprite = this.owner.getSprite();
        var vel = this.owner.getVelocity();
        if((noMove && !followingPath) || (vel.x == 0 && vel.y == 0))
        {
            if(sprite.getCurrentAnimationName() != this.animations["idle_" + lastDirection])
            {
                var tempDirection = lastDirection;
                if(!sprite.hasAnimation(this.animations["idle_" + tempDirection]))
                {
                    // If no idle animation, try pausing current animation instead
                    sprite.stopAnimation();
                }
                else
                {
                    sprite.playAnimation(this.animations["idle_" + tempDirection], "forwards");
                }
            }
        }
        else
        {
            sprite.resumeAnimation();
            if(sprite.getCurrentAnimationName() != (this.animations["walk_" + direction]))
            {
                sprite.playAnimation(this.animations["walk_" + direction], "forwards");


                lastAnimation = this.animations["walk_" + direction];
                lastDirection = direction;
            }
            if(this.automaticRotations)
            {
                this.owner.setRotation(this.autoRotations[direction]);
            }
        }
    };

    /**
     * Returns true if either the tile is off the grid, or the tile contains a collidable object
     * @param dest Co-ordinates of the tile to test
     * @returns {boolean|*} Is the move illegal
     */
    this.illegalTile = function(dest, exception)
    {
        return (!this.inGrid(dest.x, dest.y) || wade.tilemap.checkCollisionsAtTile(dest.x, dest.y, exception));
    };

    /**
     * Returns tile co-ordinates of all terrain tiles overlapping the character
     * @returns {Array} The terrain tile co-ordinates
     */
    this.overlappingTerrainTiles = function(displace)
    {
        displace = displace || {x:0, y:0};
        var corners =
        {
            topLeft:     wade.tilemap.getTileCoordinates(this.collisionBox.minX + displace.x, this.collisionBox.minY + displace.y),
            bottomRight: wade.tilemap.getTileCoordinates(this.collisionBox.maxX + displace.x, this.collisionBox.maxY + displace.y)
        };

        var dx = corners.bottomRight.x - corners.topLeft.x;
        var dy = corners.bottomRight.y - corners.topLeft.y;

        var tiles = [];
        var numX = 1 + dx;
        var numY = 1 + dy;

        // Build tile list
        for(var i=0; i<numX; i++)
        {
            for(var j=0; j<numY; j++)
            {
                var tile = wade.cloneObject(corners.topLeft);
                tile.x += i;
                tile.y += j;
                tiles.push(tile);
            }
        }
        return tiles;
    };

    // Converts local bounding box to world co-ordinates using the provided position
    var boundingToWorld = function(pos, boundingBox)
    {
        var box = {minX:0, minY:0, maxX:0, maxY:0};
        box.minX = pos.x + boundingBox.minX;
        box.maxX = pos.x + boundingBox.maxX;
        box.minY = pos.y + boundingBox.minY;
        box.maxY = pos.y + boundingBox.maxY;
        return box;
    };

    // convert box to list of corners
    var boxToCorners = function(box)
    {
        var corners = [];
        corners.push({x:box.minX, y:box.minY});
        corners.push({x:box.minX, y:box.maxY});
        corners.push({x:box.maxX, y:box.minY});
        corners.push({x:box.maxX, y:box.maxY});
        return corners;
    };

    /**
     * Tests and handles moving into a new tile
     * @param futureCoords The characters co-ordinates after velocity has been applied in world space
     */
    this.handleTileTransition = function(futureCoords)
    {
        var displace = wade.vec2.sub(futureCoords, this.owner.getPosition());
        var legal = true;
        var tiles = this.overlappingTerrainTiles(displace);
        var worldBoundingBox = wade.cloneObject(this.collisionBox);

        worldBoundingBox.minX += displace.x;
        worldBoundingBox.maxX += displace.x;
        worldBoundingBox.minY += displace.y;
        worldBoundingBox.maxY += displace.y;

        for(var i=0; i<tiles.length; i++)
        {
            var collision = wade.tilemap.checkCollisionsAtTile(tiles[i].x, tiles[i].y, this.owner);
            if(collision)
            {
                legal = false;
                break;
            }
        }

        return (legal && this.boxInGrid(worldBoundingBox));
    };

    this.setRotation = function(newAngle)
    {
        var theta = newAngle - this.owner.getRotation();
        if(Math.abs(theta) < wade.c_epsilon)
        {
            return;
        }
        this.owner.setRotation(newAngle);
        this.collisionBox = this.generateCollisionBox();
        rotation = newAngle;
        this.resolveRotation(newAngle, theta);
    };

    this.resolveRotation = function(newAngle, theta)
    {
        if(theta == 0)
        {
            return;
        }
        var allowed = this.handleTileTransition(this.owner.getPosition());

        if(allowed == false) // Undo rotation, it's illegal
        {
            this.owner.setRotation(newAngle-theta);
            this.collisionBox = this.generateCollisionBox();
            rotation = newAngle-theta;
        }
    };

    /**
     * Update character state based on user input
     */
    this.onUpdate = function()
    {
        this._tileCoordinates = this.tileCoordinates();

        // Update collision box to account for potential rotations
        this.collisionBox = this.generateCollisionBox();

        // Update gamepad state
        this.updateGamepadState();

        // Update movement and get movement direction
        var movementData = this.updateVelocity();
        var direction    = movementData.direction;
        var noMove       = movementData.noMove;
        var vel          = movementData.vel;
        var velX         = {x:vel.x, y:0};
        var velY         = {x:0    , y:vel.y};

        // Our position
        var pos = this.owner.getPosition();
        var tileCoords = wade.tilemap.getTileCoordinates(pos.x, pos.y);

        if(this.drawCollisionBox)
        {
            if(this._debugDrawCollision)
            {
                // debug collision box
                var debugPos = {x:(this.collisionBox.minX+this.collisionBox.maxX)/2,
                                y:(this.collisionBox.minY+this.collisionBox.maxY)/2};
                this._debugDrawCollision.setPosition(debugPos);
                this._debugDrawCollision.getSprite().setSize(this.collisionBox.maxX - this.collisionBox.minX, this.collisionBox.maxY - this.collisionBox.minY);
            }
        }


        // Will this movement result in us moving to a new tile
        var futureCoords  = this.calcFutureCoords(pos, vel);
        var futureCoordsX = this.calcFutureCoords(pos, velX);
        var futureCoordsY = this.calcFutureCoords(pos, velY);

        // Moving to a different tile
        // Need to test this with components if it fails
        if(!this.handleTileTransition(futureCoords))
        {
            if(!this.handleTileTransition(futureCoordsX))
            {
                if(!this.handleTileTransition(futureCoordsY))
                {
                    this.owner.setVelocity(this.velocity = {x:0, y:0}); // No valid movement possible
                }
                else
                {
                    this.owner.setVelocity(this.velocity = velY);
                }
            }
            else
            {
                this.owner.setVelocity(this.velocity = velX);
            }
        }

        // Play the correct animation
        this.updateAnimation(direction, noMove);
    };

    this._goToNextDestination = function()
    {
        // reset collision info for our tile
        var currentGridCoords = this._tileCoordinates = this.tileCoordinates();
        var gridCoords = destinations[0];
        this._nextDestination = destinations[0];
        targetObject = destinations[0].object;
        wade.removeObjectFromArrayByIndex(0, destinations);
        wade.tilemap.moveObjectToTile(this.owner, gridCoords.x, gridCoords.y, this.movementSpeed);

        // find direction suffix (for the animation)
        var dirX = (gridCoords.x - currentGridCoords.x);
        var dirY = (gridCoords.y - currentGridCoords.y);
        dirX && (dirX /= Math.abs(dirX));
        dirY && (dirY /= Math.abs(dirY));
        var direction;
        switch (dirX.toString() + dirY)
        {
            case '-11':
                direction = 'sw';
                break;
            case '-10':
                direction = 'w';
                break;
            case '-1-1':
                direction = 'nw';
                break;
            case '0-1':
                direction = 'n';
                break;
            case '01':
                direction = 's';
                break;
            case '1-1':
                direction = 'ne';
                break;
            case '10':
                direction = 'e';
                break;
            case '11':
                direction = 'se';
                break;
        }

        if (direction != this.lastDirection)
        {
            this.lastDirection = direction;
            //this.owner.playAnimation('walk_' + this.lastDirection);
        }
    };

    /**
     * Remove any destinations that were added with setDestination()
     */
    this.clearDestinations = function()
    {
        destinations.length = 0;
    };

    /**
     * Get the next destination
     * @returns {Object} An object with x and y fields representing the next destination, or null if there are no destinations in the queue
     */
    this.getNextDestination = function()
    {
        return this._nextDestination;
    };

    this.tileCoordinates = function()
    {
        var pos = this.owner.getPosition();
        return wade.tilemap.getTileCoordinates(pos.x, pos.y);
    };

    /**
     * Set a destination (a tile to move to) for the character.
     * @param {{x: number, y: number}} gridCoords The tilemap coordinates to move to
     * @returns {boolean} Whether it was possible to add the destination (i.e. it isn't blocked by objects with collisions)
     */
    this.setDestination = function(gridCoords)
    {
        var currentPosition = this.owner.getPosition();
        var gridStart = wade.tilemap.getTileCoordinates(currentPosition.x, currentPosition.y);

        var destination = this.getNextDestination();

        // if we already had a destination
        if (destination)
        {
            // start from the next grid tile
            var deltaX = destination.x - gridStart.x;
            if (deltaX)
            {
                deltaX /= Math.abs(deltaX);
            }
            var deltaY = destination.y - gridStart.y;
            if (deltaY)
            {
                deltaY /= Math.abs(deltaY);
            }
            gridStart.x += deltaX;
            gridStart.y += deltaY;
        }

        // calculate path to destination
        var path = wade.tilemap.findPath(gridStart, gridCoords, "top-down straight", this.maxPathLength);

        // if there is a path
        if (path.length)
        {
            followingPath = true;
            // add the first node

            var worldStart = wade.tilemap.getWorldCoordinates(gridStart.x, gridStart.y);
            this.clearDestinations();
            if (Math.abs(currentPosition.x - worldStart.x) > wade.c_epsilon || Math.abs(currentPosition.y - worldStart.y) > wade.c_epsilon)
            {
                if (destination && destination.x == gridCoords.x && destination.y == gridCoords.y)
                {
                    followingPath = false;
                    return false;
                }

                // Override first moveTo using this
                var pos = this.owner.getPosition();
                var tileCoords = wade.tilemap.getTileCoordinates(pos.x, pos.y);

                var closeTiles = this.overlappingTerrainTiles();
                var bestTile = null; // compares against tiles in destinations array
                for(var i=0; i<closeTiles.length; i++)
                {
                    for(var j=0; j<path.length; j++)
                    {
                        if( closeTiles[i].x == path[j].x &&
                            closeTiles[i].y == path[j].y)
                        {
                            if(!bestTile || j > bestTile.index)
                            {
                                bestTile = {index:j, position:closeTiles[i]};
                            }
                        }
                    }
                }
                if(!bestTile)
                {
                    path[0].x = gridStart.x;
                    path[0].y = gridStart.y;
                    addDirectDestination(gridStart);
                }
                else
                {
                    // Need to remove elements from destinations array
                    path[bestTile.index].x = bestTile.position.x;
                    path[bestTile.index].y = bestTile.position.y;
                    path.splice(0, bestTile.index);
                    addDirectDestination(bestTile.position);
                }
            }

            if (gridStart.x == gridCoords.x && gridStart.y == gridCoords.y)
            {
                followingPath = false;
                return false;
            }
            // iterate over the rest of the path
            for (i=1; i<path.length-1; i++)
            {
                var previousX = path[i].x - path[i-1].x;
                var nextX = path[i+1].x - path[i].x;
                var previousY = path[i].y - path[i-1].y;
                var nextY = path[i+1].y - path[i].y;
                if (previousX != nextX || previousY != nextY)
                {
                    addDirectDestination(path[i]);
                }
            }
            // add last node
            addDirectDestination(gridCoords);


            return true;
        }
        followingPath = false;
        return false;
    };

    this.onMoveComplete = function()
    {
        // if there are more destination in the queue, proceed to the next one
        if (destinations.length)
        {
            this._goToNextDestination();
        }
        else
        {
            followingPath = false;
            // enter an idle state
            // this.owner.playAnimation('idle_iso_' + this.lastDirection);
            this.lastDirection = '';

            // fire an onDestinationReached event
            var dest = this._nextDestination;
            this._nextDestination = null;
            this.owner.processEvent('onDestinationReached', {destination: dest});

            // see if we've reached any objects
            if (targetObject)
            {
                var offsets = [{x:0, y:0}];
                targetObject.interactionOffset && offsets.push({x:-targetObject.interactionOffset.x, y:-targetObject.interactionOffset.y});
                offsets = offsets.concat(wade.tilemap.getValidMovementDirections());
                var gridCoords = this._tileCoordinates;
                for (var j=0; j<offsets.length; j++)
                {
                    var objects = wade.tilemap.getObjectsInTile(gridCoords.x + offsets[j].x, tilemap.gridCoords.y + offsets[j].y);
                    for (var i=0; i<objects.length; i++)
                    {
                        if (objects[i] == targetObject)
                        {
                            var directions = {'11': 'se', '01': 's', '-11': 'sw', '-10': 'w', '-1-1': 'nw', '0-1':'n', '1-1': 'ne', '10': 'e'};
                            var diff = {x: gridCoords.x - targetObject.tilemap._tileCoordinates.x, y: gridCoords.y - targetObject._tileCoordinates.y};
                            var dir = directions[diff.x.toString() + diff.y.toString()];
                            dir && this.setDirection(dir);
                            this.owner.processEvent('onObjectReached', {object: objects[i]});
                        }
                    }
                }
            }
        }
    };

    var addDirectDestination = function(gridCoords)
    {
        destinations.push(gridCoords);
        if (!self.owner.isMoving())
        {
            self._goToNextDestination();
        }
    };
};